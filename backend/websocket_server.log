2025-05-17 11:17:24,080 - websocket_server - WARNING - Không thể import từ chatbot.py. Sử dụng hàm mock.
2025-05-17 11:17:24,081 - websocket_server - WARNING - Không thể import DepartmentInfoTool. Sử dụng mock class.
2025-05-17 11:17:24,084 - websocket_server - INFO - Khởi động server WebSocket tại 0.0.0.0:8090
2025-05-17 11:17:24,145 - websockets.server - INFO - server listening on 0.0.0.0:8090
2025-05-17 11:17:24,145 - websocket_server - INFO - Server WebSocket đang chạy tại ws://0.0.0.0:8090
2025-05-17 11:17:24,145 - websocket_server - INFO - Đã cấu hình ping_timeout=6000 giây, ping_interval=60 giây
2025-05-17 11:17:58,030 - websockets.server - INFO - connection open
2025-05-17 11:18:00,782 - websocket_server - INFO - Nhận tin nhắn dạng JSON: {"content":"test alo alo /no_think","session_id":""}
2025-05-17 11:18:00,783 - websocket_server - INFO - Session ID không được cung cấp trong tin nhắn JSON, sử dụng current_session_id: 16b1f3ea-b548-4dc1-91ef-f517c74092b7
2025-05-17 11:18:00,783 - websocket_server - INFO - Session ID từ client (sau khi kiểm tra): 16b1f3ea-b548-4dc1-91ef-f517c74092b7
2025-05-17 11:18:00,784 - websocket_server - INFO - Tắt chế độ thinking cho câu hỏi: test alo alo /no_think...
2025-05-17 11:18:00,784 - websocket_server - INFO - Nhận tin nhắn thông thường: test alo alo /no_think, enable_thinking=False
2025-05-17 11:18:00,784 - websocket_server - INFO - Không có lịch sử tin nhắn cho phiên này
2025-05-17 11:18:00,785 - websocket_server - INFO - Phân tích câu hỏi: Phòng ban=None, Loại=general, Thinking=False
2025-05-17 11:18:00,785 - websocket_server - INFO - Xử lý streaming response cho: 'test alo alo /no_think', phòng ban: None, session_id: 16b1f3ea-b548-4dc1-91ef-f517c74092b7
2025-05-17 11:18:00,785 - websocket_server - INFO - Session ID nhận được: 16b1f3ea-b548-4dc1-91ef-f517c74092b7
2025-05-17 11:18:00,786 - websocket_server - INFO - Phát hiện lệnh /no_think, tắt chế độ thinking cho: test alo alo
2025-05-17 11:18:00,786 - websocket_server - INFO - Xử lý streaming response. Query: 'test alo alo', Mode thinking: False
2025-05-17 11:18:00,786 - websocket_server - INFO - Không có lịch sử tin nhắn cho phiên này
2025-05-17 11:18:00,786 - websocket_server - INFO - Phân tích câu hỏi: Phòng ban=None, Loại=general, Thinking=False
2025-05-17 11:18:00,787 - websocket_server - INFO - Query thực tế gửi đến mô hình: test alo alo /no_think
2025-05-17 11:18:00,787 - websocket_server - INFO - Câu hỏi chung, chế độ thinking: False
2025-05-17 11:18:00,787 - websocket_server - INFO - Đã lưu hội thoại chung vào lịch sử của session 16b1f3ea-b548-4dc1-91ef-f517c74092b7
2025-05-17 11:19:18,362 - websockets.server - INFO - connection open
2025-05-17 11:19:19,935 - websockets.server - INFO - connection open
2025-05-17 11:19:22,491 - websocket_server - INFO - Nhận tin nhắn dạng JSON: {"content":"alo /no_think","session_id":""}
2025-05-17 11:19:22,492 - websocket_server - INFO - Session ID không được cung cấp trong tin nhắn JSON, sử dụng current_session_id: 16b1f3ea-b548-4dc1-91ef-f517c74092b7
2025-05-17 11:19:22,492 - websocket_server - INFO - Session ID từ client (sau khi kiểm tra): 16b1f3ea-b548-4dc1-91ef-f517c74092b7
2025-05-17 11:19:22,493 - websocket_server - INFO - Tắt chế độ thinking cho câu hỏi: alo /no_think...
2025-05-17 11:19:22,493 - websocket_server - INFO - Nhận tin nhắn thông thường: alo /no_think, enable_thinking=False
2025-05-17 11:19:22,493 - websocket_server - INFO - Đã thêm 1 tin nhắn gần nhất vào prompt
2025-05-17 11:19:22,495 - websocket_server - INFO - Đã lưu lịch sử tin nhắn và prompt vào file: data/logs/history_prompt_20250517_111922.txt
2025-05-17 11:19:22,496 - websocket_server - INFO - Phân tích câu hỏi: Phòng ban=None, Loại=general, Thinking=False
2025-05-17 11:19:22,496 - websocket_server - INFO - Xử lý streaming response cho: 'alo /no_think', phòng ban: None, session_id: 16b1f3ea-b548-4dc1-91ef-f517c74092b7
2025-05-17 11:19:22,497 - websocket_server - INFO - Session ID nhận được: 16b1f3ea-b548-4dc1-91ef-f517c74092b7
2025-05-17 11:19:22,497 - websocket_server - INFO - Phát hiện lệnh /no_think, tắt chế độ thinking cho: alo
2025-05-17 11:19:22,497 - websocket_server - INFO - Xử lý streaming response. Query: 'alo', Mode thinking: False
2025-05-17 11:19:22,498 - websocket_server - INFO - Đã thêm 1 tin nhắn gần nhất vào prompt
2025-05-17 11:19:22,499 - websocket_server - INFO - Đã lưu lịch sử tin nhắn và prompt vào file: data/logs/history_prompt_20250517_111922.txt
2025-05-17 11:19:22,499 - websocket_server - INFO - Phân tích câu hỏi: Phòng ban=None, Loại=general, Thinking=False
2025-05-17 11:19:22,499 - websocket_server - INFO - Query thực tế gửi đến mô hình: alo /no_think
2025-05-17 11:19:22,500 - websocket_server - INFO - Câu hỏi chung, chế độ thinking: False
2025-05-17 11:19:22,500 - websocket_server - INFO - Đã lưu hội thoại chung vào lịch sử của session 16b1f3ea-b548-4dc1-91ef-f517c74092b7
2025-05-17 11:19:24,785 - websocket_server - WARNING - Session  không tồn tại, sử dụng session hiện tại
2025-05-17 11:19:24,785 - websocket_server - INFO - Nhận yêu cầu phân tích (thinking) cho câu hỏi: Mock response for general query: alo /no_think
2025-05-17 11:19:24,786 - websocket_server - INFO - Đã thêm 2 tin nhắn gần nhất vào prompt
2025-05-17 11:19:24,787 - websocket_server - INFO - Đã lưu lịch sử tin nhắn và prompt vào file: data/logs/history_prompt_20250517_111924.txt
2025-05-17 11:19:24,787 - websocket_server - INFO - Phân tích câu hỏi để xác định phòng ban hoặc loại câu hỏi
2025-05-17 11:19:24,788 - websocket_server - INFO - Lấy phân tích cho câu hỏi chung
2025-05-17 11:19:24,788 - websocket_server - INFO - Gửi phản hồi thinking với request_id: thinking_1747455564784_zgioz0p
2025-05-17 11:19:24,789 - websocket_server - INFO - Đã gửi nội dung thinking (304 ký tự)
2025-05-17 11:21:28,193 - websockets.server - INFO - server closing
2025-05-17 11:21:28,256 - websockets.server - INFO - server closed
2025-05-17 11:21:28,257 - websocket_server - INFO - Server bị dừng bởi người dùng
2025-05-17 11:21:30,523 - websocket_server - INFO - Khởi động server WebSocket tại 0.0.0.0:8090
2025-05-17 11:21:30,558 - websockets.server - INFO - server listening on 0.0.0.0:8090
2025-05-17 11:21:30,558 - websocket_server - INFO - Server WebSocket đang chạy tại ws://0.0.0.0:8090
2025-05-17 11:21:30,558 - websocket_server - INFO - Đã cấu hình ping_timeout=6000 giây, ping_interval=60 giây
2025-05-17 11:23:52,845 - websockets.server - INFO - connection open
2025-05-17 11:23:53,834 - websocket_server - INFO - Nhận tin nhắn dạng JSON: {"content":"alo /no_think","session_id":""}
2025-05-17 11:23:53,834 - websocket_server - INFO - Session ID không được cung cấp trong tin nhắn JSON, sử dụng current_session_id: d16ec270-a709-41a4-bfe8-5f693a828ea5
2025-05-17 11:23:53,834 - websocket_server - INFO - Session ID từ client (sau khi kiểm tra): d16ec270-a709-41a4-bfe8-5f693a828ea5
2025-05-17 11:23:53,835 - websocket_server - INFO - Tắt chế độ thinking cho câu hỏi: alo /no_think...
2025-05-17 11:23:53,835 - websocket_server - INFO - Nhận tin nhắn thông thường: alo /no_think, enable_thinking=False
2025-05-17 11:23:53,835 - websocket_server - INFO - Không có lịch sử tin nhắn cho phiên này
2025-05-17 11:23:53,835 - chatbot_rag - INFO - Đang phân tích câu hỏi với LLM: alo /no_think, session_id: d16ec270-a709-41a4-bfe8-5f693a828ea5
2025-05-17 11:23:53,837 - chatbot_rag - WARNING - [analyze_query_with_llm] Không thể import get_session_history từ websocket_server, sử dụng get_chat_history
2025-05-17 11:23:53,838 - chatbot_rag - INFO - [analyze_query_with_llm] Lấy lịch sử từ get_chat_history: 0 bản ghi
2025-05-17 11:23:53,838 - chatbot_rag - INFO - [analyze_query_with_llm] Sử dụng lịch sử hội thoại: 0 bản ghi
2025-05-17 11:23:53,839 - chatbot_rag - INFO - [analyze_query_with_llm] Prompt cuối cùng: Lịch sử tin nhắn:

Câu hỏi người dùng hiện tại: "alo /no_think"

Phân tích câu hỏi và trả về JSON có định dạng:
{"department": "tên phòng ban hoặc null", "query_type": "department_specific hoặc genera...
2025-05-17 11:23:53,839 - chatbot_rag - INFO - Kích thước prompt: 486 ký tự
2025-05-17 11:23:53,839 - chatbot_rag - INFO - Kích thước system prompt: 4181 ký tự
2025-05-17 11:23:53,839 - chatbot_rag - INFO - Tổng kích thước: 4667 ký tự
2025-05-17 11:23:53,841 - chatbot_rag - INFO - Đã lưu full prompt vào file: data/logs/llm_full_prompt_20250517_112353.txt
2025-05-17 11:23:53,842 - chatbot_rag - INFO - System prompt: 
Bạn là trợ lý AI chuyên phân tích nội dung câu hỏi để xác định:
1. Phòng ban mà người dùng đang hỏi về (department)
2. Phân loại câu hỏi là về phòng ban cụ thể hay câu hỏi chung (query_type)
3. Xác đ...
2025-05-17 11:23:53,842 - chatbot_rag - INFO - User prompt: Lịch sử tin nhắn:

Câu hỏi người dùng hiện tại: "alo /no_think"

Phân tích câu hỏi và trả về JSON có định dạng:
{"department": "tên phòng ban hoặc null", "query_type": "department_specific hoặc genera...
2025-05-17 11:23:53,843 - chatbot_rag - INFO - Gửi truy vấn đến LLM API tại http://localhost:1234/v1/chat/completions với stream=False
2025-05-17 11:24:07,324 - chatbot_rag - INFO - Mã phản hồi từ API: 200
2025-05-17 11:24:07,325 - chatbot_rag - INFO - Phản hồi gốc từ LLM API (200 ký tự đầu): <think>

</think>

{"department": "Kinh doanh", "query_type": "department_specific", "error": false}
2025-05-17 11:24:07,330 - chatbot_rag - INFO - Đã lưu phản hồi đầy đủ vào file: data/logs/llm_response_20250517_112407.txt
2025-05-17 11:24:07,334 - chatbot_rag - INFO - [analysis_20250517_112407] Đã ghi phản hồi gốc vào: data/logs/analysis_20250517_112407_raw.txt
2025-05-17 11:24:07,335 - chatbot_rag - INFO - [analysis_20250517_112407] Phản hồi gốc: <think>

</think>

{"department": "Kinh doanh", "query_type": "department_specific", "error": false}...
2025-05-17 11:24:07,335 - chatbot_rag - WARNING - [analysis_20250517_112407] Phát hiện thẻ <think> trong phản hồi. Xử lý đặc biệt...
2025-05-17 11:24:07,336 - chatbot_rag - INFO - [analysis_20250517_112407] Đã tìm thấy 1 mẫu JSON tiềm năng trong phản hồi
2025-05-17 11:24:07,337 - chatbot_rag - INFO - [analysis_20250517_112407] Tìm thấy JSON hợp lệ trong thẻ <think>: {'department': 'Kinh doanh', 'query_type': 'department_specific', 'error': False}
2025-05-17 11:24:07,337 - websocket_server - INFO - Phân tích câu hỏi: Phòng ban=Kinh doanh, Loại=department_specific, Thinking=False
2025-05-17 11:24:07,338 - websocket_server - INFO - Xử lý streaming response cho: 'alo /no_think', phòng ban: Kinh doanh, session_id: d16ec270-a709-41a4-bfe8-5f693a828ea5
2025-05-17 11:24:07,338 - websocket_server - INFO - Session ID nhận được: d16ec270-a709-41a4-bfe8-5f693a828ea5
2025-05-17 11:24:07,339 - websocket_server - INFO - Phát hiện lệnh /no_think, tắt chế độ thinking cho: alo
2025-05-17 11:24:07,339 - websocket_server - INFO - Xử lý streaming response. Query: 'alo', Mode thinking: False
2025-05-17 11:24:07,341 - websocket_server - INFO - Không có lịch sử tin nhắn cho phiên này
2025-05-17 11:24:07,341 - websocket_server - INFO - Phân tích câu hỏi: Phòng ban=Kinh doanh, Loại=department_specific, Thinking=False
2025-05-17 11:24:07,342 - websocket_server - INFO - Query thực tế gửi đến mô hình: alo /no_think
2025-05-17 11:24:07,342 - websocket_server - INFO - Câu hỏi về phòng ban cụ thể: Kinh doanh, chế độ thinking: False
2025-05-17 11:24:07,342 - chatbot_rag - INFO - Truy vấn Smart RAG - Giai đoạn: None, Phòng ban: Kinh doanh, Session: d16ec270-a709-41a4-bfe8-5f693a828ea5
2025-05-17 11:24:07,356 - department_info_tool - INFO - Đã tải 11 phòng ban
2025-05-17 11:24:07,357 - department_info_tool - INFO - Đang trích xuất thông tin cho phòng ban: Kinh doanh
2025-05-17 11:24:07,358 - department_info_tool - INFO - Đã đọc thành công file C:\Users\thuon\OneDrive\Desktop\test\chatbot_qwen\docker_build\data\departments\kinh_doanh.txt, kích thước: 16485 bytes
2025-05-17 11:24:07,379 - department_info_tool - INFO - Đã tìm thấy 5 giai đoạn và 24 công việc cho phòng ban Kinh doanh
2025-05-17 11:24:07,379 - chatbot_rag - INFO - Tạo prompt LLM cho phòng ban: Kinh doanh, session_id: d16ec270-a709-41a4-bfe8-5f693a828ea5
2025-05-17 11:24:07,380 - chatbot_rag - INFO - Số task: 24
2025-05-17 11:24:07,380 - chatbot_rag - INFO - Lấy lịch sử hội thoại từ phiên d16ec270-a709-41a4-bfe8-5f693a828ea5
2025-05-17 11:24:07,381 - chatbot_rag - WARNING - [create_llm_prompt] Không thể import get_session_history từ websocket_server. Thử get_chat_history (cục bộ).
2025-05-17 11:24:07,381 - chatbot_rag - INFO - [create_llm_prompt] Đã lấy được 0 bản ghi lịch sử từ get_chat_history (cục bộ).
2025-05-17 11:24:07,384 - chatbot_rag - INFO - Gọi LLM:  tại 
2025-05-17 11:24:07,386 - chatbot_rag - INFO - Đã lưu prompt vào file: data/logs/prompt_20250517_112407.txt
2025-05-17 11:24:07,387 - chatbot_rag - INFO - Kích thước prompt: 12219 ký tự
2025-05-17 11:24:07,387 - chatbot_rag - INFO - Kích thước system prompt: 2631 ký tự
2025-05-17 11:24:07,387 - chatbot_rag - INFO - Tổng kích thước: 14850 ký tự
2025-05-17 11:24:07,389 - chatbot_rag - INFO - Đã lưu full prompt vào file: data/logs/llm_full_prompt_20250517_112407.txt
2025-05-17 11:24:07,389 - chatbot_rag - INFO - System prompt: 
Bạn là trợ lý AI chuyên về công việc của các phòng ban trong công ty. 
Nhiệm vụ của bạn là phân tích thông tin về các task trong phòng ban và cung cấp thông tin hữu ích cho người dùng.

Dự án được ch...
2025-05-17 11:24:07,390 - chatbot_rag - INFO - User prompt: 
Vai trò của bạn: Trợ lý thông minh cung cấp thông tin về phòng ban và công việc trong công ty.


Câu hỏi người dùng hiện tại: "alo /no_think"

Thông tin về phòng ban Kinh doanh:
Số lượng tasks: 24
Cá...
2025-05-17 11:24:07,390 - chatbot_rag - INFO - Gửi truy vấn đến LLM API tại http://localhost:1234/v1/chat/completions với stream=True
2025-05-17 11:24:51,101 - chatbot_rag - INFO - Mã phản hồi từ API: 200
2025-05-17 11:24:51,102 - chatbot_rag - INFO - Phản hồi gốc từ LLM API (200 ký tự đầu): <think>

</think>

**Alo!** 😄  
Bạn đang cần thông tin gì về phòng ban **Kinh doanh**? Mình sẵn sàng hỗ trợ bạn ngay lập tức nhé! Nếu bạn muốn biết chi tiết về các task, giai đoạn hoặc quy trình liên 
2025-05-17 11:24:51,104 - chatbot_rag - INFO - Đã lưu phản hồi đầy đủ vào file: data/logs/llm_response_20250517_112451.txt
2025-05-17 11:24:51,106 - chatbot_rag - INFO - Đã lưu response vào file: data/logs/response_20250517_112407.txt
2025-05-17 11:24:51,106 - chatbot_rag - INFO - Thời gian truy vấn LLM: 43.75 giây
2025-05-17 11:24:51,700 - department_info_tool - INFO - Đang trích xuất thông tin cho phòng ban: Kinh doanh
2025-05-17 11:24:51,701 - department_info_tool - INFO - Đã đọc thành công file C:\Users\thuon\OneDrive\Desktop\test\chatbot_qwen\docker_build\data\departments\kinh_doanh.txt, kích thước: 16485 bytes
2025-05-17 11:24:51,703 - department_info_tool - INFO - Đã tìm thấy 5 giai đoạn và 24 công việc cho phòng ban Kinh doanh
2025-05-17 11:24:55,500 - websocket_server - INFO - Đã trích xuất thinking (0 ký tự) và còn lại 218 ký tự phản hồi
2025-05-17 11:24:55,501 - websocket_server - INFO - Đã trích xuất phần thinking (0 ký tự) từ phản hồi
2025-05-17 11:24:55,501 - websocket_server - INFO - Đã lưu hội thoại phòng ban Kinh doanh vào lịch sử của session d16ec270-a709-41a4-bfe8-5f693a828ea5
2025-05-17 11:25:55,751 - websockets.server - INFO - connection open
2025-05-17 11:29:12,047 - websockets.server - INFO - connection open
2025-05-17 11:43:10,391 - websockets.server - INFO - connection open
2025-05-17 11:43:25,110 - websocket_server - INFO - Nhận tin nhắn dạng JSON: {"content":"alo /no_think","session_id":"cf6e5d85-f403-4c4d-8afc-06ff092bdf8c"}
2025-05-17 11:43:25,110 - websocket_server - INFO - Session ID từ client (sau khi kiểm tra): cf6e5d85-f403-4c4d-8afc-06ff092bdf8c
2025-05-17 11:43:25,111 - websocket_server - INFO - Tắt chế độ thinking cho câu hỏi: alo /no_think...
2025-05-17 11:43:25,112 - websocket_server - INFO - Nhận tin nhắn thông thường: alo /no_think, enable_thinking=False
2025-05-17 11:43:25,112 - websocket_server - INFO - Không có lịch sử tin nhắn cho phiên này
2025-05-17 11:43:25,113 - chatbot_rag - INFO - Đang phân tích câu hỏi với LLM: alo /no_think, session_id: cf6e5d85-f403-4c4d-8afc-06ff092bdf8c
2025-05-17 11:43:25,117 - chatbot_rag - WARNING - [analyze_query_with_llm] Không thể import get_session_history từ websocket_server, sử dụng get_chat_history
2025-05-17 11:43:25,121 - chatbot_rag - INFO - [analyze_query_with_llm] Lấy lịch sử từ get_chat_history: 0 bản ghi
2025-05-17 11:43:25,121 - chatbot_rag - INFO - [analyze_query_with_llm] Sử dụng lịch sử hội thoại: 0 bản ghi
2025-05-17 11:43:25,122 - chatbot_rag - INFO - [analyze_query_with_llm] Prompt cuối cùng: Lịch sử tin nhắn:

Câu hỏi người dùng hiện tại: "alo /no_think"

Phân tích câu hỏi và trả về JSON có định dạng:
{"department": "tên phòng ban hoặc null", "query_type": "department_specific hoặc genera...
2025-05-17 11:43:25,123 - chatbot_rag - INFO - Kích thước prompt: 486 ký tự
2025-05-17 11:43:25,124 - chatbot_rag - INFO - Kích thước system prompt: 4181 ký tự
2025-05-17 11:43:25,124 - chatbot_rag - INFO - Tổng kích thước: 4667 ký tự
2025-05-17 11:43:25,129 - chatbot_rag - INFO - Đã lưu full prompt vào file: data/logs/llm_full_prompt_20250517_114325.txt
2025-05-17 11:43:25,130 - chatbot_rag - INFO - System prompt: 
Bạn là trợ lý AI chuyên phân tích nội dung câu hỏi để xác định:
1. Phòng ban mà người dùng đang hỏi về (department)
2. Phân loại câu hỏi là về phòng ban cụ thể hay câu hỏi chung (query_type)
3. Xác đ...
2025-05-17 11:43:25,130 - chatbot_rag - INFO - User prompt: Lịch sử tin nhắn:

Câu hỏi người dùng hiện tại: "alo /no_think"

Phân tích câu hỏi và trả về JSON có định dạng:
{"department": "tên phòng ban hoặc null", "query_type": "department_specific hoặc genera...
2025-05-17 11:43:25,131 - chatbot_rag - INFO - Gửi truy vấn đến LLM API tại http://localhost:1234/v1/chat/completions với stream=False
2025-05-17 11:43:38,245 - chatbot_rag - INFO - Mã phản hồi từ API: 200
2025-05-17 11:43:38,246 - chatbot_rag - INFO - Phản hồi gốc từ LLM API (200 ký tự đầu): <think>

</think>

{"department": "Kinh doanh", "query_type": "department_specific", "error": false}
2025-05-17 11:43:38,247 - chatbot_rag - INFO - Đã lưu phản hồi đầy đủ vào file: data/logs/llm_response_20250517_114338.txt
2025-05-17 11:43:38,249 - chatbot_rag - INFO - [analysis_20250517_114338] Đã ghi phản hồi gốc vào: data/logs/analysis_20250517_114338_raw.txt
2025-05-17 11:43:38,249 - chatbot_rag - INFO - [analysis_20250517_114338] Phản hồi gốc: <think>

</think>

{"department": "Kinh doanh", "query_type": "department_specific", "error": false}...
2025-05-17 11:43:38,250 - chatbot_rag - WARNING - [analysis_20250517_114338] Phát hiện thẻ <think> trong phản hồi. Xử lý đặc biệt...
2025-05-17 11:43:38,250 - chatbot_rag - INFO - [analysis_20250517_114338] Đã tìm thấy 1 mẫu JSON tiềm năng trong phản hồi
2025-05-17 11:43:38,251 - chatbot_rag - INFO - [analysis_20250517_114338] Tìm thấy JSON hợp lệ trong thẻ <think>: {'department': 'Kinh doanh', 'query_type': 'department_specific', 'error': False}
2025-05-17 11:43:38,251 - websocket_server - INFO - Phân tích câu hỏi: Phòng ban=Kinh doanh, Loại=department_specific, Thinking=False
2025-05-17 11:43:38,252 - websocket_server - INFO - Xử lý streaming response cho: 'alo /no_think', phòng ban: Kinh doanh, session_id: cf6e5d85-f403-4c4d-8afc-06ff092bdf8c
2025-05-17 11:43:38,252 - websocket_server - INFO - Session ID nhận được: cf6e5d85-f403-4c4d-8afc-06ff092bdf8c
2025-05-17 11:43:38,252 - websocket_server - INFO - Phát hiện lệnh /no_think, tắt chế độ thinking cho: alo
2025-05-17 11:43:38,253 - websocket_server - INFO - Xử lý streaming response. Query: 'alo', Mode thinking: False
2025-05-17 11:43:38,253 - websocket_server - INFO - Không có lịch sử tin nhắn cho phiên này
2025-05-17 11:43:38,253 - websocket_server - INFO - Phân tích câu hỏi: Phòng ban=Kinh doanh, Loại=department_specific, Thinking=False
2025-05-17 11:43:38,254 - websocket_server - INFO - Query thực tế gửi đến mô hình: alo /no_think
2025-05-17 11:43:38,254 - websocket_server - INFO - Câu hỏi về phòng ban cụ thể: Kinh doanh, chế độ thinking: False
2025-05-17 11:43:38,254 - chatbot_rag - INFO - Truy vấn Smart RAG - Giai đoạn: None, Phòng ban: Kinh doanh, Session: cf6e5d85-f403-4c4d-8afc-06ff092bdf8c
2025-05-17 11:43:38,264 - department_info_tool - INFO - Đã tải 11 phòng ban
2025-05-17 11:43:38,266 - department_info_tool - INFO - Đang trích xuất thông tin cho phòng ban: Kinh doanh
2025-05-17 11:43:38,267 - department_info_tool - INFO - Đã đọc thành công file C:\Users\thuon\OneDrive\Desktop\test\chatbot_qwen\docker_build\data\departments\kinh_doanh.txt, kích thước: 16485 bytes
2025-05-17 11:43:38,272 - department_info_tool - INFO - Đã tìm thấy 5 giai đoạn và 24 công việc cho phòng ban Kinh doanh
2025-05-17 11:43:38,273 - chatbot_rag - INFO - Tạo prompt LLM cho phòng ban: Kinh doanh, session_id: cf6e5d85-f403-4c4d-8afc-06ff092bdf8c
2025-05-17 11:43:38,274 - chatbot_rag - INFO - Số task: 24
2025-05-17 11:43:38,274 - chatbot_rag - INFO - Lấy lịch sử hội thoại từ phiên cf6e5d85-f403-4c4d-8afc-06ff092bdf8c
2025-05-17 11:43:38,275 - chatbot_rag - WARNING - [create_llm_prompt] Không thể import get_session_history từ websocket_server. Thử get_chat_history (cục bộ).
2025-05-17 11:43:38,276 - chatbot_rag - INFO - [create_llm_prompt] Đã lấy được 0 bản ghi lịch sử từ get_chat_history (cục bộ).
2025-05-17 11:43:38,280 - chatbot_rag - INFO - Gọi LLM:  tại 
2025-05-17 11:43:38,283 - chatbot_rag - INFO - Đã lưu prompt vào file: data/logs/prompt_20250517_114338.txt
2025-05-17 11:43:38,283 - chatbot_rag - INFO - Kích thước prompt: 12219 ký tự
2025-05-17 11:43:38,284 - chatbot_rag - INFO - Kích thước system prompt: 2631 ký tự
2025-05-17 11:43:38,284 - chatbot_rag - INFO - Tổng kích thước: 14850 ký tự
2025-05-17 11:43:38,287 - chatbot_rag - INFO - Đã lưu full prompt vào file: data/logs/llm_full_prompt_20250517_114338.txt
2025-05-17 11:43:38,287 - chatbot_rag - INFO - System prompt: 
Bạn là trợ lý AI chuyên về công việc của các phòng ban trong công ty. 
Nhiệm vụ của bạn là phân tích thông tin về các task trong phòng ban và cung cấp thông tin hữu ích cho người dùng.

Dự án được ch...
2025-05-17 11:43:38,287 - chatbot_rag - INFO - User prompt: 
Vai trò của bạn: Trợ lý thông minh cung cấp thông tin về phòng ban và công việc trong công ty.


Câu hỏi người dùng hiện tại: "alo /no_think"

Thông tin về phòng ban Kinh doanh:
Số lượng tasks: 24
Cá...
2025-05-17 11:43:38,288 - chatbot_rag - INFO - Gửi truy vấn đến LLM API tại http://localhost:1234/v1/chat/completions với stream=True
2025-05-17 11:44:21,342 - chatbot_rag - INFO - Mã phản hồi từ API: 200
2025-05-17 11:44:21,344 - chatbot_rag - INFO - Phản hồi gốc từ LLM API (200 ký tự đầu): <think>

</think>

**Alo!** 🎉  
Tôi đây, bạn muốn biết gì về phòng ban **Kinh doanh** và các giai đoạn liên quan? Dù là task, mục tiêu hay quy trình, mình sẽ giải thích rõ ràng cho bạn nhé! 💼✨
2025-05-17 11:44:21,346 - chatbot_rag - INFO - Đã lưu phản hồi đầy đủ vào file: data/logs/llm_response_20250517_114421.txt
2025-05-17 11:44:21,348 - chatbot_rag - INFO - Đã lưu response vào file: data/logs/response_20250517_114338.txt
2025-05-17 11:44:21,349 - chatbot_rag - INFO - Thời gian truy vấn LLM: 43.08 giây
2025-05-17 11:44:21,358 - department_info_tool - INFO - Đang trích xuất thông tin cho phòng ban: Kinh doanh
2025-05-17 11:44:21,359 - department_info_tool - INFO - Đã đọc thành công file C:\Users\thuon\OneDrive\Desktop\test\chatbot_qwen\docker_build\data\departments\kinh_doanh.txt, kích thước: 16485 bytes
2025-05-17 11:44:21,363 - department_info_tool - INFO - Đã tìm thấy 5 giai đoạn và 24 công việc cho phòng ban Kinh doanh
2025-05-17 11:44:21,371 - websocket_server - INFO - Đã trích xuất thinking (0 ký tự) và còn lại 173 ký tự phản hồi
2025-05-17 11:44:21,372 - websocket_server - INFO - Đã trích xuất phần thinking (0 ký tự) từ phản hồi
2025-05-17 11:44:21,372 - websocket_server - INFO - Đã lưu hội thoại phòng ban Kinh doanh vào lịch sử của session cf6e5d85-f403-4c4d-8afc-06ff092bdf8c
2025-05-17 11:45:53,285 - websockets.server - INFO - connection open
2025-05-17 11:46:04,838 - websocket_server - INFO - Nhận tin nhắn dạng JSON: {"content":"alo /think","session_id":"284b52f9-dae0-4001-98fc-1e425fa03bf9"}
2025-05-17 11:46:04,839 - websocket_server - INFO - Session ID từ client (sau khi kiểm tra): 284b52f9-dae0-4001-98fc-1e425fa03bf9
2025-05-17 11:46:04,839 - websocket_server - INFO - Bật chế độ thinking cho câu hỏi: alo /think...
2025-05-17 11:46:04,839 - websocket_server - INFO - Nhận tin nhắn thông thường: alo /think, enable_thinking=True
2025-05-17 11:46:04,840 - websocket_server - INFO - Không có lịch sử tin nhắn cho phiên này
2025-05-17 11:46:04,840 - chatbot_rag - INFO - Đang phân tích câu hỏi với LLM: alo /think, session_id: 284b52f9-dae0-4001-98fc-1e425fa03bf9
2025-05-17 11:46:04,842 - chatbot_rag - WARNING - [analyze_query_with_llm] Không thể import get_session_history từ websocket_server, sử dụng get_chat_history
2025-05-17 11:46:04,843 - chatbot_rag - INFO - [analyze_query_with_llm] Lấy lịch sử từ get_chat_history: 0 bản ghi
2025-05-17 11:46:04,843 - chatbot_rag - INFO - [analyze_query_with_llm] Sử dụng lịch sử hội thoại: 0 bản ghi
2025-05-17 11:46:04,843 - chatbot_rag - INFO - [analyze_query_with_llm] Prompt cuối cùng: Lịch sử tin nhắn:

Câu hỏi người dùng hiện tại: "alo /think"

Phân tích câu hỏi và trả về JSON có định dạng:
{"department": "tên phòng ban hoặc null", "query_type": "department_specific hoặc general h...
2025-05-17 11:46:04,844 - chatbot_rag - INFO - Kích thước prompt: 483 ký tự
2025-05-17 11:46:04,849 - chatbot_rag - INFO - Kích thước system prompt: 4181 ký tự
2025-05-17 11:46:04,855 - chatbot_rag - INFO - Tổng kích thước: 4664 ký tự
2025-05-17 11:46:04,872 - chatbot_rag - INFO - Đã lưu full prompt vào file: data/logs/llm_full_prompt_20250517_114604.txt
2025-05-17 11:46:04,879 - chatbot_rag - INFO - System prompt: 
Bạn là trợ lý AI chuyên phân tích nội dung câu hỏi để xác định:
1. Phòng ban mà người dùng đang hỏi về (department)
2. Phân loại câu hỏi là về phòng ban cụ thể hay câu hỏi chung (query_type)
3. Xác đ...
2025-05-17 11:46:04,886 - chatbot_rag - INFO - User prompt: Lịch sử tin nhắn:

Câu hỏi người dùng hiện tại: "alo /think"

Phân tích câu hỏi và trả về JSON có định dạng:
{"department": "tên phòng ban hoặc null", "query_type": "department_specific hoặc general h...
2025-05-17 11:46:04,892 - chatbot_rag - INFO - Gửi truy vấn đến LLM API tại http://localhost:1234/v1/chat/completions với stream=False
2025-05-17 11:46:23,452 - chatbot_rag - INFO - Mã phản hồi từ API: 200
2025-05-17 11:46:23,453 - chatbot_rag - INFO - Phản hồi gốc từ LLM API (200 ký tự đầu): <think>
Okay, let's tackle this query. The user's current message is "alo". First, I need to check the history to see if there was a previous department mentioned. Since the history is empty, there's 
2025-05-17 11:46:23,455 - chatbot_rag - INFO - Đã lưu phản hồi đầy đủ vào file: data/logs/llm_response_20250517_114623.txt
2025-05-17 11:46:23,458 - chatbot_rag - INFO - [analysis_20250517_114623] Đã ghi phản hồi gốc vào: data/logs/analysis_20250517_114623_raw.txt
2025-05-17 11:46:23,458 - chatbot_rag - INFO - [analysis_20250517_114623] Phản hồi gốc: <think>
Okay, let's tackle this query. The user's current message is "alo". First, I need to check t...
2025-05-17 11:46:23,459 - chatbot_rag - WARNING - [analysis_20250517_114623] Phát hiện thẻ <think> trong phản hồi. Xử lý đặc biệt...
2025-05-17 11:46:23,459 - chatbot_rag - INFO - [analysis_20250517_114623] BƯỚC 1: Thử parse toàn bộ chuỗi phản hồi
2025-05-17 11:46:23,461 - chatbot_rag - INFO - [analysis_20250517_114623] BƯỚC 1: Không phải JSON hợp lệ: Expecting value: line 1 column 1 (char 0)
2025-05-17 11:46:23,461 - chatbot_rag - INFO - [analysis_20250517_114623] BƯỚC 2: Tìm JSON trong chuỗi phản hồi
2025-05-17 11:46:23,462 - chatbot_rag - WARNING - [analysis_20250517_114623] BƯỚC 2: Không tìm thấy mẫu JSON nào trong phản hồi
2025-05-17 11:46:23,463 - chatbot_rag - INFO - [analysis_20250517_114623] BƯỚC 3: Xử lý chuỗi thủ công để trích xuất thông tin
2025-05-17 11:46:23,480 - department_info_tool - INFO - Đã tải 11 phòng ban
2025-05-17 11:46:23,482 - department_info_tool - INFO - Đã lấy danh sách 11 phòng ban
2025-05-17 11:46:23,488 - chatbot_rag - INFO - [analysis_20250517_114623] BƯỚC 3: Kết quả phân tích thủ công: {'department': None, 'query_type': 'general', 'error': False}
2025-05-17 11:46:23,489 - websocket_server - INFO - Phân tích câu hỏi: Phòng ban=None, Loại=general, Thinking=True
2025-05-17 11:46:23,489 - websocket_server - INFO - Xử lý streaming response cho: 'alo /think', phòng ban: None, session_id: 284b52f9-dae0-4001-98fc-1e425fa03bf9
2025-05-17 11:46:23,490 - websocket_server - INFO - Session ID nhận được: 284b52f9-dae0-4001-98fc-1e425fa03bf9
2025-05-17 11:46:23,492 - websocket_server - INFO - Phát hiện lệnh /think, bật chế độ thinking cho: alo
2025-05-17 11:46:23,493 - websocket_server - INFO - Xử lý streaming response. Query: 'alo', Mode thinking: True
2025-05-17 11:46:23,493 - websocket_server - INFO - Không có lịch sử tin nhắn cho phiên này
2025-05-17 11:46:23,493 - chatbot_rag - INFO - Đang phân tích câu hỏi với LLM: alo, session_id: 284b52f9-dae0-4001-98fc-1e425fa03bf9
2025-05-17 11:46:23,494 - chatbot_rag - WARNING - [analyze_query_with_llm] Không thể import get_session_history từ websocket_server, sử dụng get_chat_history
2025-05-17 11:46:23,496 - chatbot_rag - INFO - [analyze_query_with_llm] Lấy lịch sử từ get_chat_history: 0 bản ghi
2025-05-17 11:46:23,496 - chatbot_rag - INFO - [analyze_query_with_llm] Sử dụng lịch sử hội thoại: 0 bản ghi
2025-05-17 11:46:23,496 - chatbot_rag - INFO - [analyze_query_with_llm] Prompt cuối cùng: Lịch sử tin nhắn:

Câu hỏi người dùng hiện tại: "alo"

Phân tích câu hỏi và trả về JSON có định dạng:
{"department": "tên phòng ban hoặc null", "query_type": "department_specific hoặc general hoặc nul...
2025-05-17 11:46:23,497 - chatbot_rag - INFO - Kích thước prompt: 476 ký tự
2025-05-17 11:46:23,498 - chatbot_rag - INFO - Kích thước system prompt: 4181 ký tự
2025-05-17 11:46:23,499 - chatbot_rag - INFO - Tổng kích thước: 4657 ký tự
2025-05-17 11:46:23,502 - chatbot_rag - INFO - Đã lưu full prompt vào file: data/logs/llm_full_prompt_20250517_114623.txt
2025-05-17 11:46:23,503 - chatbot_rag - INFO - System prompt: 
Bạn là trợ lý AI chuyên phân tích nội dung câu hỏi để xác định:
1. Phòng ban mà người dùng đang hỏi về (department)
2. Phân loại câu hỏi là về phòng ban cụ thể hay câu hỏi chung (query_type)
3. Xác đ...
2025-05-17 11:46:23,504 - chatbot_rag - INFO - User prompt: Lịch sử tin nhắn:

Câu hỏi người dùng hiện tại: "alo"

Phân tích câu hỏi và trả về JSON có định dạng:
{"department": "tên phòng ban hoặc null", "query_type": "department_specific hoặc general hoặc nul...
2025-05-17 11:46:23,505 - chatbot_rag - INFO - Gửi truy vấn đến LLM API tại http://localhost:1234/v1/chat/completions với stream=False
2025-05-17 11:46:33,627 - chatbot_rag - INFO - Mã phản hồi từ API: 200
2025-05-17 11:46:33,628 - chatbot_rag - INFO - Phản hồi gốc từ LLM API (200 ký tự đầu): <think>
Okay, let's tackle this query. The user's current message is "alo", which is a casual way of saying "hello" in Vietnamese. The history doesn't mention any previous department or context.

Firs
2025-05-17 11:46:33,630 - chatbot_rag - INFO - Đã lưu phản hồi đầy đủ vào file: data/logs/llm_response_20250517_114633.txt
2025-05-17 11:46:33,632 - chatbot_rag - INFO - [analysis_20250517_114633] Đã ghi phản hồi gốc vào: data/logs/analysis_20250517_114633_raw.txt
2025-05-17 11:46:33,632 - chatbot_rag - INFO - [analysis_20250517_114633] Phản hồi gốc: <think>
Okay, let's tackle this query. The user's current message is "alo", which is a casual way of...
2025-05-17 11:46:33,633 - chatbot_rag - WARNING - [analysis_20250517_114633] Phát hiện thẻ <think> trong phản hồi. Xử lý đặc biệt...
2025-05-17 11:46:33,633 - chatbot_rag - INFO - [analysis_20250517_114633] BƯỚC 1: Thử parse toàn bộ chuỗi phản hồi
2025-05-17 11:46:33,633 - chatbot_rag - INFO - [analysis_20250517_114633] BƯỚC 1: Không phải JSON hợp lệ: Expecting value: line 1 column 1 (char 0)
2025-05-17 11:46:33,634 - chatbot_rag - INFO - [analysis_20250517_114633] BƯỚC 2: Tìm JSON trong chuỗi phản hồi
2025-05-17 11:46:33,634 - chatbot_rag - WARNING - [analysis_20250517_114633] BƯỚC 2: Không tìm thấy mẫu JSON nào trong phản hồi
2025-05-17 11:46:33,636 - chatbot_rag - INFO - [analysis_20250517_114633] BƯỚC 3: Xử lý chuỗi thủ công để trích xuất thông tin
2025-05-17 11:46:33,645 - department_info_tool - INFO - Đã tải 11 phòng ban
2025-05-17 11:46:33,645 - department_info_tool - INFO - Đã lấy danh sách 11 phòng ban
2025-05-17 11:46:33,647 - chatbot_rag - INFO - [analysis_20250517_114633] BƯỚC 3: Kết quả phân tích thủ công: {'department': None, 'query_type': 'general', 'error': False}
2025-05-17 11:46:33,648 - websocket_server - INFO - Phân tích câu hỏi: Phòng ban=None, Loại=general, Thinking=True
2025-05-17 11:46:33,649 - websocket_server - INFO - Query thực tế gửi đến mô hình: alo /think
2025-05-17 11:46:33,649 - websocket_server - INFO - Câu hỏi chung, chế độ thinking: True
2025-05-17 11:46:33,651 - chatbot_rag - INFO - Xử lý câu hỏi chung cho session_id: 284b52f9-dae0-4001-98fc-1e425fa03bf9
2025-05-17 11:46:33,657 - department_info_tool - INFO - Đã tải 11 phòng ban
2025-05-17 11:46:33,658 - department_info_tool - INFO - Đã lấy danh sách 11 phòng ban
2025-05-17 11:46:33,660 - chatbot_rag - INFO - Gọi LLM để trả lời câu hỏi chung cho session_id: 284b52f9-dae0-4001-98fc-1e425fa03bf9
2025-05-17 11:46:33,661 - chatbot_rag - INFO - Đã lưu prompt vào file: data/logs/prompt_general_20250517_114633.txt
2025-05-17 11:46:33,663 - chatbot_rag - INFO - Kích thước prompt: 1622 ký tự
2025-05-17 11:46:33,663 - chatbot_rag - INFO - Kích thước system prompt: 1059 ký tự
2025-05-17 11:46:33,664 - chatbot_rag - INFO - Tổng kích thước: 2681 ký tự
2025-05-17 11:46:33,665 - chatbot_rag - INFO - Đã lưu full prompt vào file: data/logs/llm_full_prompt_20250517_114633.txt
2025-05-17 11:46:33,665 - chatbot_rag - INFO - System prompt: 
Bạn là trợ lý AI chuyên về quy trình và giai đoạn trong công ty.

CÁC PHÒNG BAN THAM GIA THEO GIAI ĐOẠN:
- MKT-SALES: Marketing, Kinh doanh
- PROPOSAL: Kinh doanh, Dự toán, Thiết kế, Team dự án
- CON...
2025-05-17 11:46:33,666 - chatbot_rag - INFO - User prompt: 
Câu hỏi: "alo /think"

Đây là câu hỏi chung về quy trình hoặc giai đoạn làm việc.

Thông tin cơ bản:
### Thông tin tổng quan về quy trình và giai đoạn

#### Giai đoạn chính trong quy trình:
1. **MKT-...
2025-05-17 11:46:33,667 - chatbot_rag - INFO - Gửi truy vấn đến LLM API tại http://localhost:1234/v1/chat/completions với stream=True
2025-05-17 11:46:57,002 - chatbot_rag - INFO - Mã phản hồi từ API: 200
2025-05-17 11:46:57,003 - chatbot_rag - INFO - Phản hồi gốc từ LLM API (200 ký tự đầu): <think>
Okay, the user asked "alo /think" which is a casual way of saying "hello" or "what's up?" in Vietnamese. They mentioned it's a general question about the process or stages. I need to respond b
2025-05-17 11:46:57,005 - chatbot_rag - INFO - Đã lưu phản hồi đầy đủ vào file: data/logs/llm_response_20250517_114657.txt
2025-05-17 11:46:57,010 - websocket_server - INFO - Đã trích xuất thinking (1472 ký tự) và còn lại 465 ký tự phản hồi
2025-05-17 11:46:57,011 - websocket_server - INFO - Đã trích xuất phần thinking (1472 ký tự) từ phản hồi
2025-05-17 11:46:57,012 - websocket_server - INFO - Đã lưu hội thoại chung vào lịch sử của session 284b52f9-dae0-4001-98fc-1e425fa03bf9
2025-05-17 11:48:34,120 - websocket_server - INFO - Nhận tin nhắn dạng JSON: {"content":"mày là ai /think","session_id":"284b52f9-dae0-4001-98fc-1e425fa03bf9"}
2025-05-17 11:48:34,121 - websocket_server - INFO - Session ID từ client (sau khi kiểm tra): 284b52f9-dae0-4001-98fc-1e425fa03bf9
2025-05-17 11:48:34,121 - websocket_server - INFO - Bật chế độ thinking cho câu hỏi: mày là ai /think...
2025-05-17 11:48:34,121 - websocket_server - INFO - Nhận tin nhắn thông thường: mày là ai /think, enable_thinking=True
2025-05-17 11:48:34,122 - websocket_server - INFO - Đã thêm 1 tin nhắn gần nhất vào prompt
2025-05-17 11:48:34,124 - websocket_server - INFO - Đã lưu lịch sử tin nhắn và prompt vào file: data/logs/history_prompt_20250517_114834.txt
2025-05-17 11:48:34,125 - chatbot_rag - INFO - Đang phân tích câu hỏi với LLM: Lịch sử tin nhắn:
Người dùng: alo

mày là ai /think, session_id: 284b52f9-dae0-4001-98fc-1e425fa03bf9
2025-05-17 11:48:34,126 - chatbot_rag - WARNING - [analyze_query_with_llm] Không thể import get_session_history từ websocket_server, sử dụng get_chat_history
2025-05-17 11:48:34,127 - chatbot_rag - INFO - [analyze_query_with_llm] Lấy lịch sử từ get_chat_history: 0 bản ghi
2025-05-17 11:48:34,127 - chatbot_rag - INFO - [analyze_query_with_llm] Sử dụng lịch sử hội thoại: 0 bản ghi
2025-05-17 11:48:34,127 - chatbot_rag - INFO - [analyze_query_with_llm] Prompt cuối cùng: Lịch sử tin nhắn:

Câu hỏi người dùng hiện tại: "Lịch sử tin nhắn:
Người dùng: alo

mày là ai /think"

Phân tích câu hỏi và trả về JSON có định dạng:
{"department": "tên phòng ban hoặc null", "query_t...
2025-05-17 11:48:34,128 - chatbot_rag - INFO - Kích thước prompt: 524 ký tự
2025-05-17 11:48:34,128 - chatbot_rag - INFO - Kích thước system prompt: 4181 ký tự
2025-05-17 11:48:34,129 - chatbot_rag - INFO - Tổng kích thước: 4705 ký tự
2025-05-17 11:48:34,131 - chatbot_rag - INFO - Đã lưu full prompt vào file: data/logs/llm_full_prompt_20250517_114834.txt
2025-05-17 11:48:34,132 - chatbot_rag - INFO - System prompt: 
Bạn là trợ lý AI chuyên phân tích nội dung câu hỏi để xác định:
1. Phòng ban mà người dùng đang hỏi về (department)
2. Phân loại câu hỏi là về phòng ban cụ thể hay câu hỏi chung (query_type)
3. Xác đ...
2025-05-17 11:48:34,132 - chatbot_rag - INFO - User prompt: Lịch sử tin nhắn:

Câu hỏi người dùng hiện tại: "Lịch sử tin nhắn:
Người dùng: alo

mày là ai /think"

Phân tích câu hỏi và trả về JSON có định dạng:
{"department": "tên phòng ban hoặc null", "query_t...
2025-05-17 11:48:34,134 - chatbot_rag - INFO - Gửi truy vấn đến LLM API tại http://localhost:1234/v1/chat/completions với stream=False
2025-05-17 11:48:52,863 - chatbot_rag - INFO - Mã phản hồi từ API: 200
2025-05-17 11:48:52,866 - chatbot_rag - INFO - Phản hồi gốc từ LLM API (200 ký tự đầu): <think>
Okay, let's tackle this query. The user's current question is "Lịch sử tin nhắn: Người dùng: alo mày là ai /think". First, I need to parse the input correctly.

The user is asking about their 
2025-05-17 11:48:52,870 - chatbot_rag - INFO - Đã lưu phản hồi đầy đủ vào file: data/logs/llm_response_20250517_114852.txt
2025-05-17 11:48:52,872 - chatbot_rag - INFO - [analysis_20250517_114852] Đã ghi phản hồi gốc vào: data/logs/analysis_20250517_114852_raw.txt
2025-05-17 11:48:52,873 - chatbot_rag - INFO - [analysis_20250517_114852] Phản hồi gốc: <think>
Okay, let's tackle this query. The user's current question is "Lịch sử tin nhắn: Người dùng:...
2025-05-17 11:48:52,873 - chatbot_rag - WARNING - [analysis_20250517_114852] Phát hiện thẻ <think> trong phản hồi. Xử lý đặc biệt...
2025-05-17 11:48:52,873 - chatbot_rag - INFO - [analysis_20250517_114852] BƯỚC 1: Thử parse toàn bộ chuỗi phản hồi
2025-05-17 11:48:52,874 - chatbot_rag - INFO - [analysis_20250517_114852] BƯỚC 1: Không phải JSON hợp lệ: Expecting value: line 1 column 1 (char 0)
2025-05-17 11:48:52,874 - chatbot_rag - INFO - [analysis_20250517_114852] BƯỚC 2: Tìm JSON trong chuỗi phản hồi
2025-05-17 11:48:52,874 - chatbot_rag - WARNING - [analysis_20250517_114852] BƯỚC 2: Không tìm thấy mẫu JSON nào trong phản hồi
2025-05-17 11:48:52,875 - chatbot_rag - INFO - [analysis_20250517_114852] BƯỚC 3: Xử lý chuỗi thủ công để trích xuất thông tin
2025-05-17 11:48:52,879 - department_info_tool - INFO - Đã tải 11 phòng ban
2025-05-17 11:48:52,880 - department_info_tool - INFO - Đã lấy danh sách 11 phòng ban
2025-05-17 11:48:52,880 - chatbot_rag - INFO - [analysis_20250517_114852] BƯỚC 3: Kết quả phân tích thủ công: {'department': None, 'query_type': 'general', 'error': False}
2025-05-17 11:48:52,880 - websocket_server - INFO - Phân tích câu hỏi: Phòng ban=None, Loại=general, Thinking=True
2025-05-17 11:48:52,881 - websocket_server - INFO - Xử lý streaming response cho: 'mày là ai /think', phòng ban: None, session_id: 284b52f9-dae0-4001-98fc-1e425fa03bf9
2025-05-17 11:48:52,881 - websocket_server - INFO - Session ID nhận được: 284b52f9-dae0-4001-98fc-1e425fa03bf9
2025-05-17 11:48:52,881 - websocket_server - INFO - Phát hiện lệnh /think, bật chế độ thinking cho: mày là ai
2025-05-17 11:48:52,882 - websocket_server - INFO - Xử lý streaming response. Query: 'mày là ai', Mode thinking: True
2025-05-17 11:48:52,883 - websocket_server - INFO - Đã thêm 1 tin nhắn gần nhất vào prompt
2025-05-17 11:48:52,885 - websocket_server - INFO - Đã lưu lịch sử tin nhắn và prompt vào file: data/logs/history_prompt_20250517_114852.txt
2025-05-17 11:48:52,886 - chatbot_rag - INFO - Đang phân tích câu hỏi với LLM: Lịch sử tin nhắn:
Người dùng: alo

mày là ai, session_id: 284b52f9-dae0-4001-98fc-1e425fa03bf9
2025-05-17 11:48:52,887 - chatbot_rag - WARNING - [analyze_query_with_llm] Không thể import get_session_history từ websocket_server, sử dụng get_chat_history
2025-05-17 11:48:52,888 - chatbot_rag - INFO - [analyze_query_with_llm] Lấy lịch sử từ get_chat_history: 0 bản ghi
2025-05-17 11:48:52,888 - chatbot_rag - INFO - [analyze_query_with_llm] Sử dụng lịch sử hội thoại: 0 bản ghi
2025-05-17 11:48:52,888 - chatbot_rag - INFO - [analyze_query_with_llm] Prompt cuối cùng: Lịch sử tin nhắn:

Câu hỏi người dùng hiện tại: "Lịch sử tin nhắn:
Người dùng: alo

mày là ai"

Phân tích câu hỏi và trả về JSON có định dạng:
{"department": "tên phòng ban hoặc null", "query_type": "...
2025-05-17 11:48:52,889 - chatbot_rag - INFO - Kích thước prompt: 517 ký tự
2025-05-17 11:48:52,889 - chatbot_rag - INFO - Kích thước system prompt: 4181 ký tự
2025-05-17 11:48:52,889 - chatbot_rag - INFO - Tổng kích thước: 4698 ký tự
2025-05-17 11:48:52,890 - chatbot_rag - INFO - Đã lưu full prompt vào file: data/logs/llm_full_prompt_20250517_114852.txt
2025-05-17 11:48:52,891 - chatbot_rag - INFO - System prompt: 
Bạn là trợ lý AI chuyên phân tích nội dung câu hỏi để xác định:
1. Phòng ban mà người dùng đang hỏi về (department)
2. Phân loại câu hỏi là về phòng ban cụ thể hay câu hỏi chung (query_type)
3. Xác đ...
2025-05-17 11:48:52,891 - chatbot_rag - INFO - User prompt: Lịch sử tin nhắn:

Câu hỏi người dùng hiện tại: "Lịch sử tin nhắn:
Người dùng: alo

mày là ai"

Phân tích câu hỏi và trả về JSON có định dạng:
{"department": "tên phòng ban hoặc null", "query_type": "...
2025-05-17 11:48:52,891 - chatbot_rag - INFO - Gửi truy vấn đến LLM API tại http://localhost:1234/v1/chat/completions với stream=False
2025-05-17 11:49:02,907 - chatbot_rag - INFO - Mã phản hồi từ API: 200
2025-05-17 11:49:02,908 - chatbot_rag - INFO - Phản hồi gốc từ LLM API (200 ký tự đầu): <think>
Okay, let's tackle this query. The user's current message is "Lịch sử tin nhắn: Người dùng: alo mày là ai". First, I need to parse the history and the current question.

Looking at the history
2025-05-17 11:49:02,915 - chatbot_rag - INFO - Đã lưu phản hồi đầy đủ vào file: data/logs/llm_response_20250517_114902.txt
2025-05-17 11:49:02,917 - chatbot_rag - INFO - [analysis_20250517_114902] Đã ghi phản hồi gốc vào: data/logs/analysis_20250517_114902_raw.txt
2025-05-17 11:49:02,917 - chatbot_rag - INFO - [analysis_20250517_114902] Phản hồi gốc: <think>
Okay, let's tackle this query. The user's current message is "Lịch sử tin nhắn: Người dùng: ...
2025-05-17 11:49:02,918 - chatbot_rag - WARNING - [analysis_20250517_114902] Phát hiện thẻ <think> trong phản hồi. Xử lý đặc biệt...
2025-05-17 11:49:02,918 - chatbot_rag - INFO - [analysis_20250517_114902] BƯỚC 1: Thử parse toàn bộ chuỗi phản hồi
2025-05-17 11:49:02,918 - chatbot_rag - INFO - [analysis_20250517_114902] BƯỚC 1: Không phải JSON hợp lệ: Expecting value: line 1 column 1 (char 0)
2025-05-17 11:49:02,919 - chatbot_rag - INFO - [analysis_20250517_114902] BƯỚC 2: Tìm JSON trong chuỗi phản hồi
2025-05-17 11:49:02,919 - chatbot_rag - WARNING - [analysis_20250517_114902] BƯỚC 2: Không tìm thấy mẫu JSON nào trong phản hồi
2025-05-17 11:49:02,919 - chatbot_rag - INFO - [analysis_20250517_114902] BƯỚC 3: Xử lý chuỗi thủ công để trích xuất thông tin
2025-05-17 11:49:02,927 - department_info_tool - INFO - Đã tải 11 phòng ban
2025-05-17 11:49:02,928 - department_info_tool - INFO - Đã lấy danh sách 11 phòng ban
2025-05-17 11:49:02,928 - chatbot_rag - INFO - [analysis_20250517_114902] BƯỚC 3: Kết quả phân tích thủ công: {'department': None, 'query_type': 'general', 'error': False}
2025-05-17 11:49:02,929 - websocket_server - INFO - Phân tích câu hỏi: Phòng ban=None, Loại=general, Thinking=True
2025-05-17 11:49:02,929 - websocket_server - INFO - Query thực tế gửi đến mô hình: mày là ai /think
2025-05-17 11:49:02,929 - websocket_server - INFO - Câu hỏi chung, chế độ thinking: True
2025-05-17 11:49:02,929 - chatbot_rag - INFO - Xử lý câu hỏi chung cho session_id: 284b52f9-dae0-4001-98fc-1e425fa03bf9
2025-05-17 11:49:02,932 - department_info_tool - INFO - Đã tải 11 phòng ban
2025-05-17 11:49:02,932 - department_info_tool - INFO - Đã lấy danh sách 11 phòng ban
2025-05-17 11:49:02,933 - chatbot_rag - INFO - Gọi LLM để trả lời câu hỏi chung cho session_id: 284b52f9-dae0-4001-98fc-1e425fa03bf9
2025-05-17 11:49:02,934 - chatbot_rag - INFO - Đã lưu prompt vào file: data/logs/prompt_general_20250517_114902.txt
2025-05-17 11:49:02,936 - chatbot_rag - INFO - Kích thước prompt: 1628 ký tự
2025-05-17 11:49:02,936 - chatbot_rag - INFO - Kích thước system prompt: 1059 ký tự
2025-05-17 11:49:02,937 - chatbot_rag - INFO - Tổng kích thước: 2687 ký tự
2025-05-17 11:49:02,938 - chatbot_rag - INFO - Đã lưu full prompt vào file: data/logs/llm_full_prompt_20250517_114902.txt
2025-05-17 11:49:02,939 - chatbot_rag - INFO - System prompt: 
Bạn là trợ lý AI chuyên về quy trình và giai đoạn trong công ty.

CÁC PHÒNG BAN THAM GIA THEO GIAI ĐOẠN:
- MKT-SALES: Marketing, Kinh doanh
- PROPOSAL: Kinh doanh, Dự toán, Thiết kế, Team dự án
- CON...
2025-05-17 11:49:02,939 - chatbot_rag - INFO - User prompt: 
Câu hỏi: "mày là ai /think"

Đây là câu hỏi chung về quy trình hoặc giai đoạn làm việc.

Thông tin cơ bản:
### Thông tin tổng quan về quy trình và giai đoạn

#### Giai đoạn chính trong quy trình:
1. ...
2025-05-17 11:49:02,940 - chatbot_rag - INFO - Gửi truy vấn đến LLM API tại http://localhost:1234/v1/chat/completions với stream=True
2025-05-17 11:49:27,720 - chatbot_rag - INFO - Mã phản hồi từ API: 200
2025-05-17 11:49:27,722 - chatbot_rag - INFO - Phản hồi gốc từ LLM API (200 ký tự đầu): <think>
Okay, let's see. The user asked "mày là ai" which is a general question about the process or stages. I need to follow the strict rules provided.

First, the instructions say not to create conn
2025-05-17 11:49:27,724 - chatbot_rag - INFO - Đã lưu phản hồi đầy đủ vào file: data/logs/llm_response_20250517_114927.txt
2025-05-17 11:49:27,729 - websocket_server - INFO - Đã trích xuất thinking (895 ký tự) và còn lại 1006 ký tự phản hồi
2025-05-17 11:49:27,729 - websocket_server - INFO - Đã trích xuất phần thinking (895 ký tự) từ phản hồi
2025-05-17 11:49:27,737 - websocket_server - INFO - Đã lưu hội thoại chung vào lịch sử của session 284b52f9-dae0-4001-98fc-1e425fa03bf9
2025-05-17 13:36:45,708 - websockets.server - INFO - server closing
2025-05-17 13:36:45,735 - websockets.server - INFO - server closed
2025-05-17 13:36:45,777 - websocket_server - INFO - Server bị dừng bởi người dùng
2025-05-17 15:31:56,478 - websocket_server - INFO - Khởi động server WebSocket tại 0.0.0.0:8090
2025-05-17 15:31:56,502 - websockets.server - INFO - server listening on 0.0.0.0:8090
2025-05-17 15:31:56,502 - websocket_server - INFO - Server WebSocket đang chạy tại ws://0.0.0.0:8090
2025-05-17 15:31:56,503 - websocket_server - INFO - Đã cấu hình ping_timeout=6000 giây, ping_interval=60 giây
2025-05-17 15:33:32,560 - websockets.server - INFO - connection open
2025-05-17 15:33:32,815 - websockets.server - INFO - connection open
2025-05-17 15:33:35,223 - websocket_server - INFO - Nhận tin nhắn dạng JSON: {"content":"xin chào /no_think","session_id":""}
2025-05-17 15:33:35,225 - websocket_server - INFO - Session ID không được cung cấp trong tin nhắn JSON, sử dụng current_session_id: 8d24b8d6-267c-479f-afa5-865acbc59572
2025-05-17 15:33:35,226 - websocket_server - INFO - Session ID từ client (sau khi kiểm tra): 8d24b8d6-267c-479f-afa5-865acbc59572
2025-05-17 15:33:35,226 - websocket_server - INFO - Tắt chế độ thinking cho câu hỏi: xin chào /no_think...
2025-05-17 15:33:35,226 - websocket_server - INFO - Nhận tin nhắn thông thường: xin chào /no_think, enable_thinking=False
2025-05-17 15:33:35,227 - websocket_server - INFO - Không có lịch sử tin nhắn cho phiên này
2025-05-17 15:33:35,227 - chatbot_rag - INFO - Đang phân tích câu hỏi với LLM: xin chào /no_think, session_id: 8d24b8d6-267c-479f-afa5-865acbc59572
2025-05-17 15:33:35,278 - chatbot_rag - INFO - [analyze_query_with_llm] Đã lấy được 0 bản ghi lịch sử từ websocket_server cho session 8d24b8d6-267c-479f-afa5-865acbc59572
2025-05-17 15:33:35,280 - chatbot_rag - INFO - [analyze_query_with_llm] Sử dụng lịch sử hội thoại: 0 bản ghi
2025-05-17 15:33:35,281 - chatbot_rag - INFO - [analyze_query_with_llm] Prompt cuối cùng: Lịch sử tin nhắn:
        
        Câu hỏi người dùng hiện tại: "xin chào /no_think"

        Phân tích câu hỏi và trả về JSON có định dạng:
        {"department": "tên phòng ban hoặc null", "query_ty...
2025-05-17 15:33:35,281 - chatbot_rag - INFO - Kích thước prompt: 599 ký tự
2025-05-17 15:33:35,282 - chatbot_rag - INFO - Kích thước system prompt: 2004 ký tự
2025-05-17 15:33:35,282 - chatbot_rag - INFO - Tổng kích thước: 2603 ký tự
2025-05-17 15:33:35,284 - chatbot_rag - INFO - Đã lưu full prompt vào file: data/logs/llm_full_prompt_20250517_153335.txt
2025-05-17 15:33:35,285 - chatbot_rag - INFO - System prompt: 
        Bạn là trợ lý AI phân tích câu hỏi để xác định:
        1. Phòng ban người dùng đang hỏi (department)
        2. Loại câu hỏi: phòng ban cụ thể hay chung (query_type)
        3. Nếu câu hỏi đ...
2025-05-17 15:33:35,286 - chatbot_rag - INFO - User prompt: Lịch sử tin nhắn:
        
        Câu hỏi người dùng hiện tại: "xin chào /no_think"

        Phân tích câu hỏi và trả về JSON có định dạng:
        {"department": "tên phòng ban hoặc null", "query_ty...
2025-05-17 15:33:35,292 - chatbot_rag - INFO - Gửi truy vấn đến LLM API tại http://192.168.0.43:1234/v1/chat/completions với stream=False
2025-05-17 15:33:37,370 - chatbot_rag - ERROR - Lỗi khi gọi LLM: HTTPConnectionPool(host='192.168.0.43', port=1234): Max retries exceeded with url: /v1/chat/completions (Caused by NewConnectionError('<urllib3.connection.HTTPConnection object at 0x0000029E1A6BBA10>: Failed to establish a new connection: [WinError 10061] No connection could be made because the target machine actively refused it'))
2025-05-17 15:33:37,373 - chatbot_rag - INFO - [analysis_20250517_153337] Đã ghi phản hồi gốc vào: data/logs/analysis_20250517_153337_raw.txt
2025-05-17 15:33:37,374 - chatbot_rag - INFO - [analysis_20250517_153337] Phản hồi gốc: Đã xảy ra lỗi khi xử lý truy vấn: HTTPConnectionPool(host='192.168.0.43', port=1234): Max retries ex...
2025-05-17 15:33:37,376 - chatbot_rag - INFO - [analysis_20250517_153337] BƯỚC 1: Thử parse toàn bộ chuỗi phản hồi
2025-05-17 15:33:37,378 - chatbot_rag - INFO - [analysis_20250517_153337] BƯỚC 1: Không phải JSON hợp lệ: Expecting value: line 1 column 1 (char 0)
2025-05-17 15:33:37,379 - chatbot_rag - INFO - [analysis_20250517_153337] BƯỚC 2: Tìm JSON trong chuỗi phản hồi
2025-05-17 15:33:37,384 - chatbot_rag - WARNING - [analysis_20250517_153337] BƯỚC 2: Không tìm thấy mẫu JSON nào trong phản hồi
2025-05-17 15:33:37,385 - chatbot_rag - INFO - [analysis_20250517_153337] BƯỚC 3: Xử lý chuỗi thủ công để trích xuất thông tin
2025-05-17 15:33:37,406 - department_info_tool - INFO - Đã tải 11 phòng ban
2025-05-17 15:33:37,407 - department_info_tool - INFO - Đã lấy danh sách 11 phòng ban
2025-05-17 15:33:37,407 - chatbot_rag - INFO - [analysis_20250517_153337] BƯỚC 3: Kết quả phân tích thủ công: {'department': None, 'query_type': 'general', 'error': False}
2025-05-17 15:33:37,408 - websocket_server - INFO - Phân tích câu hỏi: Phòng ban=None, Loại=general, Thinking=False
2025-05-17 15:33:37,408 - websocket_server - INFO - Xử lý streaming response cho: 'xin chào /no_think', phòng ban: None, session_id: 8d24b8d6-267c-479f-afa5-865acbc59572
2025-05-17 15:33:37,408 - websocket_server - INFO - Session ID nhận được: 8d24b8d6-267c-479f-afa5-865acbc59572
2025-05-17 15:33:37,412 - websocket_server - INFO - Phát hiện lệnh /no_think, tắt chế độ thinking cho: xin chào
2025-05-17 15:33:37,413 - websocket_server - INFO - Xử lý streaming response. Query: 'xin chào', Mode thinking: False
2025-05-17 15:33:37,414 - websocket_server - INFO - Không có lịch sử tin nhắn cho phiên này
2025-05-17 15:33:37,415 - chatbot_rag - INFO - Đang phân tích câu hỏi với LLM: xin chào, session_id: 8d24b8d6-267c-479f-afa5-865acbc59572
2025-05-17 15:33:37,415 - chatbot_rag - INFO - [analyze_query_with_llm] Đã lấy được 0 bản ghi lịch sử từ websocket_server cho session 8d24b8d6-267c-479f-afa5-865acbc59572
2025-05-17 15:33:37,415 - chatbot_rag - INFO - [analyze_query_with_llm] Sử dụng lịch sử hội thoại: 0 bản ghi
2025-05-17 15:33:37,416 - chatbot_rag - INFO - [analyze_query_with_llm] Prompt cuối cùng: Lịch sử tin nhắn:
        
        Câu hỏi người dùng hiện tại: "xin chào"

        Phân tích câu hỏi và trả về JSON có định dạng:
        {"department": "tên phòng ban hoặc null", "query_type": "depa...
2025-05-17 15:33:37,417 - chatbot_rag - INFO - Kích thước prompt: 589 ký tự
2025-05-17 15:33:37,418 - chatbot_rag - INFO - Kích thước system prompt: 2004 ký tự
2025-05-17 15:33:37,418 - chatbot_rag - INFO - Tổng kích thước: 2593 ký tự
2025-05-17 15:33:37,421 - chatbot_rag - INFO - Đã lưu full prompt vào file: data/logs/llm_full_prompt_20250517_153337.txt
2025-05-17 15:33:37,421 - chatbot_rag - INFO - System prompt: 
        Bạn là trợ lý AI phân tích câu hỏi để xác định:
        1. Phòng ban người dùng đang hỏi (department)
        2. Loại câu hỏi: phòng ban cụ thể hay chung (query_type)
        3. Nếu câu hỏi đ...
2025-05-17 15:33:37,421 - chatbot_rag - INFO - User prompt: Lịch sử tin nhắn:
        
        Câu hỏi người dùng hiện tại: "xin chào"

        Phân tích câu hỏi và trả về JSON có định dạng:
        {"department": "tên phòng ban hoặc null", "query_type": "depa...
2025-05-17 15:33:37,422 - chatbot_rag - INFO - Gửi truy vấn đến LLM API tại http://192.168.0.43:1234/v1/chat/completions với stream=False
2025-05-17 15:33:39,461 - chatbot_rag - ERROR - Lỗi khi gọi LLM: HTTPConnectionPool(host='192.168.0.43', port=1234): Max retries exceeded with url: /v1/chat/completions (Caused by NewConnectionError('<urllib3.connection.HTTPConnection object at 0x0000029E1A6EE5D0>: Failed to establish a new connection: [WinError 10061] No connection could be made because the target machine actively refused it'))
2025-05-17 15:33:39,463 - chatbot_rag - INFO - [analysis_20250517_153339] Đã ghi phản hồi gốc vào: data/logs/analysis_20250517_153339_raw.txt
2025-05-17 15:33:39,464 - chatbot_rag - INFO - [analysis_20250517_153339] Phản hồi gốc: Đã xảy ra lỗi khi xử lý truy vấn: HTTPConnectionPool(host='192.168.0.43', port=1234): Max retries ex...
2025-05-17 15:33:39,465 - chatbot_rag - INFO - [analysis_20250517_153339] BƯỚC 1: Thử parse toàn bộ chuỗi phản hồi
2025-05-17 15:33:39,465 - chatbot_rag - INFO - [analysis_20250517_153339] BƯỚC 1: Không phải JSON hợp lệ: Expecting value: line 1 column 1 (char 0)
2025-05-17 15:33:39,465 - chatbot_rag - INFO - [analysis_20250517_153339] BƯỚC 2: Tìm JSON trong chuỗi phản hồi
2025-05-17 15:33:39,466 - chatbot_rag - WARNING - [analysis_20250517_153339] BƯỚC 2: Không tìm thấy mẫu JSON nào trong phản hồi
2025-05-17 15:33:39,466 - chatbot_rag - INFO - [analysis_20250517_153339] BƯỚC 3: Xử lý chuỗi thủ công để trích xuất thông tin
2025-05-17 15:33:39,470 - department_info_tool - INFO - Đã tải 11 phòng ban
2025-05-17 15:33:39,471 - department_info_tool - INFO - Đã lấy danh sách 11 phòng ban
2025-05-17 15:33:39,471 - chatbot_rag - INFO - [analysis_20250517_153339] BƯỚC 3: Kết quả phân tích thủ công: {'department': None, 'query_type': 'general', 'error': False}
2025-05-17 15:33:39,472 - websocket_server - INFO - Phân tích câu hỏi: Phòng ban=None, Loại=general, Thinking=False
2025-05-17 15:33:39,472 - websocket_server - INFO - Query thực tế gửi đến mô hình: xin chào /no_think
2025-05-17 15:33:39,472 - websocket_server - INFO - Câu hỏi chung, chế độ thinking: False
2025-05-17 15:33:39,473 - chatbot_rag - INFO - Xử lý câu hỏi chung cho session_id: 8d24b8d6-267c-479f-afa5-865acbc59572
2025-05-17 15:33:39,476 - department_info_tool - INFO - Đã tải 11 phòng ban
2025-05-17 15:33:39,477 - department_info_tool - INFO - Đã lấy danh sách 11 phòng ban
2025-05-17 15:33:39,478 - chatbot_rag - INFO - Gọi LLM để trả lời câu hỏi chung cho session_id: 8d24b8d6-267c-479f-afa5-865acbc59572
2025-05-17 15:33:39,479 - chatbot_rag - INFO - Đã lưu prompt vào file: data/logs/prompt_general_20250517_153339.txt
2025-05-17 15:33:39,480 - chatbot_rag - INFO - Kích thước prompt: 1630 ký tự
2025-05-17 15:33:39,480 - chatbot_rag - INFO - Kích thước system prompt: 1205 ký tự
2025-05-17 15:33:39,481 - chatbot_rag - INFO - Tổng kích thước: 2835 ký tự
2025-05-17 15:33:39,482 - chatbot_rag - INFO - Đã lưu full prompt vào file: data/logs/llm_full_prompt_20250517_153339.txt
2025-05-17 15:33:39,482 - chatbot_rag - INFO - System prompt: 
Bạn là trợ lý AI chuyên về quy trình và giai đoạn trong công ty.

CÁC PHÒNG BAN THAM GIA THEO GIAI ĐOẠN:
- MKT-SALES: Marketing, Kinh doanh
- PROPOSAL: Kinh doanh, Dự toán, Thiết kế, Team dự án
- CON...
2025-05-17 15:33:39,483 - chatbot_rag - INFO - User prompt: 
Câu hỏi: "xin chào /no_think"

Đây là câu hỏi chung về quy trình hoặc giai đoạn làm việc.

Thông tin cơ bản:
### Thông tin tổng quan về quy trình và giai đoạn

#### Giai đoạn chính trong quy trình:
1...
2025-05-17 15:33:39,484 - chatbot_rag - INFO - Gửi truy vấn đến LLM API tại http://192.168.0.43:1234/v1/chat/completions với stream=True
2025-05-17 15:33:41,526 - chatbot_rag - ERROR - Lỗi khi gọi LLM: HTTPConnectionPool(host='192.168.0.43', port=1234): Max retries exceeded with url: /v1/chat/completions (Caused by NewConnectionError('<urllib3.connection.HTTPConnection object at 0x0000029E1A6EEC10>: Failed to establish a new connection: [WinError 10061] No connection could be made because the target machine actively refused it'))
2025-05-17 15:33:41,796 - websocket_server - INFO - Đã lưu hội thoại chung vào lịch sử của session 8d24b8d6-267c-479f-afa5-865acbc59572
2025-05-17 16:37:00,203 - websockets.server - INFO - connection open
2025-05-17 16:37:00,380 - websockets.server - INFO - connection open
2025-05-17 16:47:00,854 - websocket_server - INFO - Nhận tin nhắn dạng JSON: {"content":"xin chào /no_think","session_id":""}
2025-05-17 16:47:00,869 - websocket_server - INFO - Session ID không được cung cấp trong tin nhắn JSON, sử dụng current_session_id: 8d24b8d6-267c-479f-afa5-865acbc59572
2025-05-17 16:47:00,877 - websocket_server - INFO - Session ID từ client (sau khi kiểm tra): 8d24b8d6-267c-479f-afa5-865acbc59572
2025-05-17 16:47:00,878 - websocket_server - INFO - Tắt chế độ thinking cho câu hỏi: xin chào /no_think...
2025-05-17 16:47:00,881 - websocket_server - INFO - Nhận tin nhắn thông thường: xin chào /no_think, enable_thinking=False
2025-05-17 16:47:00,883 - websocket_server - INFO - Đã thêm 1 tin nhắn gần nhất vào prompt
2025-05-17 16:47:00,902 - websocket_server - INFO - Đã lưu lịch sử tin nhắn và prompt vào file: data/logs/history_prompt_20250517_164700.txt
2025-05-17 16:47:00,905 - chatbot_rag - INFO - Đang phân tích câu hỏi với LLM: Lịch sử tin nhắn:
Người dùng: xin chào

xin chào /no_think, session_id: 8d24b8d6-267c-479f-afa5-865acbc59572
2025-05-17 16:47:00,911 - chatbot_rag - INFO - [analyze_query_with_llm] Đã lấy được 0 bản ghi lịch sử từ websocket_server cho session 8d24b8d6-267c-479f-afa5-865acbc59572
2025-05-17 16:47:00,914 - chatbot_rag - INFO - [analyze_query_with_llm] Sử dụng lịch sử hội thoại: 0 bản ghi
2025-05-17 16:47:00,915 - chatbot_rag - INFO - [analyze_query_with_llm] Prompt cuối cùng: Lịch sử tin nhắn:
        
        Câu hỏi người dùng hiện tại: "Lịch sử tin nhắn:
Người dùng: xin chào

xin chào /no_think"

        Phân tích câu hỏi và trả về JSON có định dạng:
        {"departmen...
2025-05-17 16:47:00,918 - chatbot_rag - INFO - Kích thước prompt: 639 ký tự
2025-05-17 16:47:00,919 - chatbot_rag - INFO - Kích thước system prompt: 2004 ký tự
2025-05-17 16:47:00,919 - chatbot_rag - INFO - Tổng kích thước: 2643 ký tự
2025-05-17 16:47:00,926 - chatbot_rag - INFO - Đã lưu full prompt vào file: data/logs/llm_full_prompt_20250517_164700.txt
2025-05-17 16:47:00,927 - chatbot_rag - INFO - System prompt: 
        Bạn là trợ lý AI phân tích câu hỏi để xác định:
        1. Phòng ban người dùng đang hỏi (department)
        2. Loại câu hỏi: phòng ban cụ thể hay chung (query_type)
        3. Nếu câu hỏi đ...
2025-05-17 16:47:00,929 - chatbot_rag - INFO - User prompt: Lịch sử tin nhắn:
        
        Câu hỏi người dùng hiện tại: "Lịch sử tin nhắn:
Người dùng: xin chào

xin chào /no_think"

        Phân tích câu hỏi và trả về JSON có định dạng:
        {"departmen...
2025-05-17 16:47:00,931 - chatbot_rag - INFO - Gửi truy vấn đến LLM API tại http://192.168.0.43:1234/v1/chat/completions với stream=False
2025-05-17 16:47:03,018 - chatbot_rag - ERROR - Lỗi khi gọi LLM: HTTPConnectionPool(host='192.168.0.43', port=1234): Max retries exceeded with url: /v1/chat/completions (Caused by NewConnectionError('<urllib3.connection.HTTPConnection object at 0x0000029E1A8AD6E0>: Failed to establish a new connection: [WinError 10061] No connection could be made because the target machine actively refused it'))
2025-05-17 16:47:03,027 - chatbot_rag - INFO - [analysis_20250517_164703] Đã ghi phản hồi gốc vào: data/logs/analysis_20250517_164703_raw.txt
2025-05-17 16:47:03,029 - chatbot_rag - INFO - [analysis_20250517_164703] Phản hồi gốc: Đã xảy ra lỗi khi xử lý truy vấn: HTTPConnectionPool(host='192.168.0.43', port=1234): Max retries ex...
2025-05-17 16:47:03,031 - chatbot_rag - INFO - [analysis_20250517_164703] BƯỚC 1: Thử parse toàn bộ chuỗi phản hồi
2025-05-17 16:47:03,033 - chatbot_rag - INFO - [analysis_20250517_164703] BƯỚC 1: Không phải JSON hợp lệ: Expecting value: line 1 column 1 (char 0)
2025-05-17 16:47:03,034 - chatbot_rag - INFO - [analysis_20250517_164703] BƯỚC 2: Tìm JSON trong chuỗi phản hồi
2025-05-17 16:47:03,040 - chatbot_rag - WARNING - [analysis_20250517_164703] BƯỚC 2: Không tìm thấy mẫu JSON nào trong phản hồi
2025-05-17 16:47:03,045 - chatbot_rag - INFO - [analysis_20250517_164703] BƯỚC 3: Xử lý chuỗi thủ công để trích xuất thông tin
2025-05-17 16:47:03,073 - department_info_tool - INFO - Đã tải 11 phòng ban
2025-05-17 16:47:03,074 - department_info_tool - INFO - Đã lấy danh sách 11 phòng ban
2025-05-17 16:47:03,075 - chatbot_rag - INFO - [analysis_20250517_164703] BƯỚC 3: Kết quả phân tích thủ công: {'department': None, 'query_type': 'general', 'error': False}
2025-05-17 16:47:03,076 - websocket_server - INFO - Phân tích câu hỏi: Phòng ban=None, Loại=general, Thinking=False
2025-05-17 16:47:03,078 - websocket_server - INFO - Xử lý streaming response cho: 'xin chào /no_think', phòng ban: None, session_id: 8d24b8d6-267c-479f-afa5-865acbc59572
2025-05-17 16:47:03,079 - websocket_server - INFO - Session ID nhận được: 8d24b8d6-267c-479f-afa5-865acbc59572
2025-05-17 16:47:03,081 - websocket_server - INFO - Phát hiện lệnh /no_think, tắt chế độ thinking cho: xin chào
2025-05-17 16:47:03,081 - websocket_server - INFO - Xử lý streaming response. Query: 'xin chào', Mode thinking: False
2025-05-17 16:47:03,082 - websocket_server - INFO - Đã thêm 1 tin nhắn gần nhất vào prompt
2025-05-17 16:47:03,086 - websocket_server - INFO - Đã lưu lịch sử tin nhắn và prompt vào file: data/logs/history_prompt_20250517_164703.txt
2025-05-17 16:47:03,086 - chatbot_rag - INFO - Đang phân tích câu hỏi với LLM: Lịch sử tin nhắn:
Người dùng: xin chào

xin chào, session_id: 8d24b8d6-267c-479f-afa5-865acbc59572
2025-05-17 16:47:03,087 - chatbot_rag - INFO - [analyze_query_with_llm] Đã lấy được 0 bản ghi lịch sử từ websocket_server cho session 8d24b8d6-267c-479f-afa5-865acbc59572
2025-05-17 16:47:03,087 - chatbot_rag - INFO - [analyze_query_with_llm] Sử dụng lịch sử hội thoại: 0 bản ghi
2025-05-17 16:47:03,087 - chatbot_rag - INFO - [analyze_query_with_llm] Prompt cuối cùng: Lịch sử tin nhắn:
        
        Câu hỏi người dùng hiện tại: "Lịch sử tin nhắn:
Người dùng: xin chào

xin chào"

        Phân tích câu hỏi và trả về JSON có định dạng:
        {"department": "tên p...
2025-05-17 16:47:03,088 - chatbot_rag - INFO - Kích thước prompt: 629 ký tự
2025-05-17 16:47:03,088 - chatbot_rag - INFO - Kích thước system prompt: 2004 ký tự
2025-05-17 16:47:03,088 - chatbot_rag - INFO - Tổng kích thước: 2633 ký tự
2025-05-17 16:47:03,092 - chatbot_rag - INFO - Đã lưu full prompt vào file: data/logs/llm_full_prompt_20250517_164703.txt
2025-05-17 16:47:03,093 - chatbot_rag - INFO - System prompt: 
        Bạn là trợ lý AI phân tích câu hỏi để xác định:
        1. Phòng ban người dùng đang hỏi (department)
        2. Loại câu hỏi: phòng ban cụ thể hay chung (query_type)
        3. Nếu câu hỏi đ...
2025-05-17 16:47:03,093 - chatbot_rag - INFO - User prompt: Lịch sử tin nhắn:
        
        Câu hỏi người dùng hiện tại: "Lịch sử tin nhắn:
Người dùng: xin chào

xin chào"

        Phân tích câu hỏi và trả về JSON có định dạng:
        {"department": "tên p...
2025-05-17 16:47:03,094 - chatbot_rag - INFO - Gửi truy vấn đến LLM API tại http://192.168.0.43:1234/v1/chat/completions với stream=False
2025-05-17 16:47:05,126 - chatbot_rag - ERROR - Lỗi khi gọi LLM: HTTPConnectionPool(host='192.168.0.43', port=1234): Max retries exceeded with url: /v1/chat/completions (Caused by NewConnectionError('<urllib3.connection.HTTPConnection object at 0x0000029E1A8ADF30>: Failed to establish a new connection: [WinError 10061] No connection could be made because the target machine actively refused it'))
2025-05-17 16:47:05,130 - chatbot_rag - INFO - [analysis_20250517_164705] Đã ghi phản hồi gốc vào: data/logs/analysis_20250517_164705_raw.txt
2025-05-17 16:47:05,131 - chatbot_rag - INFO - [analysis_20250517_164705] Phản hồi gốc: Đã xảy ra lỗi khi xử lý truy vấn: HTTPConnectionPool(host='192.168.0.43', port=1234): Max retries ex...
2025-05-17 16:47:05,132 - chatbot_rag - INFO - [analysis_20250517_164705] BƯỚC 1: Thử parse toàn bộ chuỗi phản hồi
2025-05-17 16:47:05,133 - chatbot_rag - INFO - [analysis_20250517_164705] BƯỚC 1: Không phải JSON hợp lệ: Expecting value: line 1 column 1 (char 0)
2025-05-17 16:47:05,134 - chatbot_rag - INFO - [analysis_20250517_164705] BƯỚC 2: Tìm JSON trong chuỗi phản hồi
2025-05-17 16:47:05,135 - chatbot_rag - WARNING - [analysis_20250517_164705] BƯỚC 2: Không tìm thấy mẫu JSON nào trong phản hồi
2025-05-17 16:47:05,136 - chatbot_rag - INFO - [analysis_20250517_164705] BƯỚC 3: Xử lý chuỗi thủ công để trích xuất thông tin
2025-05-17 16:47:05,152 - department_info_tool - INFO - Đã tải 11 phòng ban
2025-05-17 16:47:05,153 - department_info_tool - INFO - Đã lấy danh sách 11 phòng ban
2025-05-17 16:47:05,154 - chatbot_rag - INFO - [analysis_20250517_164705] BƯỚC 3: Kết quả phân tích thủ công: {'department': None, 'query_type': 'general', 'error': False}
2025-05-17 16:47:05,155 - websocket_server - INFO - Phân tích câu hỏi: Phòng ban=None, Loại=general, Thinking=False
2025-05-17 16:47:05,156 - websocket_server - INFO - Query thực tế gửi đến mô hình: xin chào /no_think
2025-05-17 16:47:05,158 - websocket_server - INFO - Câu hỏi chung, chế độ thinking: False
2025-05-17 16:47:05,160 - chatbot_rag - INFO - Xử lý câu hỏi chung cho session_id: 8d24b8d6-267c-479f-afa5-865acbc59572
2025-05-17 16:47:05,170 - department_info_tool - INFO - Đã tải 11 phòng ban
2025-05-17 16:47:05,173 - department_info_tool - INFO - Đã lấy danh sách 11 phòng ban
2025-05-17 16:47:05,174 - chatbot_rag - INFO - Gọi LLM để trả lời câu hỏi chung cho session_id: 8d24b8d6-267c-479f-afa5-865acbc59572
2025-05-17 16:47:05,176 - chatbot_rag - INFO - Đã lưu prompt vào file: data/logs/prompt_general_20250517_164705.txt
2025-05-17 16:47:05,177 - chatbot_rag - INFO - Kích thước prompt: 1630 ký tự
2025-05-17 16:47:05,177 - chatbot_rag - INFO - Kích thước system prompt: 1205 ký tự
2025-05-17 16:47:05,178 - chatbot_rag - INFO - Tổng kích thước: 2835 ký tự
2025-05-17 16:47:05,181 - chatbot_rag - INFO - Đã lưu full prompt vào file: data/logs/llm_full_prompt_20250517_164705.txt
2025-05-17 16:47:05,182 - chatbot_rag - INFO - System prompt: 
Bạn là trợ lý AI chuyên về quy trình và giai đoạn trong công ty.

CÁC PHÒNG BAN THAM GIA THEO GIAI ĐOẠN:
- MKT-SALES: Marketing, Kinh doanh
- PROPOSAL: Kinh doanh, Dự toán, Thiết kế, Team dự án
- CON...
2025-05-17 16:47:05,183 - chatbot_rag - INFO - User prompt: 
Câu hỏi: "xin chào /no_think"

Đây là câu hỏi chung về quy trình hoặc giai đoạn làm việc.

Thông tin cơ bản:
### Thông tin tổng quan về quy trình và giai đoạn

#### Giai đoạn chính trong quy trình:
1...
2025-05-17 16:47:05,184 - chatbot_rag - INFO - Gửi truy vấn đến LLM API tại http://192.168.0.43:1234/v1/chat/completions với stream=True
2025-05-17 16:47:07,229 - chatbot_rag - ERROR - Lỗi khi gọi LLM: HTTPConnectionPool(host='192.168.0.43', port=1234): Max retries exceeded with url: /v1/chat/completions (Caused by NewConnectionError('<urllib3.connection.HTTPConnection object at 0x0000029E1A87DFD0>: Failed to establish a new connection: [WinError 10061] No connection could be made because the target machine actively refused it'))
2025-05-17 16:47:07,285 - websocket_server - INFO - Đã lưu hội thoại chung vào lịch sử của session 8d24b8d6-267c-479f-afa5-865acbc59572
2025-05-17 17:15:19,590 - websockets.server - INFO - server closing
2025-05-17 17:15:19,624 - websockets.server - INFO - server closed
2025-05-17 17:15:19,644 - websocket_server - INFO - Server bị dừng bởi người dùng
2025-05-17 17:55:10,389 - websocket_server - INFO - Khởi động server WebSocket tại 0.0.0.0:8090
2025-05-17 17:55:10,452 - websockets.server - INFO - server listening on 0.0.0.0:8090
2025-05-17 17:55:10,452 - websocket_server - INFO - Server WebSocket đang chạy tại ws://0.0.0.0:8090
2025-05-17 17:55:10,453 - websocket_server - INFO - Đã cấu hình ping_timeout=6000 giây, ping_interval=60 giây
2025-05-17 17:55:12,734 - websockets.server - INFO - server closing
2025-05-17 17:55:12,735 - websockets.server - INFO - server closed
2025-05-17 17:55:12,735 - websocket_server - INFO - Server bị dừng bởi người dùng
2025-05-18 16:38:50,623 - websocket_server - INFO - Khởi động server WebSocket tại 0.0.0.0:8090
2025-05-18 16:38:50,684 - websockets.server - INFO - server listening on 0.0.0.0:8090
2025-05-18 16:38:50,685 - websocket_server - INFO - Server WebSocket đang chạy tại ws://0.0.0.0:8090
2025-05-18 16:38:50,685 - websocket_server - INFO - Đã cấu hình ping_timeout=6000 giây, ping_interval=60 giây
2025-05-18 16:38:54,200 - websockets.server - INFO - server closing
2025-05-18 16:38:54,201 - websockets.server - INFO - server closed
2025-05-18 16:38:54,202 - websocket_server - INFO - Server bị dừng bởi người dùng
2025-05-18 16:44:04,478 - websocket_server - INFO - Khởi động server WebSocket tại 0.0.0.0:8090
2025-05-18 16:44:04,515 - websockets.server - INFO - server listening on 0.0.0.0:8090
2025-05-18 16:44:04,515 - websocket_server - INFO - Server WebSocket đang chạy tại ws://0.0.0.0:8090
2025-05-18 16:44:04,515 - websocket_server - INFO - Đã cấu hình ping_timeout=6000 giây, ping_interval=60 giây
2025-05-18 16:45:14,834 - websockets.server - INFO - connection open
2025-05-18 16:45:17,147 - websockets.server - INFO - connection open
2025-05-18 16:45:19,051 - websockets.server - INFO - connection closed
2025-05-18 16:45:19,052 - websockets.server - INFO - connection closed
2025-05-18 16:45:19,900 - websockets.server - INFO - connection open
2025-05-18 16:45:20,900 - websocket_server - INFO - Nhận tin nhắn dạng JSON: {"content":"xin chào /no_think","session_id":""}
2025-05-18 16:45:20,901 - websocket_server - INFO - Session ID không được cung cấp trong tin nhắn JSON, sử dụng current_session_id: d7451eae-0fd5-4eaf-8b36-d9f533d98c77
2025-05-18 16:45:20,901 - websocket_server - INFO - Session ID từ client (sau khi kiểm tra): d7451eae-0fd5-4eaf-8b36-d9f533d98c77
2025-05-18 16:45:20,902 - websocket_server - INFO - Tắt chế độ thinking cho câu hỏi: xin chào /no_think...
2025-05-18 16:45:20,902 - websocket_server - INFO - Nhận tin nhắn thông thường: xin chào /no_think, enable_thinking=False
2025-05-18 16:45:20,903 - websocket_server - INFO - Không có lịch sử tin nhắn cho phiên này
2025-05-18 16:45:20,903 - chatbot_rag - INFO - Đang phân tích câu hỏi với LLM: xin chào /no_think, session_id: d7451eae-0fd5-4eaf-8b36-d9f533d98c77
2025-05-18 16:45:20,917 - chatbot_rag - INFO - [analyze_query_with_llm] Đã lấy được 0 bản ghi lịch sử từ websocket_server cho session d7451eae-0fd5-4eaf-8b36-d9f533d98c77
2025-05-18 16:45:20,919 - chatbot_rag - INFO - [analyze_query_with_llm] Sử dụng lịch sử hội thoại: 0 bản ghi
2025-05-18 16:45:20,919 - chatbot_rag - INFO - [analyze_query_with_llm] Prompt cuối cùng: Lịch sử tin nhắn:
        
        Câu hỏi người dùng hiện tại: "xin chào /no_think"

        Phân tích câu hỏi và trả về JSON có định dạng:
        {"department": "tên phòng ban hoặc null", "query_ty...
2025-05-18 16:45:20,920 - chatbot_rag - INFO - Kích thước prompt: 599 ký tự
2025-05-18 16:45:20,920 - chatbot_rag - INFO - Kích thước system prompt: 2004 ký tự
2025-05-18 16:45:20,921 - chatbot_rag - INFO - Tổng kích thước: 2603 ký tự
2025-05-18 16:45:20,923 - chatbot_rag - INFO - Đã lưu full prompt vào file: data/logs/llm_full_prompt_20250518_164520.txt
2025-05-18 16:45:20,923 - chatbot_rag - INFO - System prompt: 
        Bạn là trợ lý AI phân tích câu hỏi để xác định:
        1. Phòng ban người dùng đang hỏi (department)
        2. Loại câu hỏi: phòng ban cụ thể hay chung (query_type)
        3. Nếu câu hỏi đ...
2025-05-18 16:45:20,924 - chatbot_rag - INFO - User prompt: Lịch sử tin nhắn:
        
        Câu hỏi người dùng hiện tại: "xin chào /no_think"

        Phân tích câu hỏi và trả về JSON có định dạng:
        {"department": "tên phòng ban hoặc null", "query_ty...
2025-05-18 16:45:20,924 - chatbot_rag - INFO - Gửi truy vấn đến LLM API tại http://192.168.0.43:1234/v1/chat/completions với stream=False
2025-05-18 16:45:42,000 - chatbot_rag - ERROR - Lỗi khi gọi LLM: HTTPConnectionPool(host='192.168.0.43', port=1234): Max retries exceeded with url: /v1/chat/completions (Caused by NewConnectionError('<urllib3.connection.HTTPConnection object at 0x00000198A0A98BB0>: Failed to establish a new connection: [WinError 10060] A connection attempt failed because the connected party did not properly respond after a period of time, or established connection failed because connected host has failed to respond'))
2025-05-18 16:45:42,008 - chatbot_rag - INFO - [analysis_20250518_164542] Đã ghi phản hồi gốc vào: data/logs/analysis_20250518_164542_raw.txt
2025-05-18 16:45:42,008 - chatbot_rag - INFO - [analysis_20250518_164542] Phản hồi gốc: Đã xảy ra lỗi khi xử lý truy vấn: HTTPConnectionPool(host='192.168.0.43', port=1234): Max retries ex...
2025-05-18 16:45:42,009 - chatbot_rag - INFO - [analysis_20250518_164542] BƯỚC 1: Thử parse toàn bộ chuỗi phản hồi
2025-05-18 16:45:42,011 - chatbot_rag - INFO - [analysis_20250518_164542] BƯỚC 1: Không phải JSON hợp lệ: Expecting value: line 1 column 1 (char 0)
2025-05-18 16:45:42,012 - chatbot_rag - INFO - [analysis_20250518_164542] BƯỚC 2: Tìm JSON trong chuỗi phản hồi
2025-05-18 16:45:42,013 - chatbot_rag - WARNING - [analysis_20250518_164542] BƯỚC 2: Không tìm thấy mẫu JSON nào trong phản hồi
2025-05-18 16:45:42,014 - chatbot_rag - INFO - [analysis_20250518_164542] BƯỚC 3: Xử lý chuỗi thủ công để trích xuất thông tin
2025-05-18 16:45:42,032 - department_info_tool - INFO - Đã tải 11 phòng ban
2025-05-18 16:45:42,032 - department_info_tool - INFO - Đã lấy danh sách 11 phòng ban
2025-05-18 16:45:42,033 - chatbot_rag - ERROR - [analysis_20250518_164542] BƯỚC 3: Lỗi khi xử lý chuỗi thủ công: local variable 'query_type' referenced before assignment
2025-05-18 16:45:42,034 - chatbot_rag - WARNING - [analysis_20250518_164542] Tất cả phương pháp phân tích đều thất bại, trả về kết quả mặc định
2025-05-18 16:45:42,034 - websocket_server - INFO - Phân tích câu hỏi: Phòng ban=None, Loại=general, Thinking=False
2025-05-18 16:45:42,035 - websocket_server - INFO - Xử lý streaming response cho: 'xin chào /no_think', phòng ban: None, session_id: d7451eae-0fd5-4eaf-8b36-d9f533d98c77
2025-05-18 16:45:42,035 - websocket_server - INFO - Session ID nhận được: d7451eae-0fd5-4eaf-8b36-d9f533d98c77
2025-05-18 16:45:42,036 - websocket_server - INFO - Phát hiện lệnh /no_think, tắt chế độ thinking cho: xin chào
2025-05-18 16:45:42,036 - websocket_server - INFO - Xử lý streaming response. Query: 'xin chào', Mode thinking: False
2025-05-18 16:45:42,036 - websocket_server - INFO - Không có lịch sử tin nhắn cho phiên này
2025-05-18 16:45:42,036 - chatbot_rag - INFO - Đang phân tích câu hỏi với LLM: xin chào, session_id: d7451eae-0fd5-4eaf-8b36-d9f533d98c77
2025-05-18 16:45:42,036 - chatbot_rag - INFO - [analyze_query_with_llm] Đã lấy được 0 bản ghi lịch sử từ websocket_server cho session d7451eae-0fd5-4eaf-8b36-d9f533d98c77
2025-05-18 16:45:42,037 - chatbot_rag - INFO - [analyze_query_with_llm] Sử dụng lịch sử hội thoại: 0 bản ghi
2025-05-18 16:45:42,037 - chatbot_rag - INFO - [analyze_query_with_llm] Prompt cuối cùng: Lịch sử tin nhắn:
        
        Câu hỏi người dùng hiện tại: "xin chào"

        Phân tích câu hỏi và trả về JSON có định dạng:
        {"department": "tên phòng ban hoặc null", "query_type": "depa...
2025-05-18 16:45:42,037 - chatbot_rag - INFO - Kích thước prompt: 589 ký tự
2025-05-18 16:45:42,037 - chatbot_rag - INFO - Kích thước system prompt: 2004 ký tự
2025-05-18 16:45:42,038 - chatbot_rag - INFO - Tổng kích thước: 2593 ký tự
2025-05-18 16:45:42,039 - chatbot_rag - INFO - Đã lưu full prompt vào file: data/logs/llm_full_prompt_20250518_164542.txt
2025-05-18 16:45:42,039 - chatbot_rag - INFO - System prompt: 
        Bạn là trợ lý AI phân tích câu hỏi để xác định:
        1. Phòng ban người dùng đang hỏi (department)
        2. Loại câu hỏi: phòng ban cụ thể hay chung (query_type)
        3. Nếu câu hỏi đ...
2025-05-18 16:45:42,040 - chatbot_rag - INFO - User prompt: Lịch sử tin nhắn:
        
        Câu hỏi người dùng hiện tại: "xin chào"

        Phân tích câu hỏi và trả về JSON có định dạng:
        {"department": "tên phòng ban hoặc null", "query_type": "depa...
2025-05-18 16:45:42,040 - chatbot_rag - INFO - Gửi truy vấn đến LLM API tại http://192.168.0.43:1234/v1/chat/completions với stream=False
2025-05-18 16:46:03,078 - chatbot_rag - ERROR - Lỗi khi gọi LLM: HTTPConnectionPool(host='192.168.0.43', port=1234): Max retries exceeded with url: /v1/chat/completions (Caused by NewConnectionError('<urllib3.connection.HTTPConnection object at 0x00000198A0C847C0>: Failed to establish a new connection: [WinError 10060] A connection attempt failed because the connected party did not properly respond after a period of time, or established connection failed because connected host has failed to respond'))
2025-05-18 16:46:03,085 - chatbot_rag - INFO - [analysis_20250518_164603] Đã ghi phản hồi gốc vào: data/logs/analysis_20250518_164603_raw.txt
2025-05-18 16:46:03,086 - chatbot_rag - INFO - [analysis_20250518_164603] Phản hồi gốc: Đã xảy ra lỗi khi xử lý truy vấn: HTTPConnectionPool(host='192.168.0.43', port=1234): Max retries ex...
2025-05-18 16:46:03,088 - chatbot_rag - INFO - [analysis_20250518_164603] BƯỚC 1: Thử parse toàn bộ chuỗi phản hồi
2025-05-18 16:46:03,090 - chatbot_rag - INFO - [analysis_20250518_164603] BƯỚC 1: Không phải JSON hợp lệ: Expecting value: line 1 column 1 (char 0)
2025-05-18 16:46:03,092 - chatbot_rag - INFO - [analysis_20250518_164603] BƯỚC 2: Tìm JSON trong chuỗi phản hồi
2025-05-18 16:46:03,093 - chatbot_rag - WARNING - [analysis_20250518_164603] BƯỚC 2: Không tìm thấy mẫu JSON nào trong phản hồi
2025-05-18 16:46:03,094 - chatbot_rag - INFO - [analysis_20250518_164603] BƯỚC 3: Xử lý chuỗi thủ công để trích xuất thông tin
2025-05-18 16:46:03,102 - department_info_tool - INFO - Đã tải 11 phòng ban
2025-05-18 16:46:03,102 - department_info_tool - INFO - Đã lấy danh sách 11 phòng ban
2025-05-18 16:46:03,103 - chatbot_rag - ERROR - [analysis_20250518_164603] BƯỚC 3: Lỗi khi xử lý chuỗi thủ công: local variable 'query_type' referenced before assignment
2025-05-18 16:46:03,103 - chatbot_rag - WARNING - [analysis_20250518_164603] Tất cả phương pháp phân tích đều thất bại, trả về kết quả mặc định
2025-05-18 16:46:03,104 - websocket_server - INFO - Phân tích câu hỏi: Phòng ban=None, Loại=general, Thinking=False
2025-05-18 16:46:03,104 - websocket_server - INFO - Query thực tế gửi đến mô hình: xin chào /no_think
2025-05-18 16:46:03,105 - websocket_server - INFO - Câu hỏi chung, chế độ thinking: False
2025-05-18 16:46:03,105 - chatbot_rag - INFO - Xử lý câu hỏi chung cho session_id: d7451eae-0fd5-4eaf-8b36-d9f533d98c77
2025-05-18 16:46:03,116 - department_info_tool - INFO - Đã tải 11 phòng ban
2025-05-18 16:46:03,118 - department_info_tool - INFO - Đã lấy danh sách 11 phòng ban
2025-05-18 16:46:03,118 - chatbot_rag - INFO - Gọi LLM để trả lời câu hỏi chung cho session_id: d7451eae-0fd5-4eaf-8b36-d9f533d98c77
2025-05-18 16:46:03,121 - chatbot_rag - INFO - Đã lưu prompt vào file: data/logs/prompt_general_20250518_164603.txt
2025-05-18 16:46:03,122 - chatbot_rag - INFO - Kích thước prompt: 1630 ký tự
2025-05-18 16:46:03,123 - chatbot_rag - INFO - Kích thước system prompt: 1205 ký tự
2025-05-18 16:46:03,124 - chatbot_rag - INFO - Tổng kích thước: 2835 ký tự
2025-05-18 16:46:03,126 - chatbot_rag - INFO - Đã lưu full prompt vào file: data/logs/llm_full_prompt_20250518_164603.txt
2025-05-18 16:46:03,128 - chatbot_rag - INFO - System prompt: 
Bạn là trợ lý AI chuyên về quy trình và giai đoạn trong công ty.

CÁC PHÒNG BAN THAM GIA THEO GIAI ĐOẠN:
- MKT-SALES: Marketing, Kinh doanh
- PROPOSAL: Kinh doanh, Dự toán, Thiết kế, Team dự án
- CON...
2025-05-18 16:46:03,129 - chatbot_rag - INFO - User prompt: 
Câu hỏi: "xin chào /no_think"

Đây là câu hỏi chung về quy trình hoặc giai đoạn làm việc.

Thông tin cơ bản:
### Thông tin tổng quan về quy trình và giai đoạn

#### Giai đoạn chính trong quy trình:
1...
2025-05-18 16:46:03,130 - chatbot_rag - INFO - Gửi truy vấn đến LLM API tại http://192.168.0.43:1234/v1/chat/completions với stream=True
2025-05-18 16:46:24,187 - chatbot_rag - ERROR - Lỗi khi gọi LLM: HTTPConnectionPool(host='192.168.0.43', port=1234): Max retries exceeded with url: /v1/chat/completions (Caused by NewConnectionError('<urllib3.connection.HTTPConnection object at 0x00000198A0A75880>: Failed to establish a new connection: [WinError 10060] A connection attempt failed because the connected party did not properly respond after a period of time, or established connection failed because connected host has failed to respond'))
2025-05-18 16:46:24,746 - websocket_server - INFO - Đã lưu hội thoại chung vào lịch sử của session d7451eae-0fd5-4eaf-8b36-d9f533d98c77
2025-05-18 16:48:08,818 - websockets.server - INFO - connection closed
2025-05-18 16:48:35,719 - websockets.server - INFO - connection open
2025-05-18 16:48:36,876 - websockets.server - INFO - connection closed
2025-05-18 16:48:37,295 - websockets.server - INFO - connection open
2025-05-18 16:48:39,719 - websocket_server - INFO - Nhận tin nhắn dạng JSON: {"content":"xin chào /no_think","session_id":""}
2025-05-18 16:48:39,720 - websocket_server - INFO - Session ID không được cung cấp trong tin nhắn JSON, sử dụng current_session_id: d7451eae-0fd5-4eaf-8b36-d9f533d98c77
2025-05-18 16:48:39,720 - websocket_server - INFO - Session ID từ client (sau khi kiểm tra): d7451eae-0fd5-4eaf-8b36-d9f533d98c77
2025-05-18 16:48:39,720 - websocket_server - INFO - Tắt chế độ thinking cho câu hỏi: xin chào /no_think...
2025-05-18 16:48:39,721 - websocket_server - INFO - Nhận tin nhắn thông thường: xin chào /no_think, enable_thinking=False
2025-05-18 16:48:39,721 - websocket_server - INFO - Đã thêm 1 tin nhắn gần nhất vào prompt
2025-05-18 16:48:39,723 - websocket_server - INFO - Đã lưu lịch sử tin nhắn và prompt vào file: data/logs/history_prompt_20250518_164839.txt
2025-05-18 16:48:39,724 - chatbot_rag - INFO - Đang phân tích câu hỏi với LLM: Lịch sử tin nhắn:
Người dùng: xin chào

xin chào /no_think, session_id: d7451eae-0fd5-4eaf-8b36-d9f533d98c77
2025-05-18 16:48:39,725 - chatbot_rag - INFO - [analyze_query_with_llm] Đã lấy được 0 bản ghi lịch sử từ websocket_server cho session d7451eae-0fd5-4eaf-8b36-d9f533d98c77
2025-05-18 16:48:39,725 - chatbot_rag - INFO - [analyze_query_with_llm] Sử dụng lịch sử hội thoại: 0 bản ghi
2025-05-18 16:48:39,725 - chatbot_rag - INFO - [analyze_query_with_llm] Prompt cuối cùng: Lịch sử tin nhắn:
        
        Câu hỏi người dùng hiện tại: "Lịch sử tin nhắn:
Người dùng: xin chào

xin chào /no_think"

        Phân tích câu hỏi và trả về JSON có định dạng:
        {"departmen...
2025-05-18 16:48:39,726 - chatbot_rag - INFO - Kích thước prompt: 639 ký tự
2025-05-18 16:48:39,726 - chatbot_rag - INFO - Kích thước system prompt: 2004 ký tự
2025-05-18 16:48:39,727 - chatbot_rag - INFO - Tổng kích thước: 2643 ký tự
2025-05-18 16:48:39,729 - chatbot_rag - INFO - Đã lưu full prompt vào file: data/logs/llm_full_prompt_20250518_164839.txt
2025-05-18 16:48:39,729 - chatbot_rag - INFO - System prompt: 
        Bạn là trợ lý AI phân tích câu hỏi để xác định:
        1. Phòng ban người dùng đang hỏi (department)
        2. Loại câu hỏi: phòng ban cụ thể hay chung (query_type)
        3. Nếu câu hỏi đ...
2025-05-18 16:48:39,729 - chatbot_rag - INFO - User prompt: Lịch sử tin nhắn:
        
        Câu hỏi người dùng hiện tại: "Lịch sử tin nhắn:
Người dùng: xin chào

xin chào /no_think"

        Phân tích câu hỏi và trả về JSON có định dạng:
        {"departmen...
2025-05-18 16:48:39,730 - chatbot_rag - INFO - Gửi truy vấn đến LLM API tại http://192.168.0.43:1234/v1/chat/completions với stream=False
2025-05-18 16:49:00,809 - chatbot_rag - ERROR - Lỗi khi gọi LLM: HTTPConnectionPool(host='192.168.0.43', port=1234): Max retries exceeded with url: /v1/chat/completions (Caused by NewConnectionError('<urllib3.connection.HTTPConnection object at 0x00000198A0D43400>: Failed to establish a new connection: [WinError 10060] A connection attempt failed because the connected party did not properly respond after a period of time, or established connection failed because connected host has failed to respond'))
2025-05-18 16:49:00,811 - chatbot_rag - INFO - [analysis_20250518_164900] Đã ghi phản hồi gốc vào: data/logs/analysis_20250518_164900_raw.txt
2025-05-18 16:49:00,811 - chatbot_rag - INFO - [analysis_20250518_164900] Phản hồi gốc: Đã xảy ra lỗi khi xử lý truy vấn: HTTPConnectionPool(host='192.168.0.43', port=1234): Max retries ex...
2025-05-18 16:49:00,811 - chatbot_rag - INFO - [analysis_20250518_164900] BƯỚC 1: Thử parse toàn bộ chuỗi phản hồi
2025-05-18 16:49:00,812 - chatbot_rag - INFO - [analysis_20250518_164900] BƯỚC 1: Không phải JSON hợp lệ: Expecting value: line 1 column 1 (char 0)
2025-05-18 16:49:00,812 - chatbot_rag - INFO - [analysis_20250518_164900] BƯỚC 2: Tìm JSON trong chuỗi phản hồi
2025-05-18 16:49:00,813 - chatbot_rag - WARNING - [analysis_20250518_164900] BƯỚC 2: Không tìm thấy mẫu JSON nào trong phản hồi
2025-05-18 16:49:00,813 - chatbot_rag - INFO - [analysis_20250518_164900] BƯỚC 3: Xử lý chuỗi thủ công để trích xuất thông tin
2025-05-18 16:49:00,817 - department_info_tool - INFO - Đã tải 11 phòng ban
2025-05-18 16:49:00,817 - department_info_tool - INFO - Đã lấy danh sách 11 phòng ban
2025-05-18 16:49:00,818 - chatbot_rag - ERROR - [analysis_20250518_164900] BƯỚC 3: Lỗi khi xử lý chuỗi thủ công: local variable 'query_type' referenced before assignment
2025-05-18 16:49:00,818 - chatbot_rag - WARNING - [analysis_20250518_164900] Tất cả phương pháp phân tích đều thất bại, trả về kết quả mặc định
2025-05-18 16:49:00,818 - websocket_server - INFO - Phân tích câu hỏi: Phòng ban=None, Loại=general, Thinking=False
2025-05-18 16:49:00,819 - websocket_server - INFO - Xử lý streaming response cho: 'xin chào /no_think', phòng ban: None, session_id: d7451eae-0fd5-4eaf-8b36-d9f533d98c77
2025-05-18 16:49:00,819 - websocket_server - INFO - Session ID nhận được: d7451eae-0fd5-4eaf-8b36-d9f533d98c77
2025-05-18 16:49:00,819 - websocket_server - INFO - Phát hiện lệnh /no_think, tắt chế độ thinking cho: xin chào
2025-05-18 16:49:00,819 - websocket_server - INFO - Xử lý streaming response. Query: 'xin chào', Mode thinking: False
2025-05-18 16:49:00,820 - websocket_server - INFO - Đã thêm 1 tin nhắn gần nhất vào prompt
2025-05-18 16:49:00,821 - websocket_server - INFO - Đã lưu lịch sử tin nhắn và prompt vào file: data/logs/history_prompt_20250518_164900.txt
2025-05-18 16:49:00,821 - chatbot_rag - INFO - Đang phân tích câu hỏi với LLM: Lịch sử tin nhắn:
Người dùng: xin chào

xin chào, session_id: d7451eae-0fd5-4eaf-8b36-d9f533d98c77
2025-05-18 16:49:00,822 - chatbot_rag - INFO - [analyze_query_with_llm] Đã lấy được 0 bản ghi lịch sử từ websocket_server cho session d7451eae-0fd5-4eaf-8b36-d9f533d98c77
2025-05-18 16:49:00,822 - chatbot_rag - INFO - [analyze_query_with_llm] Sử dụng lịch sử hội thoại: 0 bản ghi
2025-05-18 16:49:00,822 - chatbot_rag - INFO - [analyze_query_with_llm] Prompt cuối cùng: Lịch sử tin nhắn:
        
        Câu hỏi người dùng hiện tại: "Lịch sử tin nhắn:
Người dùng: xin chào

xin chào"

        Phân tích câu hỏi và trả về JSON có định dạng:
        {"department": "tên p...
2025-05-18 16:49:00,823 - chatbot_rag - INFO - Kích thước prompt: 629 ký tự
2025-05-18 16:49:00,823 - chatbot_rag - INFO - Kích thước system prompt: 2004 ký tự
2025-05-18 16:49:00,823 - chatbot_rag - INFO - Tổng kích thước: 2633 ký tự
2025-05-18 16:49:00,825 - chatbot_rag - INFO - Đã lưu full prompt vào file: data/logs/llm_full_prompt_20250518_164900.txt
2025-05-18 16:49:00,825 - chatbot_rag - INFO - System prompt: 
        Bạn là trợ lý AI phân tích câu hỏi để xác định:
        1. Phòng ban người dùng đang hỏi (department)
        2. Loại câu hỏi: phòng ban cụ thể hay chung (query_type)
        3. Nếu câu hỏi đ...
2025-05-18 16:49:00,825 - chatbot_rag - INFO - User prompt: Lịch sử tin nhắn:
        
        Câu hỏi người dùng hiện tại: "Lịch sử tin nhắn:
Người dùng: xin chào

xin chào"

        Phân tích câu hỏi và trả về JSON có định dạng:
        {"department": "tên p...
2025-05-18 16:49:00,826 - chatbot_rag - INFO - Gửi truy vấn đến LLM API tại http://192.168.0.43:1234/v1/chat/completions với stream=False
2025-05-18 16:49:21,859 - chatbot_rag - ERROR - Lỗi khi gọi LLM: HTTPConnectionPool(host='192.168.0.43', port=1234): Max retries exceeded with url: /v1/chat/completions (Caused by NewConnectionError('<urllib3.connection.HTTPConnection object at 0x00000198A0D43C70>: Failed to establish a new connection: [WinError 10060] A connection attempt failed because the connected party did not properly respond after a period of time, or established connection failed because connected host has failed to respond'))
2025-05-18 16:49:21,861 - chatbot_rag - INFO - [analysis_20250518_164921] Đã ghi phản hồi gốc vào: data/logs/analysis_20250518_164921_raw.txt
2025-05-18 16:49:21,861 - chatbot_rag - INFO - [analysis_20250518_164921] Phản hồi gốc: Đã xảy ra lỗi khi xử lý truy vấn: HTTPConnectionPool(host='192.168.0.43', port=1234): Max retries ex...
2025-05-18 16:49:21,862 - chatbot_rag - INFO - [analysis_20250518_164921] BƯỚC 1: Thử parse toàn bộ chuỗi phản hồi
2025-05-18 16:49:21,862 - chatbot_rag - INFO - [analysis_20250518_164921] BƯỚC 1: Không phải JSON hợp lệ: Expecting value: line 1 column 1 (char 0)
2025-05-18 16:49:21,863 - chatbot_rag - INFO - [analysis_20250518_164921] BƯỚC 2: Tìm JSON trong chuỗi phản hồi
2025-05-18 16:49:21,863 - chatbot_rag - WARNING - [analysis_20250518_164921] BƯỚC 2: Không tìm thấy mẫu JSON nào trong phản hồi
2025-05-18 16:49:21,863 - chatbot_rag - INFO - [analysis_20250518_164921] BƯỚC 3: Xử lý chuỗi thủ công để trích xuất thông tin
2025-05-18 16:49:21,868 - department_info_tool - INFO - Đã tải 11 phòng ban
2025-05-18 16:49:21,868 - department_info_tool - INFO - Đã lấy danh sách 11 phòng ban
2025-05-18 16:49:21,869 - chatbot_rag - ERROR - [analysis_20250518_164921] BƯỚC 3: Lỗi khi xử lý chuỗi thủ công: local variable 'query_type' referenced before assignment
2025-05-18 16:49:21,869 - chatbot_rag - WARNING - [analysis_20250518_164921] Tất cả phương pháp phân tích đều thất bại, trả về kết quả mặc định
2025-05-18 16:49:21,870 - websocket_server - INFO - Phân tích câu hỏi: Phòng ban=None, Loại=general, Thinking=False
2025-05-18 16:49:21,870 - websocket_server - INFO - Query thực tế gửi đến mô hình: xin chào /no_think
2025-05-18 16:49:21,870 - websocket_server - INFO - Câu hỏi chung, chế độ thinking: False
2025-05-18 16:49:21,871 - chatbot_rag - INFO - Xử lý câu hỏi chung cho session_id: d7451eae-0fd5-4eaf-8b36-d9f533d98c77
2025-05-18 16:49:21,876 - department_info_tool - INFO - Đã tải 11 phòng ban
2025-05-18 16:49:21,876 - department_info_tool - INFO - Đã lấy danh sách 11 phòng ban
2025-05-18 16:49:21,877 - chatbot_rag - INFO - Gọi LLM để trả lời câu hỏi chung cho session_id: d7451eae-0fd5-4eaf-8b36-d9f533d98c77
2025-05-18 16:49:21,879 - chatbot_rag - INFO - Đã lưu prompt vào file: data/logs/prompt_general_20250518_164921.txt
2025-05-18 16:49:21,880 - chatbot_rag - INFO - Kích thước prompt: 1630 ký tự
2025-05-18 16:49:21,880 - chatbot_rag - INFO - Kích thước system prompt: 1205 ký tự
2025-05-18 16:49:21,881 - chatbot_rag - INFO - Tổng kích thước: 2835 ký tự
2025-05-18 16:49:21,883 - chatbot_rag - INFO - Đã lưu full prompt vào file: data/logs/llm_full_prompt_20250518_164921.txt
2025-05-18 16:49:21,883 - chatbot_rag - INFO - System prompt: 
Bạn là trợ lý AI chuyên về quy trình và giai đoạn trong công ty.

CÁC PHÒNG BAN THAM GIA THEO GIAI ĐOẠN:
- MKT-SALES: Marketing, Kinh doanh
- PROPOSAL: Kinh doanh, Dự toán, Thiết kế, Team dự án
- CON...
2025-05-18 16:49:21,884 - chatbot_rag - INFO - User prompt: 
Câu hỏi: "xin chào /no_think"

Đây là câu hỏi chung về quy trình hoặc giai đoạn làm việc.

Thông tin cơ bản:
### Thông tin tổng quan về quy trình và giai đoạn

#### Giai đoạn chính trong quy trình:
1...
2025-05-18 16:49:21,885 - chatbot_rag - INFO - Gửi truy vấn đến LLM API tại http://192.168.0.43:1234/v1/chat/completions với stream=True
2025-05-18 16:49:42,928 - chatbot_rag - ERROR - Lỗi khi gọi LLM: HTTPConnectionPool(host='192.168.0.43', port=1234): Max retries exceeded with url: /v1/chat/completions (Caused by NewConnectionError('<urllib3.connection.HTTPConnection object at 0x00000198A0D4B820>: Failed to establish a new connection: [WinError 10060] A connection attempt failed because the connected party did not properly respond after a period of time, or established connection failed because connected host has failed to respond'))
2025-05-18 16:49:42,934 - websocket_server - INFO - Đã lưu hội thoại chung vào lịch sử của session d7451eae-0fd5-4eaf-8b36-d9f533d98c77
2025-05-18 16:49:42,936 - websockets.server - INFO - connection open
2025-05-18 16:51:46,475 - websockets.server - INFO - connection closed
2025-05-18 16:51:46,488 - websockets.server - INFO - connection closed
2025-05-18 16:51:46,491 - websockets.server - INFO - server closing
2025-05-18 16:51:46,493 - websockets.server - INFO - server closed
2025-05-18 16:51:46,504 - websocket_server - INFO - Server bị dừng bởi người dùng
2025-05-18 16:51:50,273 - websocket_server - INFO - Khởi động server WebSocket tại 0.0.0.0:8090
2025-05-18 16:51:50,333 - websockets.server - INFO - server listening on 0.0.0.0:8090
2025-05-18 16:51:50,333 - websocket_server - INFO - Server WebSocket đang chạy tại ws://0.0.0.0:8090
2025-05-18 16:51:50,335 - websocket_server - INFO - Đã cấu hình ping_timeout=6000 giây, ping_interval=60 giây
2025-05-18 16:51:55,890 - websockets.server - INFO - connection open
2025-05-18 16:51:58,265 - websocket_server - INFO - Nhận tin nhắn dạng JSON: {"content":"xin chào /no_think","session_id":""}
2025-05-18 16:51:58,266 - websocket_server - INFO - Session ID không được cung cấp trong tin nhắn JSON, sử dụng current_session_id: 40b42600-e648-49f8-b00c-549ce9aeebf0
2025-05-18 16:51:58,266 - websocket_server - INFO - Session ID từ client (sau khi kiểm tra): 40b42600-e648-49f8-b00c-549ce9aeebf0
2025-05-18 16:51:58,267 - websocket_server - INFO - Tắt chế độ thinking cho câu hỏi: xin chào /no_think...
2025-05-18 16:51:58,267 - websocket_server - INFO - Nhận tin nhắn thông thường: xin chào /no_think, enable_thinking=False
2025-05-18 16:51:58,267 - websocket_server - INFO - Không có lịch sử tin nhắn cho phiên này
2025-05-18 16:51:58,268 - chatbot_rag - INFO - Đang phân tích câu hỏi với LLM: xin chào /no_think, session_id: 40b42600-e648-49f8-b00c-549ce9aeebf0
2025-05-18 16:51:58,282 - chatbot_rag - INFO - [analyze_query_with_llm] Đã lấy được 0 bản ghi lịch sử từ websocket_server cho session 40b42600-e648-49f8-b00c-549ce9aeebf0
2025-05-18 16:51:58,283 - chatbot_rag - INFO - [analyze_query_with_llm] Sử dụng lịch sử hội thoại: 0 bản ghi
2025-05-18 16:51:58,283 - chatbot_rag - INFO - [analyze_query_with_llm] Prompt cuối cùng: Lịch sử tin nhắn:
        
        Câu hỏi người dùng hiện tại: "xin chào /no_think"

        Phân tích câu hỏi và trả về JSON có định dạng:
        {"department": "tên phòng ban hoặc null", "query_ty...
2025-05-18 16:51:58,284 - chatbot_rag - INFO - Kích thước prompt: 599 ký tự
2025-05-18 16:51:58,285 - chatbot_rag - INFO - Kích thước system prompt: 2004 ký tự
2025-05-18 16:51:58,285 - chatbot_rag - INFO - Tổng kích thước: 2603 ký tự
2025-05-18 16:51:58,288 - chatbot_rag - INFO - Đã lưu full prompt vào file: data/logs/llm_full_prompt_20250518_165158.txt
2025-05-18 16:51:58,288 - chatbot_rag - INFO - System prompt: 
        Bạn là trợ lý AI phân tích câu hỏi để xác định:
        1. Phòng ban người dùng đang hỏi (department)
        2. Loại câu hỏi: phòng ban cụ thể hay chung (query_type)
        3. Nếu câu hỏi đ...
2025-05-18 16:51:58,289 - chatbot_rag - INFO - User prompt: Lịch sử tin nhắn:
        
        Câu hỏi người dùng hiện tại: "xin chào /no_think"

        Phân tích câu hỏi và trả về JSON có định dạng:
        {"department": "tên phòng ban hoặc null", "query_ty...
2025-05-18 16:51:58,289 - chatbot_rag - INFO - Gửi truy vấn đến LLM API tại http://192.168.1.4:1234/v1/chat/completions với stream=False
2025-05-18 16:52:14,152 - chatbot_rag - INFO - Mã phản hồi từ API: 200
2025-05-18 16:52:14,152 - chatbot_rag - INFO - Phản hồi gốc từ LLM API (200 ký tự đầu): <think>

</think>

{"department": null, "query_type": "general", "error": false}
2025-05-18 16:52:14,154 - chatbot_rag - INFO - Đã lưu phản hồi đầy đủ vào file: data/logs/llm_response_20250518_165214.txt
2025-05-18 16:52:14,155 - chatbot_rag - INFO - [analysis_20250518_165214] Đã ghi phản hồi gốc vào: data/logs/analysis_20250518_165214_raw.txt
2025-05-18 16:52:14,156 - chatbot_rag - INFO - [analysis_20250518_165214] Phản hồi gốc: <think>

</think>

{"department": null, "query_type": "general", "error": false}...
2025-05-18 16:52:14,156 - chatbot_rag - WARNING - [analysis_20250518_165214] Phát hiện thẻ <think> trong phản hồi. Xử lý đặc biệt...
2025-05-18 16:52:14,158 - chatbot_rag - INFO - [analysis_20250518_165214] Đã tìm thấy 1 mẫu JSON tiềm năng trong phản hồi
2025-05-18 16:52:14,158 - chatbot_rag - INFO - [analysis_20250518_165214] Tìm thấy JSON hợp lệ trong thẻ <think>: {'department': None, 'query_type': 'general', 'error': False}
2025-05-18 16:52:14,159 - websocket_server - INFO - Phân tích câu hỏi: Phòng ban=None, Loại=general, Thinking=False
2025-05-18 16:52:14,161 - websocket_server - INFO - Xử lý streaming response cho: 'xin chào /no_think', phòng ban: None, session_id: 40b42600-e648-49f8-b00c-549ce9aeebf0
2025-05-18 16:52:14,162 - websocket_server - INFO - Session ID nhận được: 40b42600-e648-49f8-b00c-549ce9aeebf0
2025-05-18 16:52:14,162 - websocket_server - INFO - Phát hiện lệnh /no_think, tắt chế độ thinking cho: xin chào
2025-05-18 16:52:14,163 - websocket_server - INFO - Xử lý streaming response. Query: 'xin chào', Mode thinking: False
2025-05-18 16:52:14,163 - websocket_server - INFO - Không có lịch sử tin nhắn cho phiên này
2025-05-18 16:52:14,163 - chatbot_rag - INFO - Đang phân tích câu hỏi với LLM: xin chào, session_id: 40b42600-e648-49f8-b00c-549ce9aeebf0
2025-05-18 16:52:14,164 - chatbot_rag - INFO - [analyze_query_with_llm] Đã lấy được 0 bản ghi lịch sử từ websocket_server cho session 40b42600-e648-49f8-b00c-549ce9aeebf0
2025-05-18 16:52:14,164 - chatbot_rag - INFO - [analyze_query_with_llm] Sử dụng lịch sử hội thoại: 0 bản ghi
2025-05-18 16:52:14,165 - chatbot_rag - INFO - [analyze_query_with_llm] Prompt cuối cùng: Lịch sử tin nhắn:
        
        Câu hỏi người dùng hiện tại: "xin chào"

        Phân tích câu hỏi và trả về JSON có định dạng:
        {"department": "tên phòng ban hoặc null", "query_type": "depa...
2025-05-18 16:52:14,165 - chatbot_rag - INFO - Kích thước prompt: 589 ký tự
2025-05-18 16:52:14,166 - chatbot_rag - INFO - Kích thước system prompt: 2004 ký tự
2025-05-18 16:52:14,166 - chatbot_rag - INFO - Tổng kích thước: 2593 ký tự
2025-05-18 16:52:14,168 - chatbot_rag - INFO - Đã lưu full prompt vào file: data/logs/llm_full_prompt_20250518_165214.txt
2025-05-18 16:52:14,168 - chatbot_rag - INFO - System prompt: 
        Bạn là trợ lý AI phân tích câu hỏi để xác định:
        1. Phòng ban người dùng đang hỏi (department)
        2. Loại câu hỏi: phòng ban cụ thể hay chung (query_type)
        3. Nếu câu hỏi đ...
2025-05-18 16:52:14,168 - chatbot_rag - INFO - User prompt: Lịch sử tin nhắn:
        
        Câu hỏi người dùng hiện tại: "xin chào"

        Phân tích câu hỏi và trả về JSON có định dạng:
        {"department": "tên phòng ban hoặc null", "query_type": "depa...
2025-05-18 16:52:14,169 - chatbot_rag - INFO - Gửi truy vấn đến LLM API tại http://192.168.1.4:1234/v1/chat/completions với stream=False
2025-05-18 16:52:26,134 - chatbot_rag - INFO - Mã phản hồi từ API: 200
2025-05-18 16:52:26,135 - chatbot_rag - INFO - Phản hồi gốc từ LLM API (200 ký tự đầu): <think>
Okay, let's see. The user's current question is "xin chào", which means "hello" in Vietnamese. I need to analyze this based on the provided guidelines.

First, checking the history of messages
2025-05-18 16:52:26,136 - chatbot_rag - INFO - Đã lưu phản hồi đầy đủ vào file: data/logs/llm_response_20250518_165226.txt
2025-05-18 16:52:26,138 - chatbot_rag - INFO - [analysis_20250518_165226] Đã ghi phản hồi gốc vào: data/logs/analysis_20250518_165226_raw.txt
2025-05-18 16:52:26,139 - chatbot_rag - INFO - [analysis_20250518_165226] Phản hồi gốc: <think>
Okay, let's see. The user's current question is "xin chào", which means "hello" in Vietnames...
2025-05-18 16:52:26,139 - chatbot_rag - WARNING - [analysis_20250518_165226] Phát hiện thẻ <think> trong phản hồi. Xử lý đặc biệt...
2025-05-18 16:52:26,139 - chatbot_rag - INFO - [analysis_20250518_165226] BƯỚC 1: Thử parse toàn bộ chuỗi phản hồi
2025-05-18 16:52:26,140 - chatbot_rag - INFO - [analysis_20250518_165226] BƯỚC 1: Không phải JSON hợp lệ: Expecting value: line 1 column 1 (char 0)
2025-05-18 16:52:26,140 - chatbot_rag - INFO - [analysis_20250518_165226] BƯỚC 2: Tìm JSON trong chuỗi phản hồi
2025-05-18 16:52:26,140 - chatbot_rag - WARNING - [analysis_20250518_165226] BƯỚC 2: Không tìm thấy mẫu JSON nào trong phản hồi
2025-05-18 16:52:26,141 - chatbot_rag - INFO - [analysis_20250518_165226] BƯỚC 3: Xử lý chuỗi thủ công để trích xuất thông tin
2025-05-18 16:52:26,150 - department_info_tool - INFO - Đã tải 11 phòng ban
2025-05-18 16:52:26,150 - department_info_tool - INFO - Đã lấy danh sách 11 phòng ban
2025-05-18 16:52:26,150 - chatbot_rag - ERROR - [analysis_20250518_165226] BƯỚC 3: Lỗi khi xử lý chuỗi thủ công: local variable 'query_type' referenced before assignment
2025-05-18 16:52:26,151 - chatbot_rag - WARNING - [analysis_20250518_165226] Tất cả phương pháp phân tích đều thất bại, trả về kết quả mặc định
2025-05-18 16:52:26,151 - websocket_server - INFO - Phân tích câu hỏi: Phòng ban=None, Loại=general, Thinking=False
2025-05-18 16:52:26,151 - websocket_server - INFO - Query thực tế gửi đến mô hình: xin chào /no_think
2025-05-18 16:52:26,152 - websocket_server - INFO - Câu hỏi chung, chế độ thinking: False
2025-05-18 16:52:26,152 - chatbot_rag - INFO - Xử lý câu hỏi chung cho session_id: 40b42600-e648-49f8-b00c-549ce9aeebf0
2025-05-18 16:52:26,155 - department_info_tool - INFO - Đã tải 11 phòng ban
2025-05-18 16:52:26,155 - department_info_tool - INFO - Đã lấy danh sách 11 phòng ban
2025-05-18 16:52:26,156 - chatbot_rag - INFO - Gọi LLM để trả lời câu hỏi chung cho session_id: 40b42600-e648-49f8-b00c-549ce9aeebf0
2025-05-18 16:52:26,157 - chatbot_rag - INFO - Đã lưu prompt vào file: data/logs/prompt_general_20250518_165226.txt
2025-05-18 16:52:26,157 - chatbot_rag - INFO - Kích thước prompt: 1630 ký tự
2025-05-18 16:52:26,157 - chatbot_rag - INFO - Kích thước system prompt: 1205 ký tự
2025-05-18 16:52:26,157 - chatbot_rag - INFO - Tổng kích thước: 2835 ký tự
2025-05-18 16:52:26,158 - chatbot_rag - INFO - Đã lưu full prompt vào file: data/logs/llm_full_prompt_20250518_165226.txt
2025-05-18 16:52:26,159 - chatbot_rag - INFO - System prompt: 
Bạn là trợ lý AI chuyên về quy trình và giai đoạn trong công ty.

CÁC PHÒNG BAN THAM GIA THEO GIAI ĐOẠN:
- MKT-SALES: Marketing, Kinh doanh
- PROPOSAL: Kinh doanh, Dự toán, Thiết kế, Team dự án
- CON...
2025-05-18 16:52:26,159 - chatbot_rag - INFO - User prompt: 
Câu hỏi: "xin chào /no_think"

Đây là câu hỏi chung về quy trình hoặc giai đoạn làm việc.

Thông tin cơ bản:
### Thông tin tổng quan về quy trình và giai đoạn

#### Giai đoạn chính trong quy trình:
1...
2025-05-18 16:52:26,160 - chatbot_rag - INFO - Gửi truy vấn đến LLM API tại http://192.168.1.4:1234/v1/chat/completions với stream=True
2025-05-18 16:52:53,301 - chatbot_rag - INFO - Mã phản hồi từ API: 200
2025-05-18 16:52:53,301 - chatbot_rag - INFO - Phản hồi gốc từ LLM API (200 ký tự đầu): <think>

</think>

# Cấu trúc giai đoạn và quy trình làm việc

## Giai đoạn chính:
1. **MKT-SALES**: Marketing, Kinh doanh  
2. **PROPOSAL**: Kinh doanh, Dự toán, Thiết kế, Team dự án  
3. **CONSTRUCT
2025-05-18 16:52:53,303 - chatbot_rag - INFO - Đã lưu phản hồi đầy đủ vào file: data/logs/llm_response_20250518_165253.txt
2025-05-18 16:52:53,603 - websocket_server - INFO - Đã trích xuất thinking (0 ký tự) và còn lại 791 ký tự phản hồi
2025-05-18 16:52:53,603 - websocket_server - INFO - Đã trích xuất phần thinking (0 ký tự) từ phản hồi
2025-05-18 16:52:53,603 - websocket_server - INFO - Đã lưu hội thoại chung vào lịch sử của session 40b42600-e648-49f8-b00c-549ce9aeebf0
2025-05-18 16:53:15,075 - websocket_server - INFO - Nhận tin nhắn dạng JSON: {"content":"tôi đẹp trai không /no_think","session_id":""}
2025-05-18 16:53:15,076 - websocket_server - INFO - Session ID không được cung cấp trong tin nhắn JSON, sử dụng current_session_id: 40b42600-e648-49f8-b00c-549ce9aeebf0
2025-05-18 16:53:15,077 - websocket_server - INFO - Session ID từ client (sau khi kiểm tra): 40b42600-e648-49f8-b00c-549ce9aeebf0
2025-05-18 16:53:15,077 - websocket_server - INFO - Tắt chế độ thinking cho câu hỏi: tôi đẹp trai không /no_think...
2025-05-18 16:53:15,077 - websocket_server - INFO - Nhận tin nhắn thông thường: tôi đẹp trai không /no_think, enable_thinking=False
2025-05-18 16:53:15,078 - websocket_server - INFO - Đã thêm 1 tin nhắn gần nhất vào prompt
2025-05-18 16:53:15,079 - websocket_server - INFO - Đã lưu lịch sử tin nhắn và prompt vào file: data/logs/history_prompt_20250518_165315.txt
2025-05-18 16:53:15,079 - chatbot_rag - INFO - Đang phân tích câu hỏi với LLM: Lịch sử tin nhắn:
Người dùng: xin chào

tôi đẹp trai không /no_think, session_id: 40b42600-e648-49f8-b00c-549ce9aeebf0
2025-05-18 16:53:15,080 - chatbot_rag - INFO - [analyze_query_with_llm] Đã lấy được 0 bản ghi lịch sử từ websocket_server cho session 40b42600-e648-49f8-b00c-549ce9aeebf0
2025-05-18 16:53:15,080 - chatbot_rag - INFO - [analyze_query_with_llm] Sử dụng lịch sử hội thoại: 0 bản ghi
2025-05-18 16:53:15,080 - chatbot_rag - INFO - [analyze_query_with_llm] Prompt cuối cùng: Lịch sử tin nhắn:
        
        Câu hỏi người dùng hiện tại: "Lịch sử tin nhắn:
Người dùng: xin chào

tôi đẹp trai không /no_think"

        Phân tích câu hỏi và trả về JSON có định dạng:
        {...
2025-05-18 16:53:15,081 - chatbot_rag - INFO - Kích thước prompt: 649 ký tự
2025-05-18 16:53:15,081 - chatbot_rag - INFO - Kích thước system prompt: 2004 ký tự
2025-05-18 16:53:15,082 - chatbot_rag - INFO - Tổng kích thước: 2653 ký tự
2025-05-18 16:53:15,083 - chatbot_rag - INFO - Đã lưu full prompt vào file: data/logs/llm_full_prompt_20250518_165315.txt
2025-05-18 16:53:15,083 - chatbot_rag - INFO - System prompt: 
        Bạn là trợ lý AI phân tích câu hỏi để xác định:
        1. Phòng ban người dùng đang hỏi (department)
        2. Loại câu hỏi: phòng ban cụ thể hay chung (query_type)
        3. Nếu câu hỏi đ...
2025-05-18 16:53:15,084 - chatbot_rag - INFO - User prompt: Lịch sử tin nhắn:
        
        Câu hỏi người dùng hiện tại: "Lịch sử tin nhắn:
Người dùng: xin chào

tôi đẹp trai không /no_think"

        Phân tích câu hỏi và trả về JSON có định dạng:
        {...
2025-05-18 16:53:15,084 - chatbot_rag - INFO - Gửi truy vấn đến LLM API tại http://192.168.1.4:1234/v1/chat/completions với stream=False
2025-05-18 16:53:27,321 - chatbot_rag - INFO - Mã phản hồi từ API: 200
2025-05-18 16:53:27,322 - chatbot_rag - INFO - Phản hồi gốc từ LLM API (200 ký tự đầu): <think>

</think>

{"department": null, "query_type": "general", "error": false}
2025-05-18 16:53:27,323 - chatbot_rag - INFO - Đã lưu phản hồi đầy đủ vào file: data/logs/llm_response_20250518_165327.txt
2025-05-18 16:53:27,326 - chatbot_rag - INFO - [analysis_20250518_165327] Đã ghi phản hồi gốc vào: data/logs/analysis_20250518_165327_raw.txt
2025-05-18 16:53:27,327 - chatbot_rag - INFO - [analysis_20250518_165327] Phản hồi gốc: <think>

</think>

{"department": null, "query_type": "general", "error": false}...
2025-05-18 16:53:27,327 - chatbot_rag - WARNING - [analysis_20250518_165327] Phát hiện thẻ <think> trong phản hồi. Xử lý đặc biệt...
2025-05-18 16:53:27,328 - chatbot_rag - INFO - [analysis_20250518_165327] Đã tìm thấy 1 mẫu JSON tiềm năng trong phản hồi
2025-05-18 16:53:27,328 - chatbot_rag - INFO - [analysis_20250518_165327] Tìm thấy JSON hợp lệ trong thẻ <think>: {'department': None, 'query_type': 'general', 'error': False}
2025-05-18 16:53:27,328 - websocket_server - INFO - Phân tích câu hỏi: Phòng ban=None, Loại=general, Thinking=False
2025-05-18 16:53:27,329 - websocket_server - INFO - Xử lý streaming response cho: 'tôi đẹp trai không /no_think', phòng ban: None, session_id: 40b42600-e648-49f8-b00c-549ce9aeebf0
2025-05-18 16:53:27,329 - websocket_server - INFO - Session ID nhận được: 40b42600-e648-49f8-b00c-549ce9aeebf0
2025-05-18 16:53:27,330 - websocket_server - INFO - Phát hiện lệnh /no_think, tắt chế độ thinking cho: tôi đẹp trai không
2025-05-18 16:53:27,330 - websocket_server - INFO - Xử lý streaming response. Query: 'tôi đẹp trai không', Mode thinking: False
2025-05-18 16:53:27,330 - websocket_server - INFO - Đã thêm 1 tin nhắn gần nhất vào prompt
2025-05-18 16:53:27,332 - websocket_server - INFO - Đã lưu lịch sử tin nhắn và prompt vào file: data/logs/history_prompt_20250518_165327.txt
2025-05-18 16:53:27,332 - chatbot_rag - INFO - Đang phân tích câu hỏi với LLM: Lịch sử tin nhắn:
Người dùng: xin chào

tôi đẹp trai không, session_id: 40b42600-e648-49f8-b00c-549ce9aeebf0
2025-05-18 16:53:27,333 - chatbot_rag - INFO - [analyze_query_with_llm] Đã lấy được 0 bản ghi lịch sử từ websocket_server cho session 40b42600-e648-49f8-b00c-549ce9aeebf0
2025-05-18 16:53:27,333 - chatbot_rag - INFO - [analyze_query_with_llm] Sử dụng lịch sử hội thoại: 0 bản ghi
2025-05-18 16:53:27,333 - chatbot_rag - INFO - [analyze_query_with_llm] Prompt cuối cùng: Lịch sử tin nhắn:
        
        Câu hỏi người dùng hiện tại: "Lịch sử tin nhắn:
Người dùng: xin chào

tôi đẹp trai không"

        Phân tích câu hỏi và trả về JSON có định dạng:
        {"departmen...
2025-05-18 16:53:27,334 - chatbot_rag - INFO - Kích thước prompt: 639 ký tự
2025-05-18 16:53:27,334 - chatbot_rag - INFO - Kích thước system prompt: 2004 ký tự
2025-05-18 16:53:27,334 - chatbot_rag - INFO - Tổng kích thước: 2643 ký tự
2025-05-18 16:53:27,337 - chatbot_rag - INFO - Đã lưu full prompt vào file: data/logs/llm_full_prompt_20250518_165327.txt
2025-05-18 16:53:27,337 - chatbot_rag - INFO - System prompt: 
        Bạn là trợ lý AI phân tích câu hỏi để xác định:
        1. Phòng ban người dùng đang hỏi (department)
        2. Loại câu hỏi: phòng ban cụ thể hay chung (query_type)
        3. Nếu câu hỏi đ...
2025-05-18 16:53:27,338 - chatbot_rag - INFO - User prompt: Lịch sử tin nhắn:
        
        Câu hỏi người dùng hiện tại: "Lịch sử tin nhắn:
Người dùng: xin chào

tôi đẹp trai không"

        Phân tích câu hỏi và trả về JSON có định dạng:
        {"departmen...
2025-05-18 16:53:27,338 - chatbot_rag - INFO - Gửi truy vấn đến LLM API tại http://192.168.1.4:1234/v1/chat/completions với stream=False
2025-05-18 16:53:38,907 - chatbot_rag - INFO - Mã phản hồi từ API: 200
2025-05-18 16:53:38,907 - chatbot_rag - INFO - Phản hồi gốc từ LLM API (200 ký tự đầu): <think>
Okay, let's break this down. The user provided a conversation history where the first message is "xin chào" (hello) and then asks "tôi đẹp trai không" (am I handsome?). There's no mention of a
2025-05-18 16:53:38,910 - chatbot_rag - INFO - Đã lưu phản hồi đầy đủ vào file: data/logs/llm_response_20250518_165338.txt
2025-05-18 16:53:38,912 - chatbot_rag - INFO - [analysis_20250518_165338] Đã ghi phản hồi gốc vào: data/logs/analysis_20250518_165338_raw.txt
2025-05-18 16:53:38,912 - chatbot_rag - INFO - [analysis_20250518_165338] Phản hồi gốc: <think>
Okay, let's break this down. The user provided a conversation history where the first messag...
2025-05-18 16:53:38,912 - chatbot_rag - WARNING - [analysis_20250518_165338] Phát hiện thẻ <think> trong phản hồi. Xử lý đặc biệt...
2025-05-18 16:53:38,913 - chatbot_rag - INFO - [analysis_20250518_165338] Đã tìm thấy 1 mẫu JSON tiềm năng trong phản hồi
2025-05-18 16:53:38,913 - chatbot_rag - INFO - [analysis_20250518_165338] Tìm thấy JSON hợp lệ trong thẻ <think>: {'department': None, 'query_type': 'general', 'error': False}
2025-05-18 16:53:38,914 - websocket_server - INFO - Phân tích câu hỏi: Phòng ban=None, Loại=general, Thinking=False
2025-05-18 16:53:38,914 - websocket_server - INFO - Query thực tế gửi đến mô hình: tôi đẹp trai không /no_think
2025-05-18 16:53:38,914 - websocket_server - INFO - Câu hỏi chung, chế độ thinking: False
2025-05-18 16:53:38,915 - chatbot_rag - INFO - Xử lý câu hỏi chung cho session_id: 40b42600-e648-49f8-b00c-549ce9aeebf0
2025-05-18 16:53:38,917 - department_info_tool - INFO - Đã tải 11 phòng ban
2025-05-18 16:53:38,918 - department_info_tool - INFO - Đã lấy danh sách 11 phòng ban
2025-05-18 16:53:38,918 - chatbot_rag - INFO - Gọi LLM để trả lời câu hỏi chung cho session_id: 40b42600-e648-49f8-b00c-549ce9aeebf0
2025-05-18 16:53:38,920 - chatbot_rag - INFO - Đã lưu prompt vào file: data/logs/prompt_general_20250518_165338.txt
2025-05-18 16:53:38,921 - chatbot_rag - INFO - Kích thước prompt: 1640 ký tự
2025-05-18 16:53:38,921 - chatbot_rag - INFO - Kích thước system prompt: 1205 ký tự
2025-05-18 16:53:38,922 - chatbot_rag - INFO - Tổng kích thước: 2845 ký tự
2025-05-18 16:53:38,923 - chatbot_rag - INFO - Đã lưu full prompt vào file: data/logs/llm_full_prompt_20250518_165338.txt
2025-05-18 16:53:38,923 - chatbot_rag - INFO - System prompt: 
Bạn là trợ lý AI chuyên về quy trình và giai đoạn trong công ty.

CÁC PHÒNG BAN THAM GIA THEO GIAI ĐOẠN:
- MKT-SALES: Marketing, Kinh doanh
- PROPOSAL: Kinh doanh, Dự toán, Thiết kế, Team dự án
- CON...
2025-05-18 16:53:38,924 - chatbot_rag - INFO - User prompt: 
Câu hỏi: "tôi đẹp trai không /no_think"

Đây là câu hỏi chung về quy trình hoặc giai đoạn làm việc.

Thông tin cơ bản:
### Thông tin tổng quan về quy trình và giai đoạn

#### Giai đoạn chính trong qu...
2025-05-18 16:53:38,924 - chatbot_rag - INFO - Gửi truy vấn đến LLM API tại http://192.168.1.4:1234/v1/chat/completions với stream=True
2025-05-18 16:53:59,027 - chatbot_rag - INFO - Mã phản hồi từ API: 200
2025-05-18 16:53:59,028 - chatbot_rag - INFO - Phản hồi gốc từ LLM API (200 ký tự đầu): <think>

</think>

```markdown
# Câu hỏi không liên quan đến quy trình, giai đoạn hoặc phòng ban.

😎🔥 *TÔI ĐẸP TRAI!* 🔥😎  
👉 Nếu bạn muốn biết công ty làm gì trong từng giai đoạn, vui lòng hỏi về một 
2025-05-18 16:53:59,029 - chatbot_rag - INFO - Đã lưu phản hồi đầy đủ vào file: data/logs/llm_response_20250518_165359.txt
2025-05-18 16:53:59,032 - websocket_server - INFO - Đã trích xuất thinking (0 ký tự) và còn lại 397 ký tự phản hồi
2025-05-18 16:53:59,033 - websocket_server - INFO - Đã trích xuất phần thinking (0 ký tự) từ phản hồi
2025-05-18 16:53:59,033 - websocket_server - INFO - Đã lưu hội thoại chung vào lịch sử của session 40b42600-e648-49f8-b00c-549ce9aeebf0
2025-05-18 16:56:19,121 - websocket_server - WARNING - Session  không tồn tại, sử dụng session hiện tại
2025-05-18 16:56:19,122 - websocket_server - INFO - Nhận yêu cầu phân tích (thinking) cho câu hỏi: ```markdown
# Câu hỏi không liên quan đến quy trình, giai đoạn hoặc phòng ban.

😎🔥 *TÔI ĐẸP TRAI!* 🔥
2025-05-18 16:56:19,123 - websocket_server - INFO - Đã thêm 2 tin nhắn gần nhất vào prompt
2025-05-18 16:56:19,124 - websocket_server - INFO - Đã lưu lịch sử tin nhắn và prompt vào file: data/logs/history_prompt_20250518_165619.txt
2025-05-18 16:56:19,125 - websocket_server - INFO - Phân tích câu hỏi để xác định phòng ban hoặc loại câu hỏi
2025-05-18 16:56:19,126 - chatbot_rag - INFO - Đang phân tích câu hỏi với LLM: Lịch sử tin nhắn:
Người dùng: xin chào
Người dùng: tôi đẹp trai không

```markdown
# Câu hỏi không liên quan đến quy trình, giai đoạn hoặc phòng ban.

😎🔥 *TÔI ĐẸP TRAI!* 🔥😎  
👉 Nếu bạn muốn biết công ty làm gì trong từng giai đoạn, vui lòng hỏi về một giai đoạn cụ thể.  
👉 Nếu bạn muốn biết phòng ban nào làm gì, hãy hỏi riêng về một phòng ban!  
👉 Ví dụ: "Phòng Marketing tham gia giai đoạn nào?" hoặc "Giai đoạn MKT-SALES gồm những bước gì?"

💬 Hãy thử lại nhé!
```, session_id: 40b42600-e648-49f8-b00c-549ce9aeebf0
2025-05-18 16:56:19,127 - chatbot_rag - INFO - [analyze_query_with_llm] Đã lấy được 0 bản ghi lịch sử từ websocket_server cho session 40b42600-e648-49f8-b00c-549ce9aeebf0
2025-05-18 16:56:19,127 - chatbot_rag - INFO - [analyze_query_with_llm] Sử dụng lịch sử hội thoại: 0 bản ghi
2025-05-18 16:56:19,128 - chatbot_rag - INFO - [analyze_query_with_llm] Prompt cuối cùng: Lịch sử tin nhắn:
        
        Câu hỏi người dùng hiện tại: "Lịch sử tin nhắn:
Người dùng: xin chào
Người dùng: tôi đẹp trai không

```markdown
# Câu hỏi không liên quan đến quy trình, giai đoạn h...
2025-05-18 16:56:19,129 - chatbot_rag - INFO - Kích thước prompt: 1049 ký tự
2025-05-18 16:56:19,130 - chatbot_rag - INFO - Kích thước system prompt: 2004 ký tự
2025-05-18 16:56:19,130 - chatbot_rag - INFO - Tổng kích thước: 3053 ký tự
2025-05-18 16:56:19,133 - chatbot_rag - INFO - Đã lưu full prompt vào file: data/logs/llm_full_prompt_20250518_165619.txt
2025-05-18 16:56:19,134 - chatbot_rag - INFO - System prompt: 
        Bạn là trợ lý AI phân tích câu hỏi để xác định:
        1. Phòng ban người dùng đang hỏi (department)
        2. Loại câu hỏi: phòng ban cụ thể hay chung (query_type)
        3. Nếu câu hỏi đ...
2025-05-18 16:56:19,134 - chatbot_rag - INFO - User prompt: Lịch sử tin nhắn:
        
        Câu hỏi người dùng hiện tại: "Lịch sử tin nhắn:
Người dùng: xin chào
Người dùng: tôi đẹp trai không

```markdown
# Câu hỏi không liên quan đến quy trình, giai đoạn h...
2025-05-18 16:56:19,135 - chatbot_rag - INFO - Gửi truy vấn đến LLM API tại http://192.168.1.4:1234/v1/chat/completions với stream=False
2025-05-18 16:56:43,522 - chatbot_rag - INFO - Mã phản hồi từ API: 200
2025-05-18 16:56:43,523 - chatbot_rag - INFO - Phản hồi gốc từ LLM API (200 ký tự đầu): <think>
Okay, let's tackle this query. The user's current question is about their own appearance, asking "tôi đẹp trai không" which translates to "Am I handsome?" The history shows previous messages w
2025-05-18 16:56:43,525 - chatbot_rag - INFO - Đã lưu phản hồi đầy đủ vào file: data/logs/llm_response_20250518_165643.txt
2025-05-18 16:56:43,527 - chatbot_rag - INFO - [analysis_20250518_165643] Đã ghi phản hồi gốc vào: data/logs/analysis_20250518_165643_raw.txt
2025-05-18 16:56:43,528 - chatbot_rag - INFO - [analysis_20250518_165643] Phản hồi gốc: <think>
Okay, let's tackle this query. The user's current question is about their own appearance, as...
2025-05-18 16:56:43,528 - chatbot_rag - WARNING - [analysis_20250518_165643] Phát hiện thẻ <think> trong phản hồi. Xử lý đặc biệt...
2025-05-18 16:56:43,529 - chatbot_rag - INFO - [analysis_20250518_165643] BƯỚC 1: Thử parse toàn bộ chuỗi phản hồi
2025-05-18 16:56:43,529 - chatbot_rag - INFO - [analysis_20250518_165643] BƯỚC 1: Không phải JSON hợp lệ: Expecting value: line 1 column 1 (char 0)
2025-05-18 16:56:43,529 - chatbot_rag - INFO - [analysis_20250518_165643] BƯỚC 2: Tìm JSON trong chuỗi phản hồi
2025-05-18 16:56:43,530 - chatbot_rag - WARNING - [analysis_20250518_165643] BƯỚC 2: Không tìm thấy mẫu JSON nào trong phản hồi
2025-05-18 16:56:43,530 - chatbot_rag - INFO - [analysis_20250518_165643] BƯỚC 3: Xử lý chuỗi thủ công để trích xuất thông tin
2025-05-18 16:56:43,533 - department_info_tool - INFO - Đã tải 11 phòng ban
2025-05-18 16:56:43,534 - department_info_tool - INFO - Đã lấy danh sách 11 phòng ban
2025-05-18 16:56:43,534 - chatbot_rag - INFO - [analysis_20250518_165643] BƯỚC 3: Tìm thấy phòng ban trong câu hỏi: Marketing
2025-05-18 16:56:43,535 - chatbot_rag - ERROR - [analysis_20250518_165643] BƯỚC 3: Lỗi khi xử lý chuỗi thủ công: local variable 'query_type' referenced before assignment
2025-05-18 16:56:43,535 - chatbot_rag - WARNING - [analysis_20250518_165643] Tất cả phương pháp phân tích đều thất bại, trả về kết quả mặc định
2025-05-18 16:56:43,536 - websocket_server - INFO - Lấy phân tích cho câu hỏi chung
2025-05-18 16:56:43,536 - chatbot_rag - INFO - Xử lý câu hỏi chung cho session_id: 40b42600-e648-49f8-b00c-549ce9aeebf0
2025-05-18 16:56:43,538 - department_info_tool - INFO - Đã tải 11 phòng ban
2025-05-18 16:56:43,539 - department_info_tool - INFO - Đã lấy danh sách 11 phòng ban
2025-05-18 16:56:43,539 - chatbot_rag - INFO - Gọi LLM để trả lời câu hỏi chung cho session_id: 40b42600-e648-49f8-b00c-549ce9aeebf0
2025-05-18 16:56:43,540 - chatbot_rag - INFO - Đã lưu prompt vào file: data/logs/prompt_general_20250518_165643.txt
2025-05-18 16:56:43,541 - chatbot_rag - INFO - Kích thước prompt: 2016 ký tự
2025-05-18 16:56:43,541 - chatbot_rag - INFO - Kích thước system prompt: 1205 ký tự
2025-05-18 16:56:43,541 - chatbot_rag - INFO - Tổng kích thước: 3221 ký tự
2025-05-18 16:56:43,543 - chatbot_rag - INFO - Đã lưu full prompt vào file: data/logs/llm_full_prompt_20250518_165643.txt
2025-05-18 16:56:43,543 - chatbot_rag - INFO - System prompt: 
Bạn là trợ lý AI chuyên về quy trình và giai đoạn trong công ty.

CÁC PHÒNG BAN THAM GIA THEO GIAI ĐOẠN:
- MKT-SALES: Marketing, Kinh doanh
- PROPOSAL: Kinh doanh, Dự toán, Thiết kế, Team dự án
- CON...
2025-05-18 16:56:43,544 - chatbot_rag - INFO - User prompt: 
Câu hỏi: "```markdown
# Câu hỏi không liên quan đến quy trình, giai đoạn hoặc phòng ban.

😎🔥 *TÔI ĐẸP TRAI!* 🔥😎  
👉 Nếu bạn muốn biết công ty làm gì trong từng giai đoạn, vui lòng hỏi về một giai đoạ...
2025-05-18 16:56:43,544 - chatbot_rag - INFO - Gửi truy vấn đến LLM API tại http://192.168.1.4:1234/v1/chat/completions với stream=True
2025-05-18 16:57:26,651 - chatbot_rag - INFO - Mã phản hồi từ API: 200
2025-05-18 16:57:26,652 - chatbot_rag - INFO - Phản hồi gốc từ LLM API (200 ký tự đầu): <think>
Okay, the user provided a detailed query about their company's process and departments. They want me to structure the answer according to specific rules: no creating connections between depart
2025-05-18 16:57:26,654 - chatbot_rag - INFO - Đã lưu phản hồi đầy đủ vào file: data/logs/llm_response_20250518_165726.txt
2025-05-18 16:57:26,665 - websocket_server - INFO - Đã trích xuất thinking (1018 ký tự) và còn lại 764 ký tự phản hồi
2025-05-18 16:57:26,666 - websocket_server - INFO - Đã trích xuất phần thinking (1018 ký tự) từ phản hồi handle_general_query
2025-05-18 16:57:26,666 - websocket_server - INFO - Gửi phản hồi thinking với request_id: thinking_1747562179121_hy1v07z
2025-05-18 16:57:26,669 - websocket_server - INFO - Đã gửi nội dung thinking (1018 ký tự)
2025-05-18 16:57:26,671 - websocket_server - INFO - Nhận tin nhắn dạng JSON: {"content":"ủa mắc gì /no_think","session_id":""}
2025-05-18 16:57:26,671 - websocket_server - INFO - Session ID không được cung cấp trong tin nhắn JSON, sử dụng current_session_id: 40b42600-e648-49f8-b00c-549ce9aeebf0
2025-05-18 16:57:26,672 - websocket_server - INFO - Session ID từ client (sau khi kiểm tra): 40b42600-e648-49f8-b00c-549ce9aeebf0
2025-05-18 16:57:26,672 - websocket_server - INFO - Tắt chế độ thinking cho câu hỏi: ủa mắc gì /no_think...
2025-05-18 16:57:26,673 - websocket_server - INFO - Nhận tin nhắn thông thường: ủa mắc gì /no_think, enable_thinking=False
2025-05-18 16:57:26,673 - websocket_server - INFO - Đã thêm 2 tin nhắn gần nhất vào prompt
2025-05-18 16:57:26,675 - websocket_server - INFO - Đã lưu lịch sử tin nhắn và prompt vào file: data/logs/history_prompt_20250518_165726.txt
2025-05-18 16:57:26,676 - chatbot_rag - INFO - Đang phân tích câu hỏi với LLM: Lịch sử tin nhắn:
Người dùng: xin chào
Người dùng: tôi đẹp trai không

ủa mắc gì /no_think, session_id: 40b42600-e648-49f8-b00c-549ce9aeebf0
2025-05-18 16:57:26,677 - chatbot_rag - INFO - [analyze_query_with_llm] Đã lấy được 0 bản ghi lịch sử từ websocket_server cho session 40b42600-e648-49f8-b00c-549ce9aeebf0
2025-05-18 16:57:26,677 - chatbot_rag - INFO - [analyze_query_with_llm] Sử dụng lịch sử hội thoại: 0 bản ghi
2025-05-18 16:57:26,677 - chatbot_rag - INFO - [analyze_query_with_llm] Prompt cuối cùng: Lịch sử tin nhắn:
        
        Câu hỏi người dùng hiện tại: "Lịch sử tin nhắn:
Người dùng: xin chào
Người dùng: tôi đẹp trai không

ủa mắc gì /no_think"

        Phân tích câu hỏi và trả về JSON c...
2025-05-18 16:57:26,679 - chatbot_rag - INFO - Kích thước prompt: 671 ký tự
2025-05-18 16:57:26,680 - chatbot_rag - INFO - Kích thước system prompt: 2004 ký tự
2025-05-18 16:57:26,680 - chatbot_rag - INFO - Tổng kích thước: 2675 ký tự
2025-05-18 16:57:26,682 - chatbot_rag - INFO - Đã lưu full prompt vào file: data/logs/llm_full_prompt_20250518_165726.txt
2025-05-18 16:57:26,683 - chatbot_rag - INFO - System prompt: 
        Bạn là trợ lý AI phân tích câu hỏi để xác định:
        1. Phòng ban người dùng đang hỏi (department)
        2. Loại câu hỏi: phòng ban cụ thể hay chung (query_type)
        3. Nếu câu hỏi đ...
2025-05-18 16:57:26,689 - chatbot_rag - INFO - User prompt: Lịch sử tin nhắn:
        
        Câu hỏi người dùng hiện tại: "Lịch sử tin nhắn:
Người dùng: xin chào
Người dùng: tôi đẹp trai không

ủa mắc gì /no_think"

        Phân tích câu hỏi và trả về JSON c...
2025-05-18 16:57:26,690 - chatbot_rag - INFO - Gửi truy vấn đến LLM API tại http://192.168.1.4:1234/v1/chat/completions với stream=False
2025-05-18 16:57:39,187 - chatbot_rag - INFO - Mã phản hồi từ API: 200
2025-05-18 16:57:39,187 - chatbot_rag - INFO - Phản hồi gốc từ LLM API (200 ký tự đầu): <think>

</think>

{"department": null, "query_type": "general", "error": false}
2025-05-18 16:57:39,188 - chatbot_rag - INFO - Đã lưu phản hồi đầy đủ vào file: data/logs/llm_response_20250518_165739.txt
2025-05-18 16:57:39,190 - chatbot_rag - INFO - [analysis_20250518_165739] Đã ghi phản hồi gốc vào: data/logs/analysis_20250518_165739_raw.txt
2025-05-18 16:57:39,190 - chatbot_rag - INFO - [analysis_20250518_165739] Phản hồi gốc: <think>

</think>

{"department": null, "query_type": "general", "error": false}...
2025-05-18 16:57:39,191 - chatbot_rag - WARNING - [analysis_20250518_165739] Phát hiện thẻ <think> trong phản hồi. Xử lý đặc biệt...
2025-05-18 16:57:39,191 - chatbot_rag - INFO - [analysis_20250518_165739] Đã tìm thấy 1 mẫu JSON tiềm năng trong phản hồi
2025-05-18 16:57:39,192 - chatbot_rag - INFO - [analysis_20250518_165739] Tìm thấy JSON hợp lệ trong thẻ <think>: {'department': None, 'query_type': 'general', 'error': False}
2025-05-18 16:57:39,193 - websocket_server - INFO - Phân tích câu hỏi: Phòng ban=None, Loại=general, Thinking=False
2025-05-18 16:57:39,193 - websocket_server - INFO - Xử lý streaming response cho: 'ủa mắc gì /no_think', phòng ban: None, session_id: 40b42600-e648-49f8-b00c-549ce9aeebf0
2025-05-18 16:57:39,193 - websocket_server - INFO - Session ID nhận được: 40b42600-e648-49f8-b00c-549ce9aeebf0
2025-05-18 16:57:39,194 - websocket_server - INFO - Phát hiện lệnh /no_think, tắt chế độ thinking cho: ủa mắc gì
2025-05-18 16:57:39,194 - websocket_server - INFO - Xử lý streaming response. Query: 'ủa mắc gì', Mode thinking: False
2025-05-18 16:57:39,194 - websocket_server - INFO - Đã thêm 2 tin nhắn gần nhất vào prompt
2025-05-18 16:57:39,196 - websocket_server - INFO - Đã lưu lịch sử tin nhắn và prompt vào file: data/logs/history_prompt_20250518_165739.txt
2025-05-18 16:57:39,196 - chatbot_rag - INFO - Đang phân tích câu hỏi với LLM: Lịch sử tin nhắn:
Người dùng: xin chào
Người dùng: tôi đẹp trai không

ủa mắc gì, session_id: 40b42600-e648-49f8-b00c-549ce9aeebf0
2025-05-18 16:57:39,196 - chatbot_rag - INFO - [analyze_query_with_llm] Đã lấy được 0 bản ghi lịch sử từ websocket_server cho session 40b42600-e648-49f8-b00c-549ce9aeebf0
2025-05-18 16:57:39,197 - chatbot_rag - INFO - [analyze_query_with_llm] Sử dụng lịch sử hội thoại: 0 bản ghi
2025-05-18 16:57:39,197 - chatbot_rag - INFO - [analyze_query_with_llm] Prompt cuối cùng: Lịch sử tin nhắn:
        
        Câu hỏi người dùng hiện tại: "Lịch sử tin nhắn:
Người dùng: xin chào
Người dùng: tôi đẹp trai không

ủa mắc gì"

        Phân tích câu hỏi và trả về JSON có định dạn...
2025-05-18 16:57:39,198 - chatbot_rag - INFO - Kích thước prompt: 661 ký tự
2025-05-18 16:57:39,198 - chatbot_rag - INFO - Kích thước system prompt: 2004 ký tự
2025-05-18 16:57:39,199 - chatbot_rag - INFO - Tổng kích thước: 2665 ký tự
2025-05-18 16:57:39,201 - chatbot_rag - INFO - Đã lưu full prompt vào file: data/logs/llm_full_prompt_20250518_165739.txt
2025-05-18 16:57:39,202 - chatbot_rag - INFO - System prompt: 
        Bạn là trợ lý AI phân tích câu hỏi để xác định:
        1. Phòng ban người dùng đang hỏi (department)
        2. Loại câu hỏi: phòng ban cụ thể hay chung (query_type)
        3. Nếu câu hỏi đ...
2025-05-18 16:57:39,202 - chatbot_rag - INFO - User prompt: Lịch sử tin nhắn:
        
        Câu hỏi người dùng hiện tại: "Lịch sử tin nhắn:
Người dùng: xin chào
Người dùng: tôi đẹp trai không

ủa mắc gì"

        Phân tích câu hỏi và trả về JSON có định dạn...
2025-05-18 16:57:39,202 - chatbot_rag - INFO - Gửi truy vấn đến LLM API tại http://192.168.1.4:1234/v1/chat/completions với stream=False
2025-05-18 16:57:51,576 - chatbot_rag - INFO - Mã phản hồi từ API: 200
2025-05-18 16:57:51,576 - chatbot_rag - INFO - Phản hồi gốc từ LLM API (200 ký tự đầu): <think>
Okay, let's see. The user provided a history of messages where the user asked "xin chào" (hello) and then "tôi đẹp trai không" (am I handsome?). Now, the current question is "ủa mắc gì", which
2025-05-18 16:57:51,578 - chatbot_rag - INFO - Đã lưu phản hồi đầy đủ vào file: data/logs/llm_response_20250518_165751.txt
2025-05-18 16:57:51,581 - chatbot_rag - INFO - [analysis_20250518_165751] Đã ghi phản hồi gốc vào: data/logs/analysis_20250518_165751_raw.txt
2025-05-18 16:57:51,582 - chatbot_rag - INFO - [analysis_20250518_165751] Phản hồi gốc: <think>
Okay, let's see. The user provided a history of messages where the user asked "xin chào" (he...
2025-05-18 16:57:51,582 - chatbot_rag - WARNING - [analysis_20250518_165751] Phát hiện thẻ <think> trong phản hồi. Xử lý đặc biệt...
2025-05-18 16:57:51,583 - chatbot_rag - INFO - [analysis_20250518_165751] BƯỚC 1: Thử parse toàn bộ chuỗi phản hồi
2025-05-18 16:57:51,583 - chatbot_rag - INFO - [analysis_20250518_165751] BƯỚC 1: Không phải JSON hợp lệ: Expecting value: line 1 column 1 (char 0)
2025-05-18 16:57:51,584 - chatbot_rag - INFO - [analysis_20250518_165751] BƯỚC 2: Tìm JSON trong chuỗi phản hồi
2025-05-18 16:57:51,584 - chatbot_rag - WARNING - [analysis_20250518_165751] BƯỚC 2: Không tìm thấy mẫu JSON nào trong phản hồi
2025-05-18 16:57:51,585 - chatbot_rag - INFO - [analysis_20250518_165751] BƯỚC 3: Xử lý chuỗi thủ công để trích xuất thông tin
2025-05-18 16:57:51,592 - department_info_tool - INFO - Đã tải 11 phòng ban
2025-05-18 16:57:51,593 - department_info_tool - INFO - Đã lấy danh sách 11 phòng ban
2025-05-18 16:57:51,593 - chatbot_rag - ERROR - [analysis_20250518_165751] BƯỚC 3: Lỗi khi xử lý chuỗi thủ công: local variable 'query_type' referenced before assignment
2025-05-18 16:57:51,594 - chatbot_rag - WARNING - [analysis_20250518_165751] Tất cả phương pháp phân tích đều thất bại, trả về kết quả mặc định
2025-05-18 16:57:51,594 - websocket_server - INFO - Phân tích câu hỏi: Phòng ban=None, Loại=general, Thinking=False
2025-05-18 16:57:51,595 - websocket_server - INFO - Query thực tế gửi đến mô hình: ủa mắc gì /no_think
2025-05-18 16:57:51,595 - websocket_server - INFO - Câu hỏi chung, chế độ thinking: False
2025-05-18 16:57:51,595 - chatbot_rag - INFO - Xử lý câu hỏi chung cho session_id: 40b42600-e648-49f8-b00c-549ce9aeebf0
2025-05-18 16:57:51,600 - department_info_tool - INFO - Đã tải 11 phòng ban
2025-05-18 16:57:51,600 - department_info_tool - INFO - Đã lấy danh sách 11 phòng ban
2025-05-18 16:57:51,601 - chatbot_rag - INFO - Gọi LLM để trả lời câu hỏi chung cho session_id: 40b42600-e648-49f8-b00c-549ce9aeebf0
2025-05-18 16:57:51,602 - chatbot_rag - INFO - Đã lưu prompt vào file: data/logs/prompt_general_20250518_165751.txt
2025-05-18 16:57:51,603 - chatbot_rag - INFO - Kích thước prompt: 1631 ký tự
2025-05-18 16:57:51,603 - chatbot_rag - INFO - Kích thước system prompt: 1205 ký tự
2025-05-18 16:57:51,604 - chatbot_rag - INFO - Tổng kích thước: 2836 ký tự
2025-05-18 16:57:51,606 - chatbot_rag - INFO - Đã lưu full prompt vào file: data/logs/llm_full_prompt_20250518_165751.txt
2025-05-18 16:57:51,606 - chatbot_rag - INFO - System prompt: 
Bạn là trợ lý AI chuyên về quy trình và giai đoạn trong công ty.

CÁC PHÒNG BAN THAM GIA THEO GIAI ĐOẠN:
- MKT-SALES: Marketing, Kinh doanh
- PROPOSAL: Kinh doanh, Dự toán, Thiết kế, Team dự án
- CON...
2025-05-18 16:57:51,607 - chatbot_rag - INFO - User prompt: 
Câu hỏi: "ủa mắc gì /no_think"

Đây là câu hỏi chung về quy trình hoặc giai đoạn làm việc.

Thông tin cơ bản:
### Thông tin tổng quan về quy trình và giai đoạn

#### Giai đoạn chính trong quy trình:
...
2025-05-18 16:57:51,607 - chatbot_rag - INFO - Gửi truy vấn đến LLM API tại http://192.168.1.4:1234/v1/chat/completions với stream=True
2025-05-18 16:58:22,889 - chatbot_rag - INFO - Mã phản hồi từ API: 200
2025-05-18 16:58:22,890 - chatbot_rag - INFO - Phản hồi gốc từ LLM API (200 ký tự đầu): <think>

</think>

```markdown
# Cấu trúc giai đoạn và quy trình

## Giai đoạn chính:
1. **MKT-SALES**
2. **PROPOSAL**
3. **CONSTRUCTION**
4. **DEFECT-HANDOVER**
5. **AFTERSALE-MAINTENANCE**

## Giai 
2025-05-18 16:58:22,893 - chatbot_rag - INFO - Đã lưu phản hồi đầy đủ vào file: data/logs/llm_response_20250518_165822.txt
2025-05-18 16:58:22,898 - websocket_server - INFO - Đã trích xuất thinking (0 ký tự) và còn lại 898 ký tự phản hồi
2025-05-18 16:58:22,898 - websocket_server - INFO - Đã trích xuất phần thinking (0 ký tự) từ phản hồi
2025-05-18 16:58:22,898 - websocket_server - INFO - Đã lưu hội thoại chung vào lịch sử của session 40b42600-e648-49f8-b00c-549ce9aeebf0
2025-05-18 16:58:22,915 - websocket_server - INFO - WebSocket connection closed
2025-05-18 16:58:22,915 - websockets.server - INFO - connection closed
2025-05-18 16:58:22,924 - websockets.server - INFO - connection open
2025-05-18 17:03:10,270 - websockets.server - INFO - connection closed
2025-05-18 17:03:10,273 - websockets.server - INFO - server closing
2025-05-18 17:03:10,274 - websockets.server - INFO - server closed
2025-05-18 17:03:10,281 - websocket_server - INFO - Server bị dừng bởi người dùng
2025-05-18 17:03:12,253 - websocket_server - INFO - Khởi động server WebSocket tại 0.0.0.0:8090
2025-05-18 17:03:12,287 - websockets.server - INFO - server listening on 0.0.0.0:8090
2025-05-18 17:03:12,288 - websocket_server - INFO - Server WebSocket đang chạy tại ws://0.0.0.0:8090
2025-05-18 17:03:12,288 - websocket_server - INFO - Đã cấu hình ping_timeout=6000 giây, ping_interval=60 giây
2025-05-18 17:04:05,838 - websockets.server - INFO - connection open
2025-05-18 17:04:06,677 - websocket_server - INFO - Nhận tin nhắn dạng JSON: {"content":"xin chào, nay đi làm chán quá /no_think","session_id":""}
2025-05-18 17:04:06,678 - websocket_server - INFO - Session ID không được cung cấp trong tin nhắn JSON, sử dụng current_session_id: e06af9f8-3be4-4fd8-83f7-e5c65fd2f9ef
2025-05-18 17:04:06,678 - websocket_server - INFO - Session ID từ client (sau khi kiểm tra): e06af9f8-3be4-4fd8-83f7-e5c65fd2f9ef
2025-05-18 17:04:06,679 - websocket_server - INFO - Tắt chế độ thinking cho câu hỏi: xin chào, nay đi làm chán quá /no_think...
2025-05-18 17:04:06,679 - websocket_server - INFO - Nhận tin nhắn thông thường: xin chào, nay đi làm chán quá /no_think, enable_thinking=False
2025-05-18 17:04:06,679 - websocket_server - INFO - Không có lịch sử tin nhắn cho phiên này
2025-05-18 17:04:06,680 - chatbot_rag - INFO - Đang phân tích câu hỏi với LLM: xin chào, nay đi làm chán quá /no_think, session_id: e06af9f8-3be4-4fd8-83f7-e5c65fd2f9ef
2025-05-18 17:04:06,683 - chatbot_rag - INFO - [analyze_query_with_llm] Đã lấy được 0 bản ghi lịch sử từ websocket_server cho session e06af9f8-3be4-4fd8-83f7-e5c65fd2f9ef
2025-05-18 17:04:06,684 - chatbot_rag - INFO - [analyze_query_with_llm] Sử dụng lịch sử hội thoại: 0 bản ghi
2025-05-18 17:04:06,684 - chatbot_rag - INFO - [analyze_query_with_llm] Prompt cuối cùng: Lịch sử tin nhắn:
        
        Câu hỏi người dùng hiện tại: "xin chào, nay đi làm chán quá /no_think"

        Phân tích câu hỏi và trả về JSON có định dạng:
        {"department": "tên phòng ban ...
2025-05-18 17:04:06,684 - chatbot_rag - INFO - Kích thước prompt: 620 ký tự
2025-05-18 17:04:06,685 - chatbot_rag - INFO - Kích thước system prompt: 2006 ký tự
2025-05-18 17:04:06,685 - chatbot_rag - INFO - Tổng kích thước: 2626 ký tự
2025-05-18 17:04:06,687 - chatbot_rag - INFO - Đã lưu full prompt vào file: data/logs/llm_full_prompt_20250518_170406.txt
2025-05-18 17:04:06,687 - chatbot_rag - INFO - System prompt: 
        Bạn là trợ lý AI phân tích câu hỏi để xác định:
        1. Phòng ban người dùng đang hỏi (department)
        2. Loại câu hỏi: phòng ban cụ thể hay general (query_type)
        3. Nếu câu hỏi...
2025-05-18 17:04:06,688 - chatbot_rag - INFO - User prompt: Lịch sử tin nhắn:
        
        Câu hỏi người dùng hiện tại: "xin chào, nay đi làm chán quá /no_think"

        Phân tích câu hỏi và trả về JSON có định dạng:
        {"department": "tên phòng ban ...
2025-05-18 17:04:06,688 - chatbot_rag - INFO - Gửi truy vấn đến LLM API tại http://192.168.1.4:1234/v1/chat/completions với stream=False
2025-05-18 17:04:19,632 - chatbot_rag - INFO - Mã phản hồi từ API: 200
2025-05-18 17:04:19,633 - chatbot_rag - INFO - Phản hồi gốc từ LLM API (200 ký tự đầu): <think>

</think>

{"department": null, "query_type": "general", "error": false}
2025-05-18 17:04:19,634 - chatbot_rag - INFO - Đã lưu phản hồi đầy đủ vào file: data/logs/llm_response_20250518_170419.txt
2025-05-18 17:04:19,636 - chatbot_rag - INFO - [analysis_20250518_170419] Đã ghi phản hồi gốc vào: data/logs/analysis_20250518_170419_raw.txt
2025-05-18 17:04:19,636 - chatbot_rag - INFO - [analysis_20250518_170419] Phản hồi gốc: <think>

</think>

{"department": null, "query_type": "general", "error": false}...
2025-05-18 17:04:19,637 - chatbot_rag - WARNING - [analysis_20250518_170419] Phát hiện thẻ <think> trong phản hồi. Xử lý đặc biệt...
2025-05-18 17:04:19,637 - chatbot_rag - INFO - [analysis_20250518_170419] Đã tìm thấy 1 mẫu JSON tiềm năng trong phản hồi
2025-05-18 17:04:19,638 - chatbot_rag - INFO - [analysis_20250518_170419] Tìm thấy JSON hợp lệ trong thẻ <think>: {'department': None, 'query_type': 'general', 'error': False}
2025-05-18 17:04:19,639 - websocket_server - INFO - Phân tích câu hỏi: Phòng ban=None, Loại=general, Thinking=False
2025-05-18 17:04:19,639 - websocket_server - INFO - Xử lý streaming response cho: 'xin chào, nay đi làm chán quá /no_think', phòng ban: None, session_id: e06af9f8-3be4-4fd8-83f7-e5c65fd2f9ef
2025-05-18 17:04:19,639 - websocket_server - INFO - Session ID nhận được: e06af9f8-3be4-4fd8-83f7-e5c65fd2f9ef
2025-05-18 17:04:19,639 - websocket_server - INFO - Phát hiện lệnh /no_think, tắt chế độ thinking cho: xin chào, nay đi làm chán quá
2025-05-18 17:04:19,640 - websocket_server - INFO - Xử lý streaming response. Query: 'xin chào, nay đi làm chán quá', Mode thinking: False
2025-05-18 17:04:19,640 - websocket_server - INFO - Không có lịch sử tin nhắn cho phiên này
2025-05-18 17:04:19,640 - chatbot_rag - INFO - Đang phân tích câu hỏi với LLM: xin chào, nay đi làm chán quá, session_id: e06af9f8-3be4-4fd8-83f7-e5c65fd2f9ef
2025-05-18 17:04:19,640 - chatbot_rag - INFO - [analyze_query_with_llm] Đã lấy được 0 bản ghi lịch sử từ websocket_server cho session e06af9f8-3be4-4fd8-83f7-e5c65fd2f9ef
2025-05-18 17:04:19,641 - chatbot_rag - INFO - [analyze_query_with_llm] Sử dụng lịch sử hội thoại: 0 bản ghi
2025-05-18 17:04:19,641 - chatbot_rag - INFO - [analyze_query_with_llm] Prompt cuối cùng: Lịch sử tin nhắn:
        
        Câu hỏi người dùng hiện tại: "xin chào, nay đi làm chán quá"

        Phân tích câu hỏi và trả về JSON có định dạng:
        {"department": "tên phòng ban hoặc null"...
2025-05-18 17:04:19,641 - chatbot_rag - INFO - Kích thước prompt: 610 ký tự
2025-05-18 17:04:19,642 - chatbot_rag - INFO - Kích thước system prompt: 2006 ký tự
2025-05-18 17:04:19,642 - chatbot_rag - INFO - Tổng kích thước: 2616 ký tự
2025-05-18 17:04:19,645 - chatbot_rag - INFO - Đã lưu full prompt vào file: data/logs/llm_full_prompt_20250518_170419.txt
2025-05-18 17:04:19,646 - chatbot_rag - INFO - System prompt: 
        Bạn là trợ lý AI phân tích câu hỏi để xác định:
        1. Phòng ban người dùng đang hỏi (department)
        2. Loại câu hỏi: phòng ban cụ thể hay general (query_type)
        3. Nếu câu hỏi...
2025-05-18 17:04:19,646 - chatbot_rag - INFO - User prompt: Lịch sử tin nhắn:
        
        Câu hỏi người dùng hiện tại: "xin chào, nay đi làm chán quá"

        Phân tích câu hỏi và trả về JSON có định dạng:
        {"department": "tên phòng ban hoặc null"...
2025-05-18 17:04:19,647 - chatbot_rag - INFO - Gửi truy vấn đến LLM API tại http://192.168.1.4:1234/v1/chat/completions với stream=False
2025-05-18 17:04:29,916 - chatbot_rag - INFO - Mã phản hồi từ API: 200
2025-05-18 17:04:29,917 - chatbot_rag - INFO - Phản hồi gốc từ LLM API (200 ký tự đầu): <think>
Okay, let's break this down. The user's current question is "xin chào, nay đi làm chán quá." First, I need to determine the department. Since there's no mention of any specific department in t
2025-05-18 17:04:29,918 - chatbot_rag - INFO - Đã lưu phản hồi đầy đủ vào file: data/logs/llm_response_20250518_170429.txt
2025-05-18 17:04:29,921 - chatbot_rag - INFO - [analysis_20250518_170429] Đã ghi phản hồi gốc vào: data/logs/analysis_20250518_170429_raw.txt
2025-05-18 17:04:29,921 - chatbot_rag - INFO - [analysis_20250518_170429] Phản hồi gốc: <think>
Okay, let's break this down. The user's current question is "xin chào, nay đi làm chán quá."...
2025-05-18 17:04:29,921 - chatbot_rag - WARNING - [analysis_20250518_170429] Phát hiện thẻ <think> trong phản hồi. Xử lý đặc biệt...
2025-05-18 17:04:29,922 - chatbot_rag - INFO - [analysis_20250518_170429] Đã tìm thấy 1 mẫu JSON tiềm năng trong phản hồi
2025-05-18 17:04:29,922 - chatbot_rag - INFO - [analysis_20250518_170429] Tìm thấy JSON hợp lệ trong thẻ <think>: {'department': None, 'query_type': 'general', 'error': False}
2025-05-18 17:04:29,923 - websocket_server - INFO - Phân tích câu hỏi: Phòng ban=None, Loại=general, Thinking=False
2025-05-18 17:04:29,923 - websocket_server - INFO - Query thực tế gửi đến mô hình: xin chào, nay đi làm chán quá /no_think
2025-05-18 17:04:29,923 - websocket_server - INFO - Câu hỏi chung, chế độ thinking: False
2025-05-18 17:04:29,923 - chatbot_rag - INFO - Xử lý câu hỏi chung cho session_id: e06af9f8-3be4-4fd8-83f7-e5c65fd2f9ef
2025-05-18 17:04:29,928 - department_info_tool - INFO - Đã tải 11 phòng ban
2025-05-18 17:04:29,929 - department_info_tool - INFO - Đã lấy danh sách 11 phòng ban
2025-05-18 17:04:29,929 - chatbot_rag - INFO - Gọi LLM để trả lời câu hỏi chung cho session_id: e06af9f8-3be4-4fd8-83f7-e5c65fd2f9ef
2025-05-18 17:04:29,930 - chatbot_rag - INFO - Đã lưu prompt vào file: data/logs/prompt_general_20250518_170429.txt
2025-05-18 17:04:29,931 - chatbot_rag - INFO - Kích thước prompt: 1155 ký tự
2025-05-18 17:04:29,932 - chatbot_rag - INFO - Kích thước system prompt: 1205 ký tự
2025-05-18 17:04:29,932 - chatbot_rag - INFO - Tổng kích thước: 2360 ký tự
2025-05-18 17:04:29,935 - chatbot_rag - INFO - Đã lưu full prompt vào file: data/logs/llm_full_prompt_20250518_170429.txt
2025-05-18 17:04:29,936 - chatbot_rag - INFO - System prompt: 
Bạn là trợ lý AI chuyên về quy trình và giai đoạn trong công ty.

CÁC PHÒNG BAN THAM GIA THEO GIAI ĐOẠN:
- MKT-SALES: Marketing, Kinh doanh
- PROPOSAL: Kinh doanh, Dự toán, Thiết kế, Team dự án
- CON...
2025-05-18 17:04:29,937 - chatbot_rag - INFO - User prompt: 
Câu hỏi: "xin chào, nay đi làm chán quá /no_think"

Đây là câu hỏi chung về quy trình hoặc giai đoạn làm việc.

Thông tin cơ bản:
### Thông tin tổng quan về quy trình và giai đoạn

#### Giai đoạn chí...
2025-05-18 17:04:29,938 - chatbot_rag - INFO - Gửi truy vấn đến LLM API tại http://192.168.1.4:1234/v1/chat/completions với stream=True
2025-05-18 17:04:44,431 - chatbot_rag - INFO - Mã phản hồi từ API: 200
2025-05-18 17:04:44,431 - chatbot_rag - INFO - Phản hồi gốc từ LLM API (200 ký tự đầu): <think>

</think>

 Xin chào 😎  
Đi làm chán quá à? 🙃 Đừng buồn nha, có gì cứ nói cho mình biết nhé! 💬✨  
Chúc bạn luôn vui vẻ và hứng thú với công việc của mình nhé! 🌟🌈
2025-05-18 17:04:44,433 - chatbot_rag - INFO - Đã lưu phản hồi đầy đủ vào file: data/logs/llm_response_20250518_170444.txt
2025-05-18 17:04:44,668 - websocket_server - INFO - Đã trích xuất thinking (0 ký tự) và còn lại 149 ký tự phản hồi
2025-05-18 17:04:44,669 - websocket_server - INFO - Đã trích xuất phần thinking (0 ký tự) từ phản hồi
2025-05-18 17:04:44,669 - websocket_server - INFO - Đã lưu hội thoại chung vào lịch sử của session e06af9f8-3be4-4fd8-83f7-e5c65fd2f9ef
2025-05-18 17:05:13,848 - websocket_server - INFO - Nhận tin nhắn dạng JSON: {"content":"nay tui bị sếp la /no_think","session_id":""}
2025-05-18 17:05:13,849 - websocket_server - INFO - Session ID không được cung cấp trong tin nhắn JSON, sử dụng current_session_id: e06af9f8-3be4-4fd8-83f7-e5c65fd2f9ef
2025-05-18 17:05:13,849 - websocket_server - INFO - Session ID từ client (sau khi kiểm tra): e06af9f8-3be4-4fd8-83f7-e5c65fd2f9ef
2025-05-18 17:05:13,850 - websocket_server - INFO - Tắt chế độ thinking cho câu hỏi: nay tui bị sếp la /no_think...
2025-05-18 17:05:13,850 - websocket_server - INFO - Nhận tin nhắn thông thường: nay tui bị sếp la /no_think, enable_thinking=False
2025-05-18 17:05:13,851 - websocket_server - INFO - Đã thêm 1 tin nhắn gần nhất vào prompt
2025-05-18 17:05:13,853 - websocket_server - INFO - Đã lưu lịch sử tin nhắn và prompt vào file: data/logs/history_prompt_20250518_170513.txt
2025-05-18 17:05:13,854 - chatbot_rag - INFO - Đang phân tích câu hỏi với LLM: Lịch sử tin nhắn:
Người dùng: xin chào, nay đi làm chán quá

nay tui bị sếp la /no_think, session_id: e06af9f8-3be4-4fd8-83f7-e5c65fd2f9ef
2025-05-18 17:05:13,854 - chatbot_rag - INFO - [analyze_query_with_llm] Đã lấy được 0 bản ghi lịch sử từ websocket_server cho session e06af9f8-3be4-4fd8-83f7-e5c65fd2f9ef
2025-05-18 17:05:13,855 - chatbot_rag - INFO - [analyze_query_with_llm] Sử dụng lịch sử hội thoại: 0 bản ghi
2025-05-18 17:05:13,856 - chatbot_rag - INFO - [analyze_query_with_llm] Prompt cuối cùng: Lịch sử tin nhắn:
        
        Câu hỏi người dùng hiện tại: "Lịch sử tin nhắn:
Người dùng: xin chào, nay đi làm chán quá

nay tui bị sếp la /no_think"

        Phân tích câu hỏi và trả về JSON có ...
2025-05-18 17:05:13,856 - chatbot_rag - INFO - Kích thước prompt: 669 ký tự
2025-05-18 17:05:13,857 - chatbot_rag - INFO - Kích thước system prompt: 2006 ký tự
2025-05-18 17:05:13,857 - chatbot_rag - INFO - Tổng kích thước: 2675 ký tự
2025-05-18 17:05:13,859 - chatbot_rag - INFO - Đã lưu full prompt vào file: data/logs/llm_full_prompt_20250518_170513.txt
2025-05-18 17:05:13,860 - chatbot_rag - INFO - System prompt: 
        Bạn là trợ lý AI phân tích câu hỏi để xác định:
        1. Phòng ban người dùng đang hỏi (department)
        2. Loại câu hỏi: phòng ban cụ thể hay general (query_type)
        3. Nếu câu hỏi...
2025-05-18 17:05:13,860 - chatbot_rag - INFO - User prompt: Lịch sử tin nhắn:
        
        Câu hỏi người dùng hiện tại: "Lịch sử tin nhắn:
Người dùng: xin chào, nay đi làm chán quá

nay tui bị sếp la /no_think"

        Phân tích câu hỏi và trả về JSON có ...
2025-05-18 17:05:13,861 - chatbot_rag - INFO - Gửi truy vấn đến LLM API tại http://192.168.1.4:1234/v1/chat/completions với stream=False
2025-05-18 17:05:26,448 - chatbot_rag - INFO - Mã phản hồi từ API: 200
2025-05-18 17:05:26,449 - chatbot_rag - INFO - Phản hồi gốc từ LLM API (200 ký tự đầu): <think>

</think>

{"department": null, "query_type": "general", "error": false}
2025-05-18 17:05:26,451 - chatbot_rag - INFO - Đã lưu phản hồi đầy đủ vào file: data/logs/llm_response_20250518_170526.txt
2025-05-18 17:05:26,452 - chatbot_rag - INFO - [analysis_20250518_170526] Đã ghi phản hồi gốc vào: data/logs/analysis_20250518_170526_raw.txt
2025-05-18 17:05:26,452 - chatbot_rag - INFO - [analysis_20250518_170526] Phản hồi gốc: <think>

</think>

{"department": null, "query_type": "general", "error": false}...
2025-05-18 17:05:26,452 - chatbot_rag - WARNING - [analysis_20250518_170526] Phát hiện thẻ <think> trong phản hồi. Xử lý đặc biệt...
2025-05-18 17:05:26,454 - chatbot_rag - INFO - [analysis_20250518_170526] Đã tìm thấy 1 mẫu JSON tiềm năng trong phản hồi
2025-05-18 17:05:26,454 - chatbot_rag - INFO - [analysis_20250518_170526] Tìm thấy JSON hợp lệ trong thẻ <think>: {'department': None, 'query_type': 'general', 'error': False}
2025-05-18 17:05:26,454 - websocket_server - INFO - Phân tích câu hỏi: Phòng ban=None, Loại=general, Thinking=False
2025-05-18 17:05:26,455 - websocket_server - INFO - Xử lý streaming response cho: 'nay tui bị sếp la /no_think', phòng ban: None, session_id: e06af9f8-3be4-4fd8-83f7-e5c65fd2f9ef
2025-05-18 17:05:26,455 - websocket_server - INFO - Session ID nhận được: e06af9f8-3be4-4fd8-83f7-e5c65fd2f9ef
2025-05-18 17:05:26,455 - websocket_server - INFO - Phát hiện lệnh /no_think, tắt chế độ thinking cho: nay tui bị sếp la
2025-05-18 17:05:26,455 - websocket_server - INFO - Xử lý streaming response. Query: 'nay tui bị sếp la', Mode thinking: False
2025-05-18 17:05:26,455 - websocket_server - INFO - Đã thêm 1 tin nhắn gần nhất vào prompt
2025-05-18 17:05:26,456 - websocket_server - INFO - Đã lưu lịch sử tin nhắn và prompt vào file: data/logs/history_prompt_20250518_170526.txt
2025-05-18 17:05:26,457 - chatbot_rag - INFO - Đang phân tích câu hỏi với LLM: Lịch sử tin nhắn:
Người dùng: xin chào, nay đi làm chán quá

nay tui bị sếp la, session_id: e06af9f8-3be4-4fd8-83f7-e5c65fd2f9ef
2025-05-18 17:05:26,459 - chatbot_rag - INFO - [analyze_query_with_llm] Đã lấy được 0 bản ghi lịch sử từ websocket_server cho session e06af9f8-3be4-4fd8-83f7-e5c65fd2f9ef
2025-05-18 17:05:26,459 - chatbot_rag - INFO - [analyze_query_with_llm] Sử dụng lịch sử hội thoại: 0 bản ghi
2025-05-18 17:05:26,461 - chatbot_rag - INFO - [analyze_query_with_llm] Prompt cuối cùng: Lịch sử tin nhắn:
        
        Câu hỏi người dùng hiện tại: "Lịch sử tin nhắn:
Người dùng: xin chào, nay đi làm chán quá

nay tui bị sếp la"

        Phân tích câu hỏi và trả về JSON có định dạng:...
2025-05-18 17:05:26,462 - chatbot_rag - INFO - Kích thước prompt: 659 ký tự
2025-05-18 17:05:26,462 - chatbot_rag - INFO - Kích thước system prompt: 2006 ký tự
2025-05-18 17:05:26,463 - chatbot_rag - INFO - Tổng kích thước: 2665 ký tự
2025-05-18 17:05:26,464 - chatbot_rag - INFO - Đã lưu full prompt vào file: data/logs/llm_full_prompt_20250518_170526.txt
2025-05-18 17:05:26,464 - chatbot_rag - INFO - System prompt: 
        Bạn là trợ lý AI phân tích câu hỏi để xác định:
        1. Phòng ban người dùng đang hỏi (department)
        2. Loại câu hỏi: phòng ban cụ thể hay general (query_type)
        3. Nếu câu hỏi...
2025-05-18 17:05:26,465 - chatbot_rag - INFO - User prompt: Lịch sử tin nhắn:
        
        Câu hỏi người dùng hiện tại: "Lịch sử tin nhắn:
Người dùng: xin chào, nay đi làm chán quá

nay tui bị sếp la"

        Phân tích câu hỏi và trả về JSON có định dạng:...
2025-05-18 17:05:26,465 - chatbot_rag - INFO - Gửi truy vấn đến LLM API tại http://192.168.1.4:1234/v1/chat/completions với stream=False
2025-05-18 17:05:39,056 - chatbot_rag - INFO - Mã phản hồi từ API: 200
2025-05-18 17:05:39,056 - chatbot_rag - INFO - Phản hồi gốc từ LLM API (200 ký tự đầu): <think>
Okay, let me try to figure this out. The user's current question is about their work history and being scolded by their boss. They mentioned "nay tui bị sếp la" which translates to something l
2025-05-18 17:05:39,060 - chatbot_rag - INFO - Đã lưu phản hồi đầy đủ vào file: data/logs/llm_response_20250518_170539.txt
2025-05-18 17:05:39,064 - chatbot_rag - INFO - [analysis_20250518_170539] Đã ghi phản hồi gốc vào: data/logs/analysis_20250518_170539_raw.txt
2025-05-18 17:05:39,064 - chatbot_rag - INFO - [analysis_20250518_170539] Phản hồi gốc: <think>
Okay, let me try to figure this out. The user's current question is about their work history...
2025-05-18 17:05:39,064 - chatbot_rag - WARNING - [analysis_20250518_170539] Phát hiện thẻ <think> trong phản hồi. Xử lý đặc biệt...
2025-05-18 17:05:39,065 - chatbot_rag - INFO - [analysis_20250518_170539] BƯỚC 1: Thử parse toàn bộ chuỗi phản hồi
2025-05-18 17:05:39,065 - chatbot_rag - INFO - [analysis_20250518_170539] BƯỚC 1: Không phải JSON hợp lệ: Expecting value: line 1 column 1 (char 0)
2025-05-18 17:05:39,065 - chatbot_rag - INFO - [analysis_20250518_170539] BƯỚC 2: Tìm JSON trong chuỗi phản hồi
2025-05-18 17:05:39,066 - chatbot_rag - WARNING - [analysis_20250518_170539] BƯỚC 2: Không tìm thấy mẫu JSON nào trong phản hồi
2025-05-18 17:05:39,066 - chatbot_rag - INFO - [analysis_20250518_170539] BƯỚC 3: Xử lý chuỗi thủ công để trích xuất thông tin
2025-05-18 17:05:39,070 - department_info_tool - INFO - Đã tải 11 phòng ban
2025-05-18 17:05:39,070 - department_info_tool - INFO - Đã lấy danh sách 11 phòng ban
2025-05-18 17:05:39,070 - chatbot_rag - ERROR - [analysis_20250518_170539] BƯỚC 3: Lỗi khi xử lý chuỗi thủ công: local variable 'query_type' referenced before assignment
2025-05-18 17:05:39,071 - chatbot_rag - WARNING - [analysis_20250518_170539] Tất cả phương pháp phân tích đều thất bại, trả về kết quả mặc định
2025-05-18 17:05:39,071 - websocket_server - INFO - Phân tích câu hỏi: Phòng ban=None, Loại=general, Thinking=False
2025-05-18 17:05:39,071 - websocket_server - INFO - Query thực tế gửi đến mô hình: nay tui bị sếp la /no_think
2025-05-18 17:05:39,072 - websocket_server - INFO - Câu hỏi chung, chế độ thinking: False
2025-05-18 17:05:39,072 - chatbot_rag - INFO - Xử lý câu hỏi chung cho session_id: e06af9f8-3be4-4fd8-83f7-e5c65fd2f9ef
2025-05-18 17:05:39,076 - department_info_tool - INFO - Đã tải 11 phòng ban
2025-05-18 17:05:39,077 - department_info_tool - INFO - Đã lấy danh sách 11 phòng ban
2025-05-18 17:05:39,077 - chatbot_rag - INFO - Gọi LLM để trả lời câu hỏi chung cho session_id: e06af9f8-3be4-4fd8-83f7-e5c65fd2f9ef
2025-05-18 17:05:39,079 - chatbot_rag - INFO - Đã lưu prompt vào file: data/logs/prompt_general_20250518_170539.txt
2025-05-18 17:05:39,079 - chatbot_rag - INFO - Kích thước prompt: 1143 ký tự
2025-05-18 17:05:39,080 - chatbot_rag - INFO - Kích thước system prompt: 1205 ký tự
2025-05-18 17:05:39,080 - chatbot_rag - INFO - Tổng kích thước: 2348 ký tự
2025-05-18 17:05:39,082 - chatbot_rag - INFO - Đã lưu full prompt vào file: data/logs/llm_full_prompt_20250518_170539.txt
2025-05-18 17:05:39,082 - chatbot_rag - INFO - System prompt: 
Bạn là trợ lý AI chuyên về quy trình và giai đoạn trong công ty.

CÁC PHÒNG BAN THAM GIA THEO GIAI ĐOẠN:
- MKT-SALES: Marketing, Kinh doanh
- PROPOSAL: Kinh doanh, Dự toán, Thiết kế, Team dự án
- CON...
2025-05-18 17:05:39,083 - chatbot_rag - INFO - User prompt: 
Câu hỏi: "nay tui bị sếp la /no_think"

Đây là câu hỏi chung về quy trình hoặc giai đoạn làm việc.

Thông tin cơ bản:
### Thông tin tổng quan về quy trình và giai đoạn

#### Giai đoạn chính trong quy...
2025-05-18 17:05:39,084 - chatbot_rag - INFO - Gửi truy vấn đến LLM API tại http://192.168.1.4:1234/v1/chat/completions với stream=True
2025-05-18 17:05:57,647 - chatbot_rag - INFO - Mã phản hồi từ API: 200
2025-05-18 17:05:57,648 - chatbot_rag - INFO - Phản hồi gốc từ LLM API (200 ký tự đầu): <think>

</think>

😅 *"Nay tui bị sếp la" — có thể là do tui chưa làm đúng vai trò trong quy trình 😅*  
👉 Để biết mình đang ở giai đoạn nào và phòng ban nào phụ trách, vui lòng hỏi cụ thể hơn nhé!  
💬
2025-05-18 17:05:57,659 - chatbot_rag - INFO - Đã lưu phản hồi đầy đủ vào file: data/logs/llm_response_20250518_170557.txt
2025-05-18 17:05:57,663 - websocket_server - INFO - Đã trích xuất thinking (0 ký tự) và còn lại 393 ký tự phản hồi
2025-05-18 17:05:57,663 - websocket_server - INFO - Đã trích xuất phần thinking (0 ký tự) từ phản hồi
2025-05-18 17:05:57,664 - websocket_server - INFO - Đã lưu hội thoại chung vào lịch sử của session e06af9f8-3be4-4fd8-83f7-e5c65fd2f9ef
2025-05-18 17:09:04,913 - websocket_server - INFO - Nhận tin nhắn dạng JSON: {"content":"do tui sờ mông sếp /no_think","session_id":""}
2025-05-18 17:09:04,938 - websocket_server - INFO - Session ID không được cung cấp trong tin nhắn JSON, sử dụng current_session_id: e06af9f8-3be4-4fd8-83f7-e5c65fd2f9ef
2025-05-18 17:09:04,950 - websocket_server - INFO - Session ID từ client (sau khi kiểm tra): e06af9f8-3be4-4fd8-83f7-e5c65fd2f9ef
2025-05-18 17:09:04,951 - websocket_server - INFO - Tắt chế độ thinking cho câu hỏi: do tui sờ mông sếp /no_think...
2025-05-18 17:09:04,952 - websocket_server - INFO - Nhận tin nhắn thông thường: do tui sờ mông sếp /no_think, enable_thinking=False
2025-05-18 17:09:04,954 - websocket_server - INFO - Đã thêm 2 tin nhắn gần nhất vào prompt
2025-05-18 17:09:04,969 - websocket_server - INFO - Đã lưu lịch sử tin nhắn và prompt vào file: data/logs/history_prompt_20250518_170904.txt
2025-05-18 17:09:04,972 - chatbot_rag - INFO - Đang phân tích câu hỏi với LLM: Lịch sử tin nhắn:
Người dùng: xin chào, nay đi làm chán quá
Người dùng: nay tui bị sếp la

do tui sờ mông sếp /no_think, session_id: e06af9f8-3be4-4fd8-83f7-e5c65fd2f9ef
2025-05-18 17:09:04,976 - chatbot_rag - INFO - [analyze_query_with_llm] Đã lấy được 0 bản ghi lịch sử từ websocket_server cho session e06af9f8-3be4-4fd8-83f7-e5c65fd2f9ef
2025-05-18 17:09:04,977 - chatbot_rag - INFO - [analyze_query_with_llm] Sử dụng lịch sử hội thoại: 0 bản ghi
2025-05-18 17:09:04,977 - chatbot_rag - INFO - [analyze_query_with_llm] Prompt cuối cùng: Lịch sử tin nhắn:
        
        Câu hỏi người dùng hiện tại: "Lịch sử tin nhắn:
Người dùng: xin chào, nay đi làm chán quá
Người dùng: nay tui bị sếp la

do tui sờ mông sếp /no_think"

        Phân ...
2025-05-18 17:09:04,981 - chatbot_rag - INFO - Kích thước prompt: 700 ký tự
2025-05-18 17:09:04,981 - chatbot_rag - INFO - Kích thước system prompt: 2006 ký tự
2025-05-18 17:09:04,982 - chatbot_rag - INFO - Tổng kích thước: 2706 ký tự
2025-05-18 17:09:04,985 - chatbot_rag - INFO - Đã lưu full prompt vào file: data/logs/llm_full_prompt_20250518_170904.txt
2025-05-18 17:09:04,986 - chatbot_rag - INFO - System prompt: 
        Bạn là trợ lý AI phân tích câu hỏi để xác định:
        1. Phòng ban người dùng đang hỏi (department)
        2. Loại câu hỏi: phòng ban cụ thể hay general (query_type)
        3. Nếu câu hỏi...
2025-05-18 17:09:04,987 - chatbot_rag - INFO - User prompt: Lịch sử tin nhắn:
        
        Câu hỏi người dùng hiện tại: "Lịch sử tin nhắn:
Người dùng: xin chào, nay đi làm chán quá
Người dùng: nay tui bị sếp la

do tui sờ mông sếp /no_think"

        Phân ...
2025-05-18 17:09:04,988 - chatbot_rag - INFO - Gửi truy vấn đến LLM API tại http://192.168.1.4:1234/v1/chat/completions với stream=False
2025-05-18 17:09:20,890 - chatbot_rag - INFO - Mã phản hồi từ API: 200
2025-05-18 17:09:20,891 - chatbot_rag - INFO - Phản hồi gốc từ LLM API (200 ký tự đầu): <think>

</think>

{"department": null, "query_type": "general", "error": false}
2025-05-18 17:09:20,894 - chatbot_rag - INFO - Đã lưu phản hồi đầy đủ vào file: data/logs/llm_response_20250518_170920.txt
2025-05-18 17:09:20,897 - chatbot_rag - INFO - [analysis_20250518_170920] Đã ghi phản hồi gốc vào: data/logs/analysis_20250518_170920_raw.txt
2025-05-18 17:09:20,898 - chatbot_rag - INFO - [analysis_20250518_170920] Phản hồi gốc: <think>

</think>

{"department": null, "query_type": "general", "error": false}...
2025-05-18 17:09:20,898 - chatbot_rag - WARNING - [analysis_20250518_170920] Phát hiện thẻ <think> trong phản hồi. Xử lý đặc biệt...
2025-05-18 17:09:20,900 - chatbot_rag - INFO - [analysis_20250518_170920] Đã tìm thấy 1 mẫu JSON tiềm năng trong phản hồi
2025-05-18 17:09:20,901 - chatbot_rag - INFO - [analysis_20250518_170920] Tìm thấy JSON hợp lệ trong thẻ <think>: {'department': None, 'query_type': 'general', 'error': False}
2025-05-18 17:09:20,902 - websocket_server - INFO - Phân tích câu hỏi: Phòng ban=None, Loại=general, Thinking=False
2025-05-18 17:09:20,902 - websocket_server - INFO - Xử lý streaming response cho: 'do tui sờ mông sếp /no_think', phòng ban: None, session_id: e06af9f8-3be4-4fd8-83f7-e5c65fd2f9ef
2025-05-18 17:09:20,903 - websocket_server - INFO - Session ID nhận được: e06af9f8-3be4-4fd8-83f7-e5c65fd2f9ef
2025-05-18 17:09:20,903 - websocket_server - INFO - Phát hiện lệnh /no_think, tắt chế độ thinking cho: do tui sờ mông sếp
2025-05-18 17:09:20,903 - websocket_server - INFO - Xử lý streaming response. Query: 'do tui sờ mông sếp', Mode thinking: False
2025-05-18 17:09:20,904 - websocket_server - INFO - Đã thêm 2 tin nhắn gần nhất vào prompt
2025-05-18 17:09:20,905 - websocket_server - INFO - Đã lưu lịch sử tin nhắn và prompt vào file: data/logs/history_prompt_20250518_170920.txt
2025-05-18 17:09:20,906 - chatbot_rag - INFO - Đang phân tích câu hỏi với LLM: Lịch sử tin nhắn:
Người dùng: xin chào, nay đi làm chán quá
Người dùng: nay tui bị sếp la

do tui sờ mông sếp, session_id: e06af9f8-3be4-4fd8-83f7-e5c65fd2f9ef
2025-05-18 17:09:20,907 - chatbot_rag - INFO - [analyze_query_with_llm] Đã lấy được 0 bản ghi lịch sử từ websocket_server cho session e06af9f8-3be4-4fd8-83f7-e5c65fd2f9ef
2025-05-18 17:09:20,907 - chatbot_rag - INFO - [analyze_query_with_llm] Sử dụng lịch sử hội thoại: 0 bản ghi
2025-05-18 17:09:20,907 - chatbot_rag - INFO - [analyze_query_with_llm] Prompt cuối cùng: Lịch sử tin nhắn:
        
        Câu hỏi người dùng hiện tại: "Lịch sử tin nhắn:
Người dùng: xin chào, nay đi làm chán quá
Người dùng: nay tui bị sếp la

do tui sờ mông sếp"

        Phân tích câu h...
2025-05-18 17:09:20,909 - chatbot_rag - INFO - Kích thước prompt: 690 ký tự
2025-05-18 17:09:20,909 - chatbot_rag - INFO - Kích thước system prompt: 2006 ký tự
2025-05-18 17:09:20,910 - chatbot_rag - INFO - Tổng kích thước: 2696 ký tự
2025-05-18 17:09:20,914 - chatbot_rag - INFO - Đã lưu full prompt vào file: data/logs/llm_full_prompt_20250518_170920.txt
2025-05-18 17:09:20,914 - chatbot_rag - INFO - System prompt: 
        Bạn là trợ lý AI phân tích câu hỏi để xác định:
        1. Phòng ban người dùng đang hỏi (department)
        2. Loại câu hỏi: phòng ban cụ thể hay general (query_type)
        3. Nếu câu hỏi...
2025-05-18 17:09:20,915 - chatbot_rag - INFO - User prompt: Lịch sử tin nhắn:
        
        Câu hỏi người dùng hiện tại: "Lịch sử tin nhắn:
Người dùng: xin chào, nay đi làm chán quá
Người dùng: nay tui bị sếp la

do tui sờ mông sếp"

        Phân tích câu h...
2025-05-18 17:09:20,915 - chatbot_rag - INFO - Gửi truy vấn đến LLM API tại http://192.168.1.4:1234/v1/chat/completions với stream=False
2025-05-18 17:09:34,241 - chatbot_rag - INFO - Mã phản hồi từ API: 200
2025-05-18 17:09:34,243 - chatbot_rag - INFO - Phản hồi gốc từ LLM API (200 ký tự đầu): <think>
Okay, let me try to figure this out. The user provided a history of messages where they're talking about being upset with their boss and some inappropriate behavior. Now, the current question 
2025-05-18 17:09:34,246 - chatbot_rag - INFO - Đã lưu phản hồi đầy đủ vào file: data/logs/llm_response_20250518_170934.txt
2025-05-18 17:09:34,249 - chatbot_rag - INFO - [analysis_20250518_170934] Đã ghi phản hồi gốc vào: data/logs/analysis_20250518_170934_raw.txt
2025-05-18 17:09:34,250 - chatbot_rag - INFO - [analysis_20250518_170934] Phản hồi gốc: <think>
Okay, let me try to figure this out. The user provided a history of messages where they're t...
2025-05-18 17:09:34,251 - chatbot_rag - WARNING - [analysis_20250518_170934] Phát hiện thẻ <think> trong phản hồi. Xử lý đặc biệt...
2025-05-18 17:09:34,251 - chatbot_rag - INFO - [analysis_20250518_170934] BƯỚC 1: Thử parse toàn bộ chuỗi phản hồi
2025-05-18 17:09:34,254 - chatbot_rag - INFO - [analysis_20250518_170934] BƯỚC 1: Không phải JSON hợp lệ: Expecting value: line 1 column 1 (char 0)
2025-05-18 17:09:34,254 - chatbot_rag - INFO - [analysis_20250518_170934] BƯỚC 2: Tìm JSON trong chuỗi phản hồi
2025-05-18 17:09:34,255 - chatbot_rag - WARNING - [analysis_20250518_170934] BƯỚC 2: Không tìm thấy mẫu JSON nào trong phản hồi
2025-05-18 17:09:34,255 - chatbot_rag - INFO - [analysis_20250518_170934] BƯỚC 3: Xử lý chuỗi thủ công để trích xuất thông tin
2025-05-18 17:09:34,280 - department_info_tool - INFO - Đã tải 11 phòng ban
2025-05-18 17:09:34,281 - department_info_tool - INFO - Đã lấy danh sách 11 phòng ban
2025-05-18 17:09:34,283 - chatbot_rag - ERROR - [analysis_20250518_170934] BƯỚC 3: Lỗi khi xử lý chuỗi thủ công: local variable 'query_type' referenced before assignment
2025-05-18 17:09:34,284 - chatbot_rag - WARNING - [analysis_20250518_170934] Tất cả phương pháp phân tích đều thất bại, trả về kết quả mặc định
2025-05-18 17:09:34,284 - websocket_server - INFO - Phân tích câu hỏi: Phòng ban=None, Loại=general, Thinking=False
2025-05-18 17:09:34,285 - websocket_server - INFO - Query thực tế gửi đến mô hình: do tui sờ mông sếp /no_think
2025-05-18 17:09:34,285 - websocket_server - INFO - Câu hỏi chung, chế độ thinking: False
2025-05-18 17:09:34,287 - chatbot_rag - INFO - Xử lý câu hỏi chung cho session_id: e06af9f8-3be4-4fd8-83f7-e5c65fd2f9ef
2025-05-18 17:09:34,294 - department_info_tool - INFO - Đã tải 11 phòng ban
2025-05-18 17:09:34,294 - department_info_tool - INFO - Đã lấy danh sách 11 phòng ban
2025-05-18 17:09:34,296 - chatbot_rag - INFO - Gọi LLM để trả lời câu hỏi chung cho session_id: e06af9f8-3be4-4fd8-83f7-e5c65fd2f9ef
2025-05-18 17:09:34,298 - chatbot_rag - INFO - Đã lưu prompt vào file: data/logs/prompt_general_20250518_170934.txt
2025-05-18 17:09:34,298 - chatbot_rag - INFO - Kích thước prompt: 1144 ký tự
2025-05-18 17:09:34,298 - chatbot_rag - INFO - Kích thước system prompt: 1205 ký tự
2025-05-18 17:09:34,299 - chatbot_rag - INFO - Tổng kích thước: 2349 ký tự
2025-05-18 17:09:34,302 - chatbot_rag - INFO - Đã lưu full prompt vào file: data/logs/llm_full_prompt_20250518_170934.txt
2025-05-18 17:09:34,303 - chatbot_rag - INFO - System prompt: 
Bạn là trợ lý AI chuyên về quy trình và giai đoạn trong công ty.

CÁC PHÒNG BAN THAM GIA THEO GIAI ĐOẠN:
- MKT-SALES: Marketing, Kinh doanh
- PROPOSAL: Kinh doanh, Dự toán, Thiết kế, Team dự án
- CON...
2025-05-18 17:09:34,303 - chatbot_rag - INFO - User prompt: 
Câu hỏi: "do tui sờ mông sếp /no_think"

Đây là câu hỏi chung về quy trình hoặc giai đoạn làm việc.

Thông tin cơ bản:
### Thông tin tổng quan về quy trình và giai đoạn

#### Giai đoạn chính trong qu...
2025-05-18 17:09:34,304 - chatbot_rag - INFO - Gửi truy vấn đến LLM API tại http://192.168.1.4:1234/v1/chat/completions với stream=True
2025-05-18 17:09:54,571 - chatbot_rag - INFO - Mã phản hồi từ API: 200
2025-05-18 17:09:54,572 - chatbot_rag - INFO - Phản hồi gốc từ LLM API (200 ký tự đầu): <think>

</think>

🤣 *Do tui sờ mông sếp* — đây là câu hỏi hoàn toàn không liên quan đến quy trình làm việc, giai đoạn hay phòng ban đâu nha! 😂  
👉 Vui vẻ hơn thì hãy hỏi: "Sếp có thích bị sờ mông khô
2025-05-18 17:09:54,575 - chatbot_rag - INFO - Đã lưu phản hồi đầy đủ vào file: data/logs/llm_response_20250518_170954.txt
2025-05-18 17:09:54,609 - websocket_server - INFO - Đã trích xuất thinking (0 ký tự) và còn lại 327 ký tự phản hồi
2025-05-18 17:09:54,610 - websocket_server - INFO - Đã trích xuất phần thinking (0 ký tự) từ phản hồi
2025-05-18 17:09:54,610 - websocket_server - INFO - Đã lưu hội thoại chung vào lịch sử của session e06af9f8-3be4-4fd8-83f7-e5c65fd2f9ef
2025-05-18 17:14:59,328 - websockets.server - INFO - connection open
2025-05-18 17:14:59,399 - websockets.server - INFO - connection closed
2025-05-18 17:14:59,399 - websockets.server - INFO - connection closed
2025-05-18 17:15:01,889 - websockets.server - INFO - connection open
2025-05-18 17:18:30,404 - websockets.server - INFO - connection closed
2025-05-18 17:18:30,409 - websockets.server - INFO - server closing
2025-05-18 17:18:30,414 - websockets.server - INFO - server closed
2025-05-18 17:18:30,425 - websocket_server - INFO - Server bị dừng bởi người dùng
2025-05-18 17:18:33,345 - websocket_server - INFO - Khởi động server WebSocket tại 0.0.0.0:8090
2025-05-18 17:18:33,381 - websockets.server - INFO - server listening on 0.0.0.0:8090
2025-05-18 17:18:33,381 - websocket_server - INFO - Server WebSocket đang chạy tại ws://0.0.0.0:8090
2025-05-18 17:18:33,381 - websocket_server - INFO - Đã cấu hình ping_timeout=6000 giây, ping_interval=60 giây
2025-05-18 17:18:44,617 - websockets.server - INFO - connection open
2025-05-18 17:19:04,153 - websockets.server - INFO - connection closed
2025-05-18 17:19:04,965 - websockets.server - INFO - connection open
2025-05-18 17:19:48,881 - websocket_server - INFO - Nhận tin nhắn dạng JSON: {"content":"alu alu /no_think","session_id":"","mode":"basic","basic_prompt":"Bạn là một trợ lý AI h
2025-05-18 17:19:48,882 - websocket_server - INFO - Session ID không được cung cấp trong tin nhắn JSON, sử dụng current_session_id: 31a0a6b5-8028-4275-8a2e-e9f810554a41
2025-05-18 17:19:48,882 - websocket_server - INFO - Session ID từ client (sau khi kiểm tra): 31a0a6b5-8028-4275-8a2e-e9f810554a41
2025-05-18 17:19:48,883 - websocket_server - INFO - Tắt chế độ thinking cho câu hỏi: alu alu /no_think...
2025-05-18 17:19:48,884 - websocket_server - INFO - Nhận tin nhắn thông thường: alu alu /no_think, enable_thinking=False, mode=basic
2025-05-18 17:19:48,884 - websocket_server - INFO - Chế độ Basic được kích hoạt với prompt: Bạn là một trợ lý AI hữu ích và thông minh. Hãy trả lời câu hỏi của người dùng một cách chi tiết và ...
2025-05-18 17:19:48,885 - websocket_server - INFO - Xử lý streaming response cho: 'alu alu /no_think', phòng ban: None, session_id: 31a0a6b5-8028-4275-8a2e-e9f810554a41, mode: basic
2025-05-18 17:19:48,885 - websocket_server - INFO - Session ID nhận được: 31a0a6b5-8028-4275-8a2e-e9f810554a41
2025-05-18 17:19:48,885 - websocket_server - INFO - Phát hiện lệnh /no_think, tắt chế độ thinking cho: alu alu
2025-05-18 17:19:48,886 - websocket_server - INFO - Xử lý streaming response. Query: 'alu alu', Mode thinking: False
2025-05-18 17:19:48,886 - websocket_server - INFO - Chế độ Basic được kích hoạt với prompt: Bạn là một trợ lý AI hữu ích và thông minh. Hãy trả lời câu hỏi của người dùng một cách chi tiết và ...
2025-05-18 17:19:48,887 - websocket_server - INFO - Không có lịch sử tin nhắn cho phiên này
2025-05-18 17:19:48,888 - websocket_server - INFO - Kích thước prompt: 7 ký tự
2025-05-18 17:19:48,888 - websocket_server - INFO - Kích thước system prompt: 203 ký tự
2025-05-18 17:19:48,888 - websocket_server - INFO - Tổng kích thước: 210 ký tự
2025-05-18 17:19:48,888 - websocket_server - INFO - Bắt đầu gọi LLM API (lần thử 1/3)
2025-05-18 17:19:59,603 - websocket_server - INFO - API trả về status 200 OK
2025-05-18 17:19:59,604 - websocket_server - INFO - Streaming hoàn tất thành công
2025-05-18 17:19:59,605 - websocket_server - INFO - Lưu hội thoại basic mode vào lịch sử với session_id=31a0a6b5-8028-4275-8a2e-e9f810554a41
2025-05-18 17:21:22,013 - websockets.server - INFO - connection closed
2025-05-18 17:21:23,227 - websockets.server - INFO - connection open
2025-05-18 17:21:23,893 - websocket_server - INFO - Nhận tin nhắn dạng JSON: {"content":"alu alu /no_think","session_id":"","mode":"workflow"}
2025-05-18 17:21:23,894 - websocket_server - INFO - Session ID không được cung cấp trong tin nhắn JSON, sử dụng current_session_id: 31a0a6b5-8028-4275-8a2e-e9f810554a41
2025-05-18 17:21:23,894 - websocket_server - INFO - Session ID từ client (sau khi kiểm tra): 31a0a6b5-8028-4275-8a2e-e9f810554a41
2025-05-18 17:21:23,895 - websocket_server - INFO - Tắt chế độ thinking cho câu hỏi: alu alu /no_think...
2025-05-18 17:21:23,895 - websocket_server - INFO - Nhận tin nhắn thông thường: alu alu /no_think, enable_thinking=False, mode=workflow
2025-05-18 17:21:23,895 - websocket_server - INFO - Đã thêm 1 tin nhắn gần nhất vào prompt
2025-05-18 17:21:23,903 - websocket_server - INFO - Đã lưu lịch sử tin nhắn và prompt vào file: data/logs/history_prompt_20250518_172123.txt
2025-05-18 17:21:23,907 - chatbot_rag - INFO - Đang phân tích câu hỏi với LLM: Lịch sử tin nhắn:
Người dùng: alu alu

alu alu /no_think, session_id: 31a0a6b5-8028-4275-8a2e-e9f810554a41
2025-05-18 17:21:23,968 - chatbot_rag - INFO - [analyze_query_with_llm] Đã lấy được 0 bản ghi lịch sử từ websocket_server cho session 31a0a6b5-8028-4275-8a2e-e9f810554a41
2025-05-18 17:21:23,969 - chatbot_rag - INFO - [analyze_query_with_llm] Sử dụng lịch sử hội thoại: 0 bản ghi
2025-05-18 17:21:23,969 - chatbot_rag - INFO - [analyze_query_with_llm] Prompt cuối cùng: Lịch sử tin nhắn:
        
        Câu hỏi người dùng hiện tại: "Lịch sử tin nhắn:
Người dùng: alu alu

alu alu /no_think"

        Phân tích câu hỏi và trả về JSON có định dạng:
        {"department"...
2025-05-18 17:21:23,970 - chatbot_rag - INFO - Kích thước prompt: 637 ký tự
2025-05-18 17:21:23,970 - chatbot_rag - INFO - Kích thước system prompt: 2006 ký tự
2025-05-18 17:21:23,970 - chatbot_rag - INFO - Tổng kích thước: 2643 ký tự
2025-05-18 17:21:23,972 - chatbot_rag - INFO - Đã lưu full prompt vào file: data/logs/llm_full_prompt_20250518_172123.txt
2025-05-18 17:21:23,972 - chatbot_rag - INFO - System prompt: 
        Bạn là trợ lý AI phân tích câu hỏi để xác định:
        1. Phòng ban người dùng đang hỏi (department)
        2. Loại câu hỏi: phòng ban cụ thể hay general (query_type)
        3. Nếu câu hỏi...
2025-05-18 17:21:23,972 - chatbot_rag - INFO - User prompt: Lịch sử tin nhắn:
        
        Câu hỏi người dùng hiện tại: "Lịch sử tin nhắn:
Người dùng: alu alu

alu alu /no_think"

        Phân tích câu hỏi và trả về JSON có định dạng:
        {"department"...
2025-05-18 17:21:23,973 - chatbot_rag - INFO - Gửi truy vấn đến LLM API tại http://192.168.1.4:1234/v1/chat/completions với stream=False
2025-05-18 17:21:37,083 - chatbot_rag - INFO - Mã phản hồi từ API: 200
2025-05-18 17:21:37,083 - chatbot_rag - INFO - Phản hồi gốc từ LLM API (200 ký tự đầu): <think>

</think>

{"department": null, "query_type": "general", "error": false}
2025-05-18 17:21:37,086 - chatbot_rag - INFO - Đã lưu phản hồi đầy đủ vào file: data/logs/llm_response_20250518_172137.txt
2025-05-18 17:21:37,088 - chatbot_rag - INFO - [analysis_20250518_172137] Đã ghi phản hồi gốc vào: data/logs/analysis_20250518_172137_raw.txt
2025-05-18 17:21:37,089 - chatbot_rag - INFO - [analysis_20250518_172137] Phản hồi gốc: <think>

</think>

{"department": null, "query_type": "general", "error": false}...
2025-05-18 17:21:37,089 - chatbot_rag - WARNING - [analysis_20250518_172137] Phát hiện thẻ <think> trong phản hồi. Xử lý đặc biệt...
2025-05-18 17:21:37,092 - chatbot_rag - INFO - [analysis_20250518_172137] Đã tìm thấy 1 mẫu JSON tiềm năng trong phản hồi
2025-05-18 17:21:37,093 - chatbot_rag - INFO - [analysis_20250518_172137] Tìm thấy JSON hợp lệ trong thẻ <think>: {'department': None, 'query_type': 'general', 'error': False}
2025-05-18 17:21:37,094 - websocket_server - INFO - Phân tích câu hỏi: Phòng ban=None, Loại=general, Thinking=False
2025-05-18 17:21:37,094 - websocket_server - INFO - Xử lý streaming response cho: 'alu alu /no_think', phòng ban: None, session_id: 31a0a6b5-8028-4275-8a2e-e9f810554a41, mode: None
2025-05-18 17:21:37,094 - websocket_server - INFO - Session ID nhận được: 31a0a6b5-8028-4275-8a2e-e9f810554a41
2025-05-18 17:21:37,096 - websocket_server - INFO - Phát hiện lệnh /no_think, tắt chế độ thinking cho: alu alu
2025-05-18 17:21:37,096 - websocket_server - INFO - Xử lý streaming response. Query: 'alu alu', Mode thinking: False
2025-05-18 17:21:37,096 - websocket_server - INFO - Đã thêm 1 tin nhắn gần nhất vào prompt
2025-05-18 17:21:37,098 - websocket_server - INFO - Đã lưu lịch sử tin nhắn và prompt vào file: data/logs/history_prompt_20250518_172137.txt
2025-05-18 17:21:37,099 - chatbot_rag - INFO - Đang phân tích câu hỏi với LLM: Lịch sử tin nhắn:
Người dùng: alu alu

alu alu, session_id: 31a0a6b5-8028-4275-8a2e-e9f810554a41
2025-05-18 17:21:37,099 - chatbot_rag - INFO - [analyze_query_with_llm] Đã lấy được 0 bản ghi lịch sử từ websocket_server cho session 31a0a6b5-8028-4275-8a2e-e9f810554a41
2025-05-18 17:21:37,099 - chatbot_rag - INFO - [analyze_query_with_llm] Sử dụng lịch sử hội thoại: 0 bản ghi
2025-05-18 17:21:37,100 - chatbot_rag - INFO - [analyze_query_with_llm] Prompt cuối cùng: Lịch sử tin nhắn:
        
        Câu hỏi người dùng hiện tại: "Lịch sử tin nhắn:
Người dùng: alu alu

alu alu"

        Phân tích câu hỏi và trả về JSON có định dạng:
        {"department": "tên phò...
2025-05-18 17:21:37,100 - chatbot_rag - INFO - Kích thước prompt: 627 ký tự
2025-05-18 17:21:37,100 - chatbot_rag - INFO - Kích thước system prompt: 2006 ký tự
2025-05-18 17:21:37,100 - chatbot_rag - INFO - Tổng kích thước: 2633 ký tự
2025-05-18 17:21:37,102 - chatbot_rag - INFO - Đã lưu full prompt vào file: data/logs/llm_full_prompt_20250518_172137.txt
2025-05-18 17:21:37,103 - chatbot_rag - INFO - System prompt: 
        Bạn là trợ lý AI phân tích câu hỏi để xác định:
        1. Phòng ban người dùng đang hỏi (department)
        2. Loại câu hỏi: phòng ban cụ thể hay general (query_type)
        3. Nếu câu hỏi...
2025-05-18 17:21:37,103 - chatbot_rag - INFO - User prompt: Lịch sử tin nhắn:
        
        Câu hỏi người dùng hiện tại: "Lịch sử tin nhắn:
Người dùng: alu alu

alu alu"

        Phân tích câu hỏi và trả về JSON có định dạng:
        {"department": "tên phò...
2025-05-18 17:21:37,103 - chatbot_rag - INFO - Gửi truy vấn đến LLM API tại http://192.168.1.4:1234/v1/chat/completions với stream=False
2025-05-18 17:21:48,760 - chatbot_rag - INFO - Mã phản hồi từ API: 200
2025-05-18 17:21:48,760 - chatbot_rag - INFO - Phản hồi gốc từ LLM API (200 ký tự đầu): <think>
Okay, let's see. The user provided a message that's just "alu alu" repeated. That seems like a placeholder or maybe a test input. Now, I need to analyze this based on the given rules.

First, 
2025-05-18 17:21:48,763 - chatbot_rag - INFO - Đã lưu phản hồi đầy đủ vào file: data/logs/llm_response_20250518_172148.txt
2025-05-18 17:21:48,764 - chatbot_rag - INFO - [analysis_20250518_172148] Đã ghi phản hồi gốc vào: data/logs/analysis_20250518_172148_raw.txt
2025-05-18 17:21:48,766 - chatbot_rag - INFO - [analysis_20250518_172148] Phản hồi gốc: <think>
Okay, let's see. The user provided a message that's just "alu alu" repeated. That seems like...
2025-05-18 17:21:48,766 - chatbot_rag - WARNING - [analysis_20250518_172148] Phát hiện thẻ <think> trong phản hồi. Xử lý đặc biệt...
2025-05-18 17:21:48,767 - chatbot_rag - INFO - [analysis_20250518_172148] BƯỚC 1: Thử parse toàn bộ chuỗi phản hồi
2025-05-18 17:21:48,767 - chatbot_rag - INFO - [analysis_20250518_172148] BƯỚC 1: Không phải JSON hợp lệ: Expecting value: line 1 column 1 (char 0)
2025-05-18 17:21:48,767 - chatbot_rag - INFO - [analysis_20250518_172148] BƯỚC 2: Tìm JSON trong chuỗi phản hồi
2025-05-18 17:21:48,767 - chatbot_rag - WARNING - [analysis_20250518_172148] BƯỚC 2: Không tìm thấy mẫu JSON nào trong phản hồi
2025-05-18 17:21:48,768 - chatbot_rag - INFO - [analysis_20250518_172148] BƯỚC 3: Xử lý chuỗi thủ công để trích xuất thông tin
2025-05-18 17:21:48,774 - department_info_tool - INFO - Đã tải 11 phòng ban
2025-05-18 17:21:48,776 - department_info_tool - INFO - Đã lấy danh sách 11 phòng ban
2025-05-18 17:21:48,777 - chatbot_rag - ERROR - [analysis_20250518_172148] BƯỚC 3: Lỗi khi xử lý chuỗi thủ công: local variable 'query_type' referenced before assignment
2025-05-18 17:21:48,777 - chatbot_rag - WARNING - [analysis_20250518_172148] Tất cả phương pháp phân tích đều thất bại, trả về kết quả mặc định
2025-05-18 17:21:48,778 - websocket_server - INFO - Phân tích câu hỏi: Phòng ban=None, Loại=general, Thinking=False
2025-05-18 17:21:48,778 - websocket_server - INFO - Query thực tế gửi đến mô hình: alu alu /no_think
2025-05-18 17:21:48,778 - websocket_server - INFO - Câu hỏi chung, chế độ thinking: False
2025-05-18 17:21:48,778 - chatbot_rag - INFO - Xử lý câu hỏi chung cho session_id: 31a0a6b5-8028-4275-8a2e-e9f810554a41
2025-05-18 17:21:48,781 - department_info_tool - INFO - Đã tải 11 phòng ban
2025-05-18 17:21:48,781 - department_info_tool - INFO - Đã lấy danh sách 11 phòng ban
2025-05-18 17:21:48,782 - chatbot_rag - INFO - Gọi LLM để trả lời câu hỏi chung cho session_id: 31a0a6b5-8028-4275-8a2e-e9f810554a41
2025-05-18 17:21:48,784 - chatbot_rag - INFO - Đã lưu prompt vào file: data/logs/prompt_general_20250518_172148.txt
2025-05-18 17:21:48,784 - chatbot_rag - INFO - Kích thước prompt: 1032 ký tự
2025-05-18 17:21:48,784 - chatbot_rag - INFO - Kích thước system prompt: 916 ký tự
2025-05-18 17:21:48,784 - chatbot_rag - INFO - Tổng kích thước: 1948 ký tự
2025-05-18 17:21:48,787 - chatbot_rag - INFO - Đã lưu full prompt vào file: data/logs/llm_full_prompt_20250518_172148.txt
2025-05-18 17:21:48,787 - chatbot_rag - INFO - System prompt: 
Bạn là trợ lý AI chuyên về quy trình và giai đoạn trong công ty.

DANH SÁCH PHÒNG BAN:
- 2D
- Dự toán
- Khách hàng
- Kinh doanh
- Kế toán
- Marketing
- Mua hàng
- Team dự án
- Thi công
- Thiết kế
- Đ...
2025-05-18 17:21:48,788 - chatbot_rag - INFO - User prompt: 
Câu hỏi: "alu alu /no_think"

Đây là câu hỏi chung về quy trình hoặc giai đoạn làm việc.

Thông tin cơ bản:
### Thông tin tổng quan về quy trình và giai đoạn

#### Giai đoạn chính trong quy trình:
1....
2025-05-18 17:21:48,788 - chatbot_rag - INFO - Gửi truy vấn đến LLM API tại http://192.168.1.4:1234/v1/chat/completions với stream=True
2025-05-18 17:22:05,921 - chatbot_rag - INFO - Mã phản hồi từ API: 200
2025-05-18 17:22:05,921 - chatbot_rag - INFO - Phản hồi gốc từ LLM API (200 ký tự đầu): <think>

</think>

```markdown
# Giai đoạn và phòng ban liên quan

| Giai đoạn | Phòng ban phụ trách |
|-----------|---------------------|
| MKT-SALES | Marketing, Kinh doanh |
| PROPOSAL  | Dự toán, 
2025-05-18 17:22:05,924 - chatbot_rag - INFO - Đã lưu phản hồi đầy đủ vào file: data/logs/llm_response_20250518_172205.txt
2025-05-18 17:22:06,284 - websocket_server - INFO - Đã trích xuất thinking (0 ký tự) và còn lại 479 ký tự phản hồi
2025-05-18 17:22:06,284 - websocket_server - INFO - Đã trích xuất phần thinking (0 ký tự) từ phản hồi
2025-05-18 17:22:06,285 - websocket_server - INFO - Đã lưu hội thoại chung vào lịch sử của session 31a0a6b5-8028-4275-8a2e-e9f810554a41
2025-05-18 17:22:55,375 - websocket_server - WARNING - Session  không tồn tại, sử dụng session hiện tại
2025-05-18 17:22:55,375 - websocket_server - INFO - Nhận yêu cầu phân tích (thinking) cho câu hỏi: ```markdown
# Giai đoạn và phòng ban liên quan

| Giai đoạn | Phòng ban phụ trách |
|-----------|---
2025-05-18 17:22:55,375 - websocket_server - INFO - Đã thêm 2 tin nhắn gần nhất vào prompt
2025-05-18 17:22:55,377 - websocket_server - INFO - Đã lưu lịch sử tin nhắn và prompt vào file: data/logs/history_prompt_20250518_172255.txt
2025-05-18 17:22:55,377 - websocket_server - INFO - Phân tích câu hỏi để xác định phòng ban hoặc loại câu hỏi
2025-05-18 17:22:55,378 - chatbot_rag - INFO - Đang phân tích câu hỏi với LLM: Lịch sử tin nhắn:
Người dùng: alu alu
Người dùng: alu alu

```markdown
# Giai đoạn và phòng ban liên quan

| Giai đoạn | Phòng ban phụ trách |
|-----------|---------------------|
| MKT-SALES | Marketing, Kinh doanh |
| PROPOSAL  | Dự toán, Thiết kế, 2D |
| CONSTRUCTION | Thi công, Team dự án |
| DEFECT-HANDOVER | Khách hàng, Mua hàng, Kế toán |
| AFTERSALE-MAINTENANCE | Kinh doanh, Khách hàng |

Để biết chi tiết công việc cụ thể, vui lòng hỏi về một phòng ban cụ thể, ví dụ: "Phòng Kinh doanh làm gì trong giai đoạn PROPOSAL?" 😎🏗️
```, session_id: 31a0a6b5-8028-4275-8a2e-e9f810554a41
2025-05-18 17:22:55,378 - chatbot_rag - INFO - [analyze_query_with_llm] Đã lấy được 0 bản ghi lịch sử từ websocket_server cho session 31a0a6b5-8028-4275-8a2e-e9f810554a41
2025-05-18 17:22:55,379 - chatbot_rag - INFO - [analyze_query_with_llm] Sử dụng lịch sử hội thoại: 0 bản ghi
2025-05-18 17:22:55,379 - chatbot_rag - INFO - [analyze_query_with_llm] Prompt cuối cùng: Lịch sử tin nhắn:
        
        Câu hỏi người dùng hiện tại: "Lịch sử tin nhắn:
Người dùng: alu alu
Người dùng: alu alu

```markdown
# Giai đoạn và phòng ban liên quan

| Giai đoạn | Phòng ban phụ ...
2025-05-18 17:22:55,379 - chatbot_rag - INFO - Kích thước prompt: 1119 ký tự
2025-05-18 17:22:55,380 - chatbot_rag - INFO - Kích thước system prompt: 2006 ký tự
2025-05-18 17:22:55,380 - chatbot_rag - INFO - Tổng kích thước: 3125 ký tự
2025-05-18 17:22:55,382 - chatbot_rag - INFO - Đã lưu full prompt vào file: data/logs/llm_full_prompt_20250518_172255.txt
2025-05-18 17:22:55,383 - chatbot_rag - INFO - System prompt: 
        Bạn là trợ lý AI phân tích câu hỏi để xác định:
        1. Phòng ban người dùng đang hỏi (department)
        2. Loại câu hỏi: phòng ban cụ thể hay general (query_type)
        3. Nếu câu hỏi...
2025-05-18 17:22:55,383 - chatbot_rag - INFO - User prompt: Lịch sử tin nhắn:
        
        Câu hỏi người dùng hiện tại: "Lịch sử tin nhắn:
Người dùng: alu alu
Người dùng: alu alu

```markdown
# Giai đoạn và phòng ban liên quan

| Giai đoạn | Phòng ban phụ ...
2025-05-18 17:22:55,384 - chatbot_rag - INFO - Gửi truy vấn đến LLM API tại http://192.168.1.4:1234/v1/chat/completions với stream=False
2025-05-18 17:23:21,128 - chatbot_rag - INFO - Mã phản hồi từ API: 200
2025-05-18 17:23:21,129 - chatbot_rag - INFO - Phản hồi gốc từ LLM API (200 ký tự đầu): <think>
Okay, let's tackle this query. The user provided a history of messages and the current question. First, I need to parse the current question carefully.

The current message is a markdown table
2025-05-18 17:23:21,131 - chatbot_rag - INFO - Đã lưu phản hồi đầy đủ vào file: data/logs/llm_response_20250518_172321.txt
2025-05-18 17:23:21,133 - chatbot_rag - INFO - [analysis_20250518_172321] Đã ghi phản hồi gốc vào: data/logs/analysis_20250518_172321_raw.txt
2025-05-18 17:23:21,133 - chatbot_rag - INFO - [analysis_20250518_172321] Phản hồi gốc: <think>
Okay, let's tackle this query. The user provided a history of messages and the current quest...
2025-05-18 17:23:21,134 - chatbot_rag - WARNING - [analysis_20250518_172321] Phát hiện thẻ <think> trong phản hồi. Xử lý đặc biệt...
2025-05-18 17:23:21,134 - chatbot_rag - INFO - [analysis_20250518_172321] BƯỚC 1: Thử parse toàn bộ chuỗi phản hồi
2025-05-18 17:23:21,134 - chatbot_rag - INFO - [analysis_20250518_172321] BƯỚC 1: Không phải JSON hợp lệ: Expecting value: line 1 column 1 (char 0)
2025-05-18 17:23:21,135 - chatbot_rag - INFO - [analysis_20250518_172321] BƯỚC 2: Tìm JSON trong chuỗi phản hồi
2025-05-18 17:23:21,136 - chatbot_rag - WARNING - [analysis_20250518_172321] BƯỚC 2: Không tìm thấy mẫu JSON nào trong phản hồi
2025-05-18 17:23:21,136 - chatbot_rag - INFO - [analysis_20250518_172321] BƯỚC 3: Xử lý chuỗi thủ công để trích xuất thông tin
2025-05-18 17:23:21,139 - department_info_tool - INFO - Đã tải 11 phòng ban
2025-05-18 17:23:21,140 - department_info_tool - INFO - Đã lấy danh sách 11 phòng ban
2025-05-18 17:23:21,141 - chatbot_rag - INFO - [analysis_20250518_172321] BƯỚC 3: Tìm thấy phòng ban trong câu hỏi: 2D
2025-05-18 17:23:21,141 - chatbot_rag - ERROR - [analysis_20250518_172321] BƯỚC 3: Lỗi khi xử lý chuỗi thủ công: local variable 'query_type' referenced before assignment
2025-05-18 17:23:21,141 - chatbot_rag - WARNING - [analysis_20250518_172321] Tất cả phương pháp phân tích đều thất bại, trả về kết quả mặc định
2025-05-18 17:23:21,142 - websocket_server - INFO - Lấy phân tích cho câu hỏi chung
2025-05-18 17:23:21,142 - chatbot_rag - INFO - Xử lý câu hỏi chung cho session_id: 31a0a6b5-8028-4275-8a2e-e9f810554a41
2025-05-18 17:23:21,146 - department_info_tool - INFO - Đã tải 11 phòng ban
2025-05-18 17:23:21,146 - department_info_tool - INFO - Đã lấy danh sách 11 phòng ban
2025-05-18 17:23:21,147 - chatbot_rag - INFO - Gọi LLM để trả lời câu hỏi chung cho session_id: 31a0a6b5-8028-4275-8a2e-e9f810554a41
2025-05-18 17:23:21,148 - chatbot_rag - INFO - Đã lưu prompt vào file: data/logs/prompt_general_20250518_172321.txt
2025-05-18 17:23:21,149 - chatbot_rag - INFO - Kích thước prompt: 1501 ký tự
2025-05-18 17:23:21,149 - chatbot_rag - INFO - Kích thước system prompt: 916 ký tự
2025-05-18 17:23:21,149 - chatbot_rag - INFO - Tổng kích thước: 2417 ký tự
2025-05-18 17:23:21,151 - chatbot_rag - INFO - Đã lưu full prompt vào file: data/logs/llm_full_prompt_20250518_172321.txt
2025-05-18 17:23:21,152 - chatbot_rag - INFO - System prompt: 
Bạn là trợ lý AI chuyên về quy trình và giai đoạn trong công ty.

DANH SÁCH PHÒNG BAN:
- 2D
- Dự toán
- Khách hàng
- Kinh doanh
- Kế toán
- Marketing
- Mua hàng
- Team dự án
- Thi công
- Thiết kế
- Đ...
2025-05-18 17:23:21,153 - chatbot_rag - INFO - User prompt: 
Câu hỏi: "```markdown
# Giai đoạn và phòng ban liên quan

| Giai đoạn | Phòng ban phụ trách |
|-----------|---------------------|
| MKT-SALES | Marketing, Kinh doanh |
| PROPOSAL  | Dự toán, Thiết kế...
2025-05-18 17:23:21,153 - chatbot_rag - INFO - Gửi truy vấn đến LLM API tại http://192.168.1.4:1234/v1/chat/completions với stream=True
2025-05-18 17:24:00,996 - chatbot_rag - INFO - Mã phản hồi từ API: 200
2025-05-18 17:24:00,997 - chatbot_rag - INFO - Phản hồi gốc từ LLM API (200 ký tự đầu): <think>
Okay, the user has provided a query about the stages and responsible departments in a company. They have given a markdown table showing each stage and the departments involved. The user is ask
2025-05-18 17:24:00,999 - chatbot_rag - INFO - Đã lưu phản hồi đầy đủ vào file: data/logs/llm_response_20250518_172400.txt
2025-05-18 17:24:01,002 - websocket_server - INFO - Đã trích xuất thinking (1814 ký tự) và còn lại 479 ký tự phản hồi
2025-05-18 17:24:01,003 - websocket_server - INFO - Đã trích xuất phần thinking (1814 ký tự) từ phản hồi handle_general_query
2025-05-18 17:24:01,003 - websocket_server - INFO - Gửi phản hồi thinking với request_id: thinking_1747563775374_y7dovox
2025-05-18 17:24:01,004 - websocket_server - INFO - Đã gửi nội dung thinking (1814 ký tự)
2025-05-18 17:26:09,072 - websockets.server - INFO - connection open
2025-05-18 17:27:18,025 - websockets.server - INFO - connection open
2025-05-18 17:28:06,716 - websockets.server - INFO - connection closed
2025-05-18 17:28:06,719 - websockets.server - INFO - connection closed
2025-05-18 17:28:06,720 - websockets.server - INFO - connection closed
2025-05-18 17:28:06,726 - websockets.server - INFO - server closing
2025-05-18 17:28:06,729 - websockets.server - INFO - server closed
2025-05-18 17:28:06,738 - websocket_server - INFO - Server bị dừng bởi người dùng
2025-05-18 17:28:10,916 - websocket_server - INFO - Khởi động server WebSocket tại 0.0.0.0:8090
2025-05-18 17:28:11,004 - websockets.server - INFO - server listening on 0.0.0.0:8090
2025-05-18 17:28:11,005 - websocket_server - INFO - Server WebSocket đang chạy tại ws://0.0.0.0:8090
2025-05-18 17:28:11,007 - websocket_server - INFO - Đã cấu hình ping_timeout=6000 giây, ping_interval=60 giây
2025-05-18 17:28:12,709 - websockets.server - INFO - connection open
2025-05-18 17:28:13,034 - websockets.server - INFO - connection open
2025-05-18 17:28:17,683 - websocket_server - INFO - Nhận tin nhắn dạng JSON: {"content":"xin chào","session_id":"","mode":"basic","basic_prompt":"Bạn là một trợ lý AI hữu ích và
2025-05-18 17:28:17,684 - websocket_server - INFO - Session ID không được cung cấp trong tin nhắn JSON, sử dụng current_session_id: 755c7188-5b94-47b0-beb7-4006c742db63
2025-05-18 17:28:17,684 - websocket_server - INFO - Session ID từ client (sau khi kiểm tra): 755c7188-5b94-47b0-beb7-4006c742db63
2025-05-18 17:28:17,684 - websocket_server - INFO - Nhận tin nhắn thông thường: xin chào, enable_thinking=False, mode=basic
2025-05-18 17:28:17,684 - websocket_server - INFO - Chế độ Basic được kích hoạt với prompt: Bạn là một trợ lý AI hữu ích và thông minh. Hãy trả lời câu hỏi của người dùng một cách chi tiết và ...
2025-05-18 17:28:17,684 - websocket_server - INFO - Xử lý streaming response cho: 'xin chào', phòng ban: None, session_id: 755c7188-5b94-47b0-beb7-4006c742db63, mode: basic
2025-05-18 17:28:17,685 - websocket_server - INFO - Session ID nhận được: 755c7188-5b94-47b0-beb7-4006c742db63
2025-05-18 17:28:17,685 - websocket_server - INFO - Xử lý streaming response. Query: 'xin chào', Mode thinking: False
2025-05-18 17:28:17,685 - websocket_server - INFO - Chế độ Basic được kích hoạt với prompt: Bạn là một trợ lý AI hữu ích và thông minh. Hãy trả lời câu hỏi của người dùng một cách chi tiết và ...
2025-05-18 17:28:17,686 - websocket_server - INFO - Không có lịch sử tin nhắn cho phiên này
2025-05-18 17:28:17,686 - websocket_server - INFO - Kích thước prompt: 8 ký tự
2025-05-18 17:28:17,686 - websocket_server - INFO - Kích thước system prompt: 174 ký tự
2025-05-18 17:28:17,686 - websocket_server - INFO - Tổng kích thước: 182 ký tự
2025-05-18 17:28:17,687 - websocket_server - INFO - Bắt đầu gọi LLM API (lần thử 1/3)
2025-05-18 17:28:25,799 - websocket_server - INFO - API trả về status 200 OK
2025-05-18 17:28:25,800 - websocket_server - INFO - Streaming hoàn tất thành công
2025-05-18 17:28:25,801 - websocket_server - INFO - Lưu hội thoại basic mode vào lịch sử với session_id=755c7188-5b94-47b0-beb7-4006c742db63
2025-05-18 17:28:27,388 - websocket_server - WARNING - Session  không tồn tại, sử dụng session hiện tại
2025-05-18 17:28:27,389 - websocket_server - INFO - Nhận yêu cầu phân tích (thinking) cho câu hỏi: 
2025-05-18 17:28:27,389 - websocket_server - INFO - Đã thêm 1 tin nhắn gần nhất vào prompt
2025-05-18 17:28:27,391 - websocket_server - INFO - Đã lưu lịch sử tin nhắn và prompt vào file: data/logs/history_prompt_20250518_172827.txt
2025-05-18 17:28:27,392 - websocket_server - INFO - Phân tích câu hỏi để xác định phòng ban hoặc loại câu hỏi
2025-05-18 17:28:27,393 - chatbot_rag - INFO - Đang phân tích câu hỏi với LLM: Lịch sử tin nhắn:
Người dùng: xin chào

, session_id: 755c7188-5b94-47b0-beb7-4006c742db63
2025-05-18 17:28:27,415 - chatbot_rag - INFO - [analyze_query_with_llm] Đã lấy được 0 bản ghi lịch sử từ websocket_server cho session 755c7188-5b94-47b0-beb7-4006c742db63
2025-05-18 17:28:27,415 - chatbot_rag - INFO - [analyze_query_with_llm] Sử dụng lịch sử hội thoại: 0 bản ghi
2025-05-18 17:28:27,415 - chatbot_rag - INFO - [analyze_query_with_llm] Prompt cuối cùng: Lịch sử tin nhắn:
        
        Câu hỏi người dùng hiện tại: "Lịch sử tin nhắn:
Người dùng: xin chào

"

        Phân tích câu hỏi và trả về JSON có định dạng:
        {"department": "tên phòng ban...
2025-05-18 17:28:27,416 - chatbot_rag - INFO - Kích thước prompt: 621 ký tự
2025-05-18 17:28:27,416 - chatbot_rag - INFO - Kích thước system prompt: 2006 ký tự
2025-05-18 17:28:27,416 - chatbot_rag - INFO - Tổng kích thước: 2627 ký tự
2025-05-18 17:28:27,418 - chatbot_rag - INFO - Đã lưu full prompt vào file: data/logs/llm_full_prompt_20250518_172827.txt
2025-05-18 17:28:27,418 - chatbot_rag - INFO - System prompt: 
        Bạn là trợ lý AI phân tích câu hỏi để xác định:
        1. Phòng ban người dùng đang hỏi (department)
        2. Loại câu hỏi: phòng ban cụ thể hay general (query_type)
        3. Nếu câu hỏi...
2025-05-18 17:28:27,418 - chatbot_rag - INFO - User prompt: Lịch sử tin nhắn:
        
        Câu hỏi người dùng hiện tại: "Lịch sử tin nhắn:
Người dùng: xin chào

"

        Phân tích câu hỏi và trả về JSON có định dạng:
        {"department": "tên phòng ban...
2025-05-18 17:28:27,419 - chatbot_rag - INFO - Gửi truy vấn đến LLM API tại http://192.168.1.4:1234/v1/chat/completions với stream=False
2025-05-18 17:28:51,640 - chatbot_rag - INFO - Mã phản hồi từ API: 200
2025-05-18 17:28:51,641 - chatbot_rag - INFO - Phản hồi gốc từ LLM API (200 ký tự đầu): <think>
Okay, let's break this down. The user provided a history of messages where the initial message is "xin chào" (which means "hello"). Now, the current question is asking to analyze this and retu
2025-05-18 17:28:51,643 - chatbot_rag - INFO - Đã lưu phản hồi đầy đủ vào file: data/logs/llm_response_20250518_172851.txt
2025-05-18 17:28:51,645 - chatbot_rag - INFO - [analysis_20250518_172851] Đã ghi phản hồi gốc vào: data/logs/analysis_20250518_172851_raw.txt
2025-05-18 17:28:51,646 - chatbot_rag - INFO - [analysis_20250518_172851] Phản hồi gốc: <think>
Okay, let's break this down. The user provided a history of messages where the initial messa...
2025-05-18 17:28:51,646 - chatbot_rag - WARNING - [analysis_20250518_172851] Phát hiện thẻ <think> trong phản hồi. Xử lý đặc biệt...
2025-05-18 17:28:51,647 - chatbot_rag - INFO - [analysis_20250518_172851] BƯỚC 1: Thử parse toàn bộ chuỗi phản hồi
2025-05-18 17:28:51,648 - chatbot_rag - INFO - [analysis_20250518_172851] BƯỚC 1: Không phải JSON hợp lệ: Expecting value: line 1 column 1 (char 0)
2025-05-18 17:28:51,649 - chatbot_rag - INFO - [analysis_20250518_172851] BƯỚC 2: Tìm JSON trong chuỗi phản hồi
2025-05-18 17:28:51,649 - chatbot_rag - WARNING - [analysis_20250518_172851] BƯỚC 2: Không tìm thấy mẫu JSON nào trong phản hồi
2025-05-18 17:28:51,649 - chatbot_rag - INFO - [analysis_20250518_172851] BƯỚC 3: Xử lý chuỗi thủ công để trích xuất thông tin
2025-05-18 17:28:51,659 - department_info_tool - INFO - Đã tải 11 phòng ban
2025-05-18 17:28:51,660 - department_info_tool - INFO - Đã lấy danh sách 11 phòng ban
2025-05-18 17:28:51,660 - chatbot_rag - ERROR - [analysis_20250518_172851] BƯỚC 3: Lỗi khi xử lý chuỗi thủ công: local variable 'query_type' referenced before assignment
2025-05-18 17:28:51,660 - chatbot_rag - WARNING - [analysis_20250518_172851] Tất cả phương pháp phân tích đều thất bại, trả về kết quả mặc định
2025-05-18 17:28:51,663 - websocket_server - INFO - Lấy phân tích cho câu hỏi chung
2025-05-18 17:28:51,663 - chatbot_rag - INFO - Xử lý câu hỏi chung cho session_id: 755c7188-5b94-47b0-beb7-4006c742db63
2025-05-18 17:28:51,666 - department_info_tool - INFO - Đã tải 11 phòng ban
2025-05-18 17:28:51,667 - department_info_tool - INFO - Đã lấy danh sách 11 phòng ban
2025-05-18 17:28:51,667 - chatbot_rag - INFO - Gọi LLM để trả lời câu hỏi chung cho session_id: 755c7188-5b94-47b0-beb7-4006c742db63
2025-05-18 17:28:51,669 - chatbot_rag - INFO - Đã lưu prompt vào file: data/logs/prompt_general_20250518_172851.txt
2025-05-18 17:28:51,669 - chatbot_rag - INFO - Kích thước prompt: 1022 ký tự
2025-05-18 17:28:51,670 - chatbot_rag - INFO - Kích thước system prompt: 916 ký tự
2025-05-18 17:28:51,670 - chatbot_rag - INFO - Tổng kích thước: 1938 ký tự
2025-05-18 17:28:51,673 - chatbot_rag - INFO - Đã lưu full prompt vào file: data/logs/llm_full_prompt_20250518_172851.txt
2025-05-18 17:28:51,674 - chatbot_rag - INFO - System prompt: 
Bạn là trợ lý AI chuyên về quy trình và giai đoạn trong công ty.

DANH SÁCH PHÒNG BAN:
- 2D
- Dự toán
- Khách hàng
- Kinh doanh
- Kế toán
- Marketing
- Mua hàng
- Team dự án
- Thi công
- Thiết kế
- Đ...
2025-05-18 17:28:51,675 - chatbot_rag - INFO - User prompt: 
Câu hỏi: " /think"

Đây là câu hỏi chung về quy trình hoặc giai đoạn làm việc.

Thông tin cơ bản:
### Thông tin tổng quan về quy trình và giai đoạn

#### Giai đoạn chính trong quy trình:
1. **MKT-SAL...
2025-05-18 17:28:51,676 - chatbot_rag - INFO - Gửi truy vấn đến LLM API tại http://192.168.1.4:1234/v1/chat/completions với stream=True
2025-05-18 17:29:20,756 - chatbot_rag - INFO - Mã phản hồi từ API: 200
2025-05-18 17:29:20,758 - chatbot_rag - INFO - Phản hồi gốc từ LLM API (200 ký tự đầu): <think>
Okay, let me process this. The user is asking a general question about the workflow or stages. They provided some structure and departments.

First, I need to follow the strict rules: don't cr
2025-05-18 17:29:20,760 - chatbot_rag - INFO - Đã lưu phản hồi đầy đủ vào file: data/logs/llm_response_20250518_172920.txt
2025-05-18 17:29:21,147 - websocket_server - INFO - Đã trích xuất thinking (1003 ký tự) và còn lại 416 ký tự phản hồi
2025-05-18 17:29:21,147 - websocket_server - INFO - Đã trích xuất phần thinking (1003 ký tự) từ phản hồi handle_general_query
2025-05-18 17:29:21,147 - websocket_server - INFO - Gửi phản hồi thinking với request_id: thinking_1747564107387_cokuwo7
2025-05-18 17:29:21,148 - websocket_server - INFO - Đã gửi nội dung thinking (1003 ký tự)
2025-05-18 17:29:21,151 - websocket_server - INFO - Nhận tin nhắn dạng JSON: {"content":"xin chào","session_id":"","mode":"basic","basic_prompt":"Bạn là một trợ lý AI hữu ích và
2025-05-18 17:29:21,151 - websocket_server - INFO - Session ID không được cung cấp trong tin nhắn JSON, sử dụng current_session_id: 755c7188-5b94-47b0-beb7-4006c742db63
2025-05-18 17:29:21,151 - websocket_server - INFO - Session ID từ client (sau khi kiểm tra): 755c7188-5b94-47b0-beb7-4006c742db63
2025-05-18 17:29:21,151 - websocket_server - INFO - Nhận tin nhắn thông thường: xin chào, enable_thinking=False, mode=basic
2025-05-18 17:29:21,152 - websocket_server - INFO - Chế độ Basic được kích hoạt với prompt: Bạn là một trợ lý AI hữu ích và thông minh. Hãy trả lời câu hỏi của người dùng một cách chi tiết và ...
2025-05-18 17:29:21,153 - websocket_server - INFO - Xử lý streaming response cho: 'xin chào', phòng ban: None, session_id: 755c7188-5b94-47b0-beb7-4006c742db63, mode: basic
2025-05-18 17:29:21,154 - websocket_server - INFO - Session ID nhận được: 755c7188-5b94-47b0-beb7-4006c742db63
2025-05-18 17:29:21,154 - websocket_server - INFO - Xử lý streaming response. Query: 'xin chào', Mode thinking: False
2025-05-18 17:29:21,154 - websocket_server - INFO - Chế độ Basic được kích hoạt với prompt: Bạn là một trợ lý AI hữu ích và thông minh. Hãy trả lời câu hỏi của người dùng một cách chi tiết và ...
2025-05-18 17:29:21,155 - websocket_server - INFO - Đã thêm 1 tin nhắn gần nhất vào prompt
2025-05-18 17:29:21,158 - websocket_server - INFO - Đã lưu lịch sử tin nhắn và prompt vào file: data/logs/history_prompt_20250518_172921.txt
2025-05-18 17:29:21,158 - websocket_server - INFO - Kích thước prompt: 48 ký tự
2025-05-18 17:29:21,159 - websocket_server - INFO - Kích thước system prompt: 174 ký tự
2025-05-18 17:29:21,160 - websocket_server - INFO - Tổng kích thước: 222 ký tự
2025-05-18 17:29:21,160 - websocket_server - INFO - Bắt đầu gọi LLM API (lần thử 1/3)
2025-05-18 17:29:26,393 - websocket_server - INFO - API trả về status 200 OK
2025-05-18 17:29:26,395 - websocket_server - INFO - Streaming hoàn tất thành công
2025-05-18 17:29:26,396 - websocket_server - INFO - Lưu hội thoại basic mode vào lịch sử với session_id=755c7188-5b94-47b0-beb7-4006c742db63
2025-05-18 17:29:27,961 - websocket_server - WARNING - Session  không tồn tại, sử dụng session hiện tại
2025-05-18 17:29:27,961 - websocket_server - INFO - Nhận yêu cầu phân tích (thinking) cho câu hỏi: 
2025-05-18 17:29:27,961 - websocket_server - INFO - Đã thêm 2 tin nhắn gần nhất vào prompt
2025-05-18 17:29:27,963 - websocket_server - INFO - Đã lưu lịch sử tin nhắn và prompt vào file: data/logs/history_prompt_20250518_172927.txt
2025-05-18 17:29:27,964 - websocket_server - INFO - Phân tích câu hỏi để xác định phòng ban hoặc loại câu hỏi
2025-05-18 17:29:27,964 - chatbot_rag - INFO - Đang phân tích câu hỏi với LLM: Lịch sử tin nhắn:
Người dùng: xin chào
Người dùng: xin chào

, session_id: 755c7188-5b94-47b0-beb7-4006c742db63
2025-05-18 17:29:27,964 - chatbot_rag - INFO - [analyze_query_with_llm] Đã lấy được 0 bản ghi lịch sử từ websocket_server cho session 755c7188-5b94-47b0-beb7-4006c742db63
2025-05-18 17:29:27,965 - chatbot_rag - INFO - [analyze_query_with_llm] Sử dụng lịch sử hội thoại: 0 bản ghi
2025-05-18 17:29:27,965 - chatbot_rag - INFO - [analyze_query_with_llm] Prompt cuối cùng: Lịch sử tin nhắn:
        
        Câu hỏi người dùng hiện tại: "Lịch sử tin nhắn:
Người dùng: xin chào
Người dùng: xin chào

"

        Phân tích câu hỏi và trả về JSON có định dạng:
        {"depart...
2025-05-18 17:29:27,966 - chatbot_rag - INFO - Kích thước prompt: 642 ký tự
2025-05-18 17:29:27,966 - chatbot_rag - INFO - Kích thước system prompt: 2006 ký tự
2025-05-18 17:29:27,966 - chatbot_rag - INFO - Tổng kích thước: 2648 ký tự
2025-05-18 17:29:27,968 - chatbot_rag - INFO - Đã lưu full prompt vào file: data/logs/llm_full_prompt_20250518_172927.txt
2025-05-18 17:29:27,969 - chatbot_rag - INFO - System prompt: 
        Bạn là trợ lý AI phân tích câu hỏi để xác định:
        1. Phòng ban người dùng đang hỏi (department)
        2. Loại câu hỏi: phòng ban cụ thể hay general (query_type)
        3. Nếu câu hỏi...
2025-05-18 17:29:27,969 - chatbot_rag - INFO - User prompt: Lịch sử tin nhắn:
        
        Câu hỏi người dùng hiện tại: "Lịch sử tin nhắn:
Người dùng: xin chào
Người dùng: xin chào

"

        Phân tích câu hỏi và trả về JSON có định dạng:
        {"depart...
2025-05-18 17:29:27,970 - chatbot_rag - INFO - Gửi truy vấn đến LLM API tại http://192.168.1.4:1234/v1/chat/completions với stream=False
2025-05-18 17:29:51,378 - chatbot_rag - INFO - Mã phản hồi từ API: 200
2025-05-18 17:29:51,379 - chatbot_rag - INFO - Phản hồi gốc từ LLM API (200 ký tự đầu): <think>
Okay, let me tackle this query step by step. The user provided a history of messages where the conversation is just "xin chào" repeated twice. The current question is asking for an analysis ba
2025-05-18 17:29:51,381 - chatbot_rag - INFO - Đã lưu phản hồi đầy đủ vào file: data/logs/llm_response_20250518_172951.txt
2025-05-18 17:29:51,384 - chatbot_rag - INFO - [analysis_20250518_172951] Đã ghi phản hồi gốc vào: data/logs/analysis_20250518_172951_raw.txt
2025-05-18 17:29:51,384 - chatbot_rag - INFO - [analysis_20250518_172951] Phản hồi gốc: <think>
Okay, let me tackle this query step by step. The user provided a history of messages where t...
2025-05-18 17:29:51,384 - chatbot_rag - WARNING - [analysis_20250518_172951] Phát hiện thẻ <think> trong phản hồi. Xử lý đặc biệt...
2025-05-18 17:29:51,385 - chatbot_rag - INFO - [analysis_20250518_172951] BƯỚC 1: Thử parse toàn bộ chuỗi phản hồi
2025-05-18 17:29:51,385 - chatbot_rag - INFO - [analysis_20250518_172951] BƯỚC 1: Không phải JSON hợp lệ: Expecting value: line 1 column 1 (char 0)
2025-05-18 17:29:51,386 - chatbot_rag - INFO - [analysis_20250518_172951] BƯỚC 2: Tìm JSON trong chuỗi phản hồi
2025-05-18 17:29:51,386 - chatbot_rag - WARNING - [analysis_20250518_172951] BƯỚC 2: Không tìm thấy mẫu JSON nào trong phản hồi
2025-05-18 17:29:51,387 - chatbot_rag - INFO - [analysis_20250518_172951] BƯỚC 3: Xử lý chuỗi thủ công để trích xuất thông tin
2025-05-18 17:29:51,399 - department_info_tool - INFO - Đã tải 11 phòng ban
2025-05-18 17:29:51,400 - department_info_tool - INFO - Đã lấy danh sách 11 phòng ban
2025-05-18 17:29:51,403 - chatbot_rag - ERROR - [analysis_20250518_172951] BƯỚC 3: Lỗi khi xử lý chuỗi thủ công: local variable 'query_type' referenced before assignment
2025-05-18 17:29:51,403 - chatbot_rag - WARNING - [analysis_20250518_172951] Tất cả phương pháp phân tích đều thất bại, trả về kết quả mặc định
2025-05-18 17:29:51,404 - websocket_server - INFO - Lấy phân tích cho câu hỏi chung
2025-05-18 17:29:51,404 - chatbot_rag - INFO - Xử lý câu hỏi chung cho session_id: 755c7188-5b94-47b0-beb7-4006c742db63
2025-05-18 17:29:51,413 - department_info_tool - INFO - Đã tải 11 phòng ban
2025-05-18 17:29:51,413 - department_info_tool - INFO - Đã lấy danh sách 11 phòng ban
2025-05-18 17:29:51,414 - chatbot_rag - INFO - Gọi LLM để trả lời câu hỏi chung cho session_id: 755c7188-5b94-47b0-beb7-4006c742db63
2025-05-18 17:29:51,416 - chatbot_rag - INFO - Đã lưu prompt vào file: data/logs/prompt_general_20250518_172951.txt
2025-05-18 17:29:51,416 - chatbot_rag - INFO - Kích thước prompt: 1022 ký tự
2025-05-18 17:29:51,417 - chatbot_rag - INFO - Kích thước system prompt: 916 ký tự
2025-05-18 17:29:51,417 - chatbot_rag - INFO - Tổng kích thước: 1938 ký tự
2025-05-18 17:29:51,420 - chatbot_rag - INFO - Đã lưu full prompt vào file: data/logs/llm_full_prompt_20250518_172951.txt
2025-05-18 17:29:51,421 - chatbot_rag - INFO - System prompt: 
Bạn là trợ lý AI chuyên về quy trình và giai đoạn trong công ty.

DANH SÁCH PHÒNG BAN:
- 2D
- Dự toán
- Khách hàng
- Kinh doanh
- Kế toán
- Marketing
- Mua hàng
- Team dự án
- Thi công
- Thiết kế
- Đ...
2025-05-18 17:29:51,421 - chatbot_rag - INFO - User prompt: 
Câu hỏi: " /think"

Đây là câu hỏi chung về quy trình hoặc giai đoạn làm việc.

Thông tin cơ bản:
### Thông tin tổng quan về quy trình và giai đoạn

#### Giai đoạn chính trong quy trình:
1. **MKT-SAL...
2025-05-18 17:29:51,422 - chatbot_rag - INFO - Gửi truy vấn đến LLM API tại http://192.168.1.4:1234/v1/chat/completions với stream=True
2025-05-18 17:30:41,779 - chatbot_rag - INFO - Mã phản hồi từ API: 200
2025-05-18 17:30:41,781 - chatbot_rag - INFO - Phản hồi gốc từ LLM API (200 ký tự đầu): <think>
Okay, let me process this. The user provided a query that's asking about the general process or stages of work in a company. They mentioned specific departments and stages. According to the in
2025-05-18 17:30:41,785 - chatbot_rag - INFO - Đã lưu phản hồi đầy đủ vào file: data/logs/llm_response_20250518_173041.txt
2025-05-18 17:30:41,791 - websocket_server - INFO - Đã trích xuất thinking (2403 ký tự) và còn lại 408 ký tự phản hồi
2025-05-18 17:30:41,792 - websocket_server - INFO - Đã trích xuất phần thinking (2403 ký tự) từ phản hồi handle_general_query
2025-05-18 17:30:41,793 - websocket_server - INFO - Gửi phản hồi thinking với request_id: thinking_1747564167960_t3vsoaw
2025-05-18 17:30:41,794 - websocket_server - INFO - Đã gửi nội dung thinking (2403 ký tự)
2025-05-18 17:31:18,088 - websockets.server - INFO - connection open
2025-05-18 17:31:18,113 - websockets.server - INFO - connection open
2025-05-18 17:32:49,119 - websockets.server - INFO - connection open
2025-05-18 17:32:49,215 - websockets.server - INFO - connection open
2025-05-18 17:33:00,256 - websockets.server - INFO - connection open
2025-05-18 17:33:00,393 - websockets.server - INFO - connection open
2025-05-18 17:33:18,965 - websockets.server - INFO - connection open
2025-05-18 17:33:19,062 - websockets.server - INFO - connection open
2025-05-18 17:33:54,957 - websockets.server - INFO - connection closed
2025-05-18 17:33:54,959 - websockets.server - INFO - connection closed
2025-05-18 17:33:54,960 - websockets.server - INFO - connection closed
2025-05-18 17:33:54,960 - websockets.server - INFO - connection closed
2025-05-18 17:33:54,960 - websockets.server - INFO - connection closed
2025-05-18 17:33:56,333 - websockets.server - INFO - connection open
2025-05-18 17:40:51,769 - websockets.server - INFO - connection open
2025-05-18 17:40:51,793 - websockets.server - INFO - connection open
2025-05-18 17:40:51,814 - websockets.server - INFO - connection open
2025-05-18 17:40:51,837 - websockets.server - INFO - connection open
2025-05-18 17:42:26,551 - websockets.server - INFO - connection open
2025-05-18 17:42:26,706 - websockets.server - INFO - connection open
2025-05-18 17:44:52,591 - websockets.server - INFO - connection closed
2025-05-18 17:44:52,595 - websockets.server - INFO - connection closed
2025-05-18 17:44:52,598 - websockets.server - INFO - connection closed
2025-05-18 17:44:52,598 - websockets.server - INFO - connection closed
2025-05-18 17:44:52,773 - websockets.server - INFO - connection closed
2025-05-18 17:44:52,776 - websockets.server - INFO - connection closed
2025-05-18 17:44:52,778 - websockets.server - INFO - connection closed
2025-05-18 17:44:52,779 - websockets.server - INFO - connection closed
2025-05-18 17:44:52,783 - websockets.server - INFO - connection closed
2025-05-18 17:44:52,786 - websockets.server - INFO - connection closed
2025-05-18 17:44:52,787 - websockets.server - INFO - connection closed
2025-05-18 17:44:52,788 - websockets.server - INFO - connection closed
2025-05-18 17:44:55,028 - websockets.server - INFO - connection open
2025-05-18 17:44:55,094 - websockets.server - INFO - connection open
2025-05-18 17:45:22,450 - websockets.server - INFO - connection open
2025-05-18 17:45:22,502 - websockets.server - INFO - connection open
2025-05-18 17:46:48,937 - websockets.server - INFO - connection open
2025-05-18 17:46:49,045 - websockets.server - INFO - connection open
2025-05-18 17:47:02,899 - websockets.server - INFO - connection open
2025-05-18 17:47:02,922 - websockets.server - INFO - connection open
2025-05-18 17:47:21,627 - websockets.server - INFO - connection open
2025-05-18 17:47:21,770 - websockets.server - INFO - connection open
2025-05-18 17:52:29,727 - websockets.server - INFO - connection open
2025-05-18 17:52:29,794 - websockets.server - INFO - connection open
2025-05-18 17:53:11,717 - websockets.server - INFO - connection open
2025-05-18 17:53:11,833 - websockets.server - INFO - connection open
2025-05-18 17:54:31,425 - websockets.server - INFO - connection open
2025-05-18 17:54:31,567 - websockets.server - INFO - connection open
2025-05-18 17:54:44,356 - websockets.server - INFO - connection open
2025-05-18 17:54:44,373 - websockets.server - INFO - connection open
2025-05-18 17:56:09,416 - websockets.server - INFO - connection open
2025-05-18 17:56:09,429 - websockets.server - INFO - connection open
2025-05-18 17:56:22,629 - websockets.server - INFO - connection open
2025-05-18 17:56:22,802 - websockets.server - INFO - connection open
2025-05-18 17:56:40,395 - websockets.server - INFO - connection open
2025-05-18 17:56:40,412 - websockets.server - INFO - connection open
2025-05-18 19:12:41,685 - websockets.server - INFO - connection open
2025-05-18 19:12:41,702 - websockets.server - INFO - connection open
2025-05-18 19:12:58,585 - websockets.server - INFO - connection open
2025-05-18 19:12:58,599 - websockets.server - INFO - connection open
2025-05-18 19:13:14,975 - websockets.server - INFO - connection open
2025-05-18 19:13:15,039 - websockets.server - INFO - connection open
2025-05-18 19:32:41,356 - websockets.server - INFO - connection closed
2025-05-18 19:32:41,363 - websockets.server - INFO - connection closed
2025-05-18 19:32:41,365 - websockets.server - INFO - connection closed
2025-05-18 19:32:41,367 - websockets.server - INFO - connection closed
2025-05-18 19:32:41,369 - websockets.server - INFO - connection closed
2025-05-18 19:32:41,370 - websockets.server - INFO - connection closed
2025-05-18 19:32:41,371 - websockets.server - INFO - connection closed
2025-05-18 19:32:41,371 - websockets.server - INFO - connection closed
2025-05-18 19:32:41,371 - websockets.server - INFO - connection closed
2025-05-18 19:32:41,372 - websockets.server - INFO - connection closed
2025-05-18 19:32:41,372 - websockets.server - INFO - connection closed
2025-05-18 19:32:41,373 - websockets.server - INFO - connection closed
2025-05-18 19:32:41,374 - websockets.server - INFO - connection closed
2025-05-18 19:32:41,374 - websockets.server - INFO - connection closed
2025-05-18 19:32:41,375 - websockets.server - INFO - connection closed
2025-05-18 19:32:41,375 - websockets.server - INFO - connection closed
2025-05-18 19:32:41,376 - websockets.server - INFO - connection closed
2025-05-18 19:32:41,376 - websockets.server - INFO - connection closed
2025-05-18 19:32:41,377 - websockets.server - INFO - connection closed
2025-05-18 19:32:41,379 - websockets.server - INFO - connection closed
2025-05-18 19:32:41,380 - websockets.server - INFO - connection closed
2025-05-18 19:32:41,380 - websockets.server - INFO - connection closed
2025-05-18 19:32:41,381 - websockets.server - INFO - connection closed
2025-05-18 19:32:41,381 - websockets.server - INFO - connection closed
2025-05-18 19:32:41,382 - websockets.server - INFO - connection closed
2025-05-18 19:32:41,383 - websockets.server - INFO - connection closed
2025-05-18 19:32:41,383 - websockets.server - INFO - connection closed
2025-05-18 19:32:41,384 - websockets.server - INFO - connection closed
2025-05-18 19:32:41,384 - websockets.server - INFO - connection closed
2025-05-18 19:32:41,385 - websockets.server - INFO - connection closed
2025-05-18 19:32:41,387 - websockets.server - INFO - server closing
2025-05-18 19:32:41,392 - websockets.server - INFO - server closed
2025-05-18 19:32:41,436 - websocket_server - INFO - Server bị dừng bởi người dùng
2025-05-18 19:32:43,889 - websocket_server - INFO - Khởi động server WebSocket tại 0.0.0.0:8090
2025-05-18 19:32:43,919 - websockets.server - INFO - server listening on 0.0.0.0:8090
2025-05-18 19:32:43,919 - websocket_server - INFO - Server WebSocket đang chạy tại ws://0.0.0.0:8090
2025-05-18 19:32:43,919 - websocket_server - INFO - Đã cấu hình ping_timeout=6000 giây, ping_interval=60 giây
2025-05-18 19:32:54,374 - websockets.server - INFO - connection open
2025-05-18 19:32:54,499 - websockets.server - INFO - connection open
2025-05-18 19:32:54,585 - websockets.server - INFO - connection open
2025-05-18 19:32:54,770 - websockets.server - INFO - connection closed
2025-05-18 19:32:55,158 - websockets.server - INFO - connection closed
2025-05-18 19:33:22,017 - websocket_server - INFO - Nhận tin nhắn dạng JSON: {"content":"xin chào /no_think","session_id":"","mode":"basic","basic_prompt":"bạn là người phản biệ
2025-05-18 19:33:22,018 - websocket_server - INFO - Session ID không được cung cấp trong tin nhắn JSON, sử dụng current_session_id: b5c00203-6d1b-47b4-a61a-026ae346ed95
2025-05-18 19:33:22,018 - websocket_server - INFO - Session ID từ client (sau khi kiểm tra): b5c00203-6d1b-47b4-a61a-026ae346ed95
2025-05-18 19:33:22,019 - websocket_server - INFO - Tắt chế độ thinking cho câu hỏi: xin chào /no_think...
2025-05-18 19:33:22,019 - websocket_server - INFO - Nhận tin nhắn thông thường: xin chào /no_think, enable_thinking=False, mode=basic
2025-05-18 19:33:22,020 - websocket_server - INFO - Chế độ Basic được kích hoạt với prompt: bạn là người phản biện tôi, hãy phản biện mọi thứ tôi nói...
2025-05-18 19:33:22,020 - websocket_server - INFO - Xử lý streaming response cho: 'xin chào /no_think', phòng ban: None, session_id: b5c00203-6d1b-47b4-a61a-026ae346ed95, mode: basic
2025-05-18 19:33:22,020 - websocket_server - INFO - Session ID nhận được: b5c00203-6d1b-47b4-a61a-026ae346ed95
2025-05-18 19:33:22,021 - websocket_server - INFO - Phát hiện lệnh /no_think, tắt chế độ thinking cho: xin chào
2025-05-18 19:33:22,021 - websocket_server - INFO - Xử lý streaming response. Query: 'xin chào', Mode: basic, Thinking: False
2025-05-18 19:33:22,022 - websocket_server - INFO - Chế độ Basic được kích hoạt với prompt: bạn là người phản biện tôi, hãy phản biện mọi thứ tôi nói...
2025-05-18 19:33:22,022 - websocket_server - INFO - Không có lịch sử tin nhắn cho phiên này
2025-05-18 19:33:22,022 - websocket_server - INFO - Kích thước prompt: 8 ký tự
2025-05-18 19:33:22,023 - websocket_server - INFO - Kích thước system prompt: 57 ký tự
2025-05-18 19:33:22,023 - websocket_server - INFO - Tổng kích thước: 65 ký tự
2025-05-18 19:33:22,023 - websocket_server - INFO - Bắt đầu gọi LLM API (lần thử 1/3)
2025-05-18 19:33:29,390 - websocket_server - INFO - API trả về status 200 OK
2025-05-18 19:33:29,391 - websocket_server - INFO - Streaming hoàn tất thành công
2025-05-18 19:33:29,392 - websocket_server - INFO - Gửi phản hồi cuối cùng, chế độ basic, thinking_enabled: False, thinking_collected: False
2025-05-18 19:33:29,392 - websocket_server - INFO - Lưu hội thoại basic mode vào lịch sử với session_id=b5c00203-6d1b-47b4-a61a-026ae346ed95
2025-05-18 19:34:02,112 - websocket_server - INFO - Nhận tin nhắn dạng JSON: {"content":"xin chào /think","session_id":"","mode":"basic","basic_prompt":"bạn là người phản biện t
2025-05-18 19:34:02,113 - websocket_server - INFO - Session ID không được cung cấp trong tin nhắn JSON, sử dụng current_session_id: b5c00203-6d1b-47b4-a61a-026ae346ed95
2025-05-18 19:34:02,113 - websocket_server - INFO - Session ID từ client (sau khi kiểm tra): b5c00203-6d1b-47b4-a61a-026ae346ed95
2025-05-18 19:34:02,114 - websocket_server - INFO - Bật chế độ thinking cho câu hỏi: xin chào /think...
2025-05-18 19:34:02,114 - websocket_server - INFO - Nhận tin nhắn thông thường: xin chào /think, enable_thinking=True, mode=basic
2025-05-18 19:34:02,115 - websocket_server - INFO - Chế độ Basic được kích hoạt với prompt: bạn là người phản biện tôi, hãy phản biện mọi thứ tôi nói...
2025-05-18 19:34:02,115 - websocket_server - INFO - Xử lý streaming response cho: 'xin chào /think', phòng ban: None, session_id: b5c00203-6d1b-47b4-a61a-026ae346ed95, mode: basic
2025-05-18 19:34:02,116 - websocket_server - INFO - Session ID nhận được: b5c00203-6d1b-47b4-a61a-026ae346ed95
2025-05-18 19:34:02,116 - websocket_server - INFO - Phát hiện lệnh /think, bật chế độ thinking cho: xin chào
2025-05-18 19:34:02,116 - websocket_server - INFO - Xử lý streaming response. Query: 'xin chào', Mode: basic, Thinking: True
2025-05-18 19:34:02,117 - websocket_server - INFO - Chế độ Basic được kích hoạt với prompt: bạn là người phản biện tôi, hãy phản biện mọi thứ tôi nói...
2025-05-18 19:34:02,117 - websocket_server - INFO - Đã thêm 1 tin nhắn gần nhất vào prompt
2025-05-18 19:34:02,119 - websocket_server - INFO - Đã lưu lịch sử tin nhắn và prompt vào file: data/logs/history_prompt_20250518_193402.txt
2025-05-18 19:34:02,119 - websocket_server - INFO - Kích thước prompt: 48 ký tự
2025-05-18 19:34:02,119 - websocket_server - INFO - Kích thước system prompt: 57 ký tự
2025-05-18 19:34:02,119 - websocket_server - INFO - Tổng kích thước: 105 ký tự
2025-05-18 19:34:02,120 - websocket_server - INFO - Bắt đầu gọi LLM API (lần thử 1/3)
2025-05-18 19:34:18,919 - websocket_server - INFO - API trả về status 200 OK
2025-05-18 19:34:18,919 - websocket_server - INFO - Streaming hoàn tất thành công
2025-05-18 19:34:18,920 - websocket_server - INFO - Gửi phản hồi cuối cùng, chế độ basic, thinking_enabled: True, thinking_collected: False
2025-05-18 19:34:18,921 - websocket_server - INFO - Lưu hội thoại basic mode vào lịch sử với session_id=b5c00203-6d1b-47b4-a61a-026ae346ed95
2025-05-18 19:34:42,421 - websocket_server - WARNING - Session  không tồn tại, sử dụng session hiện tại
2025-05-18 19:34:42,422 - websocket_server - INFO - Nhận yêu cầu phân tích (thinking) cho câu hỏi: 
2025-05-18 19:34:42,422 - websocket_server - INFO - Đã thêm 2 tin nhắn gần nhất vào prompt
2025-05-18 19:34:42,423 - websocket_server - INFO - Đã lưu lịch sử tin nhắn và prompt vào file: data/logs/history_prompt_20250518_193442.txt
2025-05-18 19:34:42,424 - websocket_server - INFO - Phân tích câu hỏi để xác định phòng ban hoặc loại câu hỏi
2025-05-18 19:34:42,425 - chatbot_rag - INFO - Đang phân tích câu hỏi với LLM: Lịch sử tin nhắn:
Người dùng: xin chào
Người dùng: xin chào

, session_id: b5c00203-6d1b-47b4-a61a-026ae346ed95
2025-05-18 19:34:42,451 - chatbot_rag - INFO - [analyze_query_with_llm] Đã lấy được 0 bản ghi lịch sử từ websocket_server cho session b5c00203-6d1b-47b4-a61a-026ae346ed95
2025-05-18 19:34:42,452 - chatbot_rag - INFO - [analyze_query_with_llm] Sử dụng lịch sử hội thoại: 0 bản ghi
2025-05-18 19:34:42,452 - chatbot_rag - INFO - [analyze_query_with_llm] Prompt cuối cùng: Lịch sử tin nhắn:
        
        Câu hỏi người dùng hiện tại: "Lịch sử tin nhắn:
Người dùng: xin chào
Người dùng: xin chào

"

        Phân tích câu hỏi và trả về JSON có định dạng:
        {"depart...
2025-05-18 19:34:42,453 - chatbot_rag - INFO - Kích thước prompt: 642 ký tự
2025-05-18 19:34:42,454 - chatbot_rag - INFO - Kích thước system prompt: 2006 ký tự
2025-05-18 19:34:42,454 - chatbot_rag - INFO - Tổng kích thước: 2648 ký tự
2025-05-18 19:34:42,455 - chatbot_rag - INFO - Đã lưu full prompt vào file: data/logs/llm_full_prompt_20250518_193442.txt
2025-05-18 19:34:42,456 - chatbot_rag - INFO - System prompt: 
        Bạn là trợ lý AI phân tích câu hỏi để xác định:
        1. Phòng ban người dùng đang hỏi (department)
        2. Loại câu hỏi: phòng ban cụ thể hay general (query_type)
        3. Nếu câu hỏi...
2025-05-18 19:34:42,456 - chatbot_rag - INFO - User prompt: Lịch sử tin nhắn:
        
        Câu hỏi người dùng hiện tại: "Lịch sử tin nhắn:
Người dùng: xin chào
Người dùng: xin chào

"

        Phân tích câu hỏi và trả về JSON có định dạng:
        {"depart...
2025-05-18 19:34:42,457 - chatbot_rag - INFO - Gửi truy vấn đến LLM API tại http://192.168.1.4:1234/v1/chat/completions với stream=False
2025-05-18 19:35:02,651 - chatbot_rag - INFO - Mã phản hồi từ API: 200
2025-05-18 19:35:02,652 - chatbot_rag - INFO - Phản hồi gốc từ LLM API (200 ký tự đầu): <think>
Okay, let's tackle this query. The user provided a history of messages where they just said "xin chào" twice. Now, the current question is asking about the conversation history. 

First, I nee
2025-05-18 19:35:02,653 - chatbot_rag - INFO - Đã lưu phản hồi đầy đủ vào file: data/logs/llm_response_20250518_193502.txt
2025-05-18 19:35:02,655 - chatbot_rag - INFO - [analysis_20250518_193502] Đã ghi phản hồi gốc vào: data/logs/analysis_20250518_193502_raw.txt
2025-05-18 19:35:02,655 - chatbot_rag - INFO - [analysis_20250518_193502] Phản hồi gốc: <think>
Okay, let's tackle this query. The user provided a history of messages where they just said ...
2025-05-18 19:35:02,656 - chatbot_rag - WARNING - [analysis_20250518_193502] Phát hiện thẻ <think> trong phản hồi. Xử lý đặc biệt...
2025-05-18 19:35:02,657 - chatbot_rag - INFO - [analysis_20250518_193502] Đã tìm thấy 1 mẫu JSON tiềm năng trong phản hồi
2025-05-18 19:35:02,657 - chatbot_rag - INFO - [analysis_20250518_193502] Tìm thấy JSON hợp lệ trong thẻ <think>: {'department': None, 'query_type': 'general', 'error': False}
2025-05-18 19:35:02,657 - websocket_server - INFO - Lấy phân tích cho câu hỏi chung
2025-05-18 19:35:02,658 - chatbot_rag - INFO - Xử lý câu hỏi chung cho session_id: b5c00203-6d1b-47b4-a61a-026ae346ed95
2025-05-18 19:35:02,663 - department_info_tool - INFO - Đã tải 11 phòng ban
2025-05-18 19:35:02,664 - department_info_tool - INFO - Đã lấy danh sách 11 phòng ban
2025-05-18 19:35:02,664 - chatbot_rag - INFO - Gọi LLM để trả lời câu hỏi chung cho session_id: b5c00203-6d1b-47b4-a61a-026ae346ed95
2025-05-18 19:35:02,665 - chatbot_rag - INFO - Đã lưu prompt vào file: data/logs/prompt_general_20250518_193502.txt
2025-05-18 19:35:02,665 - chatbot_rag - INFO - Kích thước prompt: 1022 ký tự
2025-05-18 19:35:02,666 - chatbot_rag - INFO - Kích thước system prompt: 916 ký tự
2025-05-18 19:35:02,666 - chatbot_rag - INFO - Tổng kích thước: 1938 ký tự
2025-05-18 19:35:02,667 - chatbot_rag - INFO - Đã lưu full prompt vào file: data/logs/llm_full_prompt_20250518_193502.txt
2025-05-18 19:35:02,668 - chatbot_rag - INFO - System prompt: 
Bạn là trợ lý AI chuyên về quy trình và giai đoạn trong công ty.

DANH SÁCH PHÒNG BAN:
- 2D
- Dự toán
- Khách hàng
- Kinh doanh
- Kế toán
- Marketing
- Mua hàng
- Team dự án
- Thi công
- Thiết kế
- Đ...
2025-05-18 19:35:02,668 - chatbot_rag - INFO - User prompt: 
Câu hỏi: " /think"

Đây là câu hỏi chung về quy trình hoặc giai đoạn làm việc.

Thông tin cơ bản:
### Thông tin tổng quan về quy trình và giai đoạn

#### Giai đoạn chính trong quy trình:
1. **MKT-SAL...
2025-05-18 19:35:02,668 - chatbot_rag - INFO - Gửi truy vấn đến LLM API tại http://192.168.1.4:1234/v1/chat/completions với stream=True
2025-05-18 19:35:30,480 - chatbot_rag - INFO - Mã phản hồi từ API: 200
2025-05-18 19:35:30,481 - chatbot_rag - INFO - Phản hồi gốc từ LLM API (200 ký tự đầu): <think>
Okay, let's see. The user asked a general question about the process or stages. They provided some info on the main stages and the list of departments. The instructions say to focus on the str
2025-05-18 19:35:30,482 - chatbot_rag - INFO - Đã lưu phản hồi đầy đủ vào file: data/logs/llm_response_20250518_193530.txt
2025-05-18 19:35:30,762 - websocket_server - INFO - Đã trích xuất thinking (913 ký tự) và còn lại 595 ký tự phản hồi
2025-05-18 19:35:30,762 - websocket_server - INFO - Đã trích xuất phần thinking (913 ký tự) từ phản hồi handle_general_query
2025-05-18 19:35:30,763 - websocket_server - INFO - Gửi phản hồi thinking với request_id: thinking_1747571682420_2owz3qr
2025-05-18 19:35:30,763 - websocket_server - INFO - Đã gửi nội dung thinking (913 ký tự)
2025-05-18 19:35:30,765 - websocket_server - INFO - WebSocket connection closed
2025-05-18 19:35:30,765 - websockets.server - INFO - connection closed
2025-05-18 19:35:30,766 - websockets.server - INFO - connection open
2025-05-18 19:35:30,767 - websockets.server - INFO - connection open
2025-05-18 19:35:30,768 - websocket_server - INFO - WebSocket connection closed
2025-05-18 19:35:30,769 - websockets.server - INFO - connection closed
2025-05-18 19:35:31,088 - websockets.server - INFO - connection closed
2025-05-18 19:35:31,747 - websockets.server - INFO - connection open
2025-05-18 19:35:33,183 - websocket_server - INFO - Nhận tin nhắn dạng JSON: {"content":"Tôi là nhân viên 2D, hãy hướng dẫn tôi làm việc /no_think","session_id":"","mode":"workf
2025-05-18 19:35:33,183 - websocket_server - INFO - Session ID không được cung cấp trong tin nhắn JSON, sử dụng current_session_id: b5c00203-6d1b-47b4-a61a-026ae346ed95
2025-05-18 19:35:33,184 - websocket_server - INFO - Session ID từ client (sau khi kiểm tra): b5c00203-6d1b-47b4-a61a-026ae346ed95
2025-05-18 19:35:33,184 - websocket_server - INFO - Tắt chế độ thinking cho câu hỏi: Tôi là nhân viên 2D, hãy hướng dẫn tôi làm việc /n...
2025-05-18 19:35:33,184 - websocket_server - INFO - Nhận tin nhắn thông thường: Tôi là nhân viên 2D, hãy hướng dẫn tôi làm việc /no_think, enable_thinking=False, mode=workflow
2025-05-18 19:35:33,185 - websocket_server - INFO - Đã thêm 2 tin nhắn gần nhất vào prompt
2025-05-18 19:35:33,186 - websocket_server - INFO - Đã lưu lịch sử tin nhắn và prompt vào file: data/logs/history_prompt_20250518_193533.txt
2025-05-18 19:35:33,187 - chatbot_rag - INFO - Đang phân tích câu hỏi với LLM: Lịch sử tin nhắn:
Người dùng: xin chào
Người dùng: xin chào

Tôi là nhân viên 2D, hãy hướng dẫn tôi làm việc /no_think, session_id: b5c00203-6d1b-47b4-a61a-026ae346ed95
2025-05-18 19:35:33,187 - chatbot_rag - INFO - [analyze_query_with_llm] Đã lấy được 0 bản ghi lịch sử từ websocket_server cho session b5c00203-6d1b-47b4-a61a-026ae346ed95
2025-05-18 19:35:33,188 - chatbot_rag - INFO - [analyze_query_with_llm] Sử dụng lịch sử hội thoại: 0 bản ghi
2025-05-18 19:35:33,188 - chatbot_rag - INFO - [analyze_query_with_llm] Prompt cuối cùng: Lịch sử tin nhắn:
        
        Câu hỏi người dùng hiện tại: "Lịch sử tin nhắn:
Người dùng: xin chào
Người dùng: xin chào

Tôi là nhân viên 2D, hãy hướng dẫn tôi làm việc /no_think"

        Phân t...
2025-05-18 19:35:33,188 - chatbot_rag - INFO - Kích thước prompt: 699 ký tự
2025-05-18 19:35:33,189 - chatbot_rag - INFO - Kích thước system prompt: 2006 ký tự
2025-05-18 19:35:33,189 - chatbot_rag - INFO - Tổng kích thước: 2705 ký tự
2025-05-18 19:35:33,191 - chatbot_rag - INFO - Đã lưu full prompt vào file: data/logs/llm_full_prompt_20250518_193533.txt
2025-05-18 19:35:33,191 - chatbot_rag - INFO - System prompt: 
        Bạn là trợ lý AI phân tích câu hỏi để xác định:
        1. Phòng ban người dùng đang hỏi (department)
        2. Loại câu hỏi: phòng ban cụ thể hay general (query_type)
        3. Nếu câu hỏi...
2025-05-18 19:35:33,192 - chatbot_rag - INFO - User prompt: Lịch sử tin nhắn:
        
        Câu hỏi người dùng hiện tại: "Lịch sử tin nhắn:
Người dùng: xin chào
Người dùng: xin chào

Tôi là nhân viên 2D, hãy hướng dẫn tôi làm việc /no_think"

        Phân t...
2025-05-18 19:35:33,192 - chatbot_rag - INFO - Gửi truy vấn đến LLM API tại http://192.168.1.4:1234/v1/chat/completions với stream=False
2025-05-18 19:35:46,813 - chatbot_rag - INFO - Mã phản hồi từ API: 200
2025-05-18 19:35:46,815 - chatbot_rag - INFO - Phản hồi gốc từ LLM API (200 ký tự đầu): <think>

</think>

{"department": "2D", "query_type": "department_specific", "error": false}
2025-05-18 19:35:46,817 - chatbot_rag - INFO - Đã lưu phản hồi đầy đủ vào file: data/logs/llm_response_20250518_193546.txt
2025-05-18 19:35:46,821 - chatbot_rag - INFO - [analysis_20250518_193546] Đã ghi phản hồi gốc vào: data/logs/analysis_20250518_193546_raw.txt
2025-05-18 19:35:46,823 - chatbot_rag - INFO - [analysis_20250518_193546] Phản hồi gốc: <think>

</think>

{"department": "2D", "query_type": "department_specific", "error": false}...
2025-05-18 19:35:46,823 - chatbot_rag - WARNING - [analysis_20250518_193546] Phát hiện thẻ <think> trong phản hồi. Xử lý đặc biệt...
2025-05-18 19:35:46,824 - chatbot_rag - INFO - [analysis_20250518_193546] Đã tìm thấy 1 mẫu JSON tiềm năng trong phản hồi
2025-05-18 19:35:46,824 - chatbot_rag - INFO - [analysis_20250518_193546] Tìm thấy JSON hợp lệ trong thẻ <think>: {'department': '2D', 'query_type': 'department_specific', 'error': False}
2025-05-18 19:35:46,825 - websocket_server - INFO - Phân tích câu hỏi: Phòng ban=2D, Loại=department_specific, Thinking=False
2025-05-18 19:35:46,825 - websocket_server - INFO - Tin nhắn thông thường (không phải JSON) được xử lý với chế độ mặc định: workflow
2025-05-18 19:35:46,826 - websocket_server - INFO - Xử lý streaming response cho: 'Tôi là nhân viên 2D, hãy hướng dẫn tôi làm việc /no_think', phòng ban: 2D, session_id: b5c00203-6d1b-47b4-a61a-026ae346ed95, mode: workflow
2025-05-18 19:35:46,827 - websocket_server - INFO - Session ID nhận được: b5c00203-6d1b-47b4-a61a-026ae346ed95
2025-05-18 19:35:46,827 - websocket_server - INFO - Phát hiện lệnh /no_think, tắt chế độ thinking cho: Tôi là nhân viên 2D, hãy hướng dẫn tôi làm việc
2025-05-18 19:35:46,828 - websocket_server - INFO - Xử lý streaming response. Query: 'Tôi là nhân viên 2D, hãy hướng dẫn tôi làm việc', Mode: workflow, Thinking: False
2025-05-18 19:35:46,829 - websocket_server - INFO - Đã thêm 2 tin nhắn gần nhất vào prompt
2025-05-18 19:35:46,831 - websocket_server - INFO - Đã lưu lịch sử tin nhắn và prompt vào file: data/logs/history_prompt_20250518_193546.txt
2025-05-18 19:35:46,832 - websocket_server - INFO - Phân tích câu hỏi: Phòng ban=2D, Loại=department_specific, Thinking=False
2025-05-18 19:35:46,835 - websocket_server - INFO - Query thực tế gửi đến mô hình: Tôi là nhân viên 2D, hãy hướng dẫn tôi làm việc /no_think
2025-05-18 19:35:46,836 - websocket_server - INFO - Câu hỏi về phòng ban cụ thể: 2D, chế độ thinking: False
2025-05-18 19:35:46,837 - chatbot_rag - INFO - Truy vấn Smart RAG - Giai đoạn: None, Phòng ban: 2D, Session: b5c00203-6d1b-47b4-a61a-026ae346ed95
2025-05-18 19:35:46,842 - department_info_tool - INFO - Đã tải 11 phòng ban
2025-05-18 19:35:46,843 - department_info_tool - INFO - Đang trích xuất thông tin cho phòng ban: 2D
2025-05-18 19:35:46,844 - department_info_tool - INFO - Đã đọc thành công file C:\Users\thuon\OneDrive\Desktop\UI-chatbot\backend\data\departments\2d.txt, kích thước: 1707 bytes
2025-05-18 19:35:46,849 - department_info_tool - INFO - Đã tìm thấy 2 giai đoạn và 3 công việc cho phòng ban 2D
2025-05-18 19:35:46,850 - chatbot_rag - INFO - Tạo prompt LLM cho phòng ban: 2D, session_id: b5c00203-6d1b-47b4-a61a-026ae346ed95
2025-05-18 19:35:46,850 - chatbot_rag - INFO - Số task: 3
2025-05-18 19:35:46,851 - chatbot_rag - INFO - Lấy lịch sử hội thoại từ phiên b5c00203-6d1b-47b4-a61a-026ae346ed95
2025-05-18 19:35:46,866 - chatbot_rag - INFO - [create_llm_prompt] Đã lấy được 0 bản ghi lịch sử từ websocket_server.get_session_history cho session b5c00203-6d1b-47b4-a61a-026ae346ed95.
2025-05-18 19:35:46,869 - chatbot_rag - INFO - Gọi LLM:  tại 
2025-05-18 19:35:46,871 - chatbot_rag - INFO - Đã lưu prompt vào file: data/logs/prompt_20250518_193546.txt
2025-05-18 19:35:46,871 - chatbot_rag - INFO - Kích thước prompt: 2080 ký tự
2025-05-18 19:35:46,872 - chatbot_rag - INFO - Kích thước system prompt: 1212 ký tự
2025-05-18 19:35:46,872 - chatbot_rag - INFO - Tổng kích thước: 3292 ký tự
2025-05-18 19:35:46,874 - chatbot_rag - INFO - Đã lưu full prompt vào file: data/logs/llm_full_prompt_20250518_193546.txt
2025-05-18 19:35:46,874 - chatbot_rag - INFO - System prompt: 
Bạn là trợ lý AI chuyên về công việc của các phòng ban trong công ty. 
Nhiệm vụ: phân tích thông tin về các task trong phòng ban và cung cấp thông tin hữu ích.

DỰ ÁN ĐƯỢC CHIA THÀNH CÁC GIAI ĐOẠN CH...
2025-05-18 19:35:46,875 - chatbot_rag - INFO - User prompt: 
    Vai trò: Trợ lý thông minh cung cấp thông tin về phòng ban và công việc trong công ty.

    
    Câu hỏi người dùng: "Tôi là nhân viên 2D, hãy hướng dẫn tôi làm việc /no_think"

    THÔNG TIN PHÒ...
2025-05-18 19:35:46,875 - chatbot_rag - INFO - Gửi truy vấn đến LLM API tại http://192.168.1.4:1234/v1/chat/completions với stream=True
2025-05-18 19:36:38,321 - chatbot_rag - INFO - Mã phản hồi từ API: 200
2025-05-18 19:36:38,325 - chatbot_rag - INFO - Phản hồi gốc từ LLM API (200 ký tự đầu): <think>

</think>

👋 *Chào anh/chị 2D!* 🎨  
Anh/chị là thành viên của **phòng ban Thi công**, hãy cùng mình xem qua các task và giai đoạn liên quan nhé!

---

### 🏗️ **GIAI ĐOẠN CONSTRUCTION (THI CÔNG
2025-05-18 19:36:38,331 - chatbot_rag - INFO - Đã lưu phản hồi đầy đủ vào file: data/logs/llm_response_20250518_193638.txt
2025-05-18 19:36:38,334 - chatbot_rag - INFO - Đã lưu response vào file: data/logs/response_20250518_193546.txt
2025-05-18 19:36:38,335 - chatbot_rag - INFO - Thời gian truy vấn LLM: 51.49 giây
2025-05-18 19:36:38,341 - department_info_tool - INFO - Đang trích xuất thông tin cho phòng ban: 2D
2025-05-18 19:36:38,343 - department_info_tool - INFO - Đã đọc thành công file C:\Users\thuon\OneDrive\Desktop\UI-chatbot\backend\data\departments\2d.txt, kích thước: 1707 bytes
2025-05-18 19:36:38,346 - department_info_tool - INFO - Đã tìm thấy 2 giai đoạn và 3 công việc cho phòng ban 2D
2025-05-18 19:36:42,212 - websocket_server - INFO - Đã trích xuất thinking (0 ký tự) và còn lại 1250 ký tự phản hồi
2025-05-18 19:36:42,212 - websocket_server - INFO - Đã trích xuất phần thinking (0 ký tự) từ phản hồi
2025-05-18 19:36:42,213 - websocket_server - INFO - Đã lưu hội thoại phòng ban 2D vào lịch sử của session b5c00203-6d1b-47b4-a61a-026ae346ed95
2025-05-18 19:36:42,216 - websockets.server - INFO - connection open
2025-05-18 19:36:42,246 - websockets.server - INFO - connection open
2025-05-18 19:36:42,262 - websockets.server - INFO - connection open
2025-05-18 19:36:48,265 - websockets.server - INFO - connection open
2025-05-18 19:37:15,005 - websocket_server - WARNING - Session  không tồn tại, sử dụng session hiện tại
2025-05-18 19:37:15,005 - websocket_server - INFO - Nhận yêu cầu phân tích (thinking) cho câu hỏi: 👋 *Chào anh/chị 2D!* 🎨  
Anh/chị là thành viên của **phòng ban Thi công**, hãy cùng mình xem qua các
2025-05-18 19:37:15,006 - websocket_server - INFO - Đã thêm 3 tin nhắn gần nhất vào prompt
2025-05-18 19:37:15,008 - websocket_server - INFO - Đã lưu lịch sử tin nhắn và prompt vào file: data/logs/history_prompt_20250518_193715.txt
2025-05-18 19:37:15,009 - websocket_server - INFO - Phân tích câu hỏi để xác định phòng ban hoặc loại câu hỏi
2025-05-18 19:37:15,009 - chatbot_rag - INFO - Đang phân tích câu hỏi với LLM: Lịch sử tin nhắn:
Người dùng: xin chào
Người dùng: xin chào
Người dùng: Tôi là nhân viên 2D, hãy hướng dẫn tôi làm việc

👋 *Chào anh/chị 2D!* 🎨  
Anh/chị là thành viên của **phòng ban Thi công**, hãy cùng mình xem qua các task và giai đoạn liên quan nhé!

---

### 🏗️ **GIAI ĐOẠN CONSTRUCTION (THI CÔNG)**
**Mục tiêu:** Chuẩn bị kick-off nội bộ, họp cập nhật dự án, vẽ bản vẽ xin phép.

| Task ID | Tên task | Mô tả |
|--------|----------|-------|
| 2D-001 | Chuẩn bị kick-off nội bộ/ Chuẩn bị họp cập nhật dự án | Khảo sát mặt bằng. Đầu ra: Biên bản khảo sát mặt bằng |
| 2D-002 | Chuẩn bị kick-off nội bộ/ Chuẩn bị họp cập nhật dự án | Vẽ bản vẽ xin phép. Đầu ra: Bản vẽ xin phép |

---

### 📋 **GIAI ĐOẠN DEFECT-HANDOVER (XỬ LÝ LỖI & BÀN GIAO)**
**Mục tiêu:** Hoàn công với tòa nhà.

| Task ID | Tên task | Mô tả |
|--------|----------|-------|
| 2D-003 | Chuẩn bị hồ sơ Quyết toán | Điều chỉnh bản vẽ xin phép theo thực tế để làm bản vẽ hoàn công. Đầu ra: Bản vẽ hoàn công |

---

📌 **Lưu ý:**  
- Task 2D-001 và 2D-002 thuộc giai đoạn CONSTRUCTION, liên quan đến chuẩn bị trước khi thi công.  
- Task 2D-003 là task cuối cùng trong giai đoạn DEFECT-HANDOVER, đảm bảo hoàn công chính xác.

Nếu anh/chị cần hướng dẫn chi tiết hơn về từng task hoặc liên hệ với phòng ban khác (nếu có), cứ hỏi nhé! 😄  
👉 *Đừng quên kiểm tra mục tiêu của từng task để đảm bảo tiến độ!* 🚀, session_id: b5c00203-6d1b-47b4-a61a-026ae346ed95
2025-05-18 19:37:15,013 - chatbot_rag - INFO - [analyze_query_with_llm] Đã lấy được 0 bản ghi lịch sử từ websocket_server cho session b5c00203-6d1b-47b4-a61a-026ae346ed95
2025-05-18 19:37:15,013 - chatbot_rag - INFO - [analyze_query_with_llm] Sử dụng lịch sử hội thoại: 0 bản ghi
2025-05-18 19:37:15,014 - chatbot_rag - INFO - [analyze_query_with_llm] Prompt cuối cùng: Lịch sử tin nhắn:
        
        Câu hỏi người dùng hiện tại: "Lịch sử tin nhắn:
Người dùng: xin chào
Người dùng: xin chào
Người dùng: Tôi là nhân viên 2D, hãy hướng dẫn tôi làm việc

👋 *Chào anh/ch...
2025-05-18 19:37:15,014 - chatbot_rag - INFO - Kích thước prompt: 1952 ký tự
2025-05-18 19:37:15,015 - chatbot_rag - INFO - Kích thước system prompt: 2006 ký tự
2025-05-18 19:37:15,015 - chatbot_rag - INFO - Tổng kích thước: 3958 ký tự
2025-05-18 19:37:15,018 - chatbot_rag - INFO - Đã lưu full prompt vào file: data/logs/llm_full_prompt_20250518_193715.txt
2025-05-18 19:37:15,018 - chatbot_rag - INFO - System prompt: 
        Bạn là trợ lý AI phân tích câu hỏi để xác định:
        1. Phòng ban người dùng đang hỏi (department)
        2. Loại câu hỏi: phòng ban cụ thể hay general (query_type)
        3. Nếu câu hỏi...
2025-05-18 19:37:15,019 - chatbot_rag - INFO - User prompt: Lịch sử tin nhắn:
        
        Câu hỏi người dùng hiện tại: "Lịch sử tin nhắn:
Người dùng: xin chào
Người dùng: xin chào
Người dùng: Tôi là nhân viên 2D, hãy hướng dẫn tôi làm việc

👋 *Chào anh/ch...
2025-05-18 19:37:15,019 - chatbot_rag - INFO - Gửi truy vấn đến LLM API tại http://192.168.1.4:1234/v1/chat/completions với stream=False
2025-05-18 19:37:47,791 - chatbot_rag - INFO - Mã phản hồi từ API: 200
2025-05-18 19:37:47,792 - chatbot_rag - INFO - Phản hồi gốc từ LLM API (200 ký tự đầu): <think>
Okay, let's tackle this query. The user provided a history of messages where they were greeted and given an overview of tasks related to the "Thi công" (Construction) department. The current q
2025-05-18 19:37:47,795 - chatbot_rag - INFO - Đã lưu phản hồi đầy đủ vào file: data/logs/llm_response_20250518_193747.txt
2025-05-18 19:37:47,798 - chatbot_rag - INFO - [analysis_20250518_193747] Đã ghi phản hồi gốc vào: data/logs/analysis_20250518_193747_raw.txt
2025-05-18 19:37:47,798 - chatbot_rag - INFO - [analysis_20250518_193747] Phản hồi gốc: <think>
Okay, let's tackle this query. The user provided a history of messages where they were greet...
2025-05-18 19:37:47,799 - chatbot_rag - WARNING - [analysis_20250518_193747] Phát hiện thẻ <think> trong phản hồi. Xử lý đặc biệt...
2025-05-18 19:37:47,799 - chatbot_rag - INFO - [analysis_20250518_193747] BƯỚC 1: Thử parse toàn bộ chuỗi phản hồi
2025-05-18 19:37:47,800 - chatbot_rag - INFO - [analysis_20250518_193747] BƯỚC 1: Không phải JSON hợp lệ: Expecting value: line 1 column 1 (char 0)
2025-05-18 19:37:47,800 - chatbot_rag - INFO - [analysis_20250518_193747] BƯỚC 2: Tìm JSON trong chuỗi phản hồi
2025-05-18 19:37:47,800 - chatbot_rag - WARNING - [analysis_20250518_193747] BƯỚC 2: Không tìm thấy mẫu JSON nào trong phản hồi
2025-05-18 19:37:47,801 - chatbot_rag - INFO - [analysis_20250518_193747] BƯỚC 3: Xử lý chuỗi thủ công để trích xuất thông tin
2025-05-18 19:37:47,806 - department_info_tool - INFO - Đã tải 11 phòng ban
2025-05-18 19:37:47,807 - department_info_tool - INFO - Đã lấy danh sách 11 phòng ban
2025-05-18 19:37:47,808 - chatbot_rag - INFO - [analysis_20250518_193747] BƯỚC 3: Tìm thấy phòng ban trong câu hỏi: 2D
2025-05-18 19:37:47,809 - chatbot_rag - ERROR - [analysis_20250518_193747] BƯỚC 3: Lỗi khi xử lý chuỗi thủ công: local variable 'query_type' referenced before assignment
2025-05-18 19:37:47,809 - chatbot_rag - WARNING - [analysis_20250518_193747] Tất cả phương pháp phân tích đều thất bại, trả về kết quả mặc định
2025-05-18 19:37:47,810 - websocket_server - INFO - Lấy phân tích cho câu hỏi chung
2025-05-18 19:37:47,810 - chatbot_rag - INFO - Xử lý câu hỏi chung cho session_id: b5c00203-6d1b-47b4-a61a-026ae346ed95
2025-05-18 19:37:47,814 - department_info_tool - INFO - Đã tải 11 phòng ban
2025-05-18 19:37:47,814 - department_info_tool - INFO - Đã lấy danh sách 11 phòng ban
2025-05-18 19:37:47,815 - chatbot_rag - INFO - Gọi LLM để trả lời câu hỏi chung cho session_id: b5c00203-6d1b-47b4-a61a-026ae346ed95
2025-05-18 19:37:47,816 - chatbot_rag - INFO - Đã lưu prompt vào file: data/logs/prompt_general_20250518_193747.txt
2025-05-18 19:37:47,817 - chatbot_rag - INFO - Kích thước prompt: 2272 ký tự
2025-05-18 19:37:47,817 - chatbot_rag - INFO - Kích thước system prompt: 916 ký tự
2025-05-18 19:37:47,817 - chatbot_rag - INFO - Tổng kích thước: 3188 ký tự
2025-05-18 19:37:47,818 - chatbot_rag - INFO - Đã lưu full prompt vào file: data/logs/llm_full_prompt_20250518_193747.txt
2025-05-18 19:37:47,819 - chatbot_rag - INFO - System prompt: 
Bạn là trợ lý AI chuyên về quy trình và giai đoạn trong công ty.

DANH SÁCH PHÒNG BAN:
- 2D
- Dự toán
- Khách hàng
- Kinh doanh
- Kế toán
- Marketing
- Mua hàng
- Team dự án
- Thi công
- Thiết kế
- Đ...
2025-05-18 19:37:47,819 - chatbot_rag - INFO - User prompt: 
Câu hỏi: "👋 *Chào anh/chị 2D!* 🎨  
Anh/chị là thành viên của **phòng ban Thi công**, hãy cùng mình xem qua các task và giai đoạn liên quan nhé!

---

### 🏗️ **GIAI ĐOẠN CONSTRUCTION (THI CÔNG)**
**Mụ...
2025-05-18 19:37:47,820 - chatbot_rag - INFO - Gửi truy vấn đến LLM API tại http://192.168.1.4:1234/v1/chat/completions với stream=True
2025-05-18 19:39:00,771 - chatbot_rag - INFO - Mã phản hồi từ API: 200
2025-05-18 19:39:00,776 - chatbot_rag - INFO - Phản hồi gốc từ LLM API (200 ký tự đầu): <think>
Okay, let's break this down. The user provided a detailed query about the construction and defect-handover phases in a company's workflow, specifically mentioning tasks related to 2D and other
2025-05-18 19:39:00,779 - chatbot_rag - INFO - Đã lưu phản hồi đầy đủ vào file: data/logs/llm_response_20250518_193900.txt
2025-05-18 19:39:00,814 - websocket_server - INFO - Đã trích xuất thinking (2262 ký tự) và còn lại 937 ký tự phản hồi
2025-05-18 19:39:00,814 - websocket_server - INFO - Đã trích xuất phần thinking (2262 ký tự) từ phản hồi handle_general_query
2025-05-18 19:39:00,815 - websocket_server - INFO - Gửi phản hồi thinking với request_id: thinking_1747571835003_8n53b3n
2025-05-18 19:39:00,823 - websocket_server - INFO - Đã gửi nội dung thinking (2262 ký tự)
2025-05-18 19:39:00,838 - websocket_server - INFO - Nhận tin nhắn dạng JSON: {"content":"xin chào /no_think","session_id":"","mode":"basic","basic_prompt":"Bạn là một trợ lý AI 
2025-05-18 19:39:00,838 - websocket_server - INFO - Session ID không được cung cấp trong tin nhắn JSON, sử dụng current_session_id: b5c00203-6d1b-47b4-a61a-026ae346ed95
2025-05-18 19:39:00,839 - websocket_server - INFO - Session ID từ client (sau khi kiểm tra): b5c00203-6d1b-47b4-a61a-026ae346ed95
2025-05-18 19:39:00,839 - websocket_server - INFO - Tắt chế độ thinking cho câu hỏi: xin chào /no_think...
2025-05-18 19:39:00,840 - websocket_server - INFO - Nhận tin nhắn thông thường: xin chào /no_think, enable_thinking=False, mode=basic
2025-05-18 19:39:00,841 - websocket_server - INFO - Chế độ Basic được kích hoạt với prompt: Bạn là một trợ lý AI hữu ích và thông minh. Hãy trả lời câu hỏi của người dùng một cách chi tiết và ...
2025-05-18 19:39:00,842 - websocket_server - INFO - Xử lý streaming response cho: 'xin chào /no_think', phòng ban: None, session_id: b5c00203-6d1b-47b4-a61a-026ae346ed95, mode: basic
2025-05-18 19:39:00,842 - websocket_server - INFO - Session ID nhận được: b5c00203-6d1b-47b4-a61a-026ae346ed95
2025-05-18 19:39:00,842 - websocket_server - INFO - Phát hiện lệnh /no_think, tắt chế độ thinking cho: xin chào
2025-05-18 19:39:00,843 - websocket_server - INFO - Xử lý streaming response. Query: 'xin chào', Mode: basic, Thinking: False
2025-05-18 19:39:00,843 - websocket_server - INFO - Chế độ Basic được kích hoạt với prompt: Bạn là một trợ lý AI hữu ích và thông minh. Hãy trả lời câu hỏi của người dùng một cách chi tiết và ...
2025-05-18 19:39:00,844 - websocket_server - INFO - Đã thêm 3 tin nhắn gần nhất vào prompt
2025-05-18 19:39:00,846 - websocket_server - INFO - Đã lưu lịch sử tin nhắn và prompt vào file: data/logs/history_prompt_20250518_193900.txt
2025-05-18 19:39:00,848 - websocket_server - INFO - Kích thước prompt: 129 ký tự
2025-05-18 19:39:00,849 - websocket_server - INFO - Kích thước system prompt: 174 ký tự
2025-05-18 19:39:00,850 - websocket_server - INFO - Tổng kích thước: 303 ký tự
2025-05-18 19:39:00,850 - websocket_server - INFO - Bắt đầu gọi LLM API (lần thử 1/3)
2025-05-18 19:39:00,871 - websockets.server - INFO - connection open
2025-05-18 19:39:00,886 - websockets.server - INFO - connection open
2025-05-18 19:39:12,595 - websocket_server - INFO - API trả về status 200 OK
2025-05-18 19:39:12,598 - websocket_server - INFO - Streaming hoàn tất thành công
2025-05-18 19:39:12,599 - websocket_server - INFO - Gửi phản hồi cuối cùng, chế độ basic, thinking_enabled: False, thinking_collected: False
2025-05-18 19:39:12,599 - websocket_server - INFO - Lưu hội thoại basic mode vào lịch sử với session_id=b5c00203-6d1b-47b4-a61a-026ae346ed95
2025-05-18 19:39:17,647 - websockets.server - INFO - connection open
2025-05-18 19:39:35,609 - websockets.server - INFO - connection open
2025-05-18 19:40:00,555 - websockets.server - INFO - connection open
2025-05-18 19:46:06,164 - websocket_server - WARNING - Session  không tồn tại, sử dụng session hiện tại
2025-05-18 19:46:06,166 - websocket_server - INFO - Nhận yêu cầu phân tích (thinking) cho câu hỏi: 
2025-05-18 19:46:06,167 - websocket_server - INFO - Đã thêm 4 tin nhắn gần nhất vào prompt
2025-05-18 19:46:06,169 - websocket_server - INFO - Đã lưu lịch sử tin nhắn và prompt vào file: data/logs/history_prompt_20250518_194606.txt
2025-05-18 19:46:06,170 - websocket_server - INFO - Phân tích câu hỏi để xác định phòng ban hoặc loại câu hỏi
2025-05-18 19:46:06,170 - chatbot_rag - INFO - Đang phân tích câu hỏi với LLM: Lịch sử tin nhắn:
Người dùng: xin chào
Người dùng: xin chào
Người dùng: Tôi là nhân viên 2D, hãy hướng dẫn tôi làm việc
Người dùng: xin chào

, session_id: b5c00203-6d1b-47b4-a61a-026ae346ed95
2025-05-18 19:46:06,172 - chatbot_rag - INFO - [analyze_query_with_llm] Đã lấy được 0 bản ghi lịch sử từ websocket_server cho session b5c00203-6d1b-47b4-a61a-026ae346ed95
2025-05-18 19:46:06,172 - chatbot_rag - INFO - [analyze_query_with_llm] Sử dụng lịch sử hội thoại: 0 bản ghi
2025-05-18 19:46:06,172 - chatbot_rag - INFO - [analyze_query_with_llm] Prompt cuối cùng: Lịch sử tin nhắn:
        
        Câu hỏi người dùng hiện tại: "Lịch sử tin nhắn:
Người dùng: xin chào
Người dùng: xin chào
Người dùng: Tôi là nhân viên 2D, hãy hướng dẫn tôi làm việc
Người dùng: xin...
2025-05-18 19:46:06,173 - chatbot_rag - INFO - Kích thước prompt: 723 ký tự
2025-05-18 19:46:06,174 - chatbot_rag - INFO - Kích thước system prompt: 2006 ký tự
2025-05-18 19:46:06,174 - chatbot_rag - INFO - Tổng kích thước: 2729 ký tự
2025-05-18 19:46:06,178 - chatbot_rag - INFO - Đã lưu full prompt vào file: data/logs/llm_full_prompt_20250518_194606.txt
2025-05-18 19:46:06,179 - chatbot_rag - INFO - System prompt: 
        Bạn là trợ lý AI phân tích câu hỏi để xác định:
        1. Phòng ban người dùng đang hỏi (department)
        2. Loại câu hỏi: phòng ban cụ thể hay general (query_type)
        3. Nếu câu hỏi...
2025-05-18 19:46:06,180 - chatbot_rag - INFO - User prompt: Lịch sử tin nhắn:
        
        Câu hỏi người dùng hiện tại: "Lịch sử tin nhắn:
Người dùng: xin chào
Người dùng: xin chào
Người dùng: Tôi là nhân viên 2D, hãy hướng dẫn tôi làm việc
Người dùng: xin...
2025-05-18 19:46:06,181 - chatbot_rag - INFO - Gửi truy vấn đến LLM API tại http://192.168.1.4:1234/v1/chat/completions với stream=False
2025-05-18 19:46:27,518 - chatbot_rag - INFO - Mã phản hồi từ API: 200
2025-05-18 19:46:27,519 - chatbot_rag - INFO - Phản hồi gốc từ LLM API (200 ký tự đầu): <think>
Okay, let's tackle this query. The user provided a history of messages where they mentioned being a 2D employee and asked for guidance on their work. Now, the current question is just "Lịch sử
2025-05-18 19:46:27,520 - chatbot_rag - INFO - Đã lưu phản hồi đầy đủ vào file: data/logs/llm_response_20250518_194627.txt
2025-05-18 19:46:27,523 - chatbot_rag - INFO - [analysis_20250518_194627] Đã ghi phản hồi gốc vào: data/logs/analysis_20250518_194627_raw.txt
2025-05-18 19:46:27,523 - chatbot_rag - INFO - [analysis_20250518_194627] Phản hồi gốc: <think>
Okay, let's tackle this query. The user provided a history of messages where they mentioned ...
2025-05-18 19:46:27,523 - chatbot_rag - WARNING - [analysis_20250518_194627] Phát hiện thẻ <think> trong phản hồi. Xử lý đặc biệt...
2025-05-18 19:46:27,524 - chatbot_rag - INFO - [analysis_20250518_194627] BƯỚC 1: Thử parse toàn bộ chuỗi phản hồi
2025-05-18 19:46:27,524 - chatbot_rag - INFO - [analysis_20250518_194627] BƯỚC 1: Không phải JSON hợp lệ: Expecting value: line 1 column 1 (char 0)
2025-05-18 19:46:27,525 - chatbot_rag - INFO - [analysis_20250518_194627] BƯỚC 2: Tìm JSON trong chuỗi phản hồi
2025-05-18 19:46:27,525 - chatbot_rag - WARNING - [analysis_20250518_194627] BƯỚC 2: Không tìm thấy mẫu JSON nào trong phản hồi
2025-05-18 19:46:27,525 - chatbot_rag - INFO - [analysis_20250518_194627] BƯỚC 3: Xử lý chuỗi thủ công để trích xuất thông tin
2025-05-18 19:46:27,536 - department_info_tool - INFO - Đã tải 11 phòng ban
2025-05-18 19:46:27,537 - department_info_tool - INFO - Đã lấy danh sách 11 phòng ban
2025-05-18 19:46:27,538 - chatbot_rag - INFO - [analysis_20250518_194627] BƯỚC 3: Tìm thấy phòng ban trong câu hỏi: 2D
2025-05-18 19:46:27,538 - chatbot_rag - ERROR - [analysis_20250518_194627] BƯỚC 3: Lỗi khi xử lý chuỗi thủ công: local variable 'query_type' referenced before assignment
2025-05-18 19:46:27,539 - chatbot_rag - WARNING - [analysis_20250518_194627] Tất cả phương pháp phân tích đều thất bại, trả về kết quả mặc định
2025-05-18 19:46:27,539 - websocket_server - INFO - Lấy phân tích cho câu hỏi chung
2025-05-18 19:46:27,539 - chatbot_rag - INFO - Xử lý câu hỏi chung cho session_id: b5c00203-6d1b-47b4-a61a-026ae346ed95
2025-05-18 19:46:27,542 - department_info_tool - INFO - Đã tải 11 phòng ban
2025-05-18 19:46:27,542 - department_info_tool - INFO - Đã lấy danh sách 11 phòng ban
2025-05-18 19:46:27,544 - chatbot_rag - INFO - Gọi LLM để trả lời câu hỏi chung cho session_id: b5c00203-6d1b-47b4-a61a-026ae346ed95
2025-05-18 19:46:27,546 - chatbot_rag - INFO - Đã lưu prompt vào file: data/logs/prompt_general_20250518_194627.txt
2025-05-18 19:46:27,546 - chatbot_rag - INFO - Kích thước prompt: 1022 ký tự
2025-05-18 19:46:27,546 - chatbot_rag - INFO - Kích thước system prompt: 916 ký tự
2025-05-18 19:46:27,547 - chatbot_rag - INFO - Tổng kích thước: 1938 ký tự
2025-05-18 19:46:27,549 - chatbot_rag - INFO - Đã lưu full prompt vào file: data/logs/llm_full_prompt_20250518_194627.txt
2025-05-18 19:46:27,549 - chatbot_rag - INFO - System prompt: 
Bạn là trợ lý AI chuyên về quy trình và giai đoạn trong công ty.

DANH SÁCH PHÒNG BAN:
- 2D
- Dự toán
- Khách hàng
- Kinh doanh
- Kế toán
- Marketing
- Mua hàng
- Team dự án
- Thi công
- Thiết kế
- Đ...
2025-05-18 19:46:27,550 - chatbot_rag - INFO - User prompt: 
Câu hỏi: " /think"

Đây là câu hỏi chung về quy trình hoặc giai đoạn làm việc.

Thông tin cơ bản:
### Thông tin tổng quan về quy trình và giai đoạn

#### Giai đoạn chính trong quy trình:
1. **MKT-SAL...
2025-05-18 19:46:27,550 - chatbot_rag - INFO - Gửi truy vấn đến LLM API tại http://192.168.1.4:1234/v1/chat/completions với stream=True
2025-05-18 19:46:51,125 - websockets.server - INFO - connection closed
2025-05-18 19:46:51,132 - websockets.server - INFO - connection closed
2025-05-18 19:46:51,132 - websockets.server - INFO - connection closed
2025-05-18 19:46:51,133 - websockets.server - INFO - connection closed
2025-05-18 19:46:51,135 - websockets.server - INFO - connection closed
2025-05-18 19:46:51,135 - websockets.server - INFO - connection closed
2025-05-18 19:46:51,136 - websockets.server - INFO - connection closed
2025-05-18 19:46:51,138 - websockets.server - INFO - connection closed
2025-05-18 19:46:51,139 - websockets.server - INFO - connection closed
2025-05-18 19:46:51,140 - websockets.server - INFO - connection closed
2025-05-18 19:46:51,142 - websockets.server - INFO - server closing
2025-05-18 19:46:51,144 - websockets.server - INFO - server closed
2025-05-18 19:46:51,152 - websocket_server - INFO - Server bị dừng bởi người dùng
2025-05-18 19:46:51,382 - asyncio - ERROR - Task exception was never retrieved
future: <Task finished name='Task-81' coro=<WebSocketServerProtocol.handler() done, defined at C:\Users\thuon\OneDrive\Desktop\UI-chatbot\backend\venv\lib\site-packages\websockets\legacy\server.py:159> exception=KeyboardInterrupt()>
Traceback (most recent call last):
  File "server.py", line 1341, in <module>
    ping_timeout=6000,  # Tăng thời gian timeout lên 6000 giây
  File "C:\Users\thuon\AppData\Local\Programs\Python\Python38\lib\asyncio\runners.py", line 43, in run
    return loop.run_until_complete(main)
  File "C:\Users\thuon\AppData\Local\Programs\Python\Python38\lib\asyncio\base_events.py", line 603, in run_until_complete
    self.run_forever()
  File "C:\Users\thuon\AppData\Local\Programs\Python\Python38\lib\asyncio\windows_events.py", line 316, in run_forever
    super().run_forever()
  File "C:\Users\thuon\AppData\Local\Programs\Python\Python38\lib\asyncio\base_events.py", line 570, in run_forever
    self._run_once()
  File "C:\Users\thuon\AppData\Local\Programs\Python\Python38\lib\asyncio\base_events.py", line 1859, in _run_once
    handle._run()
  File "C:\Users\thuon\AppData\Local\Programs\Python\Python38\lib\asyncio\events.py", line 81, in _run
    self._context.run(self._callback, *self._args)
  File "C:\Users\thuon\OneDrive\Desktop\UI-chatbot\backend\venv\lib\site-packages\websockets\legacy\server.py", line 245, in handler
    await self.ws_handler(self)
  File "server.py", line 1115, in handle_message
    """Xử lý các tin nhắn WebSocket"""
  File "server.py", line 981, in handle_action
    session_id = data.get('session_id', current_session_id)
  File "server.py", line 849, in handle_thinking_request
    - Thông tin về quy trình, nhiệm vụ hoặc trách nhiệm của phòng ban {department}
  File "C:\Users\thuon\OneDrive\Desktop\UI-chatbot\backend\chatbot.py", line 443, in handle_general_query
    final_response = query_llm(user_prompt, system_prompt)
  File "C:\Users\thuon\OneDrive\Desktop\UI-chatbot\backend\chatbot.py", line 293, in query_llm
    response = requests.post(url, json=payload)
  File "C:\Users\thuon\OneDrive\Desktop\UI-chatbot\backend\venv\lib\site-packages\requests\api.py", line 115, in post
    return request("post", url, data=data, json=json, **kwargs)
  File "C:\Users\thuon\OneDrive\Desktop\UI-chatbot\backend\venv\lib\site-packages\requests\api.py", line 59, in request
    return session.request(method=method, url=url, **kwargs)
  File "C:\Users\thuon\OneDrive\Desktop\UI-chatbot\backend\venv\lib\site-packages\requests\sessions.py", line 589, in request
    resp = self.send(prep, **send_kwargs)
  File "C:\Users\thuon\OneDrive\Desktop\UI-chatbot\backend\venv\lib\site-packages\requests\sessions.py", line 703, in send
    r = adapter.send(request, **kwargs)
  File "C:\Users\thuon\OneDrive\Desktop\UI-chatbot\backend\venv\lib\site-packages\requests\adapters.py", line 667, in send
    resp = conn.urlopen(
  File "C:\Users\thuon\OneDrive\Desktop\UI-chatbot\backend\venv\lib\site-packages\urllib3\connectionpool.py", line 789, in urlopen
    response = self._make_request(
  File "C:\Users\thuon\OneDrive\Desktop\UI-chatbot\backend\venv\lib\site-packages\urllib3\connectionpool.py", line 536, in _make_request
    response = conn.getresponse()
  File "C:\Users\thuon\OneDrive\Desktop\UI-chatbot\backend\venv\lib\site-packages\urllib3\connection.py", line 507, in getresponse
    httplib_response = super().getresponse()
  File "C:\Users\thuon\AppData\Local\Programs\Python\Python38\lib\http\client.py", line 1322, in getresponse
    response.begin()
  File "C:\Users\thuon\AppData\Local\Programs\Python\Python38\lib\http\client.py", line 303, in begin
    version, status, reason = self._read_status()
  File "C:\Users\thuon\AppData\Local\Programs\Python\Python38\lib\http\client.py", line 264, in _read_status
    line = str(self.fp.readline(_MAXLINE + 1), "iso-8859-1")
  File "C:\Users\thuon\AppData\Local\Programs\Python\Python38\lib\socket.py", line 669, in readinto
    return self._sock.recv_into(b)
KeyboardInterrupt
2025-05-18 19:46:54,063 - websocket_server - INFO - Khởi động server WebSocket tại 0.0.0.0:8090
2025-05-18 19:46:54,086 - websockets.server - INFO - server listening on 0.0.0.0:8090
2025-05-18 19:46:54,087 - websocket_server - INFO - Server WebSocket đang chạy tại ws://0.0.0.0:8090
2025-05-18 19:46:54,087 - websocket_server - INFO - Đã cấu hình ping_timeout=6000 giây, ping_interval=60 giây
2025-05-18 19:47:05,963 - websockets.server - INFO - connection open
2025-05-18 19:47:12,303 - websocket_server - INFO - Nhận tin nhắn dạng JSON: {"content":"xin chào /no_think","session_id":"","mode":"workflow"}
2025-05-18 19:47:12,304 - websocket_server - INFO - Session ID không được cung cấp trong tin nhắn JSON, sử dụng current_session_id: fb0f8f95-cd33-4dba-9843-f75ba9898320
2025-05-18 19:47:12,304 - websocket_server - INFO - Session ID từ client (sau khi kiểm tra): fb0f8f95-cd33-4dba-9843-f75ba9898320
2025-05-18 19:47:12,304 - websocket_server - INFO - Tắt chế độ thinking cho câu hỏi: xin chào /no_think...
2025-05-18 19:47:12,305 - websocket_server - INFO - Nhận tin nhắn thông thường: xin chào /no_think, enable_thinking=False, mode=workflow
2025-05-18 19:47:12,306 - websocket_server - INFO - Không có lịch sử tin nhắn cho phiên này
2025-05-18 19:47:12,306 - chatbot_rag - INFO - Đang phân tích câu hỏi với LLM: xin chào /no_think, session_id: fb0f8f95-cd33-4dba-9843-f75ba9898320
2025-05-18 19:47:12,347 - chatbot_rag - INFO - [analyze_query_with_llm] Đã lấy được 0 bản ghi lịch sử từ websocket_server cho session fb0f8f95-cd33-4dba-9843-f75ba9898320
2025-05-18 19:47:12,350 - chatbot_rag - INFO - [analyze_query_with_llm] Sử dụng lịch sử hội thoại: 0 bản ghi
2025-05-18 19:47:12,352 - chatbot_rag - INFO - [analyze_query_with_llm] Prompt cuối cùng: Lịch sử tin nhắn:
        
        Câu hỏi người dùng hiện tại: "xin chào /no_think"

        Phân tích câu hỏi và trả về JSON có định dạng:
        {"department": "tên phòng ban hoặc null", "query_ty...
2025-05-18 19:47:12,353 - chatbot_rag - INFO - Kích thước prompt: 599 ký tự
2025-05-18 19:47:12,354 - chatbot_rag - INFO - Kích thước system prompt: 2006 ký tự
2025-05-18 19:47:12,354 - chatbot_rag - INFO - Tổng kích thước: 2605 ký tự
2025-05-18 19:47:12,356 - chatbot_rag - INFO - Đã lưu full prompt vào file: data/logs/llm_full_prompt_20250518_194712.txt
2025-05-18 19:47:12,357 - chatbot_rag - INFO - System prompt: 
        Bạn là trợ lý AI phân tích câu hỏi để xác định:
        1. Phòng ban người dùng đang hỏi (department)
        2. Loại câu hỏi: phòng ban cụ thể hay general (query_type)
        3. Nếu câu hỏi...
2025-05-18 19:47:12,358 - chatbot_rag - INFO - User prompt: Lịch sử tin nhắn:
        
        Câu hỏi người dùng hiện tại: "xin chào /no_think"

        Phân tích câu hỏi và trả về JSON có định dạng:
        {"department": "tên phòng ban hoặc null", "query_ty...
2025-05-18 19:47:12,360 - chatbot_rag - INFO - Gửi truy vấn đến LLM API tại http://192.168.1.4:1234/v1/chat/completions với stream=False
2025-05-18 19:47:26,938 - chatbot_rag - INFO - Mã phản hồi từ API: 200
2025-05-18 19:47:26,939 - chatbot_rag - INFO - Phản hồi gốc từ LLM API (200 ký tự đầu): <think>

</think>

{"department": null, "query_type": "general", "error": false}
2025-05-18 19:47:26,940 - chatbot_rag - INFO - Đã lưu phản hồi đầy đủ vào file: data/logs/llm_response_20250518_194726.txt
2025-05-18 19:47:26,944 - chatbot_rag - INFO - [analysis_20250518_194726] Đã ghi phản hồi gốc vào: data/logs/analysis_20250518_194726_raw.txt
2025-05-18 19:47:26,945 - chatbot_rag - INFO - [analysis_20250518_194726] Phản hồi gốc: <think>

</think>

{"department": null, "query_type": "general", "error": false}...
2025-05-18 19:47:26,945 - chatbot_rag - WARNING - [analysis_20250518_194726] Phát hiện thẻ <think> trong phản hồi. Xử lý đặc biệt...
2025-05-18 19:47:26,946 - chatbot_rag - INFO - [analysis_20250518_194726] Đã tìm thấy 1 mẫu JSON tiềm năng trong phản hồi
2025-05-18 19:47:26,946 - chatbot_rag - INFO - [analysis_20250518_194726] Tìm thấy JSON hợp lệ trong thẻ <think>: {'department': None, 'query_type': 'general', 'error': False}
2025-05-18 19:47:26,947 - websocket_server - INFO - Phân tích câu hỏi: Phòng ban=None, Loại=general, Thinking=False
2025-05-18 19:47:26,947 - websocket_server - INFO - Tin nhắn thông thường (không phải JSON) được xử lý với chế độ mặc định: workflow
2025-05-18 19:47:26,947 - websocket_server - INFO - Xử lý streaming response cho: 'xin chào /no_think', phòng ban: None, session_id: fb0f8f95-cd33-4dba-9843-f75ba9898320, mode: workflow
2025-05-18 19:47:26,948 - websocket_server - INFO - Session ID nhận được: fb0f8f95-cd33-4dba-9843-f75ba9898320
2025-05-18 19:47:26,948 - websocket_server - INFO - Phát hiện lệnh /no_think, tắt chế độ thinking cho: xin chào
2025-05-18 19:47:26,948 - websocket_server - INFO - Xử lý streaming response. Query: 'xin chào', Mode: workflow, Thinking: False
2025-05-18 19:47:26,949 - websocket_server - INFO - Không có lịch sử tin nhắn cho phiên này
2025-05-18 19:47:26,949 - chatbot_rag - INFO - Đang phân tích câu hỏi với LLM: xin chào, session_id: fb0f8f95-cd33-4dba-9843-f75ba9898320
2025-05-18 19:47:26,950 - chatbot_rag - INFO - [analyze_query_with_llm] Đã lấy được 0 bản ghi lịch sử từ websocket_server cho session fb0f8f95-cd33-4dba-9843-f75ba9898320
2025-05-18 19:47:26,950 - chatbot_rag - INFO - [analyze_query_with_llm] Sử dụng lịch sử hội thoại: 0 bản ghi
2025-05-18 19:47:26,951 - chatbot_rag - INFO - [analyze_query_with_llm] Prompt cuối cùng: Lịch sử tin nhắn:
        
        Câu hỏi người dùng hiện tại: "xin chào"

        Phân tích câu hỏi và trả về JSON có định dạng:
        {"department": "tên phòng ban hoặc null", "query_type": "depa...
2025-05-18 19:47:26,951 - chatbot_rag - INFO - Kích thước prompt: 589 ký tự
2025-05-18 19:47:26,951 - chatbot_rag - INFO - Kích thước system prompt: 2006 ký tự
2025-05-18 19:47:26,952 - chatbot_rag - INFO - Tổng kích thước: 2595 ký tự
2025-05-18 19:47:26,953 - chatbot_rag - INFO - Đã lưu full prompt vào file: data/logs/llm_full_prompt_20250518_194726.txt
2025-05-18 19:47:26,953 - chatbot_rag - INFO - System prompt: 
        Bạn là trợ lý AI phân tích câu hỏi để xác định:
        1. Phòng ban người dùng đang hỏi (department)
        2. Loại câu hỏi: phòng ban cụ thể hay general (query_type)
        3. Nếu câu hỏi...
2025-05-18 19:47:26,954 - chatbot_rag - INFO - User prompt: Lịch sử tin nhắn:
        
        Câu hỏi người dùng hiện tại: "xin chào"

        Phân tích câu hỏi và trả về JSON có định dạng:
        {"department": "tên phòng ban hoặc null", "query_type": "depa...
2025-05-18 19:47:26,954 - chatbot_rag - INFO - Gửi truy vấn đến LLM API tại http://192.168.1.4:1234/v1/chat/completions với stream=False
2025-05-18 19:47:39,936 - chatbot_rag - INFO - Mã phản hồi từ API: 200
2025-05-18 19:47:39,937 - chatbot_rag - INFO - Phản hồi gốc từ LLM API (200 ký tự đầu): <think>
Okay, let's tackle this. The user's current question is "xin chào" which means "hello" in Vietnamese. The history of messages is empty, so there's no prior context about any department or spec
2025-05-18 19:47:39,938 - chatbot_rag - INFO - Đã lưu phản hồi đầy đủ vào file: data/logs/llm_response_20250518_194739.txt
2025-05-18 19:47:39,941 - chatbot_rag - INFO - [analysis_20250518_194739] Đã ghi phản hồi gốc vào: data/logs/analysis_20250518_194739_raw.txt
2025-05-18 19:47:39,942 - chatbot_rag - INFO - [analysis_20250518_194739] Phản hồi gốc: <think>
Okay, let's tackle this. The user's current question is "xin chào" which means "hello" in Vi...
2025-05-18 19:47:39,943 - chatbot_rag - WARNING - [analysis_20250518_194739] Phát hiện thẻ <think> trong phản hồi. Xử lý đặc biệt...
2025-05-18 19:47:39,944 - chatbot_rag - INFO - [analysis_20250518_194739] BƯỚC 1: Thử parse toàn bộ chuỗi phản hồi
2025-05-18 19:47:39,945 - chatbot_rag - INFO - [analysis_20250518_194739] BƯỚC 1: Không phải JSON hợp lệ: Expecting value: line 1 column 1 (char 0)
2025-05-18 19:47:39,945 - chatbot_rag - INFO - [analysis_20250518_194739] BƯỚC 2: Tìm JSON trong chuỗi phản hồi
2025-05-18 19:47:39,945 - chatbot_rag - WARNING - [analysis_20250518_194739] BƯỚC 2: Không tìm thấy mẫu JSON nào trong phản hồi
2025-05-18 19:47:39,946 - chatbot_rag - INFO - [analysis_20250518_194739] BƯỚC 3: Xử lý chuỗi thủ công để trích xuất thông tin
2025-05-18 19:47:39,956 - department_info_tool - INFO - Đã tải 11 phòng ban
2025-05-18 19:47:39,956 - department_info_tool - INFO - Đã lấy danh sách 11 phòng ban
2025-05-18 19:47:39,957 - chatbot_rag - ERROR - [analysis_20250518_194739] BƯỚC 3: Lỗi khi xử lý chuỗi thủ công: local variable 'query_type' referenced before assignment
2025-05-18 19:47:39,957 - chatbot_rag - WARNING - [analysis_20250518_194739] Tất cả phương pháp phân tích đều thất bại, trả về kết quả mặc định
2025-05-18 19:47:39,958 - websocket_server - INFO - Phân tích câu hỏi: Phòng ban=None, Loại=general, Thinking=False
2025-05-18 19:47:39,963 - websocket_server - INFO - Query thực tế gửi đến mô hình: xin chào /no_think
2025-05-18 19:47:39,964 - websocket_server - INFO - Câu hỏi chung, chế độ thinking: False
2025-05-18 19:47:39,964 - chatbot_rag - INFO - Xử lý câu hỏi chung cho session_id: fb0f8f95-cd33-4dba-9843-f75ba9898320
2025-05-18 19:47:39,968 - department_info_tool - INFO - Đã tải 11 phòng ban
2025-05-18 19:47:39,969 - department_info_tool - INFO - Đã lấy danh sách 11 phòng ban
2025-05-18 19:47:39,969 - chatbot_rag - INFO - Gọi LLM để trả lời câu hỏi chung cho session_id: fb0f8f95-cd33-4dba-9843-f75ba9898320
2025-05-18 19:47:39,971 - chatbot_rag - INFO - Đã lưu prompt vào file: data/logs/prompt_general_20250518_194739.txt
2025-05-18 19:47:39,972 - chatbot_rag - INFO - Kích thước prompt: 1033 ký tự
2025-05-18 19:47:39,972 - chatbot_rag - INFO - Kích thước system prompt: 916 ký tự
2025-05-18 19:47:39,972 - chatbot_rag - INFO - Tổng kích thước: 1949 ký tự
2025-05-18 19:47:39,974 - chatbot_rag - INFO - Đã lưu full prompt vào file: data/logs/llm_full_prompt_20250518_194739.txt
2025-05-18 19:47:39,974 - chatbot_rag - INFO - System prompt: 
Bạn là trợ lý AI chuyên về quy trình và giai đoạn trong công ty.

DANH SÁCH PHÒNG BAN:
- 2D
- Dự toán
- Khách hàng
- Kinh doanh
- Kế toán
- Marketing
- Mua hàng
- Team dự án
- Thi công
- Thiết kế
- Đ...
2025-05-18 19:47:39,975 - chatbot_rag - INFO - User prompt: 
Câu hỏi: "xin chào /no_think"

Đây là câu hỏi chung về quy trình hoặc giai đoạn làm việc.

Thông tin cơ bản:
### Thông tin tổng quan về quy trình và giai đoạn

#### Giai đoạn chính trong quy trình:
1...
2025-05-18 19:47:39,976 - chatbot_rag - INFO - Gửi truy vấn đến LLM API tại http://192.168.1.4:1234/v1/chat/completions với stream=True
2025-05-18 19:47:58,938 - chatbot_rag - INFO - Mã phản hồi từ API: 200
2025-05-18 19:47:58,939 - chatbot_rag - INFO - Phản hồi gốc từ LLM API (200 ký tự đầu): <think>

</think>

 Xin chào! 😊  
Chào mừng bạn đến với quy trình làm việc của chúng ta! 🚀  

Nếu bạn muốn biết về vai trò của từng phòng ban trong các giai đoạn cụ thể, cứ hỏi nhé!  
Ví dụ: "Phòng Ma
2025-05-18 19:47:58,944 - chatbot_rag - INFO - Đã lưu phản hồi đầy đủ vào file: data/logs/llm_response_20250518_194758.txt
2025-05-18 19:47:59,295 - websocket_server - INFO - Đã trích xuất thinking (0 ký tự) và còn lại 469 ký tự phản hồi
2025-05-18 19:47:59,296 - websocket_server - INFO - Phần nội dung còn lại bắt đầu bằng: Xin chào! 😊  
Chào mừng bạn đến với quy trình làm ...
2025-05-18 19:47:59,296 - websocket_server - INFO - Đã trích xuất phần thinking (0 ký tự) từ phản hồi
2025-05-18 19:47:59,296 - websocket_server - INFO - Đã lưu hội thoại chung vào lịch sử của session fb0f8f95-cd33-4dba-9843-f75ba9898320
2025-05-18 19:48:17,095 - websocket_server - INFO - Nhận tin nhắn dạng JSON: {"content":"xin chào /think","session_id":"","mode":"basic","basic_prompt":"Bạn là một trợ lý AI hữu
2025-05-18 19:48:17,096 - websocket_server - INFO - Session ID không được cung cấp trong tin nhắn JSON, sử dụng current_session_id: fb0f8f95-cd33-4dba-9843-f75ba9898320
2025-05-18 19:48:17,096 - websocket_server - INFO - Session ID từ client (sau khi kiểm tra): fb0f8f95-cd33-4dba-9843-f75ba9898320
2025-05-18 19:48:17,096 - websocket_server - INFO - Bật chế độ thinking cho câu hỏi: xin chào /think...
2025-05-18 19:48:17,097 - websocket_server - INFO - Nhận tin nhắn thông thường: xin chào /think, enable_thinking=True, mode=basic
2025-05-18 19:48:17,097 - websocket_server - INFO - Chế độ Basic được kích hoạt với prompt: Bạn là một trợ lý AI hữu ích và thông minh. Hãy trả lời câu hỏi của người dùng một cách chi tiết và ...
2025-05-18 19:48:17,098 - websocket_server - INFO - Xử lý streaming response cho: 'xin chào /think', phòng ban: None, session_id: fb0f8f95-cd33-4dba-9843-f75ba9898320, mode: basic
2025-05-18 19:48:17,098 - websocket_server - INFO - Session ID nhận được: fb0f8f95-cd33-4dba-9843-f75ba9898320
2025-05-18 19:48:17,099 - websocket_server - INFO - Phát hiện lệnh /think, bật chế độ thinking cho: xin chào
2025-05-18 19:48:17,099 - websocket_server - INFO - Xử lý streaming response. Query: 'xin chào', Mode: basic, Thinking: True
2025-05-18 19:48:17,100 - websocket_server - INFO - Chế độ Basic được kích hoạt với prompt: Bạn là một trợ lý AI hữu ích và thông minh. Hãy trả lời câu hỏi của người dùng một cách chi tiết và ...
2025-05-18 19:48:17,100 - websocket_server - INFO - Đã thêm 1 tin nhắn gần nhất vào prompt
2025-05-18 19:48:17,102 - websocket_server - INFO - Đã lưu lịch sử tin nhắn và prompt vào file: data/logs/history_prompt_20250518_194817.txt
2025-05-18 19:48:17,103 - websocket_server - INFO - Kích thước prompt: 48 ký tự
2025-05-18 19:48:17,103 - websocket_server - INFO - Kích thước system prompt: 174 ký tự
2025-05-18 19:48:17,104 - websocket_server - INFO - Tổng kích thước: 222 ký tự
2025-05-18 19:48:17,104 - websocket_server - INFO - Bắt đầu gọi LLM API (lần thử 1/3)
2025-05-18 19:48:26,200 - websocket_server - INFO - API trả về status 200 OK
2025-05-18 19:48:26,201 - websocket_server - INFO - Streaming hoàn tất thành công
2025-05-18 19:48:26,203 - websocket_server - INFO - Gửi phản hồi cuối cùng, chế độ basic, thinking_enabled: True, thinking_collected: False
2025-05-18 19:48:26,203 - websocket_server - INFO - Lưu hội thoại basic mode vào lịch sử với session_id=fb0f8f95-cd33-4dba-9843-f75ba9898320
2025-05-18 19:48:26,214 - websocket_server - WARNING - Session  không tồn tại, sử dụng session hiện tại
2025-05-18 19:48:26,215 - websocket_server - INFO - Nhận yêu cầu phân tích (thinking) cho câu hỏi: Xin chào! 😊  
Chào mừng bạn đến với quy trình làm việc của chúng ta! 🚀  

Nếu bạn muốn biết về vai t
2025-05-18 19:48:26,224 - websocket_server - INFO - Đã thêm 2 tin nhắn gần nhất vào prompt
2025-05-18 19:48:26,234 - websocket_server - INFO - Đã lưu lịch sử tin nhắn và prompt vào file: data/logs/history_prompt_20250518_194826.txt
2025-05-18 19:48:26,235 - websocket_server - INFO - Phân tích câu hỏi để xác định phòng ban hoặc loại câu hỏi
2025-05-18 19:48:26,235 - chatbot_rag - INFO - Đang phân tích câu hỏi với LLM: Lịch sử tin nhắn:
Người dùng: xin chào
Người dùng: xin chào

Xin chào! 😊  
Chào mừng bạn đến với quy trình làm việc của chúng ta! 🚀  

Nếu bạn muốn biết về vai trò của từng phòng ban trong các giai đoạn cụ thể, cứ hỏi nhé!  
Ví dụ: "Phòng Marketing tham gia giai đoạn nào?" hoặc "Phòng Kinh doanh có những bước gì?"  

Để biết chi tiết công việc cụ thể, vui lòng hỏi về một phòng ban cụ thể, ví dụ: **"Phòng X làm gì trong giai đoạn Y?"** 💡

---  
🌟 *Nếu bạn muốn nói chuyện vui vẻ thay vì hỏi về công việc, mình cũng sẵn sàng! 😄*, session_id: fb0f8f95-cd33-4dba-9843-f75ba9898320
2025-05-18 19:48:26,236 - chatbot_rag - INFO - [analyze_query_with_llm] Đã lấy được 0 bản ghi lịch sử từ websocket_server cho session fb0f8f95-cd33-4dba-9843-f75ba9898320
2025-05-18 19:48:26,236 - chatbot_rag - INFO - [analyze_query_with_llm] Sử dụng lịch sử hội thoại: 0 bản ghi
2025-05-18 19:48:26,236 - chatbot_rag - INFO - [analyze_query_with_llm] Prompt cuối cùng: Lịch sử tin nhắn:
        
        Câu hỏi người dùng hiện tại: "Lịch sử tin nhắn:
Người dùng: xin chào
Người dùng: xin chào

Xin chào! 😊  
Chào mừng bạn đến với quy trình làm việc của chúng ta! 🚀  

...
2025-05-18 19:48:26,237 - chatbot_rag - INFO - Kích thước prompt: 1111 ký tự
2025-05-18 19:48:26,237 - chatbot_rag - INFO - Kích thước system prompt: 2006 ký tự
2025-05-18 19:48:26,238 - chatbot_rag - INFO - Tổng kích thước: 3117 ký tự
2025-05-18 19:48:26,239 - chatbot_rag - INFO - Đã lưu full prompt vào file: data/logs/llm_full_prompt_20250518_194826.txt
2025-05-18 19:48:26,239 - chatbot_rag - INFO - System prompt: 
        Bạn là trợ lý AI phân tích câu hỏi để xác định:
        1. Phòng ban người dùng đang hỏi (department)
        2. Loại câu hỏi: phòng ban cụ thể hay general (query_type)
        3. Nếu câu hỏi...
2025-05-18 19:48:26,240 - chatbot_rag - INFO - User prompt: Lịch sử tin nhắn:
        
        Câu hỏi người dùng hiện tại: "Lịch sử tin nhắn:
Người dùng: xin chào
Người dùng: xin chào

Xin chào! 😊  
Chào mừng bạn đến với quy trình làm việc của chúng ta! 🚀  

...
2025-05-18 19:48:26,240 - chatbot_rag - INFO - Gửi truy vấn đến LLM API tại http://192.168.1.4:1234/v1/chat/completions với stream=False
2025-05-18 19:48:51,584 - chatbot_rag - INFO - Mã phản hồi từ API: 200
2025-05-18 19:48:51,585 - chatbot_rag - INFO - Phản hồi gốc từ LLM API (200 ký tự đầu): <think>
Okay, let's tackle this query. The user provided a history of messages where they greeted and the assistant responded with an introduction about the company's workflow. The current question is
2025-05-18 19:48:51,587 - chatbot_rag - INFO - Đã lưu phản hồi đầy đủ vào file: data/logs/llm_response_20250518_194851.txt
2025-05-18 19:48:51,590 - chatbot_rag - INFO - [analysis_20250518_194851] Đã ghi phản hồi gốc vào: data/logs/analysis_20250518_194851_raw.txt
2025-05-18 19:48:51,591 - chatbot_rag - INFO - [analysis_20250518_194851] Phản hồi gốc: <think>
Okay, let's tackle this query. The user provided a history of messages where they greeted an...
2025-05-18 19:48:51,591 - chatbot_rag - WARNING - [analysis_20250518_194851] Phát hiện thẻ <think> trong phản hồi. Xử lý đặc biệt...
2025-05-18 19:48:51,591 - chatbot_rag - INFO - [analysis_20250518_194851] BƯỚC 1: Thử parse toàn bộ chuỗi phản hồi
2025-05-18 19:48:51,592 - chatbot_rag - INFO - [analysis_20250518_194851] BƯỚC 1: Không phải JSON hợp lệ: Expecting value: line 1 column 1 (char 0)
2025-05-18 19:48:51,592 - chatbot_rag - INFO - [analysis_20250518_194851] BƯỚC 2: Tìm JSON trong chuỗi phản hồi
2025-05-18 19:48:51,593 - chatbot_rag - WARNING - [analysis_20250518_194851] BƯỚC 2: Không tìm thấy mẫu JSON nào trong phản hồi
2025-05-18 19:48:51,593 - chatbot_rag - INFO - [analysis_20250518_194851] BƯỚC 3: Xử lý chuỗi thủ công để trích xuất thông tin
2025-05-18 19:48:51,597 - department_info_tool - INFO - Đã tải 11 phòng ban
2025-05-18 19:48:51,598 - department_info_tool - INFO - Đã lấy danh sách 11 phòng ban
2025-05-18 19:48:51,599 - chatbot_rag - INFO - [analysis_20250518_194851] BƯỚC 3: Tìm thấy phòng ban trong câu hỏi: Kinh doanh
2025-05-18 19:48:51,599 - chatbot_rag - ERROR - [analysis_20250518_194851] BƯỚC 3: Lỗi khi xử lý chuỗi thủ công: local variable 'query_type' referenced before assignment
2025-05-18 19:48:51,600 - chatbot_rag - WARNING - [analysis_20250518_194851] Tất cả phương pháp phân tích đều thất bại, trả về kết quả mặc định
2025-05-18 19:48:51,600 - websocket_server - INFO - Lấy phân tích cho câu hỏi chung
2025-05-18 19:48:51,600 - chatbot_rag - INFO - Xử lý câu hỏi chung cho session_id: fb0f8f95-cd33-4dba-9843-f75ba9898320
2025-05-18 19:48:51,604 - department_info_tool - INFO - Đã tải 11 phòng ban
2025-05-18 19:48:51,605 - department_info_tool - INFO - Đã lấy danh sách 11 phòng ban
2025-05-18 19:48:51,605 - chatbot_rag - INFO - Gọi LLM để trả lời câu hỏi chung cho session_id: fb0f8f95-cd33-4dba-9843-f75ba9898320
2025-05-18 19:48:51,607 - chatbot_rag - INFO - Đã lưu prompt vào file: data/logs/prompt_general_20250518_194851.txt
2025-05-18 19:48:51,609 - chatbot_rag - INFO - Kích thước prompt: 1491 ký tự
2025-05-18 19:48:51,609 - chatbot_rag - INFO - Kích thước system prompt: 916 ký tự
2025-05-18 19:48:51,610 - chatbot_rag - INFO - Tổng kích thước: 2407 ký tự
2025-05-18 19:48:51,611 - chatbot_rag - INFO - Đã lưu full prompt vào file: data/logs/llm_full_prompt_20250518_194851.txt
2025-05-18 19:48:51,612 - chatbot_rag - INFO - System prompt: 
Bạn là trợ lý AI chuyên về quy trình và giai đoạn trong công ty.

DANH SÁCH PHÒNG BAN:
- 2D
- Dự toán
- Khách hàng
- Kinh doanh
- Kế toán
- Marketing
- Mua hàng
- Team dự án
- Thi công
- Thiết kế
- Đ...
2025-05-18 19:48:51,613 - chatbot_rag - INFO - User prompt: 
Câu hỏi: "Xin chào! 😊  
Chào mừng bạn đến với quy trình làm việc của chúng ta! 🚀  

Nếu bạn muốn biết về vai trò của từng phòng ban trong các giai đoạn cụ thể, cứ hỏi nhé!  
Ví dụ: "Phòng Marketing t...
2025-05-18 19:48:51,613 - chatbot_rag - INFO - Gửi truy vấn đến LLM API tại http://192.168.1.4:1234/v1/chat/completions với stream=True
2025-05-18 19:49:33,686 - chatbot_rag - INFO - Mã phản hồi từ API: 200
2025-05-18 19:49:33,687 - chatbot_rag - INFO - Phản hồi gốc từ LLM API (200 ký tự đầu): <think>
Okay, let's see. The user provided a detailed query about the company's workflow and departments. They want me to follow specific rules: not create connections between departments and stages, 
2025-05-18 19:49:33,688 - chatbot_rag - INFO - Đã lưu phản hồi đầy đủ vào file: data/logs/llm_response_20250518_194933.txt
2025-05-18 19:49:33,695 - websocket_server - INFO - Đã trích xuất thinking (1466 ký tự) và còn lại 522 ký tự phản hồi
2025-05-18 19:49:33,695 - websocket_server - INFO - Phần nội dung còn lại bắt đầu bằng: ### Giai đoạn và phòng ban liên quan  
- **MKT-SAL...
2025-05-18 19:49:33,695 - websocket_server - INFO - Đã trích xuất phần thinking (1466 ký tự) từ phản hồi handle_general_query
2025-05-18 19:49:33,696 - websocket_server - INFO - Gửi phản hồi thinking với request_id: thinking_1747572505514_fh4su4a
2025-05-18 19:49:33,697 - websocket_server - INFO - Đã gửi nội dung thinking (1466 ký tự)
2025-05-18 19:49:33,705 - websocket_server - INFO - WebSocket connection closed
2025-05-18 19:49:33,706 - websockets.server - INFO - connection closed
2025-05-18 19:49:33,708 - websockets.server - INFO - connection open
2025-05-18 19:49:46,596 - websockets.server - INFO - connection closed
2025-05-18 19:49:47,465 - websockets.server - INFO - connection open
2025-05-18 19:49:56,938 - websocket_server - INFO - Nhận yêu cầu phân tích (thinking) cho câu hỏi: Xin chào! 😊  
Chào mừng bạn đến với quy trình làm việc của chúng ta! 🚀  

Nếu bạn muốn biết về vai t
2025-05-18 19:49:56,939 - websocket_server - INFO - Đã thêm 2 tin nhắn gần nhất vào prompt
2025-05-18 19:49:56,941 - websocket_server - INFO - Đã lưu lịch sử tin nhắn và prompt vào file: data/logs/history_prompt_20250518_194956.txt
2025-05-18 19:49:56,942 - websocket_server - INFO - Phân tích câu hỏi để xác định phòng ban hoặc loại câu hỏi
2025-05-18 19:49:56,942 - chatbot_rag - INFO - Đang phân tích câu hỏi với LLM: Lịch sử tin nhắn:
Người dùng: xin chào
Người dùng: xin chào

Xin chào! 😊  
Chào mừng bạn đến với quy trình làm việc của chúng ta! 🚀  

Nếu bạn muốn biết về vai trò của từng phòng ban trong các giai đoạn cụ thể, cứ hỏi nhé!  
Ví dụ: "Phòng Marketing tham gia giai đoạn nào?" hoặc "Phòng Kinh doanh có những bước gì?"  

Để biết chi tiết công việc cụ thể, vui lòng hỏi về một phòng ban cụ thể, ví dụ: **"Phòng X làm gì trong giai đoạn Y?"** 💡

---  
🌟 *Nếu bạn muốn nói chuyện vui vẻ thay vì hỏi về công việc, mình cũng sẵn sàng! 😄*, session_id: fb0f8f95-cd33-4dba-9843-f75ba9898320
2025-05-18 19:49:56,943 - chatbot_rag - INFO - [analyze_query_with_llm] Đã lấy được 0 bản ghi lịch sử từ websocket_server cho session fb0f8f95-cd33-4dba-9843-f75ba9898320
2025-05-18 19:49:56,944 - chatbot_rag - INFO - [analyze_query_with_llm] Sử dụng lịch sử hội thoại: 0 bản ghi
2025-05-18 19:49:56,944 - chatbot_rag - INFO - [analyze_query_with_llm] Prompt cuối cùng: Lịch sử tin nhắn:
        
        Câu hỏi người dùng hiện tại: "Lịch sử tin nhắn:
Người dùng: xin chào
Người dùng: xin chào

Xin chào! 😊  
Chào mừng bạn đến với quy trình làm việc của chúng ta! 🚀  

...
2025-05-18 19:49:56,944 - chatbot_rag - INFO - Kích thước prompt: 1111 ký tự
2025-05-18 19:49:56,945 - chatbot_rag - INFO - Kích thước system prompt: 2006 ký tự
2025-05-18 19:49:56,945 - chatbot_rag - INFO - Tổng kích thước: 3117 ký tự
2025-05-18 19:49:56,947 - chatbot_rag - INFO - Đã lưu full prompt vào file: data/logs/llm_full_prompt_20250518_194956.txt
2025-05-18 19:49:56,947 - chatbot_rag - INFO - System prompt: 
        Bạn là trợ lý AI phân tích câu hỏi để xác định:
        1. Phòng ban người dùng đang hỏi (department)
        2. Loại câu hỏi: phòng ban cụ thể hay general (query_type)
        3. Nếu câu hỏi...
2025-05-18 19:49:56,948 - chatbot_rag - INFO - User prompt: Lịch sử tin nhắn:
        
        Câu hỏi người dùng hiện tại: "Lịch sử tin nhắn:
Người dùng: xin chào
Người dùng: xin chào

Xin chào! 😊  
Chào mừng bạn đến với quy trình làm việc của chúng ta! 🚀  

...
2025-05-18 19:49:56,948 - chatbot_rag - INFO - Gửi truy vấn đến LLM API tại http://192.168.1.4:1234/v1/chat/completions với stream=False
2025-05-18 19:50:24,494 - chatbot_rag - INFO - Mã phản hồi từ API: 200
2025-05-18 19:50:24,495 - chatbot_rag - INFO - Phản hồi gốc từ LLM API (200 ký tự đầu): <think>
Okay, let's tackle this. The user provided a history of messages where they greeted and the assistant responded with an introduction about the workflow process. The current question is the sam
2025-05-18 19:50:24,497 - chatbot_rag - INFO - Đã lưu phản hồi đầy đủ vào file: data/logs/llm_response_20250518_195024.txt
2025-05-18 19:50:24,500 - chatbot_rag - INFO - [analysis_20250518_195024] Đã ghi phản hồi gốc vào: data/logs/analysis_20250518_195024_raw.txt
2025-05-18 19:50:24,501 - chatbot_rag - INFO - [analysis_20250518_195024] Phản hồi gốc: <think>
Okay, let's tackle this. The user provided a history of messages where they greeted and the ...
2025-05-18 19:50:24,501 - chatbot_rag - WARNING - [analysis_20250518_195024] Phát hiện thẻ <think> trong phản hồi. Xử lý đặc biệt...
2025-05-18 19:50:24,501 - chatbot_rag - INFO - [analysis_20250518_195024] BƯỚC 1: Thử parse toàn bộ chuỗi phản hồi
2025-05-18 19:50:24,502 - chatbot_rag - INFO - [analysis_20250518_195024] BƯỚC 1: Không phải JSON hợp lệ: Expecting value: line 1 column 1 (char 0)
2025-05-18 19:50:24,502 - chatbot_rag - INFO - [analysis_20250518_195024] BƯỚC 2: Tìm JSON trong chuỗi phản hồi
2025-05-18 19:50:24,502 - chatbot_rag - WARNING - [analysis_20250518_195024] BƯỚC 2: Không tìm thấy mẫu JSON nào trong phản hồi
2025-05-18 19:50:24,503 - chatbot_rag - INFO - [analysis_20250518_195024] BƯỚC 3: Xử lý chuỗi thủ công để trích xuất thông tin
2025-05-18 19:50:24,514 - department_info_tool - INFO - Đã tải 11 phòng ban
2025-05-18 19:50:24,515 - department_info_tool - INFO - Đã lấy danh sách 11 phòng ban
2025-05-18 19:50:24,516 - chatbot_rag - INFO - [analysis_20250518_195024] BƯỚC 3: Tìm thấy phòng ban trong câu hỏi: Kinh doanh
2025-05-18 19:50:24,516 - chatbot_rag - ERROR - [analysis_20250518_195024] BƯỚC 3: Lỗi khi xử lý chuỗi thủ công: local variable 'query_type' referenced before assignment
2025-05-18 19:50:24,516 - chatbot_rag - WARNING - [analysis_20250518_195024] Tất cả phương pháp phân tích đều thất bại, trả về kết quả mặc định
2025-05-18 19:50:24,517 - websocket_server - INFO - Lấy phân tích cho câu hỏi chung
2025-05-18 19:50:24,518 - chatbot_rag - INFO - Xử lý câu hỏi chung cho session_id: fb0f8f95-cd33-4dba-9843-f75ba9898320
2025-05-18 19:50:24,523 - department_info_tool - INFO - Đã tải 11 phòng ban
2025-05-18 19:50:24,523 - department_info_tool - INFO - Đã lấy danh sách 11 phòng ban
2025-05-18 19:50:24,523 - chatbot_rag - INFO - Gọi LLM để trả lời câu hỏi chung cho session_id: fb0f8f95-cd33-4dba-9843-f75ba9898320
2025-05-18 19:50:24,527 - chatbot_rag - INFO - Đã lưu prompt vào file: data/logs/prompt_general_20250518_195024.txt
2025-05-18 19:50:24,527 - chatbot_rag - INFO - Kích thước prompt: 1491 ký tự
2025-05-18 19:50:24,528 - chatbot_rag - INFO - Kích thước system prompt: 916 ký tự
2025-05-18 19:50:24,528 - chatbot_rag - INFO - Tổng kích thước: 2407 ký tự
2025-05-18 19:50:24,530 - chatbot_rag - INFO - Đã lưu full prompt vào file: data/logs/llm_full_prompt_20250518_195024.txt
2025-05-18 19:50:24,531 - chatbot_rag - INFO - System prompt: 
Bạn là trợ lý AI chuyên về quy trình và giai đoạn trong công ty.

DANH SÁCH PHÒNG BAN:
- 2D
- Dự toán
- Khách hàng
- Kinh doanh
- Kế toán
- Marketing
- Mua hàng
- Team dự án
- Thi công
- Thiết kế
- Đ...
2025-05-18 19:50:24,532 - chatbot_rag - INFO - User prompt: 
Câu hỏi: "Xin chào! 😊  
Chào mừng bạn đến với quy trình làm việc của chúng ta! 🚀  

Nếu bạn muốn biết về vai trò của từng phòng ban trong các giai đoạn cụ thể, cứ hỏi nhé!  
Ví dụ: "Phòng Marketing t...
2025-05-18 19:50:24,532 - chatbot_rag - INFO - Gửi truy vấn đến LLM API tại http://192.168.1.4:1234/v1/chat/completions với stream=True
2025-05-18 19:53:12,960 - chatbot_rag - INFO - Mã phản hồi từ API: 200
2025-05-18 19:53:12,970 - chatbot_rag - INFO - Phản hồi gốc từ LLM API (200 ký tự đầu): <think>
Okay, let's see. The user provided a detailed prompt about the company's departments and processes. They want me to act as an AI assistant that focuses on describing stages and responsible dep
2025-05-18 19:53:12,975 - chatbot_rag - INFO - Đã lưu phản hồi đầy đủ vào file: data/logs/llm_response_20250518_195312.txt
2025-05-18 19:53:13,010 - websocket_server - INFO - Đã trích xuất thinking (8613 ký tự) và còn lại 583 ký tự phản hồi
2025-05-18 19:53:13,013 - websocket_server - INFO - Phần nội dung còn lại bắt đầu bằng: # Giai đoạn chính trong quy trình làm việc  
1. **...
2025-05-18 19:53:13,014 - websocket_server - INFO - Đã trích xuất phần thinking (8613 ký tự) từ phản hồi handle_general_query
2025-05-18 19:53:13,014 - websocket_server - INFO - Gửi phản hồi thinking với request_id: thinking_1747572596937_9xj74fv
2025-05-18 19:53:13,023 - websocket_server - INFO - Đã gửi nội dung thinking (8613 ký tự)
2025-05-18 19:53:13,045 - websockets.server - INFO - connection open
2025-05-18 19:53:13,065 - websockets.server - INFO - connection open
2025-05-18 19:53:13,091 - websockets.server - INFO - connection open
2025-05-18 19:53:13,120 - websockets.server - INFO - connection open
2025-05-18 19:53:13,137 - websockets.server - INFO - connection open
2025-05-18 19:53:18,270 - websockets.server - INFO - connection open
2025-05-18 19:53:26,049 - websocket_server - INFO - Nhận yêu cầu phân tích (thinking) cho câu hỏi: Xin chào! 😊  
Chào mừng bạn đến với quy trình làm việc của chúng ta! 🚀  

Nếu bạn muốn biết về vai t
2025-05-18 19:53:26,050 - websocket_server - INFO - Đã thêm 2 tin nhắn gần nhất vào prompt
2025-05-18 19:53:26,052 - websocket_server - INFO - Đã lưu lịch sử tin nhắn và prompt vào file: data/logs/history_prompt_20250518_195326.txt
2025-05-18 19:53:26,052 - websocket_server - INFO - Phân tích câu hỏi để xác định phòng ban hoặc loại câu hỏi
2025-05-18 19:53:26,053 - chatbot_rag - INFO - Đang phân tích câu hỏi với LLM: Lịch sử tin nhắn:
Người dùng: xin chào
Người dùng: xin chào

Xin chào! 😊  
Chào mừng bạn đến với quy trình làm việc của chúng ta! 🚀  

Nếu bạn muốn biết về vai trò của từng phòng ban trong các giai đoạn cụ thể, cứ hỏi nhé!  
Ví dụ: "Phòng Marketing tham gia giai đoạn nào?" hoặc "Phòng Kinh doanh có những bước gì?"  

Để biết chi tiết công việc cụ thể, vui lòng hỏi về một phòng ban cụ thể, ví dụ: **"Phòng X làm gì trong giai đoạn Y?"** 💡

---  
🌟 *Nếu bạn muốn nói chuyện vui vẻ thay vì hỏi về công việc, mình cũng sẵn sàng! 😄*, session_id: fb0f8f95-cd33-4dba-9843-f75ba9898320
2025-05-18 19:53:26,054 - chatbot_rag - INFO - [analyze_query_with_llm] Đã lấy được 0 bản ghi lịch sử từ websocket_server cho session fb0f8f95-cd33-4dba-9843-f75ba9898320
2025-05-18 19:53:26,054 - chatbot_rag - INFO - [analyze_query_with_llm] Sử dụng lịch sử hội thoại: 0 bản ghi
2025-05-18 19:53:26,055 - chatbot_rag - INFO - [analyze_query_with_llm] Prompt cuối cùng: Lịch sử tin nhắn:
        
        Câu hỏi người dùng hiện tại: "Lịch sử tin nhắn:
Người dùng: xin chào
Người dùng: xin chào

Xin chào! 😊  
Chào mừng bạn đến với quy trình làm việc của chúng ta! 🚀  

...
2025-05-18 19:53:26,056 - chatbot_rag - INFO - Kích thước prompt: 1111 ký tự
2025-05-18 19:53:26,056 - chatbot_rag - INFO - Kích thước system prompt: 2006 ký tự
2025-05-18 19:53:26,056 - chatbot_rag - INFO - Tổng kích thước: 3117 ký tự
2025-05-18 19:53:26,059 - chatbot_rag - INFO - Đã lưu full prompt vào file: data/logs/llm_full_prompt_20250518_195326.txt
2025-05-18 19:53:26,060 - chatbot_rag - INFO - System prompt: 
        Bạn là trợ lý AI phân tích câu hỏi để xác định:
        1. Phòng ban người dùng đang hỏi (department)
        2. Loại câu hỏi: phòng ban cụ thể hay general (query_type)
        3. Nếu câu hỏi...
2025-05-18 19:53:26,061 - chatbot_rag - INFO - User prompt: Lịch sử tin nhắn:
        
        Câu hỏi người dùng hiện tại: "Lịch sử tin nhắn:
Người dùng: xin chào
Người dùng: xin chào

Xin chào! 😊  
Chào mừng bạn đến với quy trình làm việc của chúng ta! 🚀  

...
2025-05-18 19:53:26,061 - chatbot_rag - INFO - Gửi truy vấn đến LLM API tại http://192.168.1.4:1234/v1/chat/completions với stream=False
2025-05-18 19:53:53,583 - websockets.server - INFO - connection closed
2025-05-18 19:53:53,592 - websockets.server - INFO - connection closed
2025-05-18 19:53:53,593 - websockets.server - INFO - connection closed
2025-05-18 19:53:53,594 - websockets.server - INFO - connection closed
2025-05-18 19:53:53,595 - websockets.server - INFO - connection closed
2025-05-18 19:53:53,595 - websockets.server - INFO - connection closed
2025-05-18 19:53:53,595 - websockets.server - INFO - connection closed
2025-05-18 19:53:53,598 - websockets.server - INFO - server closing
2025-05-18 19:53:53,599 - websockets.server - INFO - server closed
2025-05-18 19:53:53,605 - websocket_server - INFO - Server bị dừng bởi người dùng
2025-05-18 19:53:53,701 - asyncio - ERROR - Task exception was never retrieved
future: <Task finished name='Task-47' coro=<WebSocketServerProtocol.handler() done, defined at C:\Users\thuon\OneDrive\Desktop\UI-chatbot\backend\venv\lib\site-packages\websockets\legacy\server.py:159> exception=KeyboardInterrupt()>
Traceback (most recent call last):
  File "server.py", line 1356, in <module>
    asyncio.run(main())
  File "C:\Users\thuon\AppData\Local\Programs\Python\Python38\lib\asyncio\runners.py", line 43, in run
    return loop.run_until_complete(main)
  File "C:\Users\thuon\AppData\Local\Programs\Python\Python38\lib\asyncio\base_events.py", line 603, in run_until_complete
    self.run_forever()
  File "C:\Users\thuon\AppData\Local\Programs\Python\Python38\lib\asyncio\windows_events.py", line 316, in run_forever
    super().run_forever()
  File "C:\Users\thuon\AppData\Local\Programs\Python\Python38\lib\asyncio\base_events.py", line 570, in run_forever
    self._run_once()
  File "C:\Users\thuon\AppData\Local\Programs\Python\Python38\lib\asyncio\base_events.py", line 1859, in _run_once
    handle._run()
  File "C:\Users\thuon\AppData\Local\Programs\Python\Python38\lib\asyncio\events.py", line 81, in _run
    self._context.run(self._callback, *self._args)
  File "C:\Users\thuon\OneDrive\Desktop\UI-chatbot\backend\venv\lib\site-packages\websockets\legacy\server.py", line 245, in handler
    await self.ws_handler(self)
  File "server.py", line 1130, in handle_message
    await handle_action(websocket, data['action'], data)
  File "server.py", line 996, in handle_action
    await handle_thinking_request(websocket, query, session_id, request_id)
  File "server.py", line 778, in handle_thinking_request
    analysis_result = analyze_query_with_llm(content_with_history, session_id)
  File "C:\Users\thuon\OneDrive\Desktop\UI-chatbot\backend\chatbot.py", line 1059, in analyze_query_with_llm
    response_text = query_llm(prompt, system_prompt, max_tokens=200, stream=False)
  File "C:\Users\thuon\OneDrive\Desktop\UI-chatbot\backend\chatbot.py", line 293, in query_llm
    response = requests.post(url, json=payload)
  File "C:\Users\thuon\OneDrive\Desktop\UI-chatbot\backend\venv\lib\site-packages\requests\api.py", line 115, in post
    return request("post", url, data=data, json=json, **kwargs)
  File "C:\Users\thuon\OneDrive\Desktop\UI-chatbot\backend\venv\lib\site-packages\requests\api.py", line 59, in request
    return session.request(method=method, url=url, **kwargs)
  File "C:\Users\thuon\OneDrive\Desktop\UI-chatbot\backend\venv\lib\site-packages\requests\sessions.py", line 589, in request
    resp = self.send(prep, **send_kwargs)
  File "C:\Users\thuon\OneDrive\Desktop\UI-chatbot\backend\venv\lib\site-packages\requests\sessions.py", line 703, in send
    r = adapter.send(request, **kwargs)
  File "C:\Users\thuon\OneDrive\Desktop\UI-chatbot\backend\venv\lib\site-packages\requests\adapters.py", line 667, in send
    resp = conn.urlopen(
  File "C:\Users\thuon\OneDrive\Desktop\UI-chatbot\backend\venv\lib\site-packages\urllib3\connectionpool.py", line 789, in urlopen
    response = self._make_request(
  File "C:\Users\thuon\OneDrive\Desktop\UI-chatbot\backend\venv\lib\site-packages\urllib3\connectionpool.py", line 536, in _make_request
    response = conn.getresponse()
  File "C:\Users\thuon\OneDrive\Desktop\UI-chatbot\backend\venv\lib\site-packages\urllib3\connection.py", line 507, in getresponse
    httplib_response = super().getresponse()
  File "C:\Users\thuon\AppData\Local\Programs\Python\Python38\lib\http\client.py", line 1322, in getresponse
    response.begin()
  File "C:\Users\thuon\AppData\Local\Programs\Python\Python38\lib\http\client.py", line 303, in begin
    version, status, reason = self._read_status()
  File "C:\Users\thuon\AppData\Local\Programs\Python\Python38\lib\http\client.py", line 264, in _read_status
    line = str(self.fp.readline(_MAXLINE + 1), "iso-8859-1")
  File "C:\Users\thuon\AppData\Local\Programs\Python\Python38\lib\socket.py", line 669, in readinto
    return self._sock.recv_into(b)
KeyboardInterrupt
2025-05-18 19:54:03,498 - websocket_server - INFO - Khởi động server WebSocket tại 0.0.0.0:8090
2025-05-18 19:54:03,543 - websockets.server - INFO - server listening on 0.0.0.0:8090
2025-05-18 19:54:03,544 - websocket_server - INFO - Server WebSocket đang chạy tại ws://0.0.0.0:8090
2025-05-18 19:54:03,545 - websocket_server - INFO - Đã cấu hình ping_timeout=6000 giây, ping_interval=60 giây
2025-05-18 19:54:21,836 - websockets.server - INFO - connection open
2025-05-18 19:54:30,823 - websocket_server - INFO - Nhận tin nhắn dạng JSON: {"content":"xin chào /think","session_id":"4e3c4b1b-6071-43f1-a543-4d5ebdb161c3","mode":"basic","bas
2025-05-18 19:54:30,824 - websocket_server - INFO - Session ID từ client (sau khi kiểm tra): 4e3c4b1b-6071-43f1-a543-4d5ebdb161c3
2025-05-18 19:54:30,825 - websocket_server - INFO - Bật chế độ thinking cho câu hỏi: xin chào /think...
2025-05-18 19:54:30,826 - websocket_server - INFO - Nhận tin nhắn thông thường: xin chào /think, enable_thinking=True, mode=basic
2025-05-18 19:54:30,826 - websocket_server - INFO - Chế độ Basic được kích hoạt với prompt: Bạn là một trợ lý AI hữu ích và thông minh. Hãy trả lời câu hỏi của người dùng một cách chi tiết và ...
2025-05-18 19:54:30,827 - websocket_server - INFO - Xử lý streaming response cho: 'xin chào /think', phòng ban: None, session_id: 4e3c4b1b-6071-43f1-a543-4d5ebdb161c3, mode: basic
2025-05-18 19:54:30,827 - websocket_server - INFO - Session ID nhận được: 4e3c4b1b-6071-43f1-a543-4d5ebdb161c3
2025-05-18 19:54:30,827 - websocket_server - INFO - Phát hiện lệnh /think, bật chế độ thinking cho: xin chào
2025-05-18 19:54:30,828 - websocket_server - INFO - Xử lý streaming response. Query: 'xin chào', Mode: basic, Thinking: True
2025-05-18 19:54:30,828 - websocket_server - INFO - Chế độ Basic được kích hoạt với prompt: Bạn là một trợ lý AI hữu ích và thông minh. Hãy trả lời câu hỏi của người dùng một cách chi tiết và ...
2025-05-18 19:54:30,829 - websocket_server - INFO - Không có lịch sử tin nhắn cho phiên này
2025-05-18 19:54:30,830 - websocket_server - INFO - Kích thước prompt: 8 ký tự
2025-05-18 19:54:30,830 - websocket_server - INFO - Kích thước system prompt: 174 ký tự
2025-05-18 19:54:30,830 - websocket_server - INFO - Tổng kích thước: 182 ký tự
2025-05-18 19:54:30,831 - websocket_server - INFO - Bắt đầu gọi LLM API (lần thử 1/3)
2025-05-18 19:54:40,426 - websocket_server - INFO - API trả về status 200 OK
2025-05-18 19:54:40,428 - websocket_server - INFO - Streaming hoàn tất thành công
2025-05-18 19:54:40,429 - websocket_server - INFO - Gửi phản hồi cuối cùng, chế độ basic, thinking_enabled: True, thinking_collected: False
2025-05-18 19:54:40,429 - websocket_server - INFO - Lưu hội thoại basic mode vào lịch sử với session_id=4e3c4b1b-6071-43f1-a543-4d5ebdb161c3
2025-05-18 19:55:23,506 - websockets.server - INFO - connection closed
2025-05-18 19:55:24,490 - websockets.server - INFO - connection open
2025-05-18 19:55:27,083 - websockets.server - INFO - connection closed
2025-05-18 19:55:27,944 - websockets.server - INFO - connection open
2025-05-18 19:55:30,938 - websockets.server - INFO - connection closed
2025-05-18 19:55:31,714 - websockets.server - INFO - connection open
2025-05-18 19:56:25,724 - websockets.server - INFO - connection open
2025-05-18 19:57:03,702 - websockets.server - INFO - connection open
2025-05-18 19:57:33,876 - websockets.server - INFO - connection open
2025-05-18 19:58:35,737 - websockets.server - INFO - connection open
2025-05-18 19:58:59,226 - websockets.server - INFO - connection open
2025-05-18 19:59:11,618 - websockets.server - INFO - connection closed
2025-05-18 19:59:11,619 - websockets.server - INFO - connection closed
2025-05-18 19:59:11,619 - websockets.server - INFO - connection closed
2025-05-18 19:59:11,620 - websockets.server - INFO - connection closed
2025-05-18 19:59:11,620 - websockets.server - INFO - connection closed
2025-05-18 19:59:11,620 - websockets.server - INFO - connection closed
2025-05-18 19:59:12,896 - websockets.server - INFO - connection open
2025-05-18 19:59:23,349 - websockets.server - INFO - connection closed
2025-05-18 19:59:24,094 - websockets.server - INFO - connection open
2025-05-18 19:59:31,703 - websocket_server - INFO - Nhận tin nhắn dạng JSON: {"content":"mày là ai /no_think","session_id":"4e3c4b1b-6071-43f1-a543-4d5ebdb161c3","mode":"basic",
2025-05-18 19:59:31,706 - websocket_server - INFO - Session ID từ client (sau khi kiểm tra): 4e3c4b1b-6071-43f1-a543-4d5ebdb161c3
2025-05-18 19:59:31,706 - websocket_server - INFO - Tắt chế độ thinking cho câu hỏi: mày là ai /no_think...
2025-05-18 19:59:31,708 - websocket_server - INFO - Nhận tin nhắn thông thường: mày là ai /no_think, enable_thinking=False, mode=basic
2025-05-18 19:59:31,708 - websocket_server - INFO - Chế độ Basic được kích hoạt với prompt: Bạn là một trợ lý AI hữu ích và thông minh. Hãy trả lời câu hỏi của người dùng một cách chi tiết và ...
2025-05-18 19:59:31,710 - websocket_server - INFO - Xử lý streaming response cho: 'mày là ai /no_think', phòng ban: None, session_id: 4e3c4b1b-6071-43f1-a543-4d5ebdb161c3, mode: basic
2025-05-18 19:59:31,711 - websocket_server - INFO - Session ID nhận được: 4e3c4b1b-6071-43f1-a543-4d5ebdb161c3
2025-05-18 19:59:31,711 - websocket_server - INFO - Phát hiện lệnh /no_think, tắt chế độ thinking cho: mày là ai
2025-05-18 19:59:31,712 - websocket_server - INFO - Xử lý streaming response. Query: 'mày là ai', Mode: basic, Thinking: False
2025-05-18 19:59:31,713 - websocket_server - INFO - Chế độ Basic được kích hoạt với prompt: Bạn là một trợ lý AI hữu ích và thông minh. Hãy trả lời câu hỏi của người dùng một cách chi tiết và ...
2025-05-18 19:59:31,714 - websocket_server - INFO - Đã thêm 1 tin nhắn gần nhất vào prompt
2025-05-18 19:59:31,726 - websocket_server - INFO - Đã lưu lịch sử tin nhắn và prompt vào file: data/logs/history_prompt_20250518_195931.txt
2025-05-18 19:59:31,727 - websocket_server - INFO - Kích thước prompt: 49 ký tự
2025-05-18 19:59:31,728 - websocket_server - INFO - Kích thước system prompt: 174 ký tự
2025-05-18 19:59:31,728 - websocket_server - INFO - Tổng kích thước: 223 ký tự
2025-05-18 19:59:31,729 - websocket_server - INFO - Bắt đầu gọi LLM API (lần thử 1/3)
2025-05-18 19:59:40,797 - websocket_server - INFO - API trả về status 200 OK
2025-05-18 19:59:40,800 - websocket_server - INFO - Streaming hoàn tất thành công
2025-05-18 19:59:40,801 - websocket_server - INFO - Gửi phản hồi cuối cùng, chế độ basic, thinking_enabled: False, thinking_collected: False
2025-05-18 19:59:40,801 - websocket_server - INFO - Lưu hội thoại basic mode vào lịch sử với session_id=4e3c4b1b-6071-43f1-a543-4d5ebdb161c3
2025-05-18 19:59:55,632 - websocket_server - INFO - Nhận yêu cầu phân tích (thinking) cho câu hỏi: 
2025-05-18 19:59:55,633 - websocket_server - INFO - Đã thêm 2 tin nhắn gần nhất vào prompt
2025-05-18 19:59:55,635 - websocket_server - INFO - Đã lưu lịch sử tin nhắn và prompt vào file: data/logs/history_prompt_20250518_195955.txt
2025-05-18 19:59:55,635 - websocket_server - INFO - Phân tích câu hỏi để xác định phòng ban hoặc loại câu hỏi
2025-05-18 19:59:55,640 - chatbot_rag - INFO - Đang phân tích câu hỏi với LLM: Lịch sử tin nhắn:
Người dùng: xin chào
Người dùng: mày là ai

, session_id: 4e3c4b1b-6071-43f1-a543-4d5ebdb161c3
2025-05-18 19:59:55,684 - chatbot_rag - INFO - [analyze_query_with_llm] Đã lấy được 0 bản ghi lịch sử từ websocket_server cho session 4e3c4b1b-6071-43f1-a543-4d5ebdb161c3
2025-05-18 19:59:55,685 - chatbot_rag - INFO - [analyze_query_with_llm] Sử dụng lịch sử hội thoại: 0 bản ghi
2025-05-18 19:59:55,686 - chatbot_rag - INFO - [analyze_query_with_llm] Prompt cuối cùng: Lịch sử tin nhắn:
        
        Câu hỏi người dùng hiện tại: "Lịch sử tin nhắn:
Người dùng: xin chào
Người dùng: mày là ai

"

        Phân tích câu hỏi và trả về JSON có định dạng:
        {"depar...
2025-05-18 19:59:55,687 - chatbot_rag - INFO - Kích thước prompt: 643 ký tự
2025-05-18 19:59:55,687 - chatbot_rag - INFO - Kích thước system prompt: 2006 ký tự
2025-05-18 19:59:55,687 - chatbot_rag - INFO - Tổng kích thước: 2649 ký tự
2025-05-18 19:59:55,690 - chatbot_rag - INFO - Đã lưu full prompt vào file: data/logs/llm_full_prompt_20250518_195955.txt
2025-05-18 19:59:55,690 - chatbot_rag - INFO - System prompt: 
        Bạn là trợ lý AI phân tích câu hỏi để xác định:
        1. Phòng ban người dùng đang hỏi (department)
        2. Loại câu hỏi: phòng ban cụ thể hay general (query_type)
        3. Nếu câu hỏi...
2025-05-18 19:59:55,692 - chatbot_rag - INFO - User prompt: Lịch sử tin nhắn:
        
        Câu hỏi người dùng hiện tại: "Lịch sử tin nhắn:
Người dùng: xin chào
Người dùng: mày là ai

"

        Phân tích câu hỏi và trả về JSON có định dạng:
        {"depar...
2025-05-18 19:59:55,692 - chatbot_rag - INFO - Gửi truy vấn đến LLM API tại http://192.168.1.4:1234/v1/chat/completions với stream=False
2025-05-18 20:00:17,075 - chatbot_rag - INFO - Mã phản hồi từ API: 200
2025-05-18 20:00:17,077 - chatbot_rag - INFO - Phản hồi gốc từ LLM API (200 ký tự đầu): <think>
Okay, let's tackle this query. The user provided a history of messages where they greeted and asked "mày là ai" (which means "who are you" in Vietnamese). Now, the current question is about an
2025-05-18 20:00:17,079 - chatbot_rag - INFO - Đã lưu phản hồi đầy đủ vào file: data/logs/llm_response_20250518_200017.txt
2025-05-18 20:00:17,081 - chatbot_rag - INFO - [analysis_20250518_200017] Đã ghi phản hồi gốc vào: data/logs/analysis_20250518_200017_raw.txt
2025-05-18 20:00:17,081 - chatbot_rag - INFO - [analysis_20250518_200017] Phản hồi gốc: <think>
Okay, let's tackle this query. The user provided a history of messages where they greeted an...
2025-05-18 20:00:17,082 - chatbot_rag - WARNING - [analysis_20250518_200017] Phát hiện thẻ <think> trong phản hồi. Xử lý đặc biệt...
2025-05-18 20:00:17,083 - chatbot_rag - INFO - [analysis_20250518_200017] BƯỚC 1: Thử parse toàn bộ chuỗi phản hồi
2025-05-18 20:00:17,084 - chatbot_rag - INFO - [analysis_20250518_200017] BƯỚC 1: Không phải JSON hợp lệ: Expecting value: line 1 column 1 (char 0)
2025-05-18 20:00:17,084 - chatbot_rag - INFO - [analysis_20250518_200017] BƯỚC 2: Tìm JSON trong chuỗi phản hồi
2025-05-18 20:00:17,085 - chatbot_rag - WARNING - [analysis_20250518_200017] BƯỚC 2: Không tìm thấy mẫu JSON nào trong phản hồi
2025-05-18 20:00:17,085 - chatbot_rag - INFO - [analysis_20250518_200017] BƯỚC 3: Xử lý chuỗi thủ công để trích xuất thông tin
2025-05-18 20:00:17,092 - department_info_tool - INFO - Đã tải 11 phòng ban
2025-05-18 20:00:17,092 - department_info_tool - INFO - Đã lấy danh sách 11 phòng ban
2025-05-18 20:00:17,093 - chatbot_rag - ERROR - [analysis_20250518_200017] BƯỚC 3: Lỗi khi xử lý chuỗi thủ công: local variable 'query_type' referenced before assignment
2025-05-18 20:00:17,094 - chatbot_rag - WARNING - [analysis_20250518_200017] Tất cả phương pháp phân tích đều thất bại, trả về kết quả mặc định
2025-05-18 20:00:17,094 - websocket_server - INFO - Lấy phân tích cho câu hỏi chung
2025-05-18 20:00:17,094 - chatbot_rag - INFO - Xử lý câu hỏi chung cho session_id: 4e3c4b1b-6071-43f1-a543-4d5ebdb161c3
2025-05-18 20:00:17,097 - department_info_tool - INFO - Đã tải 11 phòng ban
2025-05-18 20:00:17,097 - department_info_tool - INFO - Đã lấy danh sách 11 phòng ban
2025-05-18 20:00:17,098 - chatbot_rag - INFO - Gọi LLM để trả lời câu hỏi chung cho session_id: 4e3c4b1b-6071-43f1-a543-4d5ebdb161c3
2025-05-18 20:00:17,099 - chatbot_rag - INFO - Đã lưu prompt vào file: data/logs/prompt_general_20250518_200017.txt
2025-05-18 20:00:17,099 - chatbot_rag - INFO - Kích thước prompt: 1022 ký tự
2025-05-18 20:00:17,100 - chatbot_rag - INFO - Kích thước system prompt: 916 ký tự
2025-05-18 20:00:17,100 - chatbot_rag - INFO - Tổng kích thước: 1938 ký tự
2025-05-18 20:00:17,101 - chatbot_rag - INFO - Đã lưu full prompt vào file: data/logs/llm_full_prompt_20250518_200017.txt
2025-05-18 20:00:17,101 - chatbot_rag - INFO - System prompt: 
Bạn là trợ lý AI chuyên về quy trình và giai đoạn trong công ty.

DANH SÁCH PHÒNG BAN:
- 2D
- Dự toán
- Khách hàng
- Kinh doanh
- Kế toán
- Marketing
- Mua hàng
- Team dự án
- Thi công
- Thiết kế
- Đ...
2025-05-18 20:00:17,102 - chatbot_rag - INFO - User prompt: 
Câu hỏi: " /think"

Đây là câu hỏi chung về quy trình hoặc giai đoạn làm việc.

Thông tin cơ bản:
### Thông tin tổng quan về quy trình và giai đoạn

#### Giai đoạn chính trong quy trình:
1. **MKT-SAL...
2025-05-18 20:00:17,102 - chatbot_rag - INFO - Gửi truy vấn đến LLM API tại http://192.168.1.4:1234/v1/chat/completions với stream=True
2025-05-18 20:00:37,159 - chatbot_rag - INFO - Mã phản hồi từ API: 200
2025-05-18 20:00:37,167 - chatbot_rag - INFO - Phản hồi gốc từ LLM API (200 ký tự đầu): <think>
Okay, let's break down the user's query. They provided a structure of departments and process stages but didn't ask a specific question. The previous response was in Vietnamese, so I need to m
2025-05-18 20:00:37,169 - chatbot_rag - INFO - Đã lưu phản hồi đầy đủ vào file: data/logs/llm_response_20250518_200037.txt
2025-05-18 20:00:37,814 - websocket_server - INFO - Đã trích xuất thinking (742 ký tự) và còn lại 220 ký tự phản hồi
2025-05-18 20:00:37,815 - websocket_server - INFO - Phần nội dung còn lại bắt đầu bằng: 😅 *Câu hỏi chưa rõ ràng lắm nha! Bạn muốn biết gì ...
2025-05-18 20:00:37,815 - websocket_server - INFO - Đã trích xuất phần thinking (742 ký tự) từ phản hồi handle_general_query
2025-05-18 20:00:37,816 - websocket_server - INFO - Gửi phản hồi thinking với request_id: thinking_1747573195630_dcnwq96
2025-05-18 20:00:37,817 - websocket_server - INFO - Đã gửi nội dung thinking (742 ký tự)
2025-05-18 20:03:40,755 - websockets.server - INFO - connection open
2025-05-18 20:04:20,973 - websockets.server - INFO - connection closed
2025-05-18 20:04:20,974 - websockets.server - INFO - connection closed
2025-05-18 20:04:22,346 - websockets.server - INFO - connection open
2025-05-18 20:04:42,427 - websocket_server - INFO - Nhận tin nhắn dạng JSON: {"content":"xin chào /no_think","session_id":"4e3c4b1b-6071-43f1-a543-4d5ebdb161c3","mode":"basic","
2025-05-18 20:04:42,429 - websocket_server - INFO - Session ID từ client (sau khi kiểm tra): 4e3c4b1b-6071-43f1-a543-4d5ebdb161c3
2025-05-18 20:04:42,430 - websocket_server - INFO - Tắt chế độ thinking cho câu hỏi: xin chào /no_think...
2025-05-18 20:04:42,431 - websocket_server - INFO - Nhận tin nhắn thông thường: xin chào /no_think, enable_thinking=False, mode=basic
2025-05-18 20:04:42,432 - websocket_server - INFO - Chế độ Basic được kích hoạt với prompt: Bạn là một trợ lý AI hữu ích và thông minh. Hãy trả lời câu hỏi của người dùng một cách chi tiết và ...
2025-05-18 20:04:42,433 - websocket_server - INFO - Xử lý streaming response cho: 'xin chào /no_think', phòng ban: None, session_id: 4e3c4b1b-6071-43f1-a543-4d5ebdb161c3, mode: basic
2025-05-18 20:04:42,434 - websocket_server - INFO - Session ID nhận được: 4e3c4b1b-6071-43f1-a543-4d5ebdb161c3
2025-05-18 20:04:42,434 - websocket_server - INFO - Phát hiện lệnh /no_think, tắt chế độ thinking cho: xin chào
2025-05-18 20:04:42,435 - websocket_server - INFO - Xử lý streaming response. Query: 'xin chào', Mode: basic, Thinking: False
2025-05-18 20:04:42,435 - websocket_server - INFO - Chế độ Basic được kích hoạt với prompt: Bạn là một trợ lý AI hữu ích và thông minh. Hãy trả lời câu hỏi của người dùng một cách chi tiết và ...
2025-05-18 20:04:42,436 - websocket_server - INFO - Đã thêm 2 tin nhắn gần nhất vào prompt
2025-05-18 20:04:42,444 - websocket_server - INFO - Đã lưu lịch sử tin nhắn và prompt vào file: data/logs/history_prompt_20250518_200442.txt
2025-05-18 20:04:42,446 - websocket_server - INFO - Kích thước prompt: 70 ký tự
2025-05-18 20:04:42,449 - websocket_server - INFO - Kích thước system prompt: 174 ký tự
2025-05-18 20:04:42,450 - websocket_server - INFO - Tổng kích thước: 244 ký tự
2025-05-18 20:04:42,450 - websocket_server - INFO - Bắt đầu gọi LLM API (lần thử 1/3)
2025-05-18 20:04:52,670 - websocket_server - INFO - API trả về status 200 OK
2025-05-18 20:04:52,673 - websocket_server - INFO - Streaming hoàn tất thành công
2025-05-18 20:04:52,674 - websocket_server - INFO - Gửi phản hồi cuối cùng, chế độ basic, thinking_enabled: False, thinking_collected: False
2025-05-18 20:04:52,676 - websocket_server - INFO - Lưu hội thoại basic mode vào lịch sử với session_id=4e3c4b1b-6071-43f1-a543-4d5ebdb161c3
2025-05-18 20:05:07,290 - websocket_server - INFO - Nhận yêu cầu phân tích (thinking) cho câu hỏi: 
2025-05-18 20:05:07,291 - websocket_server - INFO - Đã thêm 3 tin nhắn gần nhất vào prompt
2025-05-18 20:05:07,300 - websocket_server - INFO - Đã lưu lịch sử tin nhắn và prompt vào file: data/logs/history_prompt_20250518_200507.txt
2025-05-18 20:05:07,300 - websocket_server - INFO - Phân tích câu hỏi để xác định phòng ban hoặc loại câu hỏi
2025-05-18 20:05:07,301 - chatbot_rag - INFO - Đang phân tích câu hỏi với LLM: Lịch sử tin nhắn:
Người dùng: xin chào
Người dùng: mày là ai
Người dùng: xin chào

, session_id: 4e3c4b1b-6071-43f1-a543-4d5ebdb161c3
2025-05-18 20:05:07,302 - chatbot_rag - INFO - [analyze_query_with_llm] Đã lấy được 0 bản ghi lịch sử từ websocket_server cho session 4e3c4b1b-6071-43f1-a543-4d5ebdb161c3
2025-05-18 20:05:07,302 - chatbot_rag - INFO - [analyze_query_with_llm] Sử dụng lịch sử hội thoại: 0 bản ghi
2025-05-18 20:05:07,303 - chatbot_rag - INFO - [analyze_query_with_llm] Prompt cuối cùng: Lịch sử tin nhắn:
        
        Câu hỏi người dùng hiện tại: "Lịch sử tin nhắn:
Người dùng: xin chào
Người dùng: mày là ai
Người dùng: xin chào

"

        Phân tích câu hỏi và trả về JSON có định ...
2025-05-18 20:05:07,304 - chatbot_rag - INFO - Kích thước prompt: 664 ký tự
2025-05-18 20:05:07,305 - chatbot_rag - INFO - Kích thước system prompt: 2006 ký tự
2025-05-18 20:05:07,307 - chatbot_rag - INFO - Tổng kích thước: 2670 ký tự
2025-05-18 20:05:07,311 - chatbot_rag - INFO - Đã lưu full prompt vào file: data/logs/llm_full_prompt_20250518_200507.txt
2025-05-18 20:05:07,312 - chatbot_rag - INFO - System prompt: 
        Bạn là trợ lý AI phân tích câu hỏi để xác định:
        1. Phòng ban người dùng đang hỏi (department)
        2. Loại câu hỏi: phòng ban cụ thể hay general (query_type)
        3. Nếu câu hỏi...
2025-05-18 20:05:07,313 - chatbot_rag - INFO - User prompt: Lịch sử tin nhắn:
        
        Câu hỏi người dùng hiện tại: "Lịch sử tin nhắn:
Người dùng: xin chào
Người dùng: mày là ai
Người dùng: xin chào

"

        Phân tích câu hỏi và trả về JSON có định ...
2025-05-18 20:05:07,314 - chatbot_rag - INFO - Gửi truy vấn đến LLM API tại http://192.168.1.4:1234/v1/chat/completions với stream=False
2025-05-18 20:05:28,821 - chatbot_rag - INFO - Mã phản hồi từ API: 200
2025-05-18 20:05:28,822 - chatbot_rag - INFO - Phản hồi gốc từ LLM API (200 ký tự đầu): <think>
Okay, let me try to figure this out. The user provided a history of messages where they just said "xin chào" (hello) multiple times and asked "mày là ai" (who are you). Now, the current questi
2025-05-18 20:05:28,823 - chatbot_rag - INFO - Đã lưu phản hồi đầy đủ vào file: data/logs/llm_response_20250518_200528.txt
2025-05-18 20:05:28,825 - chatbot_rag - INFO - [analysis_20250518_200528] Đã ghi phản hồi gốc vào: data/logs/analysis_20250518_200528_raw.txt
2025-05-18 20:05:28,826 - chatbot_rag - INFO - [analysis_20250518_200528] Phản hồi gốc: <think>
Okay, let me try to figure this out. The user provided a history of messages where they just...
2025-05-18 20:05:28,826 - chatbot_rag - WARNING - [analysis_20250518_200528] Phát hiện thẻ <think> trong phản hồi. Xử lý đặc biệt...
2025-05-18 20:05:28,827 - chatbot_rag - INFO - [analysis_20250518_200528] BƯỚC 1: Thử parse toàn bộ chuỗi phản hồi
2025-05-18 20:05:28,827 - chatbot_rag - INFO - [analysis_20250518_200528] BƯỚC 1: Không phải JSON hợp lệ: Expecting value: line 1 column 1 (char 0)
2025-05-18 20:05:28,828 - chatbot_rag - INFO - [analysis_20250518_200528] BƯỚC 2: Tìm JSON trong chuỗi phản hồi
2025-05-18 20:05:28,828 - chatbot_rag - WARNING - [analysis_20250518_200528] BƯỚC 2: Không tìm thấy mẫu JSON nào trong phản hồi
2025-05-18 20:05:28,829 - chatbot_rag - INFO - [analysis_20250518_200528] BƯỚC 3: Xử lý chuỗi thủ công để trích xuất thông tin
2025-05-18 20:05:28,838 - department_info_tool - INFO - Đã tải 11 phòng ban
2025-05-18 20:05:28,839 - department_info_tool - INFO - Đã lấy danh sách 11 phòng ban
2025-05-18 20:05:28,841 - chatbot_rag - ERROR - [analysis_20250518_200528] BƯỚC 3: Lỗi khi xử lý chuỗi thủ công: local variable 'query_type' referenced before assignment
2025-05-18 20:05:28,842 - chatbot_rag - WARNING - [analysis_20250518_200528] Tất cả phương pháp phân tích đều thất bại, trả về kết quả mặc định
2025-05-18 20:05:28,842 - websocket_server - INFO - Lấy phân tích cho câu hỏi chung
2025-05-18 20:05:28,842 - chatbot_rag - INFO - Xử lý câu hỏi chung cho session_id: 4e3c4b1b-6071-43f1-a543-4d5ebdb161c3
2025-05-18 20:05:28,845 - department_info_tool - INFO - Đã tải 11 phòng ban
2025-05-18 20:05:28,845 - department_info_tool - INFO - Đã lấy danh sách 11 phòng ban
2025-05-18 20:05:28,846 - chatbot_rag - INFO - Gọi LLM để trả lời câu hỏi chung cho session_id: 4e3c4b1b-6071-43f1-a543-4d5ebdb161c3
2025-05-18 20:05:28,847 - chatbot_rag - INFO - Đã lưu prompt vào file: data/logs/prompt_general_20250518_200528.txt
2025-05-18 20:05:28,847 - chatbot_rag - INFO - Kích thước prompt: 1022 ký tự
2025-05-18 20:05:28,848 - chatbot_rag - INFO - Kích thước system prompt: 916 ký tự
2025-05-18 20:05:28,848 - chatbot_rag - INFO - Tổng kích thước: 1938 ký tự
2025-05-18 20:05:28,850 - chatbot_rag - INFO - Đã lưu full prompt vào file: data/logs/llm_full_prompt_20250518_200528.txt
2025-05-18 20:05:28,850 - chatbot_rag - INFO - System prompt: 
Bạn là trợ lý AI chuyên về quy trình và giai đoạn trong công ty.

DANH SÁCH PHÒNG BAN:
- 2D
- Dự toán
- Khách hàng
- Kinh doanh
- Kế toán
- Marketing
- Mua hàng
- Team dự án
- Thi công
- Thiết kế
- Đ...
2025-05-18 20:05:28,851 - chatbot_rag - INFO - User prompt: 
Câu hỏi: " /think"

Đây là câu hỏi chung về quy trình hoặc giai đoạn làm việc.

Thông tin cơ bản:
### Thông tin tổng quan về quy trình và giai đoạn

#### Giai đoạn chính trong quy trình:
1. **MKT-SAL...
2025-05-18 20:05:28,851 - chatbot_rag - INFO - Gửi truy vấn đến LLM API tại http://192.168.1.4:1234/v1/chat/completions với stream=True
2025-05-18 20:05:56,527 - chatbot_rag - INFO - Mã phản hồi từ API: 200
2025-05-18 20:05:56,528 - chatbot_rag - INFO - Phản hồi gốc từ LLM API (200 ký tự đầu): <think>
Okay, let's see. The user provided a query that's a general question about the process or stages of work. They mentioned the main stages: MKT-SALES, PROPOSAL, CONSTRUCTION, DEFECT-HANDOVER, AF
2025-05-18 20:05:56,530 - chatbot_rag - INFO - Đã lưu phản hồi đầy đủ vào file: data/logs/llm_response_20250518_200556.txt
2025-05-18 20:05:56,548 - websocket_server - INFO - Đã trích xuất thinking (1123 ký tự) và còn lại 328 ký tự phản hồi
2025-05-18 20:05:56,548 - websocket_server - INFO - Phần nội dung còn lại bắt đầu bằng: 🌟 *Câu hỏi chung? Không sao đâu!* 😎  
*Đừng lo, mì...
2025-05-18 20:05:56,548 - websocket_server - INFO - Đã trích xuất phần thinking (1123 ký tự) từ phản hồi handle_general_query
2025-05-18 20:05:56,549 - websocket_server - INFO - Gửi phản hồi thinking với request_id: thinking_1747573507287_4w2bk6z
2025-05-18 20:05:56,549 - websocket_server - INFO - Đã gửi nội dung thinking (1123 ký tự)
2025-05-18 20:06:29,276 - websocket_server - INFO - Nhận tin nhắn dạng JSON: {"content":"xin chào /no_think","session_id":"4e3c4b1b-6071-43f1-a543-4d5ebdb161c3","mode":"basic","
2025-05-18 20:06:29,278 - websocket_server - INFO - Session ID từ client (sau khi kiểm tra): 4e3c4b1b-6071-43f1-a543-4d5ebdb161c3
2025-05-18 20:06:29,278 - websocket_server - INFO - Tắt chế độ thinking cho câu hỏi: xin chào /no_think...
2025-05-18 20:06:29,292 - websocket_server - INFO - Nhận tin nhắn thông thường: xin chào /no_think, enable_thinking=False, mode=basic
2025-05-18 20:06:29,293 - websocket_server - INFO - Chế độ Basic được kích hoạt với prompt: Bạn là một trợ lý AI hữu ích và thông minh. Hãy trả lời câu hỏi của người dùng một cách chi tiết và ...
2025-05-18 20:06:29,293 - websocket_server - INFO - Xử lý streaming response cho: 'xin chào /no_think', phòng ban: None, session_id: 4e3c4b1b-6071-43f1-a543-4d5ebdb161c3, mode: basic
2025-05-18 20:06:29,293 - websocket_server - INFO - Session ID nhận được: 4e3c4b1b-6071-43f1-a543-4d5ebdb161c3
2025-05-18 20:06:29,294 - websocket_server - INFO - Phát hiện lệnh /no_think, tắt chế độ thinking cho: xin chào
2025-05-18 20:06:29,294 - websocket_server - INFO - Xử lý streaming response. Query: 'xin chào', Mode: basic, Thinking: False
2025-05-18 20:06:29,295 - websocket_server - INFO - Chế độ Basic được kích hoạt với prompt: Bạn là một trợ lý AI hữu ích và thông minh. Hãy trả lời câu hỏi của người dùng một cách chi tiết và ...
2025-05-18 20:06:29,295 - websocket_server - INFO - Đã thêm 3 tin nhắn gần nhất vào prompt
2025-05-18 20:06:29,296 - websocket_server - INFO - Đã lưu lịch sử tin nhắn và prompt vào file: data/logs/history_prompt_20250518_200629.txt
2025-05-18 20:06:29,297 - websocket_server - INFO - Kích thước prompt: 91 ký tự
2025-05-18 20:06:29,297 - websocket_server - INFO - Kích thước system prompt: 174 ký tự
2025-05-18 20:06:29,298 - websocket_server - INFO - Tổng kích thước: 265 ký tự
2025-05-18 20:06:29,298 - websocket_server - INFO - Bắt đầu gọi LLM API (lần thử 1/3)
2025-05-18 20:06:41,777 - websocket_server - INFO - API trả về status 200 OK
2025-05-18 20:06:41,778 - websocket_server - INFO - Streaming hoàn tất thành công
2025-05-18 20:06:41,779 - websocket_server - INFO - Gửi phản hồi cuối cùng, chế độ basic, thinking_enabled: False, thinking_collected: False
2025-05-18 20:06:41,780 - websocket_server - INFO - Lưu hội thoại basic mode vào lịch sử với session_id=4e3c4b1b-6071-43f1-a543-4d5ebdb161c3
2025-05-18 20:07:09,262 - websockets.server - INFO - connection open
2025-05-18 20:07:09,282 - websockets.server - INFO - connection open
2025-05-18 20:07:32,807 - websockets.server - INFO - connection open
2025-05-18 20:08:39,387 - websocket_server - INFO - Nhận tin nhắn dạng JSON: {"content":"chào mày /no_think","session_id":"81024cdc-6ee1-4e5a-b07d-d73db4f11a0a","mode":"basic","
2025-05-18 20:08:39,400 - websocket_server - INFO - Session ID từ client (sau khi kiểm tra): 81024cdc-6ee1-4e5a-b07d-d73db4f11a0a
2025-05-18 20:08:39,406 - websocket_server - INFO - Tắt chế độ thinking cho câu hỏi: chào mày /no_think...
2025-05-18 20:08:39,407 - websocket_server - INFO - Nhận tin nhắn thông thường: chào mày /no_think, enable_thinking=False, mode=basic
2025-05-18 20:08:39,408 - websocket_server - INFO - Chế độ Basic được kích hoạt với prompt: Bạn là một trợ lý AI hữu ích và thông minh. Hãy trả lời câu hỏi của người dùng một cách chi tiết và ...
2025-05-18 20:08:39,409 - websocket_server - INFO - Xử lý streaming response cho: 'chào mày /no_think', phòng ban: None, session_id: 81024cdc-6ee1-4e5a-b07d-d73db4f11a0a, mode: basic
2025-05-18 20:08:39,410 - websocket_server - INFO - Session ID nhận được: 81024cdc-6ee1-4e5a-b07d-d73db4f11a0a
2025-05-18 20:08:39,411 - websocket_server - INFO - Phát hiện lệnh /no_think, tắt chế độ thinking cho: chào mày
2025-05-18 20:08:39,421 - websocket_server - INFO - Xử lý streaming response. Query: 'chào mày', Mode: basic, Thinking: False
2025-05-18 20:08:39,422 - websocket_server - INFO - Chế độ Basic được kích hoạt với prompt: Bạn là một trợ lý AI hữu ích và thông minh. Hãy trả lời câu hỏi của người dùng một cách chi tiết và ...
2025-05-18 20:08:39,425 - websocket_server - INFO - Không có lịch sử tin nhắn cho phiên này
2025-05-18 20:08:39,427 - websocket_server - INFO - Kích thước prompt: 8 ký tự
2025-05-18 20:08:39,429 - websocket_server - INFO - Kích thước system prompt: 174 ký tự
2025-05-18 20:08:39,430 - websocket_server - INFO - Tổng kích thước: 182 ký tự
2025-05-18 20:08:39,430 - websocket_server - INFO - Bắt đầu gọi LLM API (lần thử 1/3)
2025-05-18 20:08:44,852 - websocket_server - INFO - API trả về status 200 OK
2025-05-18 20:08:44,855 - websocket_server - INFO - Streaming hoàn tất thành công
2025-05-18 20:08:44,857 - websocket_server - INFO - Gửi phản hồi cuối cùng, chế độ basic, thinking_enabled: False, thinking_collected: False
2025-05-18 20:08:44,859 - websocket_server - INFO - Lưu hội thoại basic mode vào lịch sử với session_id=81024cdc-6ee1-4e5a-b07d-d73db4f11a0a
2025-05-18 20:15:25,138 - websockets.server - INFO - connection open
2025-05-18 20:15:25,251 - websockets.server - INFO - connection open
2025-05-18 20:16:29,673 - websockets.server - INFO - connection open
2025-05-18 20:16:29,741 - websockets.server - INFO - connection open
2025-05-18 20:17:21,474 - websockets.server - INFO - connection open
2025-05-18 20:17:21,508 - websockets.server - INFO - connection open
2025-05-18 20:18:07,177 - websockets.server - INFO - connection open
2025-05-18 20:18:07,198 - websockets.server - INFO - connection open
2025-05-18 20:20:16,301 - websockets.server - INFO - connection closed
2025-05-18 20:20:16,304 - websockets.server - INFO - connection closed
2025-05-18 20:20:16,311 - websockets.server - INFO - connection closed
2025-05-18 20:20:16,311 - websockets.server - INFO - connection closed
2025-05-18 20:20:16,313 - websockets.server - INFO - connection closed
2025-05-18 20:20:16,313 - websockets.server - INFO - connection closed
2025-05-18 20:20:16,313 - websockets.server - INFO - connection closed
2025-05-18 20:20:16,314 - websockets.server - INFO - connection closed
2025-05-18 20:20:16,314 - websockets.server - INFO - connection closed
2025-05-18 20:20:16,314 - websockets.server - INFO - connection closed
2025-05-18 20:20:16,315 - websockets.server - INFO - connection closed
2025-05-18 20:20:16,315 - websockets.server - INFO - connection closed
2025-05-18 20:20:18,236 - websockets.server - INFO - connection open
2025-05-18 20:20:38,209 - websockets.server - INFO - connection open
2025-05-18 20:21:03,893 - websockets.server - INFO - connection open
2025-05-18 20:21:31,808 - websockets.server - INFO - connection open
2025-05-18 20:22:04,762 - websockets.server - INFO - connection open
2025-05-18 20:22:32,632 - websockets.server - INFO - connection open
2025-05-18 20:22:52,279 - websockets.server - INFO - connection open
2025-05-18 20:24:28,340 - websockets.server - INFO - connection closed
2025-05-18 20:24:28,344 - websockets.server - INFO - connection closed
2025-05-18 20:24:28,345 - websockets.server - INFO - connection closed
2025-05-18 20:24:28,345 - websockets.server - INFO - connection closed
2025-05-18 20:24:28,346 - websockets.server - INFO - connection closed
2025-05-18 20:24:28,346 - websockets.server - INFO - connection closed
2025-05-18 20:24:28,346 - websockets.server - INFO - connection closed
2025-05-18 20:24:36,900 - websockets.server - INFO - connection open
2025-05-18 20:26:44,022 - websockets.server - INFO - connection open
2025-05-18 20:26:53,240 - websockets.server - INFO - connection closed
2025-05-18 20:26:53,241 - websockets.server - INFO - connection closed
2025-05-18 20:26:54,658 - websockets.server - INFO - connection open
2025-05-18 20:29:30,574 - websockets.server - INFO - connection open
2025-05-18 20:29:54,882 - websockets.server - INFO - connection open
2025-05-18 20:30:42,242 - websockets.server - INFO - connection open
2025-05-18 20:31:04,403 - websockets.server - INFO - connection open
2025-05-18 20:31:37,826 - websockets.server - INFO - connection open
2025-05-18 20:35:25,716 - websockets.server - INFO - connection open
2025-05-18 20:42:29,588 - websockets.server - INFO - connection open
2025-05-18 20:55:18,432 - websockets.server - INFO - connection open
2025-05-18 20:58:48,319 - websockets.server - INFO - connection open
2025-05-18 21:04:31,270 - websockets.server - INFO - connection open
2025-05-18 21:05:22,630 - websockets.server - INFO - connection open
2025-05-18 21:05:40,385 - websockets.server - INFO - connection open
2025-05-18 21:06:06,276 - websockets.server - INFO - connection open
2025-05-18 21:06:27,074 - websockets.server - INFO - connection open
2025-05-18 21:08:44,064 - websockets.server - INFO - connection open
2025-05-18 21:09:02,498 - websockets.server - INFO - connection open
2025-05-18 21:09:24,009 - websockets.server - INFO - connection open
2025-05-18 21:09:45,999 - websockets.server - INFO - connection open
2025-05-18 21:10:15,799 - websockets.server - INFO - connection open
2025-05-18 21:10:34,998 - websockets.server - INFO - connection open
2025-05-18 21:11:01,374 - websockets.server - INFO - connection open
2025-05-18 21:11:23,260 - websockets.server - INFO - connection open
2025-05-18 21:11:53,006 - websockets.server - INFO - connection open
2025-05-18 21:19:36,966 - websockets.server - INFO - connection closed
2025-05-18 21:19:36,968 - websockets.server - INFO - connection closed
2025-05-18 21:19:36,968 - websockets.server - INFO - connection closed
2025-05-18 21:19:36,968 - websockets.server - INFO - connection closed
2025-05-18 21:19:36,970 - websockets.server - INFO - connection closed
2025-05-18 21:19:36,970 - websockets.server - INFO - connection closed
2025-05-18 21:19:36,971 - websockets.server - INFO - connection closed
2025-05-18 21:19:36,971 - websockets.server - INFO - connection closed
2025-05-18 21:19:36,971 - websockets.server - INFO - connection closed
2025-05-18 21:19:36,972 - websockets.server - INFO - connection closed
2025-05-18 21:19:36,972 - websockets.server - INFO - connection closed
2025-05-18 21:19:36,972 - websockets.server - INFO - connection closed
2025-05-18 21:19:36,973 - websockets.server - INFO - connection closed
2025-05-18 21:19:36,973 - websockets.server - INFO - connection closed
2025-05-18 21:19:36,973 - websockets.server - INFO - connection closed
2025-05-18 21:19:36,974 - websockets.server - INFO - connection closed
2025-05-18 21:19:36,974 - websockets.server - INFO - connection closed
2025-05-18 21:19:36,974 - websockets.server - INFO - connection closed
2025-05-18 21:19:36,975 - websockets.server - INFO - connection closed
2025-05-18 21:19:36,975 - websockets.server - INFO - connection closed
2025-05-18 21:19:36,975 - websockets.server - INFO - connection closed
2025-05-18 21:19:36,978 - websockets.server - INFO - connection closed
2025-05-18 21:19:36,979 - websockets.server - INFO - connection closed
2025-05-18 21:19:36,979 - websockets.server - INFO - connection closed
2025-05-18 21:19:36,984 - websockets.server - INFO - server closing
2025-05-18 21:19:36,986 - websockets.server - INFO - server closed
2025-05-18 21:19:37,011 - websocket_server - INFO - Server bị dừng bởi người dùng
2025-05-18 21:19:39,521 - websocket_server - INFO - Khởi động server WebSocket tại 0.0.0.0:8090
2025-05-18 21:19:39,549 - websockets.server - INFO - server listening on 0.0.0.0:8090
2025-05-18 21:19:39,549 - websocket_server - INFO - Server WebSocket đang chạy tại ws://0.0.0.0:8090
2025-05-18 21:19:39,550 - websocket_server - INFO - Đã cấu hình ping_timeout=6000 giây, ping_interval=60 giây
2025-05-18 21:19:59,371 - websockets.server - INFO - connection open
2025-05-18 21:20:07,713 - websocket_server - INFO - Nhận tin nhắn dạng JSON: {"content":"chào mày /no_think","session_id":"273c7f89-714d-440a-841d-c86c21de1269","mode":"basic","
2025-05-18 21:20:07,714 - websocket_server - INFO - Session ID từ client (sau khi kiểm tra): 273c7f89-714d-440a-841d-c86c21de1269
2025-05-18 21:20:07,714 - websocket_server - INFO - Tắt chế độ thinking cho câu hỏi: chào mày /no_think...
2025-05-18 21:20:07,715 - websocket_server - INFO - Cập nhật chế độ của session 273c7f89-714d-440a-841d-c86c21de1269 từ workflow thành basic
2025-05-18 21:20:07,715 - websocket_server - INFO - Nhận tin nhắn thông thường: chào mày /no_think, enable_thinking=False, mode=basic
2025-05-18 21:20:07,715 - websocket_server - INFO - Chế độ Basic được kích hoạt với prompt: Bạn là một trợ lý AI hữu ích và thông minh. Hãy trả lời câu hỏi của người dùng một cách chi tiết và ...
2025-05-18 21:20:07,716 - websocket_server - INFO - Xử lý streaming response cho: 'chào mày /no_think', phòng ban: None, session_id: 273c7f89-714d-440a-841d-c86c21de1269, mode: basic
2025-05-18 21:20:07,716 - websocket_server - INFO - Session ID nhận được: 273c7f89-714d-440a-841d-c86c21de1269
2025-05-18 21:20:07,717 - websocket_server - INFO - Phát hiện lệnh /no_think, tắt chế độ thinking cho: chào mày
2025-05-18 21:20:07,717 - websocket_server - INFO - Xử lý streaming response. Query: 'chào mày', Mode: basic, Thinking: False
2025-05-18 21:20:07,717 - websocket_server - INFO - Chế độ Basic được kích hoạt với prompt: Bạn là một trợ lý AI hữu ích và thông minh. Hãy trả lời câu hỏi của người dùng một cách chi tiết và ...
2025-05-18 21:20:07,718 - websocket_server - INFO - Không có lịch sử tin nhắn cho phiên này
2025-05-18 21:20:07,718 - websocket_server - INFO - Kích thước prompt: 8 ký tự
2025-05-18 21:20:07,718 - websocket_server - INFO - Kích thước system prompt: 174 ký tự
2025-05-18 21:20:07,719 - websocket_server - INFO - Tổng kích thước: 182 ký tự
2025-05-18 21:20:07,719 - websocket_server - INFO - Bắt đầu gọi LLM API (lần thử 1/3)
2025-05-18 21:20:13,344 - websocket_server - INFO - API trả về status 200 OK
2025-05-18 21:20:13,345 - websocket_server - INFO - Streaming hoàn tất thành công
2025-05-18 21:20:13,346 - websocket_server - INFO - Gửi phản hồi cuối cùng, chế độ basic, thinking_enabled: False, thinking_collected: False
2025-05-18 21:20:13,347 - websocket_server - INFO - Lưu hội thoại basic mode vào lịch sử với session_id=273c7f89-714d-440a-841d-c86c21de1269
2025-05-18 21:20:13,347 - websocket_server - INFO - Cập nhật chế độ của session 273c7f89-714d-440a-841d-c86c21de1269 thành basic
2025-05-18 21:21:54,486 - websocket_server - INFO - Nhận tin nhắn dạng JSON: {"content":"chào mày /no_think","session_id":"b63c05c6-4ded-416a-a0d1-e39b50024ddf","mode":"basic","
2025-05-18 21:21:54,488 - websocket_server - INFO - Session ID từ client (sau khi kiểm tra): b63c05c6-4ded-416a-a0d1-e39b50024ddf
2025-05-18 21:21:54,489 - websocket_server - INFO - Tắt chế độ thinking cho câu hỏi: chào mày /no_think...
2025-05-18 21:21:54,489 - websocket_server - INFO - Cập nhật chế độ của session b63c05c6-4ded-416a-a0d1-e39b50024ddf từ workflow thành basic
2025-05-18 21:21:54,490 - websocket_server - INFO - Nhận tin nhắn thông thường: chào mày /no_think, enable_thinking=False, mode=basic
2025-05-18 21:21:54,490 - websocket_server - INFO - Chế độ Basic được kích hoạt với prompt: Bạn là một trợ lý AI hữu ích và thông minh. Hãy trả lời câu hỏi của người dùng một cách chi tiết và ...
2025-05-18 21:21:54,491 - websocket_server - INFO - Xử lý streaming response cho: 'chào mày /no_think', phòng ban: None, session_id: b63c05c6-4ded-416a-a0d1-e39b50024ddf, mode: basic
2025-05-18 21:21:54,492 - websocket_server - INFO - Session ID nhận được: b63c05c6-4ded-416a-a0d1-e39b50024ddf
2025-05-18 21:21:54,492 - websocket_server - INFO - Phát hiện lệnh /no_think, tắt chế độ thinking cho: chào mày
2025-05-18 21:21:54,493 - websocket_server - INFO - Xử lý streaming response. Query: 'chào mày', Mode: basic, Thinking: False
2025-05-18 21:21:54,493 - websocket_server - INFO - Chế độ Basic được kích hoạt với prompt: Bạn là một trợ lý AI hữu ích và thông minh. Hãy trả lời câu hỏi của người dùng một cách chi tiết và ...
2025-05-18 21:21:54,493 - websocket_server - INFO - Không có lịch sử tin nhắn cho phiên này
2025-05-18 21:21:54,494 - websocket_server - INFO - Kích thước prompt: 8 ký tự
2025-05-18 21:21:54,495 - websocket_server - INFO - Kích thước system prompt: 174 ký tự
2025-05-18 21:21:54,495 - websocket_server - INFO - Tổng kích thước: 182 ký tự
2025-05-18 21:21:54,496 - websocket_server - INFO - Bắt đầu gọi LLM API (lần thử 1/3)
2025-05-18 21:22:00,230 - websocket_server - INFO - API trả về status 200 OK
2025-05-18 21:22:00,231 - websocket_server - INFO - Streaming hoàn tất thành công
2025-05-18 21:22:00,231 - websocket_server - INFO - Gửi phản hồi cuối cùng, chế độ basic, thinking_enabled: False, thinking_collected: False
2025-05-18 21:22:00,232 - websocket_server - INFO - Lưu hội thoại basic mode vào lịch sử với session_id=b63c05c6-4ded-416a-a0d1-e39b50024ddf
2025-05-18 21:22:00,232 - websocket_server - INFO - Cập nhật chế độ của session b63c05c6-4ded-416a-a0d1-e39b50024ddf thành basic
2025-05-18 21:25:20,294 - websockets.server - INFO - connection closed
2025-05-18 21:25:21,717 - websockets.server - INFO - connection open
2025-05-18 21:25:26,408 - websocket_server - INFO - Nhận tin nhắn dạng JSON: {"content":"xin chào /no_think","session_id":"aea1cba8-b5bb-47f5-9bf2-413941d3f4a9","mode":"workflow
2025-05-18 21:25:26,410 - websocket_server - INFO - Session ID từ client (sau khi kiểm tra): aea1cba8-b5bb-47f5-9bf2-413941d3f4a9
2025-05-18 21:25:26,411 - websocket_server - INFO - Tắt chế độ thinking cho câu hỏi: xin chào /no_think...
2025-05-18 21:25:26,411 - websocket_server - INFO - Nhận tin nhắn thông thường: xin chào /no_think, enable_thinking=False, mode=workflow
2025-05-18 21:25:26,412 - websocket_server - INFO - Không có lịch sử tin nhắn cho phiên này
2025-05-18 21:25:26,414 - chatbot_rag - INFO - Đang phân tích câu hỏi với LLM: xin chào /no_think, session_id: aea1cba8-b5bb-47f5-9bf2-413941d3f4a9
2025-05-18 21:25:26,494 - chatbot_rag - INFO - [analyze_query_with_llm] Đã lấy được 0 bản ghi lịch sử từ websocket_server cho session aea1cba8-b5bb-47f5-9bf2-413941d3f4a9
2025-05-18 21:25:26,495 - chatbot_rag - INFO - [analyze_query_with_llm] Sử dụng lịch sử hội thoại: 0 bản ghi
2025-05-18 21:25:26,496 - chatbot_rag - INFO - [analyze_query_with_llm] Prompt cuối cùng: Lịch sử tin nhắn:
        
        Câu hỏi người dùng hiện tại: "xin chào /no_think"

        Phân tích câu hỏi và trả về JSON có định dạng:
        {"department": "tên phòng ban hoặc null", "query_ty...
2025-05-18 21:25:26,496 - chatbot_rag - INFO - Kích thước prompt: 599 ký tự
2025-05-18 21:25:26,497 - chatbot_rag - INFO - Kích thước system prompt: 2006 ký tự
2025-05-18 21:25:26,497 - chatbot_rag - INFO - Tổng kích thước: 2605 ký tự
2025-05-18 21:25:26,501 - chatbot_rag - INFO - Đã lưu full prompt vào file: data/logs/llm_full_prompt_20250518_212526.txt
2025-05-18 21:25:26,502 - chatbot_rag - INFO - System prompt: 
        Bạn là trợ lý AI phân tích câu hỏi để xác định:
        1. Phòng ban người dùng đang hỏi (department)
        2. Loại câu hỏi: phòng ban cụ thể hay general (query_type)
        3. Nếu câu hỏi...
2025-05-18 21:25:26,503 - chatbot_rag - INFO - User prompt: Lịch sử tin nhắn:
        
        Câu hỏi người dùng hiện tại: "xin chào /no_think"

        Phân tích câu hỏi và trả về JSON có định dạng:
        {"department": "tên phòng ban hoặc null", "query_ty...
2025-05-18 21:25:26,505 - chatbot_rag - INFO - Gửi truy vấn đến LLM API tại http://192.168.1.4:1234/v1/chat/completions với stream=False
2025-05-18 21:25:37,993 - chatbot_rag - INFO - Mã phản hồi từ API: 200
2025-05-18 21:25:37,994 - chatbot_rag - INFO - Phản hồi gốc từ LLM API (200 ký tự đầu): <think>

</think>

{"department": null, "query_type": "general", "error": false}
2025-05-18 21:25:37,995 - chatbot_rag - INFO - Đã lưu phản hồi đầy đủ vào file: data/logs/llm_response_20250518_212537.txt
2025-05-18 21:25:37,996 - chatbot_rag - INFO - [analysis_20250518_212537] Đã ghi phản hồi gốc vào: data/logs/analysis_20250518_212537_raw.txt
2025-05-18 21:25:37,996 - chatbot_rag - INFO - [analysis_20250518_212537] Phản hồi gốc: <think>

</think>

{"department": null, "query_type": "general", "error": false}...
2025-05-18 21:25:37,997 - chatbot_rag - WARNING - [analysis_20250518_212537] Phát hiện thẻ <think> trong phản hồi. Xử lý đặc biệt...
2025-05-18 21:25:38,000 - chatbot_rag - INFO - [analysis_20250518_212537] Đã tìm thấy 1 mẫu JSON tiềm năng trong phản hồi
2025-05-18 21:25:38,000 - chatbot_rag - INFO - [analysis_20250518_212537] Tìm thấy JSON hợp lệ trong thẻ <think>: {'department': None, 'query_type': 'general', 'error': False}
2025-05-18 21:25:38,001 - websocket_server - INFO - Phân tích câu hỏi: Phòng ban=None, Loại=general, Thinking=False
2025-05-18 21:25:38,001 - websocket_server - INFO - Xử lý streaming response cho: 'xin chào /no_think', phòng ban: None, session_id: aea1cba8-b5bb-47f5-9bf2-413941d3f4a9, mode: workflow
2025-05-18 21:25:38,002 - websocket_server - INFO - Session ID nhận được: aea1cba8-b5bb-47f5-9bf2-413941d3f4a9
2025-05-18 21:25:38,002 - websocket_server - INFO - Phát hiện lệnh /no_think, tắt chế độ thinking cho: xin chào
2025-05-18 21:25:38,002 - websocket_server - INFO - Xử lý streaming response. Query: 'xin chào', Mode: workflow, Thinking: False
2025-05-18 21:25:38,002 - websocket_server - INFO - Không có lịch sử tin nhắn cho phiên này
2025-05-18 21:25:38,003 - chatbot_rag - INFO - Đang phân tích câu hỏi với LLM: xin chào, session_id: aea1cba8-b5bb-47f5-9bf2-413941d3f4a9
2025-05-18 21:25:38,003 - chatbot_rag - INFO - [analyze_query_with_llm] Đã lấy được 0 bản ghi lịch sử từ websocket_server cho session aea1cba8-b5bb-47f5-9bf2-413941d3f4a9
2025-05-18 21:25:38,004 - chatbot_rag - INFO - [analyze_query_with_llm] Sử dụng lịch sử hội thoại: 0 bản ghi
2025-05-18 21:25:38,004 - chatbot_rag - INFO - [analyze_query_with_llm] Prompt cuối cùng: Lịch sử tin nhắn:
        
        Câu hỏi người dùng hiện tại: "xin chào"

        Phân tích câu hỏi và trả về JSON có định dạng:
        {"department": "tên phòng ban hoặc null", "query_type": "depa...
2025-05-18 21:25:38,004 - chatbot_rag - INFO - Kích thước prompt: 589 ký tự
2025-05-18 21:25:38,005 - chatbot_rag - INFO - Kích thước system prompt: 2006 ký tự
2025-05-18 21:25:38,005 - chatbot_rag - INFO - Tổng kích thước: 2595 ký tự
2025-05-18 21:25:38,007 - chatbot_rag - INFO - Đã lưu full prompt vào file: data/logs/llm_full_prompt_20250518_212538.txt
2025-05-18 21:25:38,007 - chatbot_rag - INFO - System prompt: 
        Bạn là trợ lý AI phân tích câu hỏi để xác định:
        1. Phòng ban người dùng đang hỏi (department)
        2. Loại câu hỏi: phòng ban cụ thể hay general (query_type)
        3. Nếu câu hỏi...
2025-05-18 21:25:38,007 - chatbot_rag - INFO - User prompt: Lịch sử tin nhắn:
        
        Câu hỏi người dùng hiện tại: "xin chào"

        Phân tích câu hỏi và trả về JSON có định dạng:
        {"department": "tên phòng ban hoặc null", "query_type": "depa...
2025-05-18 21:25:38,008 - chatbot_rag - INFO - Gửi truy vấn đến LLM API tại http://192.168.1.4:1234/v1/chat/completions với stream=False
2025-05-18 21:25:47,461 - chatbot_rag - INFO - Mã phản hồi từ API: 200
2025-05-18 21:25:47,462 - chatbot_rag - INFO - Phản hồi gốc từ LLM API (200 ký tự đầu): <think>
Okay, let's break this down. The user sent "xin chào", which is a greeting in Vietnamese. The history doesn't mention any department or specific process. According to the rules, if there's no 
2025-05-18 21:25:47,464 - chatbot_rag - INFO - Đã lưu phản hồi đầy đủ vào file: data/logs/llm_response_20250518_212547.txt
2025-05-18 21:25:47,485 - chatbot_rag - INFO - [analysis_20250518_212547] Đã ghi phản hồi gốc vào: data/logs/analysis_20250518_212547_raw.txt
2025-05-18 21:25:47,486 - chatbot_rag - INFO - [analysis_20250518_212547] Phản hồi gốc: <think>
Okay, let's break this down. The user sent "xin chào", which is a greeting in Vietnamese. Th...
2025-05-18 21:25:47,504 - chatbot_rag - WARNING - [analysis_20250518_212547] Phát hiện thẻ <think> trong phản hồi. Xử lý đặc biệt...
2025-05-18 21:25:47,504 - chatbot_rag - INFO - [analysis_20250518_212547] Đã tìm thấy 2 mẫu JSON tiềm năng trong phản hồi
2025-05-18 21:25:47,504 - chatbot_rag - INFO - [analysis_20250518_212547] Tìm thấy JSON hợp lệ trong thẻ <think>: {'department': None, 'query_type': 'general', 'error': False}
2025-05-18 21:25:47,505 - websocket_server - INFO - THÔNG TIN XỬ LÝ TIN NHẮN:
2025-05-18 21:25:47,505 - websocket_server - INFO - - Chế độ: workflow
2025-05-18 21:25:47,505 - websocket_server - INFO - - Session ID: aea1cba8-b5bb-47f5-9bf2-413941d3f4a9
2025-05-18 21:25:47,505 - websocket_server - INFO - - Trạng thái thinking: False
2025-05-18 21:25:47,506 - websocket_server - INFO - - Query chính: 'xin chào'
2025-05-18 21:25:47,506 - websocket_server - INFO - - Query gửi đến model: 'xin chào /no_think'
2025-05-18 21:25:47,506 - websocket_server - INFO - - Phòng ban phát hiện: None
2025-05-18 21:25:47,522 - websocket_server - INFO - - Loại query: general
2025-05-18 21:25:47,523 - websocket_server - INFO - Phân tích câu hỏi: Phòng ban=None, Loại=general, Thinking=False
2025-05-18 21:25:47,531 - websocket_server - INFO - Câu hỏi chung, chế độ thinking: False
2025-05-18 21:25:47,554 - chatbot_rag - INFO - Xử lý câu hỏi chung cho session_id: aea1cba8-b5bb-47f5-9bf2-413941d3f4a9
2025-05-18 21:25:47,594 - department_info_tool - INFO - Đã tải 11 phòng ban
2025-05-18 21:25:47,595 - department_info_tool - INFO - Đã lấy danh sách 11 phòng ban
2025-05-18 21:25:47,597 - chatbot_rag - INFO - Gọi LLM để trả lời câu hỏi chung cho session_id: aea1cba8-b5bb-47f5-9bf2-413941d3f4a9
2025-05-18 21:25:47,599 - chatbot_rag - INFO - Đã lưu prompt vào file: data/logs/prompt_general_20250518_212547.txt
2025-05-18 21:25:47,600 - chatbot_rag - INFO - Kích thước prompt: 1033 ký tự
2025-05-18 21:25:47,600 - chatbot_rag - INFO - Kích thước system prompt: 916 ký tự
2025-05-18 21:25:47,601 - chatbot_rag - INFO - Tổng kích thước: 1949 ký tự
2025-05-18 21:25:47,603 - chatbot_rag - INFO - Đã lưu full prompt vào file: data/logs/llm_full_prompt_20250518_212547.txt
2025-05-18 21:25:47,603 - chatbot_rag - INFO - System prompt: 
Bạn là trợ lý AI chuyên về quy trình và giai đoạn trong công ty.

DANH SÁCH PHÒNG BAN:
- 2D
- Dự toán
- Khách hàng
- Kinh doanh
- Kế toán
- Marketing
- Mua hàng
- Team dự án
- Thi công
- Thiết kế
- Đ...
2025-05-18 21:25:47,604 - chatbot_rag - INFO - User prompt: 
Câu hỏi: "xin chào /no_think"

Đây là câu hỏi chung về quy trình hoặc giai đoạn làm việc.

Thông tin cơ bản:
### Thông tin tổng quan về quy trình và giai đoạn

#### Giai đoạn chính trong quy trình:
1...
2025-05-18 21:25:47,605 - chatbot_rag - INFO - Gửi truy vấn đến LLM API tại http://192.168.1.4:1234/v1/chat/completions với stream=True
2025-05-18 21:26:04,809 - chatbot_rag - INFO - Mã phản hồi từ API: 200
2025-05-18 21:26:04,812 - chatbot_rag - INFO - Phản hồi gốc từ LLM API (200 ký tự đầu): <think>

</think>

 Xin chào!👋✨  
Chào mừng bạn đến với quy trình làm việc của chúng tôi! 🚀  
Nếu bạn có thắc mắc về giai đoạn hay phòng ban nào đó, cứ hỏi nhé!  
Ví dụ: "Phòng Marketing tham gia giai
2025-05-18 21:26:04,813 - chatbot_rag - INFO - Đã lưu phản hồi đầy đủ vào file: data/logs/llm_response_20250518_212604.txt
2025-05-18 21:26:05,204 - websocket_server - INFO - Đã trích xuất thinking (0 ký tự) và còn lại 439 ký tự phản hồi
2025-05-18 21:26:05,204 - websocket_server - INFO - Phần nội dung còn lại bắt đầu bằng: Xin chào!👋✨  
Chào mừng bạn đến với quy trình làm ...
2025-05-18 21:26:05,204 - websocket_server - INFO - enable_thinking=False, bỏ qua nội dung thinking
2025-05-18 21:26:05,205 - websocket_server - INFO - Đã lưu hội thoại chung vào lịch sử của session aea1cba8-b5bb-47f5-9bf2-413941d3f4a9
2025-05-18 21:26:05,205 - websocket_server - INFO - Cập nhật chế độ của session aea1cba8-b5bb-47f5-9bf2-413941d3f4a9 thành workflow
2025-05-18 21:26:05,207 - websocket_server - INFO - WebSocket connection closed
2025-05-18 21:26:05,207 - websockets.server - INFO - connection closed
2025-05-18 21:26:05,208 - websockets.server - INFO - connection open
2025-05-18 21:26:13,326 - websocket_server - INFO - Nhận yêu cầu phân tích (thinking) cho câu hỏi: Xin chào!👋✨  
Chào mừng bạn đến với quy trình làm việc của chúng tôi! 🚀  
Nếu bạn có thắc mắc về gia
2025-05-18 21:26:13,326 - websocket_server - INFO - Đã thêm 1 tin nhắn gần nhất vào prompt
2025-05-18 21:26:13,330 - websocket_server - INFO - Đã lưu lịch sử tin nhắn và prompt vào file: data/logs/history_prompt_20250518_212613.txt
2025-05-18 21:26:13,331 - websocket_server - INFO - Phân tích câu hỏi để xác định phòng ban hoặc loại câu hỏi
2025-05-18 21:26:13,331 - chatbot_rag - INFO - Đang phân tích câu hỏi với LLM: Lịch sử tin nhắn:
Người dùng: xin chào

Xin chào!👋✨  
Chào mừng bạn đến với quy trình làm việc của chúng tôi! 🚀  
Nếu bạn có thắc mắc về giai đoạn hay phòng ban nào đó, cứ hỏi nhé!  
Ví dụ: "Phòng Marketing tham gia giai đoạn nào?" hoặc "Giai đoạn DEFECT-HANDOVER gồm những bước gì?"  

Để biết chi tiết công việc cụ thể, vui lòng hỏi về một phòng ban cụ thể, ví dụ: **"Phòng Kinh doanh làm gì trong giai đoạn MKT-SALES?"** 📌

💡 *Nếu bạn muốn nói chuyện vui vẻ, đừng ngại hỏi! 😄*, session_id: aea1cba8-b5bb-47f5-9bf2-413941d3f4a9
2025-05-18 21:26:13,334 - chatbot_rag - INFO - [analyze_query_with_llm] Đã lấy được 0 bản ghi lịch sử từ websocket_server cho session aea1cba8-b5bb-47f5-9bf2-413941d3f4a9
2025-05-18 21:26:13,334 - chatbot_rag - INFO - [analyze_query_with_llm] Sử dụng lịch sử hội thoại: 0 bản ghi
2025-05-18 21:26:13,336 - chatbot_rag - INFO - [analyze_query_with_llm] Prompt cuối cùng: Lịch sử tin nhắn:
        
        Câu hỏi người dùng hiện tại: "Lịch sử tin nhắn:
Người dùng: xin chào

Xin chào!👋✨  
Chào mừng bạn đến với quy trình làm việc của chúng tôi! 🚀  
Nếu bạn có thắc mắc v...
2025-05-18 21:26:13,338 - chatbot_rag - INFO - Kích thước prompt: 1060 ký tự
2025-05-18 21:26:13,339 - chatbot_rag - INFO - Kích thước system prompt: 2006 ký tự
2025-05-18 21:26:13,339 - chatbot_rag - INFO - Tổng kích thước: 3066 ký tự
2025-05-18 21:26:13,341 - chatbot_rag - INFO - Đã lưu full prompt vào file: data/logs/llm_full_prompt_20250518_212613.txt
2025-05-18 21:26:13,341 - chatbot_rag - INFO - System prompt: 
        Bạn là trợ lý AI phân tích câu hỏi để xác định:
        1. Phòng ban người dùng đang hỏi (department)
        2. Loại câu hỏi: phòng ban cụ thể hay general (query_type)
        3. Nếu câu hỏi...
2025-05-18 21:26:13,342 - chatbot_rag - INFO - User prompt: Lịch sử tin nhắn:
        
        Câu hỏi người dùng hiện tại: "Lịch sử tin nhắn:
Người dùng: xin chào

Xin chào!👋✨  
Chào mừng bạn đến với quy trình làm việc của chúng tôi! 🚀  
Nếu bạn có thắc mắc v...
2025-05-18 21:26:13,342 - chatbot_rag - INFO - Gửi truy vấn đến LLM API tại http://192.168.1.4:1234/v1/chat/completions với stream=False
2025-05-18 21:26:38,349 - chatbot_rag - INFO - Mã phản hồi từ API: 200
2025-05-18 21:26:38,350 - chatbot_rag - INFO - Phản hồi gốc từ LLM API (200 ký tự đầu): <think>
Okay, let's tackle this query. The user provided a history of messages where the assistant greeted them and explained how to ask questions about specific departments or processes. The current 
2025-05-18 21:26:38,353 - chatbot_rag - INFO - Đã lưu phản hồi đầy đủ vào file: data/logs/llm_response_20250518_212638.txt
2025-05-18 21:26:38,356 - chatbot_rag - INFO - [analysis_20250518_212638] Đã ghi phản hồi gốc vào: data/logs/analysis_20250518_212638_raw.txt
2025-05-18 21:26:38,356 - chatbot_rag - INFO - [analysis_20250518_212638] Phản hồi gốc: <think>
Okay, let's tackle this query. The user provided a history of messages where the assistant g...
2025-05-18 21:26:38,357 - chatbot_rag - WARNING - [analysis_20250518_212638] Phát hiện thẻ <think> trong phản hồi. Xử lý đặc biệt...
2025-05-18 21:26:38,358 - chatbot_rag - INFO - [analysis_20250518_212638] BƯỚC 1: Thử parse toàn bộ chuỗi phản hồi
2025-05-18 21:26:38,360 - chatbot_rag - INFO - [analysis_20250518_212638] BƯỚC 1: Không phải JSON hợp lệ: Expecting value: line 1 column 1 (char 0)
2025-05-18 21:26:38,361 - chatbot_rag - INFO - [analysis_20250518_212638] BƯỚC 2: Tìm JSON trong chuỗi phản hồi
2025-05-18 21:26:38,362 - chatbot_rag - WARNING - [analysis_20250518_212638] BƯỚC 2: Không tìm thấy mẫu JSON nào trong phản hồi
2025-05-18 21:26:38,362 - chatbot_rag - INFO - [analysis_20250518_212638] BƯỚC 3: Xử lý chuỗi thủ công để trích xuất thông tin
2025-05-18 21:26:38,374 - department_info_tool - INFO - Đã tải 11 phòng ban
2025-05-18 21:26:38,375 - department_info_tool - INFO - Đã lấy danh sách 11 phòng ban
2025-05-18 21:26:38,377 - chatbot_rag - INFO - [analysis_20250518_212638] BƯỚC 3: Tìm thấy phòng ban trong câu hỏi: Kinh doanh
2025-05-18 21:26:38,377 - chatbot_rag - ERROR - [analysis_20250518_212638] BƯỚC 3: Lỗi khi xử lý chuỗi thủ công: local variable 'query_type' referenced before assignment
2025-05-18 21:26:38,378 - chatbot_rag - WARNING - [analysis_20250518_212638] Tất cả phương pháp phân tích đều thất bại, trả về kết quả mặc định
2025-05-18 21:26:38,379 - websocket_server - INFO - Lấy phân tích cho câu hỏi chung
2025-05-18 21:26:38,379 - chatbot_rag - INFO - Xử lý câu hỏi chung cho session_id: aea1cba8-b5bb-47f5-9bf2-413941d3f4a9
2025-05-18 21:26:38,387 - department_info_tool - INFO - Đã tải 11 phòng ban
2025-05-18 21:26:38,387 - department_info_tool - INFO - Đã lấy danh sách 11 phòng ban
2025-05-18 21:26:38,388 - chatbot_rag - INFO - Gọi LLM để trả lời câu hỏi chung cho session_id: aea1cba8-b5bb-47f5-9bf2-413941d3f4a9
2025-05-18 21:26:38,391 - chatbot_rag - INFO - Đã lưu prompt vào file: data/logs/prompt_general_20250518_212638.txt
2025-05-18 21:26:38,391 - chatbot_rag - INFO - Kích thước prompt: 1461 ký tự
2025-05-18 21:26:38,391 - chatbot_rag - INFO - Kích thước system prompt: 916 ký tự
2025-05-18 21:26:38,392 - chatbot_rag - INFO - Tổng kích thước: 2377 ký tự
2025-05-18 21:26:38,393 - chatbot_rag - INFO - Đã lưu full prompt vào file: data/logs/llm_full_prompt_20250518_212638.txt
2025-05-18 21:26:38,394 - chatbot_rag - INFO - System prompt: 
Bạn là trợ lý AI chuyên về quy trình và giai đoạn trong công ty.

DANH SÁCH PHÒNG BAN:
- 2D
- Dự toán
- Khách hàng
- Kinh doanh
- Kế toán
- Marketing
- Mua hàng
- Team dự án
- Thi công
- Thiết kế
- Đ...
2025-05-18 21:26:38,394 - chatbot_rag - INFO - User prompt: 
Câu hỏi: "Xin chào!👋✨  
Chào mừng bạn đến với quy trình làm việc của chúng tôi! 🚀  
Nếu bạn có thắc mắc về giai đoạn hay phòng ban nào đó, cứ hỏi nhé!  
Ví dụ: "Phòng Marketing tham gia giai đoạn nào...
2025-05-18 21:26:38,395 - chatbot_rag - INFO - Gửi truy vấn đến LLM API tại http://192.168.1.4:1234/v1/chat/completions với stream=True
2025-05-18 21:27:26,024 - chatbot_rag - INFO - Mã phản hồi từ API: 200
2025-05-18 21:27:26,025 - chatbot_rag - INFO - Phản hồi gốc từ LLM API (200 ký tự đầu): <think>
Okay, the user provided a detailed setup about the company's departments and processes. They want me to respond in Vietnamese using Markdown, focusing on structure without explaining specific 
2025-05-18 21:27:26,027 - chatbot_rag - INFO - Đã lưu phản hồi đầy đủ vào file: data/logs/llm_response_20250518_212726.txt
2025-05-18 21:27:26,031 - websocket_server - INFO - Đã trích xuất thinking (1827 ký tự) và còn lại 582 ký tự phản hồi
2025-05-18 21:27:26,032 - websocket_server - INFO - Phần nội dung còn lại bắt đầu bằng: # 📌 Giai đoạn và phòng ban liên quan  

1. **MKT-S...
2025-05-18 21:27:26,032 - websocket_server - INFO - Đã trích xuất phần thinking (1827 ký tự) từ phản hồi handle_general_query
2025-05-18 21:27:26,033 - websocket_server - INFO - Gửi phản hồi thinking với request_id: thinking_1747578373325_x1ged8h
2025-05-18 21:27:26,034 - websocket_server - INFO - Đã gửi nội dung thinking (1827 ký tự)
2025-05-18 21:27:26,035 - websocket_server - INFO - Nhận tin nhắn dạng JSON: {"content":"xin chào /no_think","session_id":"aea1cba8-b5bb-47f5-9bf2-413941d3f4a9","mode":"basic","
2025-05-18 21:27:26,036 - websocket_server - INFO - Session ID từ client (sau khi kiểm tra): aea1cba8-b5bb-47f5-9bf2-413941d3f4a9
2025-05-18 21:27:26,037 - websocket_server - INFO - Tắt chế độ thinking cho câu hỏi: xin chào /no_think...
2025-05-18 21:27:26,037 - websocket_server - INFO - Cập nhật chế độ của session aea1cba8-b5bb-47f5-9bf2-413941d3f4a9 từ workflow thành basic
2025-05-18 21:27:26,037 - websocket_server - INFO - Nhận tin nhắn thông thường: xin chào /no_think, enable_thinking=False, mode=basic
2025-05-18 21:27:26,038 - websocket_server - INFO - Chế độ Basic được kích hoạt với prompt: Bạn là một trợ lý AI hữu ích và thông minh. Hãy trả lời câu hỏi của người dùng một cách chi tiết và ...
2025-05-18 21:27:26,038 - websocket_server - INFO - Xử lý streaming response cho: 'xin chào /no_think', phòng ban: None, session_id: aea1cba8-b5bb-47f5-9bf2-413941d3f4a9, mode: basic
2025-05-18 21:27:26,038 - websocket_server - INFO - Session ID nhận được: aea1cba8-b5bb-47f5-9bf2-413941d3f4a9
2025-05-18 21:27:26,040 - websocket_server - INFO - Phát hiện lệnh /no_think, tắt chế độ thinking cho: xin chào
2025-05-18 21:27:26,040 - websocket_server - INFO - Xử lý streaming response. Query: 'xin chào', Mode: basic, Thinking: False
2025-05-18 21:27:26,041 - websocket_server - INFO - Chế độ Basic được kích hoạt với prompt: Bạn là một trợ lý AI hữu ích và thông minh. Hãy trả lời câu hỏi của người dùng một cách chi tiết và ...
2025-05-18 21:27:26,041 - websocket_server - INFO - Đã thêm 1 tin nhắn gần nhất vào prompt
2025-05-18 21:27:26,042 - websocket_server - INFO - Đã lưu lịch sử tin nhắn và prompt vào file: data/logs/history_prompt_20250518_212726.txt
2025-05-18 21:27:26,043 - websocket_server - INFO - Kích thước prompt: 48 ký tự
2025-05-18 21:27:26,043 - websocket_server - INFO - Kích thước system prompt: 174 ký tự
2025-05-18 21:27:26,044 - websocket_server - INFO - Tổng kích thước: 222 ký tự
2025-05-18 21:27:26,044 - websocket_server - INFO - Bắt đầu gọi LLM API (lần thử 1/3)
2025-05-18 21:27:31,446 - websocket_server - INFO - API trả về status 200 OK
2025-05-18 21:27:31,447 - websocket_server - INFO - Streaming hoàn tất thành công
2025-05-18 21:27:31,448 - websocket_server - INFO - Gửi phản hồi cuối cùng, chế độ basic, thinking_enabled: False, thinking_collected: False
2025-05-18 21:27:31,449 - websocket_server - INFO - Lưu hội thoại basic mode vào lịch sử với session_id=aea1cba8-b5bb-47f5-9bf2-413941d3f4a9
2025-05-18 21:27:31,449 - websocket_server - INFO - Cập nhật chế độ của session aea1cba8-b5bb-47f5-9bf2-413941d3f4a9 thành basic
2025-05-18 21:27:45,740 - websocket_server - INFO - Nhận yêu cầu phân tích (thinking) cho câu hỏi: 
2025-05-18 21:27:45,741 - websocket_server - INFO - Không có lịch sử tin nhắn cho phiên này
2025-05-18 21:27:45,742 - websocket_server - INFO - Phân tích câu hỏi để xác định phòng ban hoặc loại câu hỏi
2025-05-18 21:27:45,743 - chatbot_rag - INFO - Đang phân tích câu hỏi với LLM: , session_id: 03210ac7-0b45-4d51-a671-b26baddc72c2
2025-05-18 21:27:45,744 - chatbot_rag - INFO - [analyze_query_with_llm] Đã lấy được 0 bản ghi lịch sử từ websocket_server cho session 03210ac7-0b45-4d51-a671-b26baddc72c2
2025-05-18 21:27:45,744 - chatbot_rag - INFO - [analyze_query_with_llm] Sử dụng lịch sử hội thoại: 0 bản ghi
2025-05-18 21:27:45,745 - chatbot_rag - INFO - [analyze_query_with_llm] Prompt cuối cùng: Lịch sử tin nhắn:
        
        Câu hỏi người dùng hiện tại: ""

        Phân tích câu hỏi và trả về JSON có định dạng:
        {"department": "tên phòng ban hoặc null", "query_type": "department_s...
2025-05-18 21:27:45,745 - chatbot_rag - INFO - Kích thước prompt: 581 ký tự
2025-05-18 21:27:45,746 - chatbot_rag - INFO - Kích thước system prompt: 2006 ký tự
2025-05-18 21:27:45,746 - chatbot_rag - INFO - Tổng kích thước: 2587 ký tự
2025-05-18 21:27:45,749 - chatbot_rag - INFO - Đã lưu full prompt vào file: data/logs/llm_full_prompt_20250518_212745.txt
2025-05-18 21:27:45,749 - chatbot_rag - INFO - System prompt: 
        Bạn là trợ lý AI phân tích câu hỏi để xác định:
        1. Phòng ban người dùng đang hỏi (department)
        2. Loại câu hỏi: phòng ban cụ thể hay general (query_type)
        3. Nếu câu hỏi...
2025-05-18 21:27:45,750 - chatbot_rag - INFO - User prompt: Lịch sử tin nhắn:
        
        Câu hỏi người dùng hiện tại: ""

        Phân tích câu hỏi và trả về JSON có định dạng:
        {"department": "tên phòng ban hoặc null", "query_type": "department_s...
2025-05-18 21:27:45,750 - chatbot_rag - INFO - Gửi truy vấn đến LLM API tại http://192.168.1.4:1234/v1/chat/completions với stream=False
2025-05-18 21:28:08,958 - chatbot_rag - INFO - Mã phản hồi từ API: 200
2025-05-18 21:28:08,959 - chatbot_rag - INFO - Phản hồi gốc từ LLM API (200 ký tự đầu): <think>
Okay, let's tackle this. The user provided a query where the current question is an empty string. They want me to analyze it based on the given rules.

First, I need to check if there's any me
2025-05-18 21:28:08,978 - chatbot_rag - INFO - Đã lưu phản hồi đầy đủ vào file: data/logs/llm_response_20250518_212808.txt
2025-05-18 21:28:08,981 - chatbot_rag - INFO - [analysis_20250518_212808] Đã ghi phản hồi gốc vào: data/logs/analysis_20250518_212808_raw.txt
2025-05-18 21:28:08,981 - chatbot_rag - INFO - [analysis_20250518_212808] Phản hồi gốc: <think>
Okay, let's tackle this. The user provided a query where the current question is an empty st...
2025-05-18 21:28:08,982 - chatbot_rag - WARNING - [analysis_20250518_212808] Phát hiện thẻ <think> trong phản hồi. Xử lý đặc biệt...
2025-05-18 21:28:08,982 - chatbot_rag - INFO - [analysis_20250518_212808] BƯỚC 1: Thử parse toàn bộ chuỗi phản hồi
2025-05-18 21:28:08,982 - chatbot_rag - INFO - [analysis_20250518_212808] BƯỚC 1: Không phải JSON hợp lệ: Expecting value: line 1 column 1 (char 0)
2025-05-18 21:28:08,983 - chatbot_rag - INFO - [analysis_20250518_212808] BƯỚC 2: Tìm JSON trong chuỗi phản hồi
2025-05-18 21:28:08,983 - chatbot_rag - WARNING - [analysis_20250518_212808] BƯỚC 2: Không tìm thấy mẫu JSON nào trong phản hồi
2025-05-18 21:28:08,983 - chatbot_rag - INFO - [analysis_20250518_212808] BƯỚC 3: Xử lý chuỗi thủ công để trích xuất thông tin
2025-05-18 21:28:08,989 - department_info_tool - INFO - Đã tải 11 phòng ban
2025-05-18 21:28:08,990 - department_info_tool - INFO - Đã lấy danh sách 11 phòng ban
2025-05-18 21:28:08,997 - chatbot_rag - ERROR - [analysis_20250518_212808] BƯỚC 3: Lỗi khi xử lý chuỗi thủ công: local variable 'query_type' referenced before assignment
2025-05-18 21:28:08,997 - chatbot_rag - WARNING - [analysis_20250518_212808] Tất cả phương pháp phân tích đều thất bại, trả về kết quả mặc định
2025-05-18 21:28:08,998 - websocket_server - INFO - Lấy phân tích cho câu hỏi chung
2025-05-18 21:28:08,998 - chatbot_rag - INFO - Xử lý câu hỏi chung cho session_id: 03210ac7-0b45-4d51-a671-b26baddc72c2
2025-05-18 21:28:09,003 - department_info_tool - INFO - Đã tải 11 phòng ban
2025-05-18 21:28:09,004 - department_info_tool - INFO - Đã lấy danh sách 11 phòng ban
2025-05-18 21:28:09,004 - chatbot_rag - INFO - Gọi LLM để trả lời câu hỏi chung cho session_id: 03210ac7-0b45-4d51-a671-b26baddc72c2
2025-05-18 21:28:09,027 - chatbot_rag - INFO - Đã lưu prompt vào file: data/logs/prompt_general_20250518_212809.txt
2025-05-18 21:28:09,028 - chatbot_rag - INFO - Kích thước prompt: 1022 ký tự
2025-05-18 21:28:09,028 - chatbot_rag - INFO - Kích thước system prompt: 916 ký tự
2025-05-18 21:28:09,029 - chatbot_rag - INFO - Tổng kích thước: 1938 ký tự
2025-05-18 21:28:09,030 - chatbot_rag - INFO - Đã lưu full prompt vào file: data/logs/llm_full_prompt_20250518_212809.txt
2025-05-18 21:28:09,032 - chatbot_rag - INFO - System prompt: 
Bạn là trợ lý AI chuyên về quy trình và giai đoạn trong công ty.

DANH SÁCH PHÒNG BAN:
- 2D
- Dự toán
- Khách hàng
- Kinh doanh
- Kế toán
- Marketing
- Mua hàng
- Team dự án
- Thi công
- Thiết kế
- Đ...
2025-05-18 21:28:09,032 - chatbot_rag - INFO - User prompt: 
Câu hỏi: " /think"

Đây là câu hỏi chung về quy trình hoặc giai đoạn làm việc.

Thông tin cơ bản:
### Thông tin tổng quan về quy trình và giai đoạn

#### Giai đoạn chính trong quy trình:
1. **MKT-SAL...
2025-05-18 21:28:09,033 - chatbot_rag - INFO - Gửi truy vấn đến LLM API tại http://192.168.1.4:1234/v1/chat/completions với stream=True
2025-05-18 21:28:28,569 - chatbot_rag - INFO - Mã phản hồi từ API: 200
2025-05-18 21:28:28,569 - chatbot_rag - INFO - Phản hồi gốc từ LLM API (200 ký tự đầu): <think>
Okay, the user is asking a general question about the process or stages. Let me check if it's related to their work.

The info provided lists main stages and departments. The user's query is j
2025-05-18 21:28:28,571 - chatbot_rag - INFO - Đã lưu phản hồi đầy đủ vào file: data/logs/llm_response_20250518_212828.txt
2025-05-18 21:28:28,578 - websocket_server - INFO - Đã trích xuất thinking (558 ký tự) và còn lại 194 ký tự phản hồi
2025-05-18 21:28:28,579 - websocket_server - INFO - Phần nội dung còn lại bắt đầu bằng: 🤔 *Đang suy ngẫm...*  
Bạn có muốn hỏi gì về quy t...
2025-05-18 21:28:28,579 - websocket_server - INFO - Đã trích xuất phần thinking (558 ký tự) từ phản hồi handle_general_query
2025-05-18 21:28:28,579 - websocket_server - INFO - Gửi phản hồi thinking với request_id: thinking_1747578465739_2fraiv4
2025-05-18 21:28:28,582 - websocket_server - INFO - Đã gửi nội dung thinking (558 ký tự)
2025-05-18 21:29:10,684 - websockets.server - INFO - connection closed
2025-05-18 21:29:10,685 - websockets.server - INFO - server closing
2025-05-18 21:29:10,686 - websockets.server - INFO - server closed
2025-05-18 21:29:10,690 - websocket_server - INFO - Server bị dừng bởi người dùng
2025-05-18 21:29:13,845 - websocket_server - INFO - Khởi động server WebSocket tại 0.0.0.0:8090
2025-05-18 21:29:13,890 - websockets.server - INFO - server listening on 0.0.0.0:8090
2025-05-18 21:29:13,890 - websocket_server - INFO - Server WebSocket đang chạy tại ws://0.0.0.0:8090
2025-05-18 21:29:13,891 - websocket_server - INFO - Đã cấu hình ping_timeout=6000 giây, ping_interval=60 giây
2025-05-18 21:29:18,446 - websockets.server - INFO - connection open
2025-05-18 21:29:30,075 - websocket_server - INFO - Nhận tin nhắn dạng JSON: {"content":"xin chào /no_think","session_id":"85ec3946-0108-4ab1-9671-76b7df2f46b1","mode":"basic","
2025-05-18 21:29:30,077 - websocket_server - INFO - Session ID từ client (sau khi kiểm tra): 85ec3946-0108-4ab1-9671-76b7df2f46b1
2025-05-18 21:29:30,077 - websocket_server - INFO - Tắt chế độ thinking cho câu hỏi: xin chào /no_think...
2025-05-18 21:29:30,078 - websocket_server - INFO - Cập nhật chế độ của session 85ec3946-0108-4ab1-9671-76b7df2f46b1 từ workflow thành basic
2025-05-18 21:29:30,078 - websocket_server - INFO - Nhận tin nhắn thông thường: xin chào /no_think, enable_thinking=False, mode=basic
2025-05-18 21:29:30,078 - websocket_server - INFO - Chế độ Basic được kích hoạt với prompt: Bạn là một trợ lý AI hữu ích và thông minh. Hãy trả lời câu hỏi của người dùng một cách chi tiết và ...
2025-05-18 21:29:30,079 - websocket_server - INFO - Xử lý streaming response cho: 'xin chào /no_think', phòng ban: None, session_id: 85ec3946-0108-4ab1-9671-76b7df2f46b1, mode: basic
2025-05-18 21:29:30,079 - websocket_server - INFO - Session ID nhận được: 85ec3946-0108-4ab1-9671-76b7df2f46b1
2025-05-18 21:29:30,079 - websocket_server - INFO - Phát hiện lệnh /no_think, tắt chế độ thinking cho: xin chào
2025-05-18 21:29:30,080 - websocket_server - INFO - Xử lý streaming response. Query: 'xin chào', Mode: basic, Thinking: False
2025-05-18 21:29:30,080 - websocket_server - INFO - Chế độ Basic được kích hoạt với prompt: Bạn là một trợ lý AI hữu ích và thông minh. Hãy trả lời câu hỏi của người dùng một cách chi tiết và ...
2025-05-18 21:29:30,080 - websocket_server - INFO - [DEBUG THINKING] Query hiển thị: 'xin chào', Query gửi đến model: 'xin chào /no_think'
2025-05-18 21:29:30,081 - websocket_server - INFO - Không có lịch sử tin nhắn cho phiên này
2025-05-18 21:29:30,081 - websocket_server - INFO - [DEBUG THINKING] Nội dung cuối cùng gửi đến LLM: 'xin chào /no_think...'
2025-05-18 21:29:30,082 - websocket_server - INFO - Kích thước prompt: 18 ký tự
2025-05-18 21:29:30,082 - websocket_server - INFO - Kích thước system prompt: 174 ký tự
2025-05-18 21:29:30,082 - websocket_server - INFO - Tổng kích thước: 192 ký tự
2025-05-18 21:29:30,082 - websocket_server - INFO - Bắt đầu gọi LLM API (lần thử 1/3)
2025-05-18 21:29:33,081 - websocket_server - INFO - API trả về status 200 OK
2025-05-18 21:29:33,085 - websocket_server - INFO - Streaming hoàn tất thành công
2025-05-18 21:29:33,090 - websocket_server - INFO - Gửi phản hồi cuối cùng, chế độ basic, thinking_enabled: False, thinking_collected: False
2025-05-18 21:29:33,091 - websocket_server - INFO - Lưu hội thoại basic mode vào lịch sử với session_id=85ec3946-0108-4ab1-9671-76b7df2f46b1
2025-05-18 21:29:33,095 - websocket_server - INFO - Cập nhật chế độ của session 85ec3946-0108-4ab1-9671-76b7df2f46b1 thành basic
2025-05-18 21:29:42,844 - websocket_server - INFO - Nhận yêu cầu phân tích (thinking) cho câu hỏi: 
2025-05-18 21:29:42,844 - websocket_server - INFO - Đã thêm 1 tin nhắn gần nhất vào prompt
2025-05-18 21:29:42,853 - websocket_server - INFO - Đã lưu lịch sử tin nhắn và prompt vào file: data/logs/history_prompt_20250518_212942.txt
2025-05-18 21:29:42,853 - websocket_server - INFO - [DEBUG THINKING] Nội dung cuối cùng trả về từ add_history_to_prompt có hậu tố: 
2025-05-18 21:29:42,853 - websocket_server - INFO - Phân tích câu hỏi để xác định phòng ban hoặc loại câu hỏi
2025-05-18 21:29:42,855 - chatbot_rag - INFO - Đang phân tích câu hỏi với LLM: Lịch sử tin nhắn:
Người dùng: xin chào

, session_id: 85ec3946-0108-4ab1-9671-76b7df2f46b1
2025-05-18 21:29:42,876 - chatbot_rag - INFO - [analyze_query_with_llm] Đã lấy được 0 bản ghi lịch sử từ websocket_server cho session 85ec3946-0108-4ab1-9671-76b7df2f46b1
2025-05-18 21:29:42,877 - chatbot_rag - INFO - [analyze_query_with_llm] Sử dụng lịch sử hội thoại: 0 bản ghi
2025-05-18 21:29:42,877 - chatbot_rag - INFO - [analyze_query_with_llm] Prompt cuối cùng: Lịch sử tin nhắn:
        
        Câu hỏi người dùng hiện tại: "Lịch sử tin nhắn:
Người dùng: xin chào

"

        Phân tích câu hỏi và trả về JSON có định dạng:
        {"department": "tên phòng ban...
2025-05-18 21:29:42,878 - chatbot_rag - INFO - Kích thước prompt: 621 ký tự
2025-05-18 21:29:42,879 - chatbot_rag - INFO - Kích thước system prompt: 2006 ký tự
2025-05-18 21:29:42,879 - chatbot_rag - INFO - Tổng kích thước: 2627 ký tự
2025-05-18 21:29:42,882 - chatbot_rag - INFO - Đã lưu full prompt vào file: data/logs/llm_full_prompt_20250518_212942.txt
2025-05-18 21:29:42,882 - chatbot_rag - INFO - System prompt: 
        Bạn là trợ lý AI phân tích câu hỏi để xác định:
        1. Phòng ban người dùng đang hỏi (department)
        2. Loại câu hỏi: phòng ban cụ thể hay general (query_type)
        3. Nếu câu hỏi...
2025-05-18 21:29:42,883 - chatbot_rag - INFO - User prompt: Lịch sử tin nhắn:
        
        Câu hỏi người dùng hiện tại: "Lịch sử tin nhắn:
Người dùng: xin chào

"

        Phân tích câu hỏi và trả về JSON có định dạng:
        {"department": "tên phòng ban...
2025-05-18 21:29:42,883 - chatbot_rag - INFO - Gửi truy vấn đến LLM API tại http://192.168.1.4:1234/v1/chat/completions với stream=False
2025-05-18 21:30:05,317 - chatbot_rag - INFO - Mã phản hồi từ API: 200
2025-05-18 21:30:05,319 - chatbot_rag - INFO - Phản hồi gốc từ LLM API (200 ký tự đầu): <think>
Okay, let's break this down. The user provided a history of messages where the initial message is just "xin chào" (hello). There's no mention of any specific department or process in the histo
2025-05-18 21:30:05,320 - chatbot_rag - INFO - Đã lưu phản hồi đầy đủ vào file: data/logs/llm_response_20250518_213005.txt
2025-05-18 21:30:05,322 - chatbot_rag - INFO - [analysis_20250518_213005] Đã ghi phản hồi gốc vào: data/logs/analysis_20250518_213005_raw.txt
2025-05-18 21:30:05,323 - chatbot_rag - INFO - [analysis_20250518_213005] Phản hồi gốc: <think>
Okay, let's break this down. The user provided a history of messages where the initial messa...
2025-05-18 21:30:05,323 - chatbot_rag - WARNING - [analysis_20250518_213005] Phát hiện thẻ <think> trong phản hồi. Xử lý đặc biệt...
2025-05-18 21:30:05,325 - chatbot_rag - INFO - [analysis_20250518_213005] BƯỚC 1: Thử parse toàn bộ chuỗi phản hồi
2025-05-18 21:30:05,325 - chatbot_rag - INFO - [analysis_20250518_213005] BƯỚC 1: Không phải JSON hợp lệ: Expecting value: line 1 column 1 (char 0)
2025-05-18 21:30:05,326 - chatbot_rag - INFO - [analysis_20250518_213005] BƯỚC 2: Tìm JSON trong chuỗi phản hồi
2025-05-18 21:30:05,326 - chatbot_rag - WARNING - [analysis_20250518_213005] BƯỚC 2: Không tìm thấy mẫu JSON nào trong phản hồi
2025-05-18 21:30:05,326 - chatbot_rag - INFO - [analysis_20250518_213005] BƯỚC 3: Xử lý chuỗi thủ công để trích xuất thông tin
2025-05-18 21:30:05,336 - department_info_tool - INFO - Đã tải 11 phòng ban
2025-05-18 21:30:05,336 - department_info_tool - INFO - Đã lấy danh sách 11 phòng ban
2025-05-18 21:30:05,337 - chatbot_rag - ERROR - [analysis_20250518_213005] BƯỚC 3: Lỗi khi xử lý chuỗi thủ công: local variable 'query_type' referenced before assignment
2025-05-18 21:30:05,337 - chatbot_rag - WARNING - [analysis_20250518_213005] Tất cả phương pháp phân tích đều thất bại, trả về kết quả mặc định
2025-05-18 21:30:05,338 - websocket_server - INFO - Lấy phân tích cho câu hỏi chung
2025-05-18 21:30:05,338 - chatbot_rag - INFO - Xử lý câu hỏi chung cho session_id: 85ec3946-0108-4ab1-9671-76b7df2f46b1
2025-05-18 21:30:05,340 - department_info_tool - INFO - Đã tải 11 phòng ban
2025-05-18 21:30:05,340 - department_info_tool - INFO - Đã lấy danh sách 11 phòng ban
2025-05-18 21:30:05,341 - chatbot_rag - INFO - Gọi LLM để trả lời câu hỏi chung cho session_id: 85ec3946-0108-4ab1-9671-76b7df2f46b1
2025-05-18 21:30:05,343 - chatbot_rag - INFO - Đã lưu prompt vào file: data/logs/prompt_general_20250518_213005.txt
2025-05-18 21:30:05,344 - chatbot_rag - INFO - Kích thước prompt: 1022 ký tự
2025-05-18 21:30:05,344 - chatbot_rag - INFO - Kích thước system prompt: 916 ký tự
2025-05-18 21:30:05,344 - chatbot_rag - INFO - Tổng kích thước: 1938 ký tự
2025-05-18 21:30:05,346 - chatbot_rag - INFO - Đã lưu full prompt vào file: data/logs/llm_full_prompt_20250518_213005.txt
2025-05-18 21:30:05,346 - chatbot_rag - INFO - System prompt: 
Bạn là trợ lý AI chuyên về quy trình và giai đoạn trong công ty.

DANH SÁCH PHÒNG BAN:
- 2D
- Dự toán
- Khách hàng
- Kinh doanh
- Kế toán
- Marketing
- Mua hàng
- Team dự án
- Thi công
- Thiết kế
- Đ...
2025-05-18 21:30:05,347 - chatbot_rag - INFO - User prompt: 
Câu hỏi: " /think"

Đây là câu hỏi chung về quy trình hoặc giai đoạn làm việc.

Thông tin cơ bản:
### Thông tin tổng quan về quy trình và giai đoạn

#### Giai đoạn chính trong quy trình:
1. **MKT-SAL...
2025-05-18 21:30:05,347 - chatbot_rag - INFO - Gửi truy vấn đến LLM API tại http://192.168.1.4:1234/v1/chat/completions với stream=True
2025-05-18 21:30:37,263 - chatbot_rag - INFO - Mã phản hồi từ API: 200
2025-05-18 21:30:37,264 - chatbot_rag - INFO - Phản hồi gốc từ LLM API (200 ký tự đầu): <think>
Okay, let's see. The user provided a query that's pretty vague about the process or stages of work. They mentioned some general info about the company's departments and stages but didn't ask a
2025-05-18 21:30:37,266 - chatbot_rag - INFO - Đã lưu phản hồi đầy đủ vào file: data/logs/llm_response_20250518_213037.txt
2025-05-18 21:30:37,638 - websocket_server - INFO - Đã trích xuất thinking (1580 ký tự) và còn lại 308 ký tự phản hồi
2025-05-18 21:30:37,638 - websocket_server - INFO - Phần nội dung còn lại bắt đầu bằng: **🎉 Câu hỏi chung không liên quan đến công việc? T...
2025-05-18 21:30:37,638 - websocket_server - INFO - Đã trích xuất phần thinking (1580 ký tự) từ phản hồi handle_general_query
2025-05-18 21:30:37,639 - websocket_server - INFO - Gửi phản hồi thinking với request_id: thinking_1747578582843_a3gbte2
2025-05-18 21:30:37,639 - websocket_server - INFO - Đã gửi nội dung thinking (1580 ký tự)
2025-05-18 21:32:07,803 - websocket_server - INFO - Nhận yêu cầu phân tích (thinking) cho câu hỏi: 
2025-05-18 21:32:07,806 - websocket_server - INFO - Đã thêm 1 tin nhắn gần nhất vào prompt
2025-05-18 21:32:07,812 - websocket_server - INFO - Đã lưu lịch sử tin nhắn và prompt vào file: data/logs/history_prompt_20250518_213207.txt
2025-05-18 21:32:07,813 - websocket_server - INFO - [DEBUG THINKING] Nội dung cuối cùng trả về từ add_history_to_prompt có hậu tố: 
2025-05-18 21:32:07,813 - websocket_server - INFO - Phân tích câu hỏi để xác định phòng ban hoặc loại câu hỏi
2025-05-18 21:32:07,814 - chatbot_rag - INFO - Đang phân tích câu hỏi với LLM: Lịch sử tin nhắn:
Người dùng: xin chào

, session_id: 85ec3946-0108-4ab1-9671-76b7df2f46b1
2025-05-18 21:32:07,815 - chatbot_rag - INFO - [analyze_query_with_llm] Đã lấy được 0 bản ghi lịch sử từ websocket_server cho session 85ec3946-0108-4ab1-9671-76b7df2f46b1
2025-05-18 21:32:07,817 - chatbot_rag - INFO - [analyze_query_with_llm] Sử dụng lịch sử hội thoại: 0 bản ghi
2025-05-18 21:32:07,817 - chatbot_rag - INFO - [analyze_query_with_llm] Prompt cuối cùng: Lịch sử tin nhắn:
        
        Câu hỏi người dùng hiện tại: "Lịch sử tin nhắn:
Người dùng: xin chào

"

        Phân tích câu hỏi và trả về JSON có định dạng:
        {"department": "tên phòng ban...
2025-05-18 21:32:07,819 - chatbot_rag - INFO - Kích thước prompt: 621 ký tự
2025-05-18 21:32:07,819 - chatbot_rag - INFO - Kích thước system prompt: 2006 ký tự
2025-05-18 21:32:07,820 - chatbot_rag - INFO - Tổng kích thước: 2627 ký tự
2025-05-18 21:32:07,831 - chatbot_rag - INFO - Đã lưu full prompt vào file: data/logs/llm_full_prompt_20250518_213207.txt
2025-05-18 21:32:07,832 - chatbot_rag - INFO - System prompt: 
        Bạn là trợ lý AI phân tích câu hỏi để xác định:
        1. Phòng ban người dùng đang hỏi (department)
        2. Loại câu hỏi: phòng ban cụ thể hay general (query_type)
        3. Nếu câu hỏi...
2025-05-18 21:32:07,834 - chatbot_rag - INFO - User prompt: Lịch sử tin nhắn:
        
        Câu hỏi người dùng hiện tại: "Lịch sử tin nhắn:
Người dùng: xin chào

"

        Phân tích câu hỏi và trả về JSON có định dạng:
        {"department": "tên phòng ban...
2025-05-18 21:32:07,835 - chatbot_rag - INFO - Gửi truy vấn đến LLM API tại http://192.168.1.4:1234/v1/chat/completions với stream=False
2025-05-18 21:32:34,169 - chatbot_rag - INFO - Mã phản hồi từ API: 200
2025-05-18 21:32:34,173 - chatbot_rag - INFO - Phản hồi gốc từ LLM API (200 ký tự đầu): <think>
Okay, let me try to figure out how to handle this user's query. The user provided a history of messages where the first message is "xin chào" (which means "hello"). Now, their current question
2025-05-18 21:32:34,176 - chatbot_rag - INFO - Đã lưu phản hồi đầy đủ vào file: data/logs/llm_response_20250518_213234.txt
2025-05-18 21:32:34,179 - chatbot_rag - INFO - [analysis_20250518_213234] Đã ghi phản hồi gốc vào: data/logs/analysis_20250518_213234_raw.txt
2025-05-18 21:32:34,180 - chatbot_rag - INFO - [analysis_20250518_213234] Phản hồi gốc: <think>
Okay, let me try to figure out how to handle this user's query. The user provided a history ...
2025-05-18 21:32:34,180 - chatbot_rag - WARNING - [analysis_20250518_213234] Phát hiện thẻ <think> trong phản hồi. Xử lý đặc biệt...
2025-05-18 21:32:34,181 - chatbot_rag - INFO - [analysis_20250518_213234] BƯỚC 1: Thử parse toàn bộ chuỗi phản hồi
2025-05-18 21:32:34,182 - chatbot_rag - INFO - [analysis_20250518_213234] BƯỚC 1: Không phải JSON hợp lệ: Expecting value: line 1 column 1 (char 0)
2025-05-18 21:32:34,183 - chatbot_rag - INFO - [analysis_20250518_213234] BƯỚC 2: Tìm JSON trong chuỗi phản hồi
2025-05-18 21:32:34,184 - chatbot_rag - WARNING - [analysis_20250518_213234] BƯỚC 2: Không tìm thấy mẫu JSON nào trong phản hồi
2025-05-18 21:32:34,184 - chatbot_rag - INFO - [analysis_20250518_213234] BƯỚC 3: Xử lý chuỗi thủ công để trích xuất thông tin
2025-05-18 21:32:34,193 - department_info_tool - INFO - Đã tải 11 phòng ban
2025-05-18 21:32:34,194 - department_info_tool - INFO - Đã lấy danh sách 11 phòng ban
2025-05-18 21:32:34,196 - chatbot_rag - ERROR - [analysis_20250518_213234] BƯỚC 3: Lỗi khi xử lý chuỗi thủ công: local variable 'query_type' referenced before assignment
2025-05-18 21:32:34,196 - chatbot_rag - WARNING - [analysis_20250518_213234] Tất cả phương pháp phân tích đều thất bại, trả về kết quả mặc định
2025-05-18 21:32:34,196 - websocket_server - INFO - Lấy phân tích cho câu hỏi chung
2025-05-18 21:32:34,197 - chatbot_rag - INFO - Xử lý câu hỏi chung cho session_id: 85ec3946-0108-4ab1-9671-76b7df2f46b1
2025-05-18 21:32:34,203 - department_info_tool - INFO - Đã tải 11 phòng ban
2025-05-18 21:32:34,203 - department_info_tool - INFO - Đã lấy danh sách 11 phòng ban
2025-05-18 21:32:34,204 - chatbot_rag - INFO - Gọi LLM để trả lời câu hỏi chung cho session_id: 85ec3946-0108-4ab1-9671-76b7df2f46b1
2025-05-18 21:32:34,205 - chatbot_rag - INFO - Đã lưu prompt vào file: data/logs/prompt_general_20250518_213234.txt
2025-05-18 21:32:34,206 - chatbot_rag - INFO - Kích thước prompt: 1022 ký tự
2025-05-18 21:32:34,206 - chatbot_rag - INFO - Kích thước system prompt: 916 ký tự
2025-05-18 21:32:34,206 - chatbot_rag - INFO - Tổng kích thước: 1938 ký tự
2025-05-18 21:32:34,208 - chatbot_rag - INFO - Đã lưu full prompt vào file: data/logs/llm_full_prompt_20250518_213234.txt
2025-05-18 21:32:34,208 - chatbot_rag - INFO - System prompt: 
Bạn là trợ lý AI chuyên về quy trình và giai đoạn trong công ty.

DANH SÁCH PHÒNG BAN:
- 2D
- Dự toán
- Khách hàng
- Kinh doanh
- Kế toán
- Marketing
- Mua hàng
- Team dự án
- Thi công
- Thiết kế
- Đ...
2025-05-18 21:32:34,209 - chatbot_rag - INFO - User prompt: 
Câu hỏi: " /think"

Đây là câu hỏi chung về quy trình hoặc giai đoạn làm việc.

Thông tin cơ bản:
### Thông tin tổng quan về quy trình và giai đoạn

#### Giai đoạn chính trong quy trình:
1. **MKT-SAL...
2025-05-18 21:32:34,210 - chatbot_rag - INFO - Gửi truy vấn đến LLM API tại http://192.168.1.4:1234/v1/chat/completions với stream=True
2025-05-18 21:33:10,777 - websockets.server - INFO - connection closed
2025-05-18 21:33:10,791 - websockets.server - INFO - server closing
2025-05-18 21:33:10,794 - websockets.server - INFO - server closed
2025-05-18 21:33:10,800 - websocket_server - INFO - Server bị dừng bởi người dùng
2025-05-18 21:33:10,935 - asyncio - ERROR - Task exception was never retrieved
future: <Task finished name='Task-5' coro=<WebSocketServerProtocol.handler() done, defined at C:\Users\thuon\OneDrive\Desktop\UI-chatbot\backend\venv\lib\site-packages\websockets\legacy\server.py:159> exception=KeyboardInterrupt()>
Traceback (most recent call last):
  File "server.py", line 1488, in <module>
  File "C:\Users\thuon\AppData\Local\Programs\Python\Python38\lib\asyncio\runners.py", line 43, in run
    return loop.run_until_complete(main)
  File "C:\Users\thuon\AppData\Local\Programs\Python\Python38\lib\asyncio\base_events.py", line 603, in run_until_complete
    self.run_forever()
  File "C:\Users\thuon\AppData\Local\Programs\Python\Python38\lib\asyncio\windows_events.py", line 316, in run_forever
    super().run_forever()
  File "C:\Users\thuon\AppData\Local\Programs\Python\Python38\lib\asyncio\base_events.py", line 570, in run_forever
    self._run_once()
  File "C:\Users\thuon\AppData\Local\Programs\Python\Python38\lib\asyncio\base_events.py", line 1859, in _run_once
    handle._run()
  File "C:\Users\thuon\AppData\Local\Programs\Python\Python38\lib\asyncio\events.py", line 81, in _run
    self._context.run(self._callback, *self._args)
  File "C:\Users\thuon\OneDrive\Desktop\UI-chatbot\backend\venv\lib\site-packages\websockets\legacy\server.py", line 245, in handler
    await self.ws_handler(self)
  File "server.py", line 1237, in handle_message
    "error": str(e)
  File "server.py", line 1103, in handle_action
    await websocket.send(json.dumps(response))
  File "server.py", line 969, in handle_thinking_request
    ## Phân tích câu hỏi về phòng ban {department}
  File "C:\Users\thuon\OneDrive\Desktop\UI-chatbot\backend\chatbot.py", line 443, in handle_general_query
    final_response = query_llm(user_prompt, system_prompt)
  File "C:\Users\thuon\OneDrive\Desktop\UI-chatbot\backend\chatbot.py", line 293, in query_llm
    response = requests.post(url, json=payload)
  File "C:\Users\thuon\OneDrive\Desktop\UI-chatbot\backend\venv\lib\site-packages\requests\api.py", line 115, in post
    return request("post", url, data=data, json=json, **kwargs)
  File "C:\Users\thuon\OneDrive\Desktop\UI-chatbot\backend\venv\lib\site-packages\requests\api.py", line 59, in request
    return session.request(method=method, url=url, **kwargs)
  File "C:\Users\thuon\OneDrive\Desktop\UI-chatbot\backend\venv\lib\site-packages\requests\sessions.py", line 589, in request
    resp = self.send(prep, **send_kwargs)
  File "C:\Users\thuon\OneDrive\Desktop\UI-chatbot\backend\venv\lib\site-packages\requests\sessions.py", line 703, in send
    r = adapter.send(request, **kwargs)
  File "C:\Users\thuon\OneDrive\Desktop\UI-chatbot\backend\venv\lib\site-packages\requests\adapters.py", line 667, in send
    resp = conn.urlopen(
  File "C:\Users\thuon\OneDrive\Desktop\UI-chatbot\backend\venv\lib\site-packages\urllib3\connectionpool.py", line 789, in urlopen
    response = self._make_request(
  File "C:\Users\thuon\OneDrive\Desktop\UI-chatbot\backend\venv\lib\site-packages\urllib3\connectionpool.py", line 536, in _make_request
    response = conn.getresponse()
  File "C:\Users\thuon\OneDrive\Desktop\UI-chatbot\backend\venv\lib\site-packages\urllib3\connection.py", line 507, in getresponse
    httplib_response = super().getresponse()
  File "C:\Users\thuon\AppData\Local\Programs\Python\Python38\lib\http\client.py", line 1322, in getresponse
    response.begin()
  File "C:\Users\thuon\AppData\Local\Programs\Python\Python38\lib\http\client.py", line 303, in begin
    version, status, reason = self._read_status()
  File "C:\Users\thuon\AppData\Local\Programs\Python\Python38\lib\http\client.py", line 264, in _read_status
    line = str(self.fp.readline(_MAXLINE + 1), "iso-8859-1")
  File "C:\Users\thuon\AppData\Local\Programs\Python\Python38\lib\socket.py", line 669, in readinto
    return self._sock.recv_into(b)
KeyboardInterrupt
2025-05-18 21:33:46,991 - websocket_server - INFO - Khởi động server WebSocket tại 0.0.0.0:8090
2025-05-18 21:33:47,032 - websockets.server - INFO - server listening on 0.0.0.0:8090
2025-05-18 21:33:47,033 - websocket_server - INFO - Server WebSocket đang chạy tại ws://0.0.0.0:8090
2025-05-18 21:33:47,034 - websocket_server - INFO - Đã cấu hình ping_timeout=6000 giây, ping_interval=60 giây
2025-05-18 21:33:54,812 - websockets.server - INFO - connection open
2025-05-18 21:34:28,369 - websocket_server - INFO - Nhận tin nhắn dạng JSON: {"content":"xin chào /no_think","session_id":"ca7a6388-c9b6-44eb-9c6b-3d846dc07adc","mode":"basic","
2025-05-18 21:34:28,457 - websocket_server - INFO - Session ID từ client (sau khi kiểm tra): ca7a6388-c9b6-44eb-9c6b-3d846dc07adc
2025-05-18 21:34:28,513 - websocket_server - INFO - Tắt chế độ thinking cho câu hỏi: xin chào /no_think...
2025-05-18 21:34:28,514 - websocket_server - INFO - Cập nhật chế độ của session ca7a6388-c9b6-44eb-9c6b-3d846dc07adc từ workflow thành basic
2025-05-18 21:34:28,520 - websocket_server - INFO - Nhận tin nhắn thông thường: xin chào /no_think, enable_thinking=False, mode=basic
2025-05-18 21:34:28,521 - websocket_server - INFO - Chế độ Basic được kích hoạt với prompt: luôn trả lời tôi bị ngu...
2025-05-18 21:34:28,524 - websocket_server - INFO - Xử lý streaming response cho: 'xin chào /no_think', phòng ban: None, session_id: ca7a6388-c9b6-44eb-9c6b-3d846dc07adc, mode: basic
2025-05-18 21:34:28,526 - websocket_server - INFO - Session ID nhận được: ca7a6388-c9b6-44eb-9c6b-3d846dc07adc
2025-05-18 21:34:28,527 - websocket_server - INFO - Phát hiện lệnh /no_think, tắt chế độ thinking cho: xin chào
2025-05-18 21:34:28,528 - websocket_server - INFO - Xử lý streaming response. Query: 'xin chào', Mode: basic, Thinking: False
2025-05-18 21:34:28,528 - websocket_server - INFO - Chế độ Basic được kích hoạt với prompt: luôn trả lời tôi bị ngu...
2025-05-18 21:34:28,529 - websocket_server - INFO - [DEBUG THINKING] Query hiển thị: 'xin chào', Query gửi đến model: 'xin chào /no_think'
2025-05-18 21:34:28,533 - websocket_server - INFO - Không có lịch sử tin nhắn cho phiên này
2025-05-18 21:34:28,534 - websocket_server - INFO - [DEBUG THINKING] Nội dung cuối cùng gửi đến LLM: 'xin chào /no_think...'
2025-05-18 21:34:28,536 - websocket_server - INFO - [DEBUG THINKING] System prompt cuối cùng: 'luôn trả lời tôi bị ngu


HƯỚNG DẪN QUAN TRỌNG VỀ THINKING:

Khi chế độ thinking được BẬT (thể hiện bằng hậu tố '/think'):
- Đặt suy nghĩ, phân tích và lý luận của bạn trong thẻ <think>...</think>
- Thẻ <think> phải luôn đứng TRƯỚC phần câu trả lời chính thức
- Ví dụ: "<think>Đây là phân tích của tôi...</think>

Đây là câu trả lời chính thức..."

Khi chế độ thinking bị TẮT (thể hiện bằng hậu tố '/no_think'):
- KHÔNG được sử dụng thẻ <think> trong bất kỳ phần nào của câu trả lời
- Chỉ trả về câu trả lời trực tiếp, không có phần thinking

LƯU Ý: 
- Luôn kiểm tra cuối câu hỏi của người dùng để xác định có hậu tố '/think' hay '/no_think'
- Tuân thủ nghiêm ngặt quy tắc này trong mọi câu trả lời
'
2025-05-18 21:34:28,541 - websocket_server - INFO - Kích thước prompt: 18 ký tự
2025-05-18 21:34:28,542 - websocket_server - INFO - Kích thước system prompt: 699 ký tự
2025-05-18 21:34:28,543 - websocket_server - INFO - Tổng kích thước: 717 ký tự
2025-05-18 21:34:28,543 - websocket_server - INFO - Bắt đầu gọi LLM API (lần thử 1/3)
2025-05-18 21:34:37,545 - websocket_server - INFO - API trả về status 200 OK
2025-05-18 21:34:37,551 - websocket_server - INFO - Streaming hoàn tất thành công
2025-05-18 21:34:37,555 - websocket_server - WARNING - [DEBUG THINKING] Phát hiện response rỗng, tạo phản hồi mặc định
2025-05-18 21:34:37,557 - websocket_server - INFO - [DEBUG THINKING] Gửi phản hồi cuối cùng, content: 63 ký tự, thinking: False
2025-05-18 21:34:37,557 - websocket_server - INFO - Gửi phản hồi cuối cùng, chế độ basic, thinking_enabled: False, thinking_collected: False
2025-05-18 21:34:37,566 - websocket_server - INFO - Lưu hội thoại basic mode vào lịch sử với session_id=ca7a6388-c9b6-44eb-9c6b-3d846dc07adc
2025-05-18 21:34:37,569 - websocket_server - INFO - Cập nhật chế độ của session ca7a6388-c9b6-44eb-9c6b-3d846dc07adc thành basic
2025-05-18 21:34:50,943 - websocket_server - INFO - Nhận yêu cầu phân tích (thinking) cho câu hỏi: Xin lỗi, tôi không thể xử lý yêu cầu của bạn. Vui lòng thử lại.
2025-05-18 21:34:50,944 - websocket_server - INFO - Đã thêm 1 tin nhắn gần nhất vào prompt
2025-05-18 21:34:50,956 - websocket_server - INFO - Đã lưu lịch sử tin nhắn và prompt vào file: data/logs/history_prompt_20250518_213450.txt
2025-05-18 21:34:50,957 - websocket_server - INFO - [DEBUG THINKING] Nội dung cuối cùng trả về từ add_history_to_prompt có hậu tố: g thử lại.
2025-05-18 21:34:50,958 - websocket_server - INFO - Phân tích câu hỏi để xác định phòng ban hoặc loại câu hỏi
2025-05-18 21:34:50,960 - chatbot_rag - INFO - Đang phân tích câu hỏi với LLM: Lịch sử tin nhắn:
Người dùng: xin chào

Xin lỗi, tôi không thể xử lý yêu cầu của bạn. Vui lòng thử lại., session_id: ca7a6388-c9b6-44eb-9c6b-3d846dc07adc
2025-05-18 21:34:51,030 - chatbot_rag - INFO - [analyze_query_with_llm] Đã lấy được 0 bản ghi lịch sử từ websocket_server cho session ca7a6388-c9b6-44eb-9c6b-3d846dc07adc
2025-05-18 21:34:51,030 - chatbot_rag - INFO - [analyze_query_with_llm] Sử dụng lịch sử hội thoại: 0 bản ghi
2025-05-18 21:34:51,031 - chatbot_rag - INFO - [analyze_query_with_llm] Prompt cuối cùng: Lịch sử tin nhắn:
        
        Câu hỏi người dùng hiện tại: "Lịch sử tin nhắn:
Người dùng: xin chào

Xin lỗi, tôi không thể xử lý yêu cầu của bạn. Vui lòng thử lại."

        Phân tích câu hỏi và ...
2025-05-18 21:34:51,034 - chatbot_rag - INFO - Kích thước prompt: 684 ký tự
2025-05-18 21:34:51,035 - chatbot_rag - INFO - Kích thước system prompt: 2006 ký tự
2025-05-18 21:34:51,035 - chatbot_rag - INFO - Tổng kích thước: 2690 ký tự
2025-05-18 21:34:51,038 - chatbot_rag - INFO - Đã lưu full prompt vào file: data/logs/llm_full_prompt_20250518_213451.txt
2025-05-18 21:34:51,038 - chatbot_rag - INFO - System prompt: 
        Bạn là trợ lý AI phân tích câu hỏi để xác định:
        1. Phòng ban người dùng đang hỏi (department)
        2. Loại câu hỏi: phòng ban cụ thể hay general (query_type)
        3. Nếu câu hỏi...
2025-05-18 21:34:51,039 - chatbot_rag - INFO - User prompt: Lịch sử tin nhắn:
        
        Câu hỏi người dùng hiện tại: "Lịch sử tin nhắn:
Người dùng: xin chào

Xin lỗi, tôi không thể xử lý yêu cầu của bạn. Vui lòng thử lại."

        Phân tích câu hỏi và ...
2025-05-18 21:34:51,039 - chatbot_rag - INFO - Gửi truy vấn đến LLM API tại http://192.168.1.4:1234/v1/chat/completions với stream=False
2025-05-18 21:35:15,856 - chatbot_rag - INFO - Mã phản hồi từ API: 200
2025-05-18 21:35:15,857 - chatbot_rag - INFO - Phản hồi gốc từ LLM API (200 ký tự đầu): <think>
Okay, let's tackle this query. The user provided a history of messages where the previous interaction was an apology for not being able to process the request. Now, the current question is abo
2025-05-18 21:35:15,859 - chatbot_rag - INFO - Đã lưu phản hồi đầy đủ vào file: data/logs/llm_response_20250518_213515.txt
2025-05-18 21:35:15,862 - chatbot_rag - INFO - [analysis_20250518_213515] Đã ghi phản hồi gốc vào: data/logs/analysis_20250518_213515_raw.txt
2025-05-18 21:35:15,862 - chatbot_rag - INFO - [analysis_20250518_213515] Phản hồi gốc: <think>
Okay, let's tackle this query. The user provided a history of messages where the previous in...
2025-05-18 21:35:15,863 - chatbot_rag - WARNING - [analysis_20250518_213515] Phát hiện thẻ <think> trong phản hồi. Xử lý đặc biệt...
2025-05-18 21:35:15,865 - chatbot_rag - INFO - [analysis_20250518_213515] BƯỚC 1: Thử parse toàn bộ chuỗi phản hồi
2025-05-18 21:35:15,865 - chatbot_rag - INFO - [analysis_20250518_213515] BƯỚC 1: Không phải JSON hợp lệ: Expecting value: line 1 column 1 (char 0)
2025-05-18 21:35:15,866 - chatbot_rag - INFO - [analysis_20250518_213515] BƯỚC 2: Tìm JSON trong chuỗi phản hồi
2025-05-18 21:35:15,866 - chatbot_rag - WARNING - [analysis_20250518_213515] BƯỚC 2: Không tìm thấy mẫu JSON nào trong phản hồi
2025-05-18 21:35:15,866 - chatbot_rag - INFO - [analysis_20250518_213515] BƯỚC 3: Xử lý chuỗi thủ công để trích xuất thông tin
2025-05-18 21:35:15,873 - department_info_tool - INFO - Đã tải 11 phòng ban
2025-05-18 21:35:15,874 - department_info_tool - INFO - Đã lấy danh sách 11 phòng ban
2025-05-18 21:35:15,875 - chatbot_rag - ERROR - [analysis_20250518_213515] BƯỚC 3: Lỗi khi xử lý chuỗi thủ công: local variable 'query_type' referenced before assignment
2025-05-18 21:35:15,876 - chatbot_rag - WARNING - [analysis_20250518_213515] Tất cả phương pháp phân tích đều thất bại, trả về kết quả mặc định
2025-05-18 21:35:15,876 - websocket_server - INFO - Lấy phân tích cho câu hỏi chung
2025-05-18 21:35:15,876 - chatbot_rag - INFO - Xử lý câu hỏi chung cho session_id: ca7a6388-c9b6-44eb-9c6b-3d846dc07adc
2025-05-18 21:35:15,881 - department_info_tool - INFO - Đã tải 11 phòng ban
2025-05-18 21:35:15,881 - department_info_tool - INFO - Đã lấy danh sách 11 phòng ban
2025-05-18 21:35:15,882 - chatbot_rag - INFO - Gọi LLM để trả lời câu hỏi chung cho session_id: ca7a6388-c9b6-44eb-9c6b-3d846dc07adc
2025-05-18 21:35:15,883 - chatbot_rag - INFO - Đã lưu prompt vào file: data/logs/prompt_general_20250518_213515.txt
2025-05-18 21:35:15,883 - chatbot_rag - INFO - Kích thước prompt: 1085 ký tự
2025-05-18 21:35:15,883 - chatbot_rag - INFO - Kích thước system prompt: 916 ký tự
2025-05-18 21:35:15,884 - chatbot_rag - INFO - Tổng kích thước: 2001 ký tự
2025-05-18 21:35:15,886 - chatbot_rag - INFO - Đã lưu full prompt vào file: data/logs/llm_full_prompt_20250518_213515.txt
2025-05-18 21:35:15,886 - chatbot_rag - INFO - System prompt: 
Bạn là trợ lý AI chuyên về quy trình và giai đoạn trong công ty.

DANH SÁCH PHÒNG BAN:
- 2D
- Dự toán
- Khách hàng
- Kinh doanh
- Kế toán
- Marketing
- Mua hàng
- Team dự án
- Thi công
- Thiết kế
- Đ...
2025-05-18 21:35:15,887 - chatbot_rag - INFO - User prompt: 
Câu hỏi: "Xin lỗi, tôi không thể xử lý yêu cầu của bạn. Vui lòng thử lại. /think"

Đây là câu hỏi chung về quy trình hoặc giai đoạn làm việc.

Thông tin cơ bản:
### Thông tin tổng quan về quy trình v...
2025-05-18 21:35:15,887 - chatbot_rag - INFO - Gửi truy vấn đến LLM API tại http://192.168.1.4:1234/v1/chat/completions với stream=True
2025-05-18 21:35:39,142 - chatbot_rag - INFO - Mã phản hồi từ API: 200
2025-05-18 21:35:39,144 - chatbot_rag - INFO - Phản hồi gốc từ LLM API (200 ký tự đầu): <think>
Okay, let's see. The user is asking about a process or stage in the company workflow, but their message is just an error response from the system. They mentioned they can't process the request
2025-05-18 21:35:39,146 - chatbot_rag - INFO - Đã lưu phản hồi đầy đủ vào file: data/logs/llm_response_20250518_213539.txt
2025-05-18 21:35:39,610 - websocket_server - INFO - Đã trích xuất thinking (881 ký tự) và còn lại 194 ký tự phản hồi
2025-05-18 21:35:39,611 - websocket_server - INFO - Phần nội dung còn lại bắt đầu bằng: 😅 Xin lỗi nha! Có vẻ hệ thống đang "đánh nhau" với...
2025-05-18 21:35:39,611 - websocket_server - INFO - Đã trích xuất phần thinking (881 ký tự) từ phản hồi handle_general_query
2025-05-18 21:35:39,611 - websocket_server - INFO - Gửi phản hồi thinking với request_id: thinking_1747578890939_xu8p9fm
2025-05-18 21:35:39,612 - websocket_server - INFO - Đã gửi nội dung thinking (881 ký tự)
2025-05-18 21:35:39,614 - websocket_server - INFO - Nhận tin nhắn dạng JSON: {"content":"mày là ai /no_think","session_id":"ca7a6388-c9b6-44eb-9c6b-3d846dc07adc","mode":"basic",
2025-05-18 21:35:39,615 - websocket_server - INFO - Session ID từ client (sau khi kiểm tra): ca7a6388-c9b6-44eb-9c6b-3d846dc07adc
2025-05-18 21:35:39,616 - websocket_server - INFO - Tắt chế độ thinking cho câu hỏi: mày là ai /no_think...
2025-05-18 21:35:39,617 - websocket_server - INFO - Nhận tin nhắn thông thường: mày là ai /no_think, enable_thinking=False, mode=basic
2025-05-18 21:35:39,617 - websocket_server - INFO - Chế độ Basic được kích hoạt với prompt: luôn trả lời tôi bị ngu...
2025-05-18 21:35:39,618 - websocket_server - INFO - Xử lý streaming response cho: 'mày là ai /no_think', phòng ban: None, session_id: ca7a6388-c9b6-44eb-9c6b-3d846dc07adc, mode: basic
2025-05-18 21:35:39,619 - websocket_server - INFO - Session ID nhận được: ca7a6388-c9b6-44eb-9c6b-3d846dc07adc
2025-05-18 21:35:39,619 - websocket_server - INFO - Phát hiện lệnh /no_think, tắt chế độ thinking cho: mày là ai
2025-05-18 21:35:39,620 - websocket_server - INFO - Xử lý streaming response. Query: 'mày là ai', Mode: basic, Thinking: False
2025-05-18 21:35:39,620 - websocket_server - INFO - Chế độ Basic được kích hoạt với prompt: luôn trả lời tôi bị ngu...
2025-05-18 21:35:39,621 - websocket_server - INFO - [DEBUG THINKING] Query hiển thị: 'mày là ai', Query gửi đến model: 'mày là ai /no_think'
2025-05-18 21:35:39,621 - websocket_server - INFO - Phát hiện hậu tố /no_think trong prompt gốc, giữ lại cho LLM nhưng loại bỏ cho log
2025-05-18 21:35:39,622 - websocket_server - INFO - Đã thêm 1 tin nhắn gần nhất vào prompt
2025-05-18 21:35:39,624 - websocket_server - INFO - Đã lưu lịch sử tin nhắn và prompt vào file: data/logs/history_prompt_20250518_213539.txt
2025-05-18 21:35:39,624 - websocket_server - INFO - [DEBUG THINKING] Nội dung cuối cùng trả về từ add_history_to_prompt có hậu tố:  /no_think
2025-05-18 21:35:39,625 - websocket_server - INFO - [DEBUG THINKING] Nội dung cuối cùng gửi đến LLM: 'Lịch sử tin nhắn:
Người dùng: xin chào

mày là ai /no_think...'
2025-05-18 21:35:39,625 - websocket_server - INFO - [DEBUG THINKING] System prompt cuối cùng: 'luôn trả lời tôi bị ngu


HƯỚNG DẪN QUAN TRỌNG VỀ THINKING:

Khi chế độ thinking được BẬT (thể hiện bằng hậu tố '/think'):
- Đặt suy nghĩ, phân tích và lý luận của bạn trong thẻ <think>...</think>
- Thẻ <think> phải luôn đứng TRƯỚC phần câu trả lời chính thức
- Ví dụ: "<think>Đây là phân tích của tôi...</think>

Đây là câu trả lời chính thức..."

Khi chế độ thinking bị TẮT (thể hiện bằng hậu tố '/no_think'):
- KHÔNG được sử dụng thẻ <think> trong bất kỳ phần nào của câu trả lời
- Chỉ trả về câu trả lời trực tiếp, không có phần thinking

LƯU Ý: 
- Luôn kiểm tra cuối câu hỏi của người dùng để xác định có hậu tố '/think' hay '/no_think'
- Tuân thủ nghiêm ngặt quy tắc này trong mọi câu trả lời
'
2025-05-18 21:35:39,626 - websocket_server - INFO - Kích thước prompt: 59 ký tự
2025-05-18 21:35:39,626 - websocket_server - INFO - Kích thước system prompt: 699 ký tự
2025-05-18 21:35:39,627 - websocket_server - INFO - Tổng kích thước: 758 ký tự
2025-05-18 21:35:39,627 - websocket_server - INFO - Bắt đầu gọi LLM API (lần thử 1/3)
2025-05-18 21:35:46,067 - websocket_server - INFO - API trả về status 200 OK
2025-05-18 21:35:46,067 - websocket_server - INFO - Streaming hoàn tất thành công
2025-05-18 21:35:46,068 - websocket_server - WARNING - [DEBUG THINKING] Phát hiện response rỗng, tạo phản hồi mặc định
2025-05-18 21:35:46,069 - websocket_server - INFO - [DEBUG THINKING] Gửi phản hồi cuối cùng, content: 63 ký tự, thinking: False
2025-05-18 21:35:46,069 - websocket_server - INFO - Gửi phản hồi cuối cùng, chế độ basic, thinking_enabled: False, thinking_collected: False
2025-05-18 21:35:46,070 - websocket_server - INFO - Lưu hội thoại basic mode vào lịch sử với session_id=ca7a6388-c9b6-44eb-9c6b-3d846dc07adc
2025-05-18 21:35:46,071 - websocket_server - INFO - Cập nhật chế độ của session ca7a6388-c9b6-44eb-9c6b-3d846dc07adc thành basic
2025-05-18 21:36:36,031 - websockets.server - INFO - connection closed
2025-05-18 21:36:40,074 - websockets.server - INFO - server closing
2025-05-18 21:36:40,075 - websockets.server - INFO - server closed
2025-05-18 21:36:40,087 - websocket_server - INFO - Server bị dừng bởi người dùng
2025-05-18 21:40:03,418 - websocket_server - INFO - Khởi động server WebSocket tại 0.0.0.0:8090
2025-05-18 21:40:03,466 - websockets.server - INFO - server listening on 0.0.0.0:8090
2025-05-18 21:40:03,467 - websocket_server - INFO - Server WebSocket đang chạy tại ws://0.0.0.0:8090
2025-05-18 21:40:03,467 - websocket_server - INFO - Đã cấu hình ping_timeout=6000 giây, ping_interval=60 giây
2025-05-18 21:40:17,825 - websockets.server - INFO - connection open
2025-05-18 21:40:20,789 - websocket_server - INFO - Nhận tin nhắn dạng JSON: {"content":"xin chào /no_think","session_id":""}
2025-05-18 21:40:20,790 - websocket_server - INFO - Session ID không được cung cấp trong tin nhắn JSON, sử dụng current_session_id: 325c3bfd-8a69-4e84-8d00-36bab37dc761
2025-05-18 21:40:20,791 - websocket_server - INFO - Session ID từ client (sau khi kiểm tra): 325c3bfd-8a69-4e84-8d00-36bab37dc761
2025-05-18 21:40:20,791 - websocket_server - INFO - Tắt chế độ thinking cho câu hỏi: xin chào /no_think...
2025-05-18 21:40:20,792 - websocket_server - INFO - Nhận tin nhắn thông thường: xin chào /no_think, enable_thinking=False
2025-05-18 21:40:20,792 - websocket_server - INFO - Không có lịch sử tin nhắn cho phiên này
2025-05-18 21:40:20,792 - chatbot_rag - INFO - Đang phân tích câu hỏi với LLM: xin chào /no_think, session_id: 325c3bfd-8a69-4e84-8d00-36bab37dc761
2025-05-18 21:40:20,812 - chatbot_rag - INFO - [analyze_query_with_llm] Đã lấy được 0 bản ghi lịch sử từ websocket_server cho session 325c3bfd-8a69-4e84-8d00-36bab37dc761
2025-05-18 21:40:20,812 - chatbot_rag - INFO - [analyze_query_with_llm] Sử dụng lịch sử hội thoại: 0 bản ghi
2025-05-18 21:40:20,813 - chatbot_rag - INFO - [analyze_query_with_llm] Prompt cuối cùng: Lịch sử tin nhắn:
        
        Câu hỏi người dùng hiện tại: "xin chào /no_think"

        Phân tích câu hỏi và trả về JSON có định dạng:
        {"department": "tên phòng ban hoặc null", "query_ty...
2025-05-18 21:40:20,814 - chatbot_rag - INFO - Kích thước prompt: 599 ký tự
2025-05-18 21:40:20,814 - chatbot_rag - INFO - Kích thước system prompt: 2006 ký tự
2025-05-18 21:40:20,815 - chatbot_rag - INFO - Tổng kích thước: 2605 ký tự
2025-05-18 21:40:20,817 - chatbot_rag - INFO - Đã lưu full prompt vào file: data/logs/llm_full_prompt_20250518_214020.txt
2025-05-18 21:40:20,818 - chatbot_rag - INFO - System prompt: 
        Bạn là trợ lý AI phân tích câu hỏi để xác định:
        1. Phòng ban người dùng đang hỏi (department)
        2. Loại câu hỏi: phòng ban cụ thể hay general (query_type)
        3. Nếu câu hỏi...
2025-05-18 21:40:20,819 - chatbot_rag - INFO - User prompt: Lịch sử tin nhắn:
        
        Câu hỏi người dùng hiện tại: "xin chào /no_think"

        Phân tích câu hỏi và trả về JSON có định dạng:
        {"department": "tên phòng ban hoặc null", "query_ty...
2025-05-18 21:40:20,822 - chatbot_rag - INFO - Gửi truy vấn đến LLM API tại http://192.168.1.4:1234/v1/chat/completions với stream=False
2025-05-18 21:40:36,094 - chatbot_rag - INFO - Mã phản hồi từ API: 200
2025-05-18 21:40:36,095 - chatbot_rag - INFO - Phản hồi gốc từ LLM API (200 ký tự đầu): <think>

</think>

{"department": null, "query_type": "general", "error": false}
2025-05-18 21:40:36,105 - chatbot_rag - INFO - Đã lưu phản hồi đầy đủ vào file: data/logs/llm_response_20250518_214036.txt
2025-05-18 21:40:36,117 - chatbot_rag - INFO - [analysis_20250518_214036] Đã ghi phản hồi gốc vào: data/logs/analysis_20250518_214036_raw.txt
2025-05-18 21:40:36,118 - chatbot_rag - INFO - [analysis_20250518_214036] Phản hồi gốc: <think>

</think>

{"department": null, "query_type": "general", "error": false}...
2025-05-18 21:40:36,119 - chatbot_rag - WARNING - [analysis_20250518_214036] Phát hiện thẻ <think> trong phản hồi. Xử lý đặc biệt...
2025-05-18 21:40:36,120 - chatbot_rag - INFO - [analysis_20250518_214036] Đã tìm thấy 1 mẫu JSON tiềm năng trong phản hồi
2025-05-18 21:40:36,121 - chatbot_rag - INFO - [analysis_20250518_214036] Tìm thấy JSON hợp lệ trong thẻ <think>: {'department': None, 'query_type': 'general', 'error': False}
2025-05-18 21:40:36,122 - websocket_server - INFO - Phân tích câu hỏi: Phòng ban=None, Loại=general, Thinking=False
2025-05-18 21:40:36,123 - websocket_server - INFO - Xử lý streaming response cho: 'xin chào /no_think', phòng ban: None, session_id: 325c3bfd-8a69-4e84-8d00-36bab37dc761
2025-05-18 21:40:36,123 - websocket_server - INFO - Session ID nhận được: 325c3bfd-8a69-4e84-8d00-36bab37dc761
2025-05-18 21:40:36,123 - websocket_server - INFO - Phát hiện lệnh /no_think, tắt chế độ thinking cho: xin chào
2025-05-18 21:40:36,124 - websocket_server - INFO - Xử lý streaming response. Query: 'xin chào', Mode thinking: False
2025-05-18 21:40:36,124 - websocket_server - INFO - Không có lịch sử tin nhắn cho phiên này
2025-05-18 21:40:36,125 - chatbot_rag - INFO - Đang phân tích câu hỏi với LLM: xin chào, session_id: 325c3bfd-8a69-4e84-8d00-36bab37dc761
2025-05-18 21:40:36,125 - chatbot_rag - INFO - [analyze_query_with_llm] Đã lấy được 0 bản ghi lịch sử từ websocket_server cho session 325c3bfd-8a69-4e84-8d00-36bab37dc761
2025-05-18 21:40:36,126 - chatbot_rag - INFO - [analyze_query_with_llm] Sử dụng lịch sử hội thoại: 0 bản ghi
2025-05-18 21:40:36,126 - chatbot_rag - INFO - [analyze_query_with_llm] Prompt cuối cùng: Lịch sử tin nhắn:
        
        Câu hỏi người dùng hiện tại: "xin chào"

        Phân tích câu hỏi và trả về JSON có định dạng:
        {"department": "tên phòng ban hoặc null", "query_type": "depa...
2025-05-18 21:40:36,126 - chatbot_rag - INFO - Kích thước prompt: 589 ký tự
2025-05-18 21:40:36,128 - chatbot_rag - INFO - Kích thước system prompt: 2006 ký tự
2025-05-18 21:40:36,129 - chatbot_rag - INFO - Tổng kích thước: 2595 ký tự
2025-05-18 21:40:36,135 - chatbot_rag - INFO - Đã lưu full prompt vào file: data/logs/llm_full_prompt_20250518_214036.txt
2025-05-18 21:40:36,136 - chatbot_rag - INFO - System prompt: 
        Bạn là trợ lý AI phân tích câu hỏi để xác định:
        1. Phòng ban người dùng đang hỏi (department)
        2. Loại câu hỏi: phòng ban cụ thể hay general (query_type)
        3. Nếu câu hỏi...
2025-05-18 21:40:36,137 - chatbot_rag - INFO - User prompt: Lịch sử tin nhắn:
        
        Câu hỏi người dùng hiện tại: "xin chào"

        Phân tích câu hỏi và trả về JSON có định dạng:
        {"department": "tên phòng ban hoặc null", "query_type": "depa...
2025-05-18 21:40:36,139 - chatbot_rag - INFO - Gửi truy vấn đến LLM API tại http://192.168.1.4:1234/v1/chat/completions với stream=False
2025-05-18 21:40:50,212 - chatbot_rag - INFO - Mã phản hồi từ API: 200
2025-05-18 21:40:50,218 - chatbot_rag - INFO - Phản hồi gốc từ LLM API (200 ký tự đầu): <think>
Okay, let's tackle this query. The user's current message is "xin chào", which means "hello" in Vietnamese. The history of messages is empty, so there's no previous context to reference.

Firs
2025-05-18 21:40:50,233 - chatbot_rag - INFO - Đã lưu phản hồi đầy đủ vào file: data/logs/llm_response_20250518_214050.txt
2025-05-18 21:40:50,243 - chatbot_rag - INFO - [analysis_20250518_214050] Đã ghi phản hồi gốc vào: data/logs/analysis_20250518_214050_raw.txt
2025-05-18 21:40:50,245 - chatbot_rag - INFO - [analysis_20250518_214050] Phản hồi gốc: <think>
Okay, let's tackle this query. The user's current message is "xin chào", which means "hello"...
2025-05-18 21:40:50,276 - chatbot_rag - WARNING - [analysis_20250518_214050] Phát hiện thẻ <think> trong phản hồi. Xử lý đặc biệt...
2025-05-18 21:40:50,283 - chatbot_rag - INFO - [analysis_20250518_214050] Đã tìm thấy 1 mẫu JSON tiềm năng trong phản hồi
2025-05-18 21:40:50,288 - chatbot_rag - INFO - [analysis_20250518_214050] Tìm thấy JSON hợp lệ trong thẻ <think>: {'department': None, 'query_type': 'general', 'error': False}
2025-05-18 21:40:50,291 - websocket_server - INFO - Phân tích câu hỏi: Phòng ban=None, Loại=general, Thinking=False
2025-05-18 21:40:50,293 - websocket_server - INFO - Query thực tế gửi đến mô hình: xin chào /no_think
2025-05-18 21:40:50,294 - websocket_server - INFO - Câu hỏi chung, chế độ thinking: False
2025-05-18 21:40:50,300 - chatbot_rag - INFO - Xử lý câu hỏi chung cho session_id: 325c3bfd-8a69-4e84-8d00-36bab37dc761
2025-05-18 21:40:50,337 - department_info_tool - INFO - Đã tải 11 phòng ban
2025-05-18 21:40:50,344 - department_info_tool - INFO - Đã lấy danh sách 11 phòng ban
2025-05-18 21:40:50,351 - chatbot_rag - INFO - Gọi LLM để trả lời câu hỏi chung cho session_id: 325c3bfd-8a69-4e84-8d00-36bab37dc761
2025-05-18 21:40:50,353 - chatbot_rag - INFO - Đã lưu prompt vào file: data/logs/prompt_general_20250518_214050.txt
2025-05-18 21:40:50,353 - chatbot_rag - INFO - Kích thước prompt: 1033 ký tự
2025-05-18 21:40:50,354 - chatbot_rag - INFO - Kích thước system prompt: 916 ký tự
2025-05-18 21:40:50,354 - chatbot_rag - INFO - Tổng kích thước: 1949 ký tự
2025-05-18 21:40:50,358 - chatbot_rag - INFO - Đã lưu full prompt vào file: data/logs/llm_full_prompt_20250518_214050.txt
2025-05-18 21:40:50,360 - chatbot_rag - INFO - System prompt: 
Bạn là trợ lý AI chuyên về quy trình và giai đoạn trong công ty.

DANH SÁCH PHÒNG BAN:
- 2D
- Dự toán
- Khách hàng
- Kinh doanh
- Kế toán
- Marketing
- Mua hàng
- Team dự án
- Thi công
- Thiết kế
- Đ...
2025-05-18 21:40:50,361 - chatbot_rag - INFO - User prompt: 
Câu hỏi: "xin chào /no_think"

Đây là câu hỏi chung về quy trình hoặc giai đoạn làm việc.

Thông tin cơ bản:
### Thông tin tổng quan về quy trình và giai đoạn

#### Giai đoạn chính trong quy trình:
1...
2025-05-18 21:40:50,364 - chatbot_rag - INFO - Gửi truy vấn đến LLM API tại http://192.168.1.4:1234/v1/chat/completions với stream=True
2025-05-18 21:41:06,226 - chatbot_rag - INFO - Mã phản hồi từ API: 200
2025-05-18 21:41:06,229 - chatbot_rag - INFO - Phản hồi gốc từ LLM API (200 ký tự đầu): <think>

</think>

 Xin chào! 😊  
Chào mừng bạn đến với quy trình làm việc của chúng ta! 🚀  
Nếu bạn có bất kỳ thắc mắc nào về các giai đoạn hoặc phòng ban, mình sẽ hỗ trợ bạn ngay lập tức! 💬  
Đừng n
2025-05-18 21:41:06,232 - chatbot_rag - INFO - Đã lưu phản hồi đầy đủ vào file: data/logs/llm_response_20250518_214106.txt
2025-05-18 21:41:06,651 - websocket_server - INFO - Đã trích xuất thinking (0 ký tự) và còn lại 381 ký tự phản hồi
2025-05-18 21:41:06,652 - websocket_server - INFO - Đã trích xuất phần thinking (0 ký tự) từ phản hồi
2025-05-18 21:41:06,652 - websocket_server - INFO - Đã lưu hội thoại chung vào lịch sử của session 325c3bfd-8a69-4e84-8d00-36bab37dc761
2025-05-18 21:41:12,326 - websockets.server - INFO - connection closed
2025-05-18 21:41:12,327 - websockets.server - INFO - server closing
2025-05-18 21:41:12,327 - websockets.server - INFO - server closed
2025-05-18 21:41:12,330 - websocket_server - INFO - Server bị dừng bởi người dùng
2025-05-18 16:30:52,188 - websocket_server - INFO - Khởi động server WebSocket tại 0.0.0.0:8090
2025-05-18 16:30:52,222 - websockets.server - INFO - server listening on 0.0.0.0:8090
2025-05-18 16:30:52,223 - websocket_server - INFO - Server WebSocket đang chạy tại ws://0.0.0.0:8090
2025-05-18 16:30:52,224 - websocket_server - INFO - Đã cấu hình ping_timeout=6000 giây, ping_interval=60 giây
2025-05-18 16:32:37,841 - websockets.server - INFO - connection open
2025-05-18 16:32:40,528 - websocket_server - INFO - Nhận tin nhắn dạng JSON: {"content":"xin chào /no_think","session_id":""}
2025-05-18 16:32:40,530 - websocket_server - INFO - Session ID không được cung cấp trong tin nhắn JSON, sử dụng current_session_id: 472dd73a-11ea-45e8-86fd-f03096ec57ba
2025-05-18 16:32:40,531 - websocket_server - INFO - Session ID từ client (sau khi kiểm tra): 472dd73a-11ea-45e8-86fd-f03096ec57ba
2025-05-18 16:32:40,532 - websocket_server - INFO - Tắt chế độ thinking cho câu hỏi: xin chào /no_think...
2025-05-18 16:32:40,535 - websocket_server - INFO - Nhận tin nhắn thông thường: xin chào /no_think, enable_thinking=False
2025-05-18 16:32:40,537 - websocket_server - INFO - Không có lịch sử tin nhắn cho phiên này
2025-05-18 16:32:40,539 - chatbot_rag - INFO - Đang phân tích câu hỏi với LLM: xin chào /no_think, session_id: 472dd73a-11ea-45e8-86fd-f03096ec57ba
2025-05-18 16:32:42,293 - chatbot_rag - INFO - [analyze_query_with_llm] Đã lấy được 0 bản ghi lịch sử từ websocket_server cho session 472dd73a-11ea-45e8-86fd-f03096ec57ba
2025-05-18 16:32:42,294 - chatbot_rag - INFO - [analyze_query_with_llm] Sử dụng lịch sử hội thoại: 0 bản ghi
2025-05-18 16:32:42,294 - chatbot_rag - INFO - [analyze_query_with_llm] Prompt cuối cùng: Lịch sử tin nhắn:
        
        Câu hỏi người dùng hiện tại: "xin chào /no_think"

        Phân tích câu hỏi và trả về JSON có định dạng:
        {"department": "tên phòng ban hoặc null", "query_ty...
2025-05-18 16:32:42,295 - chatbot_rag - INFO - Kích thước prompt: 599 ký tự
2025-05-18 16:32:42,296 - chatbot_rag - INFO - Kích thước system prompt: 2006 ký tự
2025-05-18 16:32:42,297 - chatbot_rag - INFO - Tổng kích thước: 2605 ký tự
2025-05-18 16:32:42,486 - chatbot_rag - INFO - Đã lưu full prompt vào file: data/logs/llm_full_prompt_20250518_163242.txt
2025-05-18 16:32:42,504 - chatbot_rag - INFO - System prompt: 
        Bạn là trợ lý AI phân tích câu hỏi để xác định:
        1. Phòng ban người dùng đang hỏi (department)
        2. Loại câu hỏi: phòng ban cụ thể hay general (query_type)
        3. Nếu câu hỏi...
2025-05-18 16:32:42,506 - chatbot_rag - INFO - User prompt: Lịch sử tin nhắn:
        
        Câu hỏi người dùng hiện tại: "xin chào /no_think"

        Phân tích câu hỏi và trả về JSON có định dạng:
        {"department": "tên phòng ban hoặc null", "query_ty...
2025-05-18 16:32:42,508 - chatbot_rag - INFO - Gửi truy vấn đến LLM API tại http://192.168.1.4:1234/v1/chat/completions với stream=False
2025-05-19 02:35:10,012 - websocket_server - INFO - Khởi động server WebSocket tại 0.0.0.0:8090
2025-05-19 02:35:10,034 - websockets.server - INFO - server listening on 0.0.0.0:8090
2025-05-19 02:35:10,035 - websocket_server - INFO - Server WebSocket đang chạy tại ws://0.0.0.0:8090
2025-05-19 02:35:10,035 - websocket_server - INFO - Đã cấu hình ping_timeout=6000 giây, ping_interval=60 giây
2025-05-19 10:06:35,647 - websocket_server - INFO - Khởi động server WebSocket tại 0.0.0.0:8090
2025-05-19 10:06:35,785 - websockets.server - INFO - server listening on 0.0.0.0:8090
2025-05-19 10:06:35,785 - websocket_server - INFO - Server WebSocket đang chạy tại ws://0.0.0.0:8090
2025-05-19 10:06:35,785 - websocket_server - INFO - Đã cấu hình ping_timeout=6000 giây, ping_interval=60 giây
2025-05-19 10:07:12,809 - websockets.server - INFO - connection open
2025-05-19 10:07:18,540 - websocket_server - INFO - Nhận tin nhắn dạng JSON: {"content":"xin chào /no_think","session_id":""}
2025-05-19 10:07:18,541 - websocket_server - INFO - Session ID không được cung cấp trong tin nhắn JSON, sử dụng current_session_id: 9ddb8ec1-79f6-4a3a-abd7-8206a58eb76b
2025-05-19 10:07:18,541 - websocket_server - INFO - Session ID từ client (sau khi kiểm tra): 9ddb8ec1-79f6-4a3a-abd7-8206a58eb76b
2025-05-19 10:07:18,542 - websocket_server - INFO - Tắt chế độ thinking cho câu hỏi: xin chào /no_think...
2025-05-19 10:07:18,543 - websocket_server - INFO - Nhận tin nhắn thông thường: xin chào /no_think, enable_thinking=False
2025-05-19 10:07:18,543 - websocket_server - INFO - Không có lịch sử tin nhắn cho phiên này
2025-05-19 10:07:18,543 - chatbot_rag - INFO - Đang phân tích câu hỏi với LLM: xin chào /no_think, session_id: 9ddb8ec1-79f6-4a3a-abd7-8206a58eb76b
2025-05-19 10:07:18,560 - chatbot_rag - INFO - [analyze_query_with_llm] Đã lấy được 0 bản ghi lịch sử từ websocket_server cho session 9ddb8ec1-79f6-4a3a-abd7-8206a58eb76b
2025-05-19 10:07:18,561 - chatbot_rag - INFO - [analyze_query_with_llm] Sử dụng lịch sử hội thoại: 0 bản ghi
2025-05-19 10:07:18,561 - chatbot_rag - INFO - [analyze_query_with_llm] Prompt cuối cùng: Lịch sử tin nhắn:
        
        Câu hỏi người dùng hiện tại: "xin chào /no_think"

        Phân tích câu hỏi và trả về JSON có định dạng:
        {"department": "tên phòng ban hoặc null", "query_ty...
2025-05-19 10:07:18,562 - chatbot_rag - INFO - Kích thước prompt: 599 ký tự
2025-05-19 10:07:18,562 - chatbot_rag - INFO - Kích thước system prompt: 2006 ký tự
2025-05-19 10:07:18,563 - chatbot_rag - INFO - Tổng kích thước: 2605 ký tự
2025-05-19 10:07:18,565 - chatbot_rag - INFO - Đã lưu full prompt vào file: data/logs/llm_full_prompt_20250519_100718.txt
2025-05-19 10:07:18,566 - chatbot_rag - INFO - System prompt: 
        Bạn là trợ lý AI phân tích câu hỏi để xác định:
        1. Phòng ban người dùng đang hỏi (department)
        2. Loại câu hỏi: phòng ban cụ thể hay general (query_type)
        3. Nếu câu hỏi...
2025-05-19 10:07:18,567 - chatbot_rag - INFO - User prompt: Lịch sử tin nhắn:
        
        Câu hỏi người dùng hiện tại: "xin chào /no_think"

        Phân tích câu hỏi và trả về JSON có định dạng:
        {"department": "tên phòng ban hoặc null", "query_ty...
2025-05-19 10:07:18,567 - chatbot_rag - INFO - Gửi truy vấn đến LLM API tại http://192.168.0.43:1234/v1/chat/completions với stream=False
2025-05-19 10:07:19,006 - chatbot_rag - INFO - Mã phản hồi từ API: 200
2025-05-19 10:07:19,007 - chatbot_rag - INFO - Phản hồi gốc từ LLM API (200 ký tự đầu): <think>

</think>

{"department": null, "query_type": "general", "error": false}
2025-05-19 10:07:19,009 - chatbot_rag - INFO - Đã lưu phản hồi đầy đủ vào file: data/logs/llm_response_20250519_100719.txt
2025-05-19 10:07:19,012 - chatbot_rag - INFO - [analysis_20250519_100719] Đã ghi phản hồi gốc vào: data/logs/analysis_20250519_100719_raw.txt
2025-05-19 10:07:19,012 - chatbot_rag - INFO - [analysis_20250519_100719] Phản hồi gốc: <think>

</think>

{"department": null, "query_type": "general", "error": false}...
2025-05-19 10:07:19,013 - chatbot_rag - WARNING - [analysis_20250519_100719] Phát hiện thẻ <think> trong phản hồi. Xử lý đặc biệt...
2025-05-19 10:07:19,013 - chatbot_rag - INFO - [analysis_20250519_100719] Đã tìm thấy 1 mẫu JSON tiềm năng trong phản hồi
2025-05-19 10:07:19,014 - chatbot_rag - INFO - [analysis_20250519_100719] Tìm thấy JSON hợp lệ trong thẻ <think>: {'department': None, 'query_type': 'general', 'error': False}
2025-05-19 10:07:19,014 - websocket_server - INFO - Phân tích câu hỏi: Phòng ban=None, Loại=general, Thinking=False
2025-05-19 10:07:19,015 - websocket_server - INFO - Xử lý streaming response cho: 'xin chào /no_think', phòng ban: None, session_id: 9ddb8ec1-79f6-4a3a-abd7-8206a58eb76b
2025-05-19 10:07:19,015 - websocket_server - INFO - Session ID nhận được: 9ddb8ec1-79f6-4a3a-abd7-8206a58eb76b
2025-05-19 10:07:19,015 - websocket_server - INFO - Phát hiện lệnh /no_think, tắt chế độ thinking cho: xin chào
2025-05-19 10:07:19,016 - websocket_server - INFO - Xử lý streaming response. Query: 'xin chào', Mode thinking: False
2025-05-19 10:07:19,016 - websocket_server - INFO - Không có lịch sử tin nhắn cho phiên này
2025-05-19 10:07:19,017 - chatbot_rag - INFO - Đang phân tích câu hỏi với LLM: xin chào, session_id: 9ddb8ec1-79f6-4a3a-abd7-8206a58eb76b
2025-05-19 10:07:19,018 - chatbot_rag - INFO - [analyze_query_with_llm] Đã lấy được 0 bản ghi lịch sử từ websocket_server cho session 9ddb8ec1-79f6-4a3a-abd7-8206a58eb76b
2025-05-19 10:07:19,019 - chatbot_rag - INFO - [analyze_query_with_llm] Sử dụng lịch sử hội thoại: 0 bản ghi
2025-05-19 10:07:19,019 - chatbot_rag - INFO - [analyze_query_with_llm] Prompt cuối cùng: Lịch sử tin nhắn:
        
        Câu hỏi người dùng hiện tại: "xin chào"

        Phân tích câu hỏi và trả về JSON có định dạng:
        {"department": "tên phòng ban hoặc null", "query_type": "depa...
2025-05-19 10:07:19,020 - chatbot_rag - INFO - Kích thước prompt: 589 ký tự
2025-05-19 10:07:19,020 - chatbot_rag - INFO - Kích thước system prompt: 2006 ký tự
2025-05-19 10:07:19,020 - chatbot_rag - INFO - Tổng kích thước: 2595 ký tự
2025-05-19 10:07:19,022 - chatbot_rag - INFO - Đã lưu full prompt vào file: data/logs/llm_full_prompt_20250519_100719.txt
2025-05-19 10:07:19,023 - chatbot_rag - INFO - System prompt: 
        Bạn là trợ lý AI phân tích câu hỏi để xác định:
        1. Phòng ban người dùng đang hỏi (department)
        2. Loại câu hỏi: phòng ban cụ thể hay general (query_type)
        3. Nếu câu hỏi...
2025-05-19 10:07:19,024 - chatbot_rag - INFO - User prompt: Lịch sử tin nhắn:
        
        Câu hỏi người dùng hiện tại: "xin chào"

        Phân tích câu hỏi và trả về JSON có định dạng:
        {"department": "tên phòng ban hoặc null", "query_type": "depa...
2025-05-19 10:07:19,026 - chatbot_rag - INFO - Gửi truy vấn đến LLM API tại http://192.168.0.43:1234/v1/chat/completions với stream=False
2025-05-19 10:07:20,916 - chatbot_rag - INFO - Mã phản hồi từ API: 200
2025-05-19 10:07:20,916 - chatbot_rag - INFO - Phản hồi gốc từ LLM API (200 ký tự đầu): <think>
Okay, let's tackle this. The user's current question is "xin chào", which means "hello" in Vietnamese. I need to analyze this based on the provided guidelines.

First, looking at the history o
2025-05-19 10:07:21,102 - chatbot_rag - INFO - Đã lưu phản hồi đầy đủ vào file: data/logs/llm_response_20250519_100720.txt
2025-05-19 10:07:21,122 - chatbot_rag - INFO - [analysis_20250519_100721] Đã ghi phản hồi gốc vào: data/logs/analysis_20250519_100721_raw.txt
2025-05-19 10:07:21,123 - chatbot_rag - INFO - [analysis_20250519_100721] Phản hồi gốc: <think>
Okay, let's tackle this. The user's current question is "xin chào", which means "hello" in V...
2025-05-19 10:07:21,123 - chatbot_rag - WARNING - [analysis_20250519_100721] Phát hiện thẻ <think> trong phản hồi. Xử lý đặc biệt...
2025-05-19 10:07:21,123 - chatbot_rag - INFO - [analysis_20250519_100721] BƯỚC 1: Thử parse toàn bộ chuỗi phản hồi
2025-05-19 10:07:21,124 - chatbot_rag - INFO - [analysis_20250519_100721] BƯỚC 1: Không phải JSON hợp lệ: Expecting value: line 1 column 1 (char 0)
2025-05-19 10:07:21,124 - chatbot_rag - INFO - [analysis_20250519_100721] BƯỚC 2: Tìm JSON trong chuỗi phản hồi
2025-05-19 10:07:21,124 - chatbot_rag - WARNING - [analysis_20250519_100721] BƯỚC 2: Không tìm thấy mẫu JSON nào trong phản hồi
2025-05-19 10:07:21,125 - chatbot_rag - INFO - [analysis_20250519_100721] BƯỚC 3: Xử lý chuỗi thủ công để trích xuất thông tin
2025-05-19 10:07:21,622 - department_info_tool - INFO - Đã tải 11 phòng ban
2025-05-19 10:07:21,622 - department_info_tool - INFO - Đã lấy danh sách 11 phòng ban
2025-05-19 10:07:21,628 - chatbot_rag - ERROR - [analysis_20250519_100721] BƯỚC 3: Lỗi khi xử lý chuỗi thủ công: local variable 'query_type' referenced before assignment
2025-05-19 10:07:21,628 - chatbot_rag - WARNING - [analysis_20250519_100721] Tất cả phương pháp phân tích đều thất bại, trả về kết quả mặc định
2025-05-19 10:07:21,628 - websocket_server - INFO - Phân tích câu hỏi: Phòng ban=None, Loại=general, Thinking=False
2025-05-19 10:07:21,629 - websocket_server - INFO - Query thực tế gửi đến mô hình: xin chào /no_think
2025-05-19 10:07:21,629 - websocket_server - INFO - Câu hỏi chung, chế độ thinking: False
2025-05-19 10:07:21,629 - chatbot_rag - INFO - Xử lý câu hỏi chung cho session_id: 9ddb8ec1-79f6-4a3a-abd7-8206a58eb76b
2025-05-19 10:07:21,632 - department_info_tool - INFO - Đã tải 11 phòng ban
2025-05-19 10:07:21,632 - department_info_tool - INFO - Đã lấy danh sách 11 phòng ban
2025-05-19 10:07:21,632 - chatbot_rag - INFO - Gọi LLM để trả lời câu hỏi chung cho session_id: 9ddb8ec1-79f6-4a3a-abd7-8206a58eb76b
2025-05-19 10:07:21,634 - chatbot_rag - INFO - Đã lưu prompt vào file: data/logs/prompt_general_20250519_100721.txt
2025-05-19 10:07:21,634 - chatbot_rag - INFO - Kích thước prompt: 1033 ký tự
2025-05-19 10:07:21,634 - chatbot_rag - INFO - Kích thước system prompt: 916 ký tự
2025-05-19 10:07:21,635 - chatbot_rag - INFO - Tổng kích thước: 1949 ký tự
2025-05-19 10:07:21,636 - chatbot_rag - INFO - Đã lưu full prompt vào file: data/logs/llm_full_prompt_20250519_100721.txt
2025-05-19 10:07:21,636 - chatbot_rag - INFO - System prompt: 
Bạn là trợ lý AI chuyên về quy trình và giai đoạn trong công ty.

DANH SÁCH PHÒNG BAN:
- 2D
- Dự toán
- Khách hàng
- Kinh doanh
- Kế toán
- Marketing
- Mua hàng
- Team dự án
- Thi công
- Thiết kế
- Đ...
2025-05-19 10:07:21,636 - chatbot_rag - INFO - User prompt: 
Câu hỏi: "xin chào /no_think"

Đây là câu hỏi chung về quy trình hoặc giai đoạn làm việc.

Thông tin cơ bản:
### Thông tin tổng quan về quy trình và giai đoạn

#### Giai đoạn chính trong quy trình:
1...
2025-05-19 10:07:21,637 - chatbot_rag - INFO - Gửi truy vấn đến LLM API tại http://192.168.0.43:1234/v1/chat/completions với stream=True
2025-05-19 10:07:23,239 - chatbot_rag - INFO - Mã phản hồi từ API: 200
2025-05-19 10:07:23,239 - chatbot_rag - INFO - Phản hồi gốc từ LLM API (200 ký tự đầu): <think>

</think>

 Xin chào! 😊  
Chào mừng bạn đến với quy trình làm việc của chúng tôi! 🚀  
Nếu bạn có thắc mắc về các giai đoạn hoặc phòng ban, mình sẽ hỗ trợ ngay lập tức nhé! 💬  
Đừng quên hỏi ri
2025-05-19 10:07:23,241 - chatbot_rag - INFO - Đã lưu phản hồi đầy đủ vào file: data/logs/llm_response_20250519_100723.txt
2025-05-19 10:07:23,773 - websocket_server - INFO - Đã trích xuất thinking (0 ký tự) và còn lại 486 ký tự phản hồi
2025-05-19 10:07:23,774 - websocket_server - INFO - Đã trích xuất phần thinking (0 ký tự) từ phản hồi
2025-05-19 10:07:23,774 - websocket_server - INFO - Đã lưu hội thoại chung vào lịch sử của session 9ddb8ec1-79f6-4a3a-abd7-8206a58eb76b
2025-05-19 10:07:31,367 - websocket_server - INFO - Nhận tin nhắn dạng JSON: {"content":"bạn là ai /no_think","session_id":""}
2025-05-19 10:07:31,368 - websocket_server - INFO - Session ID không được cung cấp trong tin nhắn JSON, sử dụng current_session_id: 9ddb8ec1-79f6-4a3a-abd7-8206a58eb76b
2025-05-19 10:07:31,368 - websocket_server - INFO - Session ID từ client (sau khi kiểm tra): 9ddb8ec1-79f6-4a3a-abd7-8206a58eb76b
2025-05-19 10:07:31,369 - websocket_server - INFO - Tắt chế độ thinking cho câu hỏi: bạn là ai /no_think...
2025-05-19 10:07:31,369 - websocket_server - INFO - Nhận tin nhắn thông thường: bạn là ai /no_think, enable_thinking=False
2025-05-19 10:07:31,369 - websocket_server - INFO - Đã thêm 1 tin nhắn gần nhất vào prompt
2025-05-19 10:07:31,371 - websocket_server - INFO - Đã lưu lịch sử tin nhắn và prompt vào file: data/logs/history_prompt_20250519_100731.txt
2025-05-19 10:07:31,371 - chatbot_rag - INFO - Đang phân tích câu hỏi với LLM: Lịch sử tin nhắn:
Người dùng: xin chào

bạn là ai /no_think, session_id: 9ddb8ec1-79f6-4a3a-abd7-8206a58eb76b
2025-05-19 10:07:31,372 - chatbot_rag - INFO - [analyze_query_with_llm] Đã lấy được 0 bản ghi lịch sử từ websocket_server cho session 9ddb8ec1-79f6-4a3a-abd7-8206a58eb76b
2025-05-19 10:07:31,372 - chatbot_rag - INFO - [analyze_query_with_llm] Sử dụng lịch sử hội thoại: 0 bản ghi
2025-05-19 10:07:31,372 - chatbot_rag - INFO - [analyze_query_with_llm] Prompt cuối cùng: Lịch sử tin nhắn:
        
        Câu hỏi người dùng hiện tại: "Lịch sử tin nhắn:
Người dùng: xin chào

bạn là ai /no_think"

        Phân tích câu hỏi và trả về JSON có định dạng:
        {"departme...
2025-05-19 10:07:31,373 - chatbot_rag - INFO - Kích thước prompt: 640 ký tự
2025-05-19 10:07:31,373 - chatbot_rag - INFO - Kích thước system prompt: 2006 ký tự
2025-05-19 10:07:31,373 - chatbot_rag - INFO - Tổng kích thước: 2646 ký tự
2025-05-19 10:07:31,375 - chatbot_rag - INFO - Đã lưu full prompt vào file: data/logs/llm_full_prompt_20250519_100731.txt
2025-05-19 10:07:31,375 - chatbot_rag - INFO - System prompt: 
        Bạn là trợ lý AI phân tích câu hỏi để xác định:
        1. Phòng ban người dùng đang hỏi (department)
        2. Loại câu hỏi: phòng ban cụ thể hay general (query_type)
        3. Nếu câu hỏi...
2025-05-19 10:07:31,376 - chatbot_rag - INFO - User prompt: Lịch sử tin nhắn:
        
        Câu hỏi người dùng hiện tại: "Lịch sử tin nhắn:
Người dùng: xin chào

bạn là ai /no_think"

        Phân tích câu hỏi và trả về JSON có định dạng:
        {"departme...
2025-05-19 10:07:31,376 - chatbot_rag - INFO - Gửi truy vấn đến LLM API tại http://192.168.0.43:1234/v1/chat/completions với stream=False
2025-05-19 10:07:31,766 - chatbot_rag - INFO - Mã phản hồi từ API: 200
2025-05-19 10:07:31,766 - chatbot_rag - INFO - Phản hồi gốc từ LLM API (200 ký tự đầu): <think>

</think>

{"department": null, "query_type": "general", "error": false}
2025-05-19 10:07:31,768 - chatbot_rag - INFO - Đã lưu phản hồi đầy đủ vào file: data/logs/llm_response_20250519_100731.txt
2025-05-19 10:07:31,770 - chatbot_rag - INFO - [analysis_20250519_100731] Đã ghi phản hồi gốc vào: data/logs/analysis_20250519_100731_raw.txt
2025-05-19 10:07:31,771 - chatbot_rag - INFO - [analysis_20250519_100731] Phản hồi gốc: <think>

</think>

{"department": null, "query_type": "general", "error": false}...
2025-05-19 10:07:31,771 - chatbot_rag - WARNING - [analysis_20250519_100731] Phát hiện thẻ <think> trong phản hồi. Xử lý đặc biệt...
2025-05-19 10:07:31,772 - chatbot_rag - INFO - [analysis_20250519_100731] Đã tìm thấy 1 mẫu JSON tiềm năng trong phản hồi
2025-05-19 10:07:31,772 - chatbot_rag - INFO - [analysis_20250519_100731] Tìm thấy JSON hợp lệ trong thẻ <think>: {'department': None, 'query_type': 'general', 'error': False}
2025-05-19 10:07:31,772 - websocket_server - INFO - Phân tích câu hỏi: Phòng ban=None, Loại=general, Thinking=False
2025-05-19 10:07:31,773 - websocket_server - INFO - Xử lý streaming response cho: 'bạn là ai /no_think', phòng ban: None, session_id: 9ddb8ec1-79f6-4a3a-abd7-8206a58eb76b
2025-05-19 10:07:31,773 - websocket_server - INFO - Session ID nhận được: 9ddb8ec1-79f6-4a3a-abd7-8206a58eb76b
2025-05-19 10:07:31,773 - websocket_server - INFO - Phát hiện lệnh /no_think, tắt chế độ thinking cho: bạn là ai
2025-05-19 10:07:31,774 - websocket_server - INFO - Xử lý streaming response. Query: 'bạn là ai', Mode thinking: False
2025-05-19 10:07:31,774 - websocket_server - INFO - Đã thêm 1 tin nhắn gần nhất vào prompt
2025-05-19 10:07:31,775 - websocket_server - INFO - Đã lưu lịch sử tin nhắn và prompt vào file: data/logs/history_prompt_20250519_100731.txt
2025-05-19 10:07:31,775 - chatbot_rag - INFO - Đang phân tích câu hỏi với LLM: Lịch sử tin nhắn:
Người dùng: xin chào

bạn là ai, session_id: 9ddb8ec1-79f6-4a3a-abd7-8206a58eb76b
2025-05-19 10:07:31,776 - chatbot_rag - INFO - [analyze_query_with_llm] Đã lấy được 0 bản ghi lịch sử từ websocket_server cho session 9ddb8ec1-79f6-4a3a-abd7-8206a58eb76b
2025-05-19 10:07:31,776 - chatbot_rag - INFO - [analyze_query_with_llm] Sử dụng lịch sử hội thoại: 0 bản ghi
2025-05-19 10:07:31,777 - chatbot_rag - INFO - [analyze_query_with_llm] Prompt cuối cùng: Lịch sử tin nhắn:
        
        Câu hỏi người dùng hiện tại: "Lịch sử tin nhắn:
Người dùng: xin chào

bạn là ai"

        Phân tích câu hỏi và trả về JSON có định dạng:
        {"department": "tên ...
2025-05-19 10:07:31,778 - chatbot_rag - INFO - Kích thước prompt: 630 ký tự
2025-05-19 10:07:31,778 - chatbot_rag - INFO - Kích thước system prompt: 2006 ký tự
2025-05-19 10:07:31,779 - chatbot_rag - INFO - Tổng kích thước: 2636 ký tự
2025-05-19 10:07:31,780 - chatbot_rag - INFO - Đã lưu full prompt vào file: data/logs/llm_full_prompt_20250519_100731.txt
2025-05-19 10:07:31,780 - chatbot_rag - INFO - System prompt: 
        Bạn là trợ lý AI phân tích câu hỏi để xác định:
        1. Phòng ban người dùng đang hỏi (department)
        2. Loại câu hỏi: phòng ban cụ thể hay general (query_type)
        3. Nếu câu hỏi...
2025-05-19 10:07:31,781 - chatbot_rag - INFO - User prompt: Lịch sử tin nhắn:
        
        Câu hỏi người dùng hiện tại: "Lịch sử tin nhắn:
Người dùng: xin chào

bạn là ai"

        Phân tích câu hỏi và trả về JSON có định dạng:
        {"department": "tên ...
2025-05-19 10:07:31,781 - chatbot_rag - INFO - Gửi truy vấn đến LLM API tại http://192.168.0.43:1234/v1/chat/completions với stream=False
2025-05-19 10:07:33,644 - chatbot_rag - INFO - Mã phản hồi từ API: 200
2025-05-19 10:07:33,644 - chatbot_rag - INFO - Phản hồi gốc từ LLM API (200 ký tự đầu): <think>
Okay, let's see. The user's current question is "Lịch sử tin nhắn: Người dùng: xin chào bạn là ai". So first, I need to parse this.

The history shows the user greeted with "xin chào" and aske
2025-05-19 10:07:33,645 - chatbot_rag - INFO - Đã lưu phản hồi đầy đủ vào file: data/logs/llm_response_20250519_100733.txt
2025-05-19 10:07:33,647 - chatbot_rag - INFO - [analysis_20250519_100733] Đã ghi phản hồi gốc vào: data/logs/analysis_20250519_100733_raw.txt
2025-05-19 10:07:33,647 - chatbot_rag - INFO - [analysis_20250519_100733] Phản hồi gốc: <think>
Okay, let's see. The user's current question is "Lịch sử tin nhắn: Người dùng: xin chào bạn ...
2025-05-19 10:07:33,647 - chatbot_rag - WARNING - [analysis_20250519_100733] Phát hiện thẻ <think> trong phản hồi. Xử lý đặc biệt...
2025-05-19 10:07:33,648 - chatbot_rag - INFO - [analysis_20250519_100733] BƯỚC 1: Thử parse toàn bộ chuỗi phản hồi
2025-05-19 10:07:33,648 - chatbot_rag - INFO - [analysis_20250519_100733] BƯỚC 1: Không phải JSON hợp lệ: Expecting value: line 1 column 1 (char 0)
2025-05-19 10:07:33,648 - chatbot_rag - INFO - [analysis_20250519_100733] BƯỚC 2: Tìm JSON trong chuỗi phản hồi
2025-05-19 10:07:33,649 - chatbot_rag - WARNING - [analysis_20250519_100733] BƯỚC 2: Không tìm thấy mẫu JSON nào trong phản hồi
2025-05-19 10:07:33,649 - chatbot_rag - INFO - [analysis_20250519_100733] BƯỚC 3: Xử lý chuỗi thủ công để trích xuất thông tin
2025-05-19 10:07:33,654 - department_info_tool - INFO - Đã tải 11 phòng ban
2025-05-19 10:07:33,654 - department_info_tool - INFO - Đã lấy danh sách 11 phòng ban
2025-05-19 10:07:33,654 - chatbot_rag - ERROR - [analysis_20250519_100733] BƯỚC 3: Lỗi khi xử lý chuỗi thủ công: local variable 'query_type' referenced before assignment
2025-05-19 10:07:33,655 - chatbot_rag - WARNING - [analysis_20250519_100733] Tất cả phương pháp phân tích đều thất bại, trả về kết quả mặc định
2025-05-19 10:07:33,655 - websocket_server - INFO - Phân tích câu hỏi: Phòng ban=None, Loại=general, Thinking=False
2025-05-19 10:07:33,655 - websocket_server - INFO - Query thực tế gửi đến mô hình: bạn là ai /no_think
2025-05-19 10:07:33,656 - websocket_server - INFO - Câu hỏi chung, chế độ thinking: False
2025-05-19 10:07:33,656 - chatbot_rag - INFO - Xử lý câu hỏi chung cho session_id: 9ddb8ec1-79f6-4a3a-abd7-8206a58eb76b
2025-05-19 10:07:33,660 - department_info_tool - INFO - Đã tải 11 phòng ban
2025-05-19 10:07:33,661 - department_info_tool - INFO - Đã lấy danh sách 11 phòng ban
2025-05-19 10:07:33,661 - chatbot_rag - INFO - Gọi LLM để trả lời câu hỏi chung cho session_id: 9ddb8ec1-79f6-4a3a-abd7-8206a58eb76b
2025-05-19 10:07:33,662 - chatbot_rag - INFO - Đã lưu prompt vào file: data/logs/prompt_general_20250519_100733.txt
2025-05-19 10:07:33,663 - chatbot_rag - INFO - Kích thước prompt: 1034 ký tự
2025-05-19 10:07:33,663 - chatbot_rag - INFO - Kích thước system prompt: 916 ký tự
2025-05-19 10:07:33,664 - chatbot_rag - INFO - Tổng kích thước: 1950 ký tự
2025-05-19 10:07:33,667 - chatbot_rag - INFO - Đã lưu full prompt vào file: data/logs/llm_full_prompt_20250519_100733.txt
2025-05-19 10:07:33,667 - chatbot_rag - INFO - System prompt: 
Bạn là trợ lý AI chuyên về quy trình và giai đoạn trong công ty.

DANH SÁCH PHÒNG BAN:
- 2D
- Dự toán
- Khách hàng
- Kinh doanh
- Kế toán
- Marketing
- Mua hàng
- Team dự án
- Thi công
- Thiết kế
- Đ...
2025-05-19 10:07:33,668 - chatbot_rag - INFO - User prompt: 
Câu hỏi: "bạn là ai /no_think"

Đây là câu hỏi chung về quy trình hoặc giai đoạn làm việc.

Thông tin cơ bản:
### Thông tin tổng quan về quy trình và giai đoạn

#### Giai đoạn chính trong quy trình:
...
2025-05-19 10:07:33,668 - chatbot_rag - INFO - Gửi truy vấn đến LLM API tại http://192.168.0.43:1234/v1/chat/completions với stream=True
2025-05-19 10:07:35,072 - chatbot_rag - INFO - Mã phản hồi từ API: 200
2025-05-19 10:07:35,073 - chatbot_rag - INFO - Phản hồi gốc từ LLM API (200 ký tự đầu): <think>

</think>

👋 *Chào bạn!*  
Tôi là **AI hỗ trợ quy trình công ty**, chuyên giúp bạn hiểu rõ về các giai đoạn làm việc và vai trò của từng phòng ban.  

💡 Nếu bạn muốn biết một phòng ban cụ thể 
2025-05-19 10:07:35,074 - chatbot_rag - INFO - Đã lưu phản hồi đầy đủ vào file: data/logs/llm_response_20250519_100735.txt
2025-05-19 10:07:35,078 - websocket_server - INFO - Đã trích xuất thinking (0 ký tự) và còn lại 433 ký tự phản hồi
2025-05-19 10:07:35,078 - websocket_server - INFO - Đã trích xuất phần thinking (0 ký tự) từ phản hồi
2025-05-19 10:07:35,078 - websocket_server - INFO - Đã lưu hội thoại chung vào lịch sử của session 9ddb8ec1-79f6-4a3a-abd7-8206a58eb76b
2025-05-19 10:07:49,749 - websocket_server - INFO - Nhận tin nhắn dạng JSON: {"content":"nói chuyện vui vẻ đê /no_think","session_id":""}
2025-05-19 10:07:49,750 - websocket_server - INFO - Session ID không được cung cấp trong tin nhắn JSON, sử dụng current_session_id: 9ddb8ec1-79f6-4a3a-abd7-8206a58eb76b
2025-05-19 10:07:49,750 - websocket_server - INFO - Session ID từ client (sau khi kiểm tra): 9ddb8ec1-79f6-4a3a-abd7-8206a58eb76b
2025-05-19 10:07:49,750 - websocket_server - INFO - Tắt chế độ thinking cho câu hỏi: nói chuyện vui vẻ đê /no_think...
2025-05-19 10:07:49,751 - websocket_server - INFO - Nhận tin nhắn thông thường: nói chuyện vui vẻ đê /no_think, enable_thinking=False
2025-05-19 10:07:49,751 - websocket_server - INFO - Đã thêm 2 tin nhắn gần nhất vào prompt
2025-05-19 10:07:49,752 - websocket_server - INFO - Đã lưu lịch sử tin nhắn và prompt vào file: data/logs/history_prompt_20250519_100749.txt
2025-05-19 10:07:49,753 - chatbot_rag - INFO - Đang phân tích câu hỏi với LLM: Lịch sử tin nhắn:
Người dùng: xin chào
Người dùng: bạn là ai

nói chuyện vui vẻ đê /no_think, session_id: 9ddb8ec1-79f6-4a3a-abd7-8206a58eb76b
2025-05-19 10:07:49,753 - chatbot_rag - INFO - [analyze_query_with_llm] Đã lấy được 0 bản ghi lịch sử từ websocket_server cho session 9ddb8ec1-79f6-4a3a-abd7-8206a58eb76b
2025-05-19 10:07:49,753 - chatbot_rag - INFO - [analyze_query_with_llm] Sử dụng lịch sử hội thoại: 0 bản ghi
2025-05-19 10:07:49,754 - chatbot_rag - INFO - [analyze_query_with_llm] Prompt cuối cùng: Lịch sử tin nhắn:
        
        Câu hỏi người dùng hiện tại: "Lịch sử tin nhắn:
Người dùng: xin chào
Người dùng: bạn là ai

nói chuyện vui vẻ đê /no_think"

        Phân tích câu hỏi và trả về JSON...
2025-05-19 10:07:49,754 - chatbot_rag - INFO - Kích thước prompt: 673 ký tự
2025-05-19 10:07:49,755 - chatbot_rag - INFO - Kích thước system prompt: 2006 ký tự
2025-05-19 10:07:49,755 - chatbot_rag - INFO - Tổng kích thước: 2679 ký tự
2025-05-19 10:07:49,758 - chatbot_rag - INFO - Đã lưu full prompt vào file: data/logs/llm_full_prompt_20250519_100749.txt
2025-05-19 10:07:49,758 - chatbot_rag - INFO - System prompt: 
        Bạn là trợ lý AI phân tích câu hỏi để xác định:
        1. Phòng ban người dùng đang hỏi (department)
        2. Loại câu hỏi: phòng ban cụ thể hay general (query_type)
        3. Nếu câu hỏi...
2025-05-19 10:07:49,759 - chatbot_rag - INFO - User prompt: Lịch sử tin nhắn:
        
        Câu hỏi người dùng hiện tại: "Lịch sử tin nhắn:
Người dùng: xin chào
Người dùng: bạn là ai

nói chuyện vui vẻ đê /no_think"

        Phân tích câu hỏi và trả về JSON...
2025-05-19 10:07:49,759 - chatbot_rag - INFO - Gửi truy vấn đến LLM API tại http://192.168.0.43:1234/v1/chat/completions với stream=False
2025-05-19 10:07:50,145 - chatbot_rag - INFO - Mã phản hồi từ API: 200
2025-05-19 10:07:50,145 - chatbot_rag - INFO - Phản hồi gốc từ LLM API (200 ký tự đầu): <think>

</think>

{"department": null, "query_type": "general", "error": false}
2025-05-19 10:07:50,146 - chatbot_rag - INFO - Đã lưu phản hồi đầy đủ vào file: data/logs/llm_response_20250519_100750.txt
2025-05-19 10:07:50,148 - chatbot_rag - INFO - [analysis_20250519_100750] Đã ghi phản hồi gốc vào: data/logs/analysis_20250519_100750_raw.txt
2025-05-19 10:07:50,149 - chatbot_rag - INFO - [analysis_20250519_100750] Phản hồi gốc: <think>

</think>

{"department": null, "query_type": "general", "error": false}...
2025-05-19 10:07:50,149 - chatbot_rag - WARNING - [analysis_20250519_100750] Phát hiện thẻ <think> trong phản hồi. Xử lý đặc biệt...
2025-05-19 10:07:50,149 - chatbot_rag - INFO - [analysis_20250519_100750] Đã tìm thấy 1 mẫu JSON tiềm năng trong phản hồi
2025-05-19 10:07:50,150 - chatbot_rag - INFO - [analysis_20250519_100750] Tìm thấy JSON hợp lệ trong thẻ <think>: {'department': None, 'query_type': 'general', 'error': False}
2025-05-19 10:07:50,151 - websocket_server - INFO - Phân tích câu hỏi: Phòng ban=None, Loại=general, Thinking=False
2025-05-19 10:07:50,151 - websocket_server - INFO - Xử lý streaming response cho: 'nói chuyện vui vẻ đê /no_think', phòng ban: None, session_id: 9ddb8ec1-79f6-4a3a-abd7-8206a58eb76b
2025-05-19 10:07:50,152 - websocket_server - INFO - Session ID nhận được: 9ddb8ec1-79f6-4a3a-abd7-8206a58eb76b
2025-05-19 10:07:50,153 - websocket_server - INFO - Phát hiện lệnh /no_think, tắt chế độ thinking cho: nói chuyện vui vẻ đê
2025-05-19 10:07:50,153 - websocket_server - INFO - Xử lý streaming response. Query: 'nói chuyện vui vẻ đê', Mode thinking: False
2025-05-19 10:07:50,154 - websocket_server - INFO - Đã thêm 2 tin nhắn gần nhất vào prompt
2025-05-19 10:07:50,155 - websocket_server - INFO - Đã lưu lịch sử tin nhắn và prompt vào file: data/logs/history_prompt_20250519_100750.txt
2025-05-19 10:07:50,155 - chatbot_rag - INFO - Đang phân tích câu hỏi với LLM: Lịch sử tin nhắn:
Người dùng: xin chào
Người dùng: bạn là ai

nói chuyện vui vẻ đê, session_id: 9ddb8ec1-79f6-4a3a-abd7-8206a58eb76b
2025-05-19 10:07:50,156 - chatbot_rag - INFO - [analyze_query_with_llm] Đã lấy được 0 bản ghi lịch sử từ websocket_server cho session 9ddb8ec1-79f6-4a3a-abd7-8206a58eb76b
2025-05-19 10:07:50,156 - chatbot_rag - INFO - [analyze_query_with_llm] Sử dụng lịch sử hội thoại: 0 bản ghi
2025-05-19 10:07:50,156 - chatbot_rag - INFO - [analyze_query_with_llm] Prompt cuối cùng: Lịch sử tin nhắn:
        
        Câu hỏi người dùng hiện tại: "Lịch sử tin nhắn:
Người dùng: xin chào
Người dùng: bạn là ai

nói chuyện vui vẻ đê"

        Phân tích câu hỏi và trả về JSON có định d...
2025-05-19 10:07:50,157 - chatbot_rag - INFO - Kích thước prompt: 663 ký tự
2025-05-19 10:07:50,158 - chatbot_rag - INFO - Kích thước system prompt: 2006 ký tự
2025-05-19 10:07:50,158 - chatbot_rag - INFO - Tổng kích thước: 2669 ký tự
2025-05-19 10:07:50,160 - chatbot_rag - INFO - Đã lưu full prompt vào file: data/logs/llm_full_prompt_20250519_100750.txt
2025-05-19 10:07:50,161 - chatbot_rag - INFO - System prompt: 
        Bạn là trợ lý AI phân tích câu hỏi để xác định:
        1. Phòng ban người dùng đang hỏi (department)
        2. Loại câu hỏi: phòng ban cụ thể hay general (query_type)
        3. Nếu câu hỏi...
2025-05-19 10:07:50,161 - chatbot_rag - INFO - User prompt: Lịch sử tin nhắn:
        
        Câu hỏi người dùng hiện tại: "Lịch sử tin nhắn:
Người dùng: xin chào
Người dùng: bạn là ai

nói chuyện vui vẻ đê"

        Phân tích câu hỏi và trả về JSON có định d...
2025-05-19 10:07:50,162 - chatbot_rag - INFO - Gửi truy vấn đến LLM API tại http://192.168.0.43:1234/v1/chat/completions với stream=False
2025-05-19 10:07:52,042 - chatbot_rag - INFO - Mã phản hồi từ API: 200
2025-05-19 10:07:52,043 - chatbot_rag - INFO - Phản hồi gốc từ LLM API (200 ký tự đầu): <think>
Okay, let me try to figure this out. The user provided a history of messages where they greeted and asked who I am. Now, the current question is about the chat history itself, but it seems lik
2025-05-19 10:07:52,045 - chatbot_rag - INFO - Đã lưu phản hồi đầy đủ vào file: data/logs/llm_response_20250519_100752.txt
2025-05-19 10:07:52,048 - chatbot_rag - INFO - [analysis_20250519_100752] Đã ghi phản hồi gốc vào: data/logs/analysis_20250519_100752_raw.txt
2025-05-19 10:07:52,048 - chatbot_rag - INFO - [analysis_20250519_100752] Phản hồi gốc: <think>
Okay, let me try to figure this out. The user provided a history of messages where they gree...
2025-05-19 10:07:52,048 - chatbot_rag - WARNING - [analysis_20250519_100752] Phát hiện thẻ <think> trong phản hồi. Xử lý đặc biệt...
2025-05-19 10:07:52,048 - chatbot_rag - INFO - [analysis_20250519_100752] BƯỚC 1: Thử parse toàn bộ chuỗi phản hồi
2025-05-19 10:07:52,049 - chatbot_rag - INFO - [analysis_20250519_100752] BƯỚC 1: Không phải JSON hợp lệ: Expecting value: line 1 column 1 (char 0)
2025-05-19 10:07:52,049 - chatbot_rag - INFO - [analysis_20250519_100752] BƯỚC 2: Tìm JSON trong chuỗi phản hồi
2025-05-19 10:07:52,049 - chatbot_rag - WARNING - [analysis_20250519_100752] BƯỚC 2: Không tìm thấy mẫu JSON nào trong phản hồi
2025-05-19 10:07:52,051 - chatbot_rag - INFO - [analysis_20250519_100752] BƯỚC 3: Xử lý chuỗi thủ công để trích xuất thông tin
2025-05-19 10:07:52,054 - department_info_tool - INFO - Đã tải 11 phòng ban
2025-05-19 10:07:52,055 - department_info_tool - INFO - Đã lấy danh sách 11 phòng ban
2025-05-19 10:07:52,055 - chatbot_rag - ERROR - [analysis_20250519_100752] BƯỚC 3: Lỗi khi xử lý chuỗi thủ công: local variable 'query_type' referenced before assignment
2025-05-19 10:07:52,055 - chatbot_rag - WARNING - [analysis_20250519_100752] Tất cả phương pháp phân tích đều thất bại, trả về kết quả mặc định
2025-05-19 10:07:52,056 - websocket_server - INFO - Phân tích câu hỏi: Phòng ban=None, Loại=general, Thinking=False
2025-05-19 10:07:52,056 - websocket_server - INFO - Query thực tế gửi đến mô hình: nói chuyện vui vẻ đê /no_think
2025-05-19 10:07:52,056 - websocket_server - INFO - Câu hỏi chung, chế độ thinking: False
2025-05-19 10:07:52,057 - chatbot_rag - INFO - Xử lý câu hỏi chung cho session_id: 9ddb8ec1-79f6-4a3a-abd7-8206a58eb76b
2025-05-19 10:07:52,061 - department_info_tool - INFO - Đã tải 11 phòng ban
2025-05-19 10:07:52,061 - department_info_tool - INFO - Đã lấy danh sách 11 phòng ban
2025-05-19 10:07:52,061 - chatbot_rag - INFO - Gọi LLM để trả lời câu hỏi chung cho session_id: 9ddb8ec1-79f6-4a3a-abd7-8206a58eb76b
2025-05-19 10:07:52,063 - chatbot_rag - INFO - Đã lưu prompt vào file: data/logs/prompt_general_20250519_100752.txt
2025-05-19 10:07:52,065 - chatbot_rag - INFO - Kích thước prompt: 1045 ký tự
2025-05-19 10:07:52,066 - chatbot_rag - INFO - Kích thước system prompt: 916 ký tự
2025-05-19 10:07:52,067 - chatbot_rag - INFO - Tổng kích thước: 1961 ký tự
2025-05-19 10:07:52,069 - chatbot_rag - INFO - Đã lưu full prompt vào file: data/logs/llm_full_prompt_20250519_100752.txt
2025-05-19 10:07:52,069 - chatbot_rag - INFO - System prompt: 
Bạn là trợ lý AI chuyên về quy trình và giai đoạn trong công ty.

DANH SÁCH PHÒNG BAN:
- 2D
- Dự toán
- Khách hàng
- Kinh doanh
- Kế toán
- Marketing
- Mua hàng
- Team dự án
- Thi công
- Thiết kế
- Đ...
2025-05-19 10:07:52,070 - chatbot_rag - INFO - User prompt: 
Câu hỏi: "nói chuyện vui vẻ đê /no_think"

Đây là câu hỏi chung về quy trình hoặc giai đoạn làm việc.

Thông tin cơ bản:
### Thông tin tổng quan về quy trình và giai đoạn

#### Giai đoạn chính trong ...
2025-05-19 10:07:52,070 - chatbot_rag - INFO - Gửi truy vấn đến LLM API tại http://192.168.0.43:1234/v1/chat/completions với stream=True
2025-05-19 10:07:52,891 - chatbot_rag - INFO - Mã phản hồi từ API: 200
2025-05-19 10:07:52,892 - chatbot_rag - INFO - Phản hồi gốc từ LLM API (200 ký tự đầu): <think>

</think>

💬 *Cười toe toét* 😄  
Để biết chi tiết công việc cụ thể, vui lòng hỏi về một phòng ban cụ thể, ví dụ: "Phòng Marketing làm gì trong giai đoạn MKT-SALES?" 🎉  

*(spam icon)* 💃🕺🎉🎊🔥💥✨🌟
2025-05-19 10:07:52,893 - chatbot_rag - INFO - Đã lưu phản hồi đầy đủ vào file: data/logs/llm_response_20250519_100752.txt
2025-05-19 10:07:52,896 - websocket_server - INFO - Đã trích xuất thinking (0 ký tự) và còn lại 185 ký tự phản hồi
2025-05-19 10:07:52,896 - websocket_server - INFO - Đã trích xuất phần thinking (0 ký tự) từ phản hồi
2025-05-19 10:07:52,897 - websocket_server - INFO - Đã lưu hội thoại chung vào lịch sử của session 9ddb8ec1-79f6-4a3a-abd7-8206a58eb76b
2025-05-19 10:08:04,565 - websockets.server - INFO - connection closed
2025-05-19 10:08:04,566 - websockets.server - INFO - server closing
2025-05-19 10:08:04,566 - websockets.server - INFO - server closed
2025-05-19 10:08:04,568 - websocket_server - INFO - Server bị dừng bởi người dùng
2025-05-19 10:09:59,287 - websocket_server - INFO - Khởi động server WebSocket tại 0.0.0.0:8090
2025-05-19 10:09:59,322 - websockets.server - INFO - server listening on 0.0.0.0:8090
2025-05-19 10:09:59,323 - websocket_server - INFO - Server WebSocket đang chạy tại ws://0.0.0.0:8090
2025-05-19 10:09:59,323 - websocket_server - INFO - Đã cấu hình ping_timeout=6000 giây, ping_interval=60 giây
2025-05-19 10:10:07,200 - websockets.server - INFO - connection open
2025-05-19 10:10:09,083 - websocket_server - INFO - Nhận tin nhắn dạng JSON: {"content":"Tôi muốn biết về các giai đoạn hiện tại của DBhomes /no_think","session_id":""}
2025-05-19 10:10:09,084 - websocket_server - INFO - Session ID không được cung cấp trong tin nhắn JSON, sử dụng current_session_id: e58eb630-381b-498e-ac91-af001428423f
2025-05-19 10:10:09,084 - websocket_server - INFO - Session ID từ client (sau khi kiểm tra): e58eb630-381b-498e-ac91-af001428423f
2025-05-19 10:10:09,084 - websocket_server - INFO - Tắt chế độ thinking cho câu hỏi: Tôi muốn biết về các giai đoạn hiện tại của DBhome...
2025-05-19 10:10:09,085 - websocket_server - INFO - Nhận tin nhắn thông thường: Tôi muốn biết về các giai đoạn hiện tại của DBhomes /no_think, enable_thinking=False
2025-05-19 10:10:09,085 - websocket_server - INFO - Không có lịch sử tin nhắn cho phiên này
2025-05-19 10:10:09,086 - chatbot_rag - INFO - Đang phân tích câu hỏi với LLM: Tôi muốn biết về các giai đoạn hiện tại của DBhomes /no_think, session_id: e58eb630-381b-498e-ac91-af001428423f
2025-05-19 10:10:09,090 - chatbot_rag - INFO - [analyze_query_with_llm] Đã lấy được 0 bản ghi lịch sử từ websocket_server cho session e58eb630-381b-498e-ac91-af001428423f
2025-05-19 10:10:09,091 - chatbot_rag - INFO - [analyze_query_with_llm] Sử dụng lịch sử hội thoại: 0 bản ghi
2025-05-19 10:10:09,092 - chatbot_rag - INFO - [analyze_query_with_llm] Prompt cuối cùng: Lịch sử tin nhắn:
        
        Câu hỏi người dùng hiện tại: "Tôi muốn biết về các giai đoạn hiện tại của DBhomes /no_think"

        Phân tích câu hỏi và trả về JSON có định dạng:
        {"depart...
2025-05-19 10:10:09,095 - chatbot_rag - INFO - Kích thước prompt: 642 ký tự
2025-05-19 10:10:09,096 - chatbot_rag - INFO - Kích thước system prompt: 2006 ký tự
2025-05-19 10:10:09,096 - chatbot_rag - INFO - Tổng kích thước: 2648 ký tự
2025-05-19 10:10:09,098 - chatbot_rag - ERROR - Lỗi khi gọi LLM: [Errno 28] No space left on device
2025-05-19 10:10:09,104 - chatbot_rag - INFO - [analysis_20250519_101009] Đã ghi phản hồi gốc vào: data/logs/analysis_20250519_101009_raw.txt
2025-05-19 10:10:09,104 - chatbot_rag - INFO - [analysis_20250519_101009] Phản hồi gốc: Đã xảy ra lỗi khi xử lý truy vấn: [Errno 28] No space left on device...
2025-05-19 10:10:09,105 - chatbot_rag - INFO - [analysis_20250519_101009] BƯỚC 1: Thử parse toàn bộ chuỗi phản hồi
2025-05-19 10:10:09,106 - chatbot_rag - INFO - [analysis_20250519_101009] BƯỚC 1: Không phải JSON hợp lệ: Expecting value: line 1 column 1 (char 0)
2025-05-19 10:10:09,224 - chatbot_rag - INFO - [analysis_20250519_101009] BƯỚC 2: Tìm JSON trong chuỗi phản hồi
2025-05-19 10:10:09,235 - chatbot_rag - WARNING - [analysis_20250519_101009] BƯỚC 2: Không tìm thấy mẫu JSON nào trong phản hồi
2025-05-19 10:10:09,250 - chatbot_rag - INFO - [analysis_20250519_101009] BƯỚC 3: Xử lý chuỗi thủ công để trích xuất thông tin
2025-05-19 10:10:09,266 - department_info_tool - INFO - Đã tải 11 phòng ban
2025-05-19 10:10:09,277 - department_info_tool - INFO - Đã lấy danh sách 11 phòng ban
2025-05-19 10:10:09,286 - chatbot_rag - ERROR - [analysis_20250519_101009] BƯỚC 3: Lỗi khi xử lý chuỗi thủ công: local variable 'query_type' referenced before assignment
2025-05-19 10:10:09,295 - chatbot_rag - WARNING - [analysis_20250519_101009] Tất cả phương pháp phân tích đều thất bại, trả về kết quả mặc định
2025-05-19 10:10:09,305 - websocket_server - INFO - Phân tích câu hỏi: Phòng ban=None, Loại=general, Thinking=False
2025-05-19 10:10:09,309 - websocket_server - INFO - Xử lý streaming response cho: 'Tôi muốn biết về các giai đoạn hiện tại của DBhomes /no_think', phòng ban: None, session_id: e58eb630-381b-498e-ac91-af001428423f
2025-05-19 10:10:09,319 - websocket_server - INFO - Session ID nhận được: e58eb630-381b-498e-ac91-af001428423f
2025-05-19 10:10:09,327 - websocket_server - INFO - Phát hiện lệnh /no_think, tắt chế độ thinking cho: Tôi muốn biết về các giai đoạn hiện tại của DBhomes
2025-05-19 10:10:09,341 - websocket_server - INFO - Xử lý streaming response. Query: 'Tôi muốn biết về các giai đoạn hiện tại của DBhomes', Mode thinking: False
2025-05-19 10:10:09,356 - websocket_server - INFO - Không có lịch sử tin nhắn cho phiên này
2025-05-19 10:10:09,367 - chatbot_rag - INFO - Đang phân tích câu hỏi với LLM: Tôi muốn biết về các giai đoạn hiện tại của DBhomes, session_id: e58eb630-381b-498e-ac91-af001428423f
2025-05-19 10:10:09,378 - chatbot_rag - INFO - [analyze_query_with_llm] Đã lấy được 0 bản ghi lịch sử từ websocket_server cho session e58eb630-381b-498e-ac91-af001428423f
2025-05-19 10:10:09,390 - chatbot_rag - INFO - [analyze_query_with_llm] Sử dụng lịch sử hội thoại: 0 bản ghi
2025-05-19 10:10:09,402 - chatbot_rag - INFO - [analyze_query_with_llm] Prompt cuối cùng: Lịch sử tin nhắn:
        
        Câu hỏi người dùng hiện tại: "Tôi muốn biết về các giai đoạn hiện tại của DBhomes"

        Phân tích câu hỏi và trả về JSON có định dạng:
        {"department": "tê...
2025-05-19 10:10:09,417 - chatbot_rag - INFO - Kích thước prompt: 632 ký tự
2025-05-19 10:10:09,426 - chatbot_rag - INFO - Kích thước system prompt: 2006 ký tự
2025-05-19 10:10:09,433 - chatbot_rag - INFO - Tổng kích thước: 2638 ký tự
2025-05-19 10:10:09,448 - chatbot_rag - ERROR - Lỗi khi gọi LLM: [Errno 28] No space left on device
2025-05-19 10:10:09,465 - chatbot_rag - INFO - [analysis_20250519_101009] Đã ghi phản hồi gốc vào: data/logs/analysis_20250519_101009_raw.txt
2025-05-19 10:10:09,474 - chatbot_rag - INFO - [analysis_20250519_101009] Phản hồi gốc: Đã xảy ra lỗi khi xử lý truy vấn: [Errno 28] No space left on device...
2025-05-19 10:10:09,481 - chatbot_rag - INFO - [analysis_20250519_101009] BƯỚC 1: Thử parse toàn bộ chuỗi phản hồi
2025-05-19 10:10:09,488 - chatbot_rag - INFO - [analysis_20250519_101009] BƯỚC 1: Không phải JSON hợp lệ: Expecting value: line 1 column 1 (char 0)
2025-05-19 10:10:09,499 - chatbot_rag - INFO - [analysis_20250519_101009] BƯỚC 2: Tìm JSON trong chuỗi phản hồi
2025-05-19 10:10:09,507 - chatbot_rag - WARNING - [analysis_20250519_101009] BƯỚC 2: Không tìm thấy mẫu JSON nào trong phản hồi
2025-05-19 10:10:09,514 - chatbot_rag - INFO - [analysis_20250519_101009] BƯỚC 3: Xử lý chuỗi thủ công để trích xuất thông tin
2025-05-19 10:10:09,526 - department_info_tool - INFO - Đã tải 11 phòng ban
2025-05-19 10:10:09,536 - department_info_tool - INFO - Đã lấy danh sách 11 phòng ban
2025-05-19 10:10:09,544 - chatbot_rag - ERROR - [analysis_20250519_101009] BƯỚC 3: Lỗi khi xử lý chuỗi thủ công: local variable 'query_type' referenced before assignment
2025-05-19 10:10:09,554 - chatbot_rag - WARNING - [analysis_20250519_101009] Tất cả phương pháp phân tích đều thất bại, trả về kết quả mặc định
2025-05-19 10:10:09,560 - websocket_server - INFO - Phân tích câu hỏi: Phòng ban=None, Loại=general, Thinking=False
2025-05-19 10:10:09,567 - websocket_server - INFO - Query thực tế gửi đến mô hình: Tôi muốn biết về các giai đoạn hiện tại của DBhomes /no_think
2025-05-19 10:10:09,572 - websocket_server - INFO - Câu hỏi chung, chế độ thinking: False
2025-05-19 10:10:09,579 - chatbot_rag - INFO - Xử lý câu hỏi chung cho session_id: e58eb630-381b-498e-ac91-af001428423f
2025-05-19 10:10:09,595 - department_info_tool - INFO - Đã tải 11 phòng ban
2025-05-19 10:10:09,603 - department_info_tool - INFO - Đã lấy danh sách 11 phòng ban
2025-05-19 10:10:09,612 - chatbot_rag - INFO - Gọi LLM để trả lời câu hỏi chung cho session_id: e58eb630-381b-498e-ac91-af001428423f
2025-05-19 10:10:09,619 - chatbot_rag - ERROR - Lỗi khi gọi LLM để trả lời câu hỏi chung cho session_id: e58eb630-381b-498e-ac91-af001428423f: [Errno 28] No space left on device
2025-05-19 10:10:09,627 - websocket_server - INFO - Đã lưu hội thoại chung vào lịch sử của session e58eb630-381b-498e-ac91-af001428423f
2025-05-19 10:10:15,163 - websocket_server - INFO - Nhận tin nhắn dạng JSON: {"content":"phòng 2D làm nhiệm vụ gì /no_think","session_id":""}
2025-05-19 10:10:15,167 - websocket_server - INFO - Session ID không được cung cấp trong tin nhắn JSON, sử dụng current_session_id: e58eb630-381b-498e-ac91-af001428423f
2025-05-19 10:10:15,172 - websocket_server - INFO - Session ID từ client (sau khi kiểm tra): e58eb630-381b-498e-ac91-af001428423f
2025-05-19 10:10:15,177 - websocket_server - INFO - Tắt chế độ thinking cho câu hỏi: phòng 2D làm nhiệm vụ gì /no_think...
2025-05-19 10:10:15,184 - websocket_server - INFO - Nhận tin nhắn thông thường: phòng 2D làm nhiệm vụ gì /no_think, enable_thinking=False
2025-05-19 10:10:15,189 - websocket_server - INFO - Đã thêm 1 tin nhắn gần nhất vào prompt
2025-05-19 10:10:15,198 - websocket_server - INFO - Đã lưu lịch sử tin nhắn và prompt vào file: data/logs/history_prompt_20250519_101015.txt
2025-05-19 10:10:15,205 - chatbot_rag - INFO - Đang phân tích câu hỏi với LLM: Lịch sử tin nhắn:
Người dùng: Tôi muốn biết về các giai đoạn hiện tại của DBhomes

phòng 2D làm nhiệm vụ gì /no_think, session_id: e58eb630-381b-498e-ac91-af001428423f
2025-05-19 10:10:15,210 - chatbot_rag - INFO - [analyze_query_with_llm] Đã lấy được 0 bản ghi lịch sử từ websocket_server cho session e58eb630-381b-498e-ac91-af001428423f
2025-05-19 10:10:15,214 - chatbot_rag - INFO - [analyze_query_with_llm] Sử dụng lịch sử hội thoại: 0 bản ghi
2025-05-19 10:10:15,220 - chatbot_rag - INFO - [analyze_query_with_llm] Prompt cuối cùng: Lịch sử tin nhắn:
        
        Câu hỏi người dùng hiện tại: "Lịch sử tin nhắn:
Người dùng: Tôi muốn biết về các giai đoạn hiện tại của DBhomes

phòng 2D làm nhiệm vụ gì /no_think"

        Phân tí...
2025-05-19 10:10:15,227 - chatbot_rag - INFO - Kích thước prompt: 698 ký tự
2025-05-19 10:21:59,733 - websockets.server - INFO - connection closed
2025-05-19 10:21:59,736 - websockets.server - INFO - server closing
2025-05-19 10:21:59,737 - websockets.server - INFO - server closed
2025-05-19 10:21:59,740 - websocket_server - INFO - Server bị dừng bởi người dùng
